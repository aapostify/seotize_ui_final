<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Partner Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>

<style>
/* CSS Variables - Modern Professional Theme */
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #10b981;
    --accent: #f59e0b;
    --error: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    
    --radius-sm: 6px;
    --radius: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    
    --transition: all 0.2s ease;
}

/* Light Theme */
[data-theme="light"] {
    --bg: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --sidebar: #ffffff;
    --card: #ffffff;
    --card-hover: #f8fafc;
    --text: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    --border: #e2e8f0;
    --input-bg: #ffffff;
}

/* Dark Theme */
[data-theme="dark"] {
    --bg: #0a0a0a;
    --bg-secondary: #151515;
    --bg-tertiary: #1f1f1f;
    --sidebar: #151515;
    --card: #151515;
    --card-hover: #1f1f1f;
    --text: #ffffff;
    --text-secondary: #b3b3b3;
    --text-tertiary: #808080;
    --border: #2a2a2a;
    --input-bg: #1f1f1f;
}

/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: var(--transition);
    line-height: 1.5;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Layout */
.dashboard-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: var(--sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: var(--transition);
}

.sidebar-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    text-decoration: none;
}

.sidebar-nav {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

.nav-section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    padding: 0 0.75rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    border-radius: var(--radius);
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.nav-item:hover {
    background: var(--bg-tertiary);
    color: var(--text);
}

.nav-item.active {
    background: var(--primary);
    color: white;
}

.nav-item i {
    font-size: 1.125rem;
    width: 1.25rem;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.theme-toggle {
    padding: 0.5rem;
    border-radius: var(--radius);
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.125rem;
    transition: var(--transition);
}

.theme-toggle:hover {
    background: var(--bg-tertiary);
    color: var(--text);
}

/* Mobile Profile Menu */
.mobile-profile-menu {
    display: none;
    padding: 0;
    border-radius: 50%;
    background: transparent;
    border: none;
    cursor: pointer;
}

.mobile-profile-menu .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    transition: var(--transition);
}

.mobile-profile-menu .user-avatar:hover {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Profile Dropdown */
.mobile-profile-dropdown {
    display: none;
    position: fixed;
    top: 60px;
    right: 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: 10001;
    overflow: hidden;
    min-width: 260px;
    animation: slideDown 0.15s ease;
}

.mobile-profile-dropdown.active {
    display: block;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-menu-container {
    position: relative;
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius);
    background: var(--bg-tertiary);
    cursor: pointer;
    transition: var(--transition);
}

.user-menu:hover {
    background: var(--card-hover);
}

.user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 200px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: none;
    z-index: 1000;
}

.user-dropdown.active {
    display: block;
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 1rem;
    color: var(--text);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
    font-size: 0.875rem;
}

.user-dropdown-item:hover {
    background: var(--bg-tertiary);
}

.user-dropdown-item i {
    width: 1.125rem;
}

.user-dropdown-item.danger {
    color: var(--error);
}

/* Content Area */
.content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .content {
        padding: 0.75rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
}

/* Cards */
.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    transition: var(--transition);
    margin-bottom: 1.5rem;
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
}

.card-body {
    padding: 1.25rem;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1rem;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    transition: var(--transition);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.stat-icon.primary { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
.stat-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.stat-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

.stat-content {
    flex: 1;
    min-width: 0;
}

.stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.125rem;
    line-height: 1.2;
}

.stat-label {
    font-size: 0.6875rem;
    color: var(--text-secondary);
    line-height: 1.2;
}

/* Buttons */
.btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--bg-tertiary); color: var(--text); }
.btn-secondary:hover { background: var(--border); }
.btn-danger { 
    background: transparent; 
    color: var(--error); 
    border: 1.5px solid var(--error);
    padding: 0.625rem 1.25rem;
    font-weight: 600;
}
.btn-danger:hover { 
    background: var(--error); 
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
}
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; margin-top: 1rem; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn:active { transform: scale(0.98); }

/* Forms */
.form-group { margin-bottom: 1.25rem; }
.form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); font-size: 0.875rem; }
.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.875rem;
    transition: var(--transition);
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Tables */
.table-container { 
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--card);
    overflow: hidden;
}

.table-container.desktop-table {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

table { 
    width: 100%; 
    border-collapse: collapse; 
    min-width: 600px;
}
th { 
    background: var(--bg-tertiary); 
    padding: 0.625rem 0.75rem; 
    text-align: left; 
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}
td { 
    padding: 0.625rem 0.75rem; 
    border-bottom: 1px solid var(--border); 
    color: var(--text-secondary);
    font-size: 0.8125rem;
    word-break: break-word;
    white-space: normal;
}
tr:last-child td { border-bottom: none; }
tr:hover { background: var(--card-hover); }

/* Mobile Card-Based Table Layout */
.mobile-data-list {
    display: none;
}

@media (min-width: 769px) {
    .mobile-data-list {
        display: none !important;
    }
    
    .table-container.desktop-table {
        display: block !important;
    }
}

.mobile-data-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.875rem;
    margin-bottom: 0.75rem;
    transition: var(--transition);
}

.mobile-data-item:hover {
    background: var(--card-hover);
    border-color: var(--primary);
}

.mobile-data-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.625rem;
}

.mobile-data-url {
    flex: 1;
    font-weight: 600;
    color: var(--text);
    font-size: 0.875rem;
    line-height: 1.4;
    word-break: break-all;
    overflow-wrap: break-word;
    min-width: 0;
}

.mobile-data-reward {
    flex-shrink: 0;
    font-size: 1rem;
    font-weight: 700;
    color: var(--success) !important;
    white-space: nowrap;
}

.mobile-data-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.mobile-data-meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.mobile-data-meta-item i {
    font-size: 0.875rem;
    color: var(--text-tertiary);
}

/* Cancel Task Button - Square with icon top, text bottom */
.cancel-task-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    width: 64px;
    height: 64px;
    padding: 0.5rem;
    background: transparent;
    border: 1.5px solid var(--error);
    border-radius: var(--radius);
    color: var(--error);
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
}

.cancel-task-btn i {
    font-size: 1.25rem;
}

.cancel-task-btn span {
    font-size: 0.6875rem;
    font-weight: 600;
    line-height: 1;
}

.cancel-task-btn:hover {
    background: var(--error);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
}

/* Instructions Container */
.instructions-container {
    background: var(--bg-tertiary);
    padding: 1rem;
    border-radius: var(--radius-lg);
    text-align: left;
}

.instructions-title {
    margin-bottom: 0.875rem;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text);
}

.instructions-list {
    padding-left: 1.25rem;
    line-height: 1.7;
    font-size: 1rem;
    color: var(--text-secondary);
    margin: 0;
}

.instructions-list li {
    margin-bottom: 0.75rem;
}

.instructions-list li:last-child {
    margin-bottom: 0;
}

.instructions-list strong {
    color: var(--text);
    font-weight: 600;
}

.search-query-box {
    background: var(--bg);
    padding: 0.625rem;
    border-radius: var(--radius);
    margin: 0.5rem 0;
    font-family: monospace;
    font-size: 1rem;
    user-select: all;
    word-break: break-all;
    border: 1px solid var(--border);
    color: var(--text);
    line-height: 1.4;
}

@media (max-width: 768px) {
    .instructions-container {
        padding: 0.875rem;
    }
    
    .instructions-title {
        font-size: 0.8125rem;
        margin-bottom: 0.75rem;
    }
    
    .instructions-list {
        padding-left: 1rem;
        font-size: 0.87rem;
        line-height: 1.6;
    }
    
    .instructions-list li {
        margin-bottom: 0.625rem;
    }
    
    .search-query-box {
        padding: 0.5rem;
        font-size: 0.75rem;
        margin: 0.375rem 0;
    }
    
    .card-header {
        flex-wrap: wrap;
    }
    
    .cancel-task-btn {
        width: 56px;
        height: 56px;
    }
}

/* Tabs */
.tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.25rem;
}

.tab {
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: var(--transition);
}

.tab:hover {
    color: var(--text);
}

.tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    flex-wrap: wrap;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    width: 100%;
}

.pagination-btn {
    padding: 0.4rem 0.7rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.8125rem;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-info {
    width: 100%;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.8125rem;
    margin-top: 0.75rem;
    order: 2;
}

/* Modal */
.modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    background: rgba(0, 0, 0, 0.6); 
    z-index: 1000; 
    animation: fadeIn 0.2s; 
}
.modal-overlay.active { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
}
.modal { 
    background: var(--card); 
    border-radius: var(--radius-xl); 
    max-width: 90vw; 
    width: 500px; 
    max-height: 90vh; 
    overflow: hidden; 
    animation: slideUp 0.2s;
    border: 1px solid var(--border);
}
.modal-header { 
    padding: 1.25rem; 
    border-bottom: 1px solid var(--border); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
.modal-title { 
    font-size: 1.125rem; 
    font-weight: 600; 
    color: var(--text);
}
.modal-close { 
    background: transparent; 
    border: none; 
    color: var(--text-secondary); 
    font-size: 1.25rem; 
    cursor: pointer;
    transition: var(--transition);
    padding: 0.25rem;
}
.modal-close:hover {
    color: var(--text);
}
.modal-body { 
    padding: 1.25rem; 
    max-height: calc(90vh - 100px); 
    overflow-y: auto; 
}

/* Toast */
.toast { 
    position: fixed; 
    bottom: 1.5rem; 
    right: 1.5rem; 
    padding: 0.875rem 1.25rem; 
    background: var(--card); 
    border-radius: var(--radius-lg); 
    box-shadow: var(--shadow-lg); 
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    animation: slideInRight 0.2s; 
    z-index: 2000;
    font-size: 0.875rem;
}
.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--error); }
.toast.warning { border-left: 3px solid var(--warning); }
.toast.info { border-left: 3px solid var(--primary); }

/* Task Cards */
.task-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 1rem; 
}

.available-task-card { 
    background: var(--card); 
    border: 1px solid var(--border); 
    border-radius: var(--radius-lg); 
    padding: 1.25rem; 
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    min-height: 180px;
}

.available-task-card.active-task {
    cursor: pointer;
}

.available-task-card.active-task:hover { 
    box-shadow: var(--shadow-lg); 
    border-color: var(--primary);
}

.task-card-header { 
    margin-bottom: 1rem; 
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.task-url { 
    font-weight: 600; 
    color: var(--text);
    font-size: 0.875rem;
    line-height: 1.4;
    word-break: break-word;
    flex: 1;
    min-width: 0;
}

.task-priority-badge {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    border-radius: 99px;
    font-size: 0.6875rem;
    font-weight: 600;
    flex-shrink: 0;
    white-space: nowrap;
}

.task-priority-badge.high {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.task-priority-badge.medium {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.task-priority-badge.low {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

 { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 0.5rem; 
    margin-top: 0.75rem;
    margin-bottom: 1rem;
    max-height: 3.5em;
    overflow: hidden;
    position: relative;
}

.keyword-badge { 
    background: var(--bg-tertiary); 
    color: var(--text-secondary); 
    padding: 0.25rem 0.625rem; 
    border-radius: 99px; 
    font-size: 0.6875rem; 
}

.task-footer { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-top: auto;
    border-top: 1px solid var(--border); 
}

.task-credit { 
    font-size: 1.25rem; 
    font-weight: 700; 
    color: var(--success); 
}

.available-task-card.inactive-task { 
    opacity: 0.6; 
    cursor: not-allowed;
}

.inactive-task .task-footer { 
    position: relative; 
}

.inactive-overlay { 
    display: flex;
    flex-direction: column;
    align-items: flex-end; 
    justify-content: center; 
    text-align: right;
    gap: 0.25rem;
}

/* Badge */
.badge { 
    display: inline-block; 
    padding: 0.25rem 0.5rem; 
    border-radius: var(--radius-sm); 
    font-size: 0.75rem; 
    font-weight: 600; 
}
.badge-primary { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
.badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--error); }

/* Spinner */
.spinner { 
    width: 40px; 
    height: 40px; 
    border: 3px solid var(--border); 
    border-top-color: var(--primary); 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
}

/* Empty State */
.empty-state { 
    text-align: center; 
    padding: 3rem 1.5rem; 
}
.empty-state-icon { 
    font-size: 3rem; 
    color: var(--text-tertiary); 
    margin-bottom: 1rem; 
}
.empty-state-title { 
    font-size: 1.25rem; 
    font-weight: 600; 
    margin-bottom: 0.5rem;
    color: var(--text);
}
.empty-state-description { 
    color: var(--text-secondary); 
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
}

/* Mobile Bottom Navigation */
.mobile-nav { 
    display: none; 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    background: var(--card); 
    border-top: 1px solid var(--border); 
    z-index: 50; 
    padding: 0.5rem;
}
.mobile-nav-items { 
    display: flex; 
    justify-content: space-around; 
}
.mobile-nav-item { 
    display: flex; 
    align-items: center; 
    gap: 2rem; 
    padding: 1rem; 
    color: var(--text-secondary); 
    text-decoration: none; 
    font-size: 0.6875rem; 
    flex: 1;
    border-radius: var(--radius);
    transition: var(--transition);
}
.mobile-nav-item:active {
    transform: scale(0.95);
}
.mobile-nav-item.active { 
    color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}
.mobile-nav-item i { 
    font-size: 1.25rem; 
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar { 
        display: none; 
    }
    
    .mobile-nav { 
        display: block; 
    }
    
    .main-content { 
        padding-bottom: 60px; 
    }
    
    .header { 
        padding: 0.75rem 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-left h2 {
        font-size: 1.125rem;
    }
    
    .user-menu-container {
        display: none !important;
    }
    
    .mobile-profile-menu {
        display: flex;
    }
    
    .stats-grid { 
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .stat-card {
        padding: 1rem;
        gap: 0.5rem;
    }
    
    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 0.875rem;
    }
    
    .stat-value {
        font-size: 1rem;
    }
    
    .stat-label {
        font-size: 0.625rem;
    }
    
    .task-grid { 
        grid-template-columns: 1fr; 
    }
    
    .content { 
        padding: 0.75rem; 
    }
    
    .task-grid {
        gap: 0.75rem;
    }
    
    .available-task-card {
        padding: 1rem;
        min-height: 160px;
        margin-bottom: 1rem;
    }
    
    .task-keywords {
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .cancel-task-btn {
        width: 56px;
        height: 56px;
    }
    
    .cancel-task-btn i {
        font-size: 1.125rem;
    }
    
    .cancel-task-btn span {
        font-size: 0.625rem;
    }
    
    .card-header {
        flex-wrap: nowrap;
    }
    
    .card-title {
        font-size: 0.875rem;
    }
    
    .pagination {
        margin-top: 1rem;
        padding: 0.75rem;
    }
    
    .modal { 
        width: 100%;
        max-width: 100%;
        margin: 0;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    
    .card-header {
        padding: 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .tab {
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
        white-space: nowrap;
    }
    
    /* Mobile Table Improvements - Hide desktop table, show mobile cards */
    .table-container.desktop-table {
        display: none;
    }
    
    .mobile-data-list {
        display: block;
    }
    
    .content {
        padding: 0.75rem;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 0.875rem;
    }
    
    .card-body {
        padding: 0.875rem;
    }
    
    .card-title {
        font-size: 0.9375rem;
    }
    
    .tabs {
        padding: 0 0.875rem;
    }
    
    .tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .tab i {
        font-size: 0.875rem;
    }
    
    .pagination {
        margin-top: 0.75rem;
        padding: 0.75rem 0.5rem;
        gap: 0;
    }
    
    .pagination-controls {
        width: 100%;
        justify-content: center;
        gap: 0.25rem;
        order: 1;
    }
    
    .pagination-btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        min-width: 36px;
    }
    
    .pagination-info {
        font-size: 0.6875rem;
        margin-top: 0.5rem;
        width: 100%;
        text-align: center;
        order: 2;
    }
    
    .content {
        padding-bottom: 5rem;
    }
}

/* Animations */
@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}

@keyframes slideUp { 
    from { 
        transform: translateY(20px); 
        opacity: 0; 
    } 
    to { 
        transform: translateY(0); 
        opacity: 1; 
    } 
}

@keyframes slideInRight { 
    from { 
        transform: translateX(100%); 
        opacity: 0;
    } 
    to { 
        transform: translateX(0);
        opacity: 1;
    } 
}

@keyframes spin { 
    to { transform: rotate(360deg); } 
}
</style>
</head>
<body data-theme="light">
<div class="dashboard-layout">
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="#" class="logo">
            <i class="ri-user-star-line"></i>
            <span>SEOTIZE Partner</span>
        </a>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <a href="#" class="nav-item active" data-page="dashboard">
                <i class="ri-dashboard-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-page="balance">
                <i class="ri-wallet-3-line"></i>
                <span>Balance & Withdraw</span>
            </a>
        </div>
    </nav>
</aside>

<nav class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-items">
        <a href="#" class="mobile-nav-item active" data-page="dashboard">
            <i class="ri-dashboard-line"></i>
            <span>Dashboard</span>
        </a>
        <a href="#" class="mobile-nav-item" data-page="balance">
            <i class="ri-wallet-3-line"></i>
            <span>Balance</span>
        </a>
    </div>
</nav>

<main class="main-content">
    <header class="header">
        <div class="header-left">
            <h2>Partner Dashboard</h2>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="ri-moon-line" id="themeIcon"></i>
            </button>

            <button class="mobile-profile-menu" onclick="toggleMobileProfileDropdown(event)">
                <div class="user-avatar" id="mobileUserAvatar">P</div>
            </button>

            <div id="mobileProfileDropdown" class="mobile-profile-dropdown">
                <div style="padding: 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div class="user-avatar" style="width: 44px; height: 44px; font-size: 1.125rem;">
                            <span id="mobileDropdownUserInitial">P</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text); font-size: 0.875rem;" id="mobileDropdownUserName">Partner</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);" id="mobileDropdownUserEmail">partner@example.com</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.5rem 0;">
                    <a href="#" class="nav-item" onclick="logout(); closeMobileProfileDropdown()" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--error);">
                        <i class="ri-logout-box-line"></i>
                        <span>Sign Out</span>
                    </a>
                </div>
            </div>

            <div class="user-menu-container">
                <div class="user-menu" onclick="toggleUserDropdown()">
                    <div class="user-avatar"><span id="userInitial">P</span></div>
                    <div>
                        <div style="font-weight: 500; font-size: 0.8125rem;" id="userName">Partner</div>
                        <div style="font-size: 0.6875rem; color: var(--text-secondary);" id="userEmail">partner@example.com</div>
                    </div>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <a href="#" class="user-dropdown-item danger" onclick="logout()">
                        <i class="ri-logout-box-line"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="content" id="content">
        <!-- Content will be dynamically loaded here -->
    </div>
</main>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Modal Title</h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
function getBrowserData() {
    var userAgent = navigator.userAgent;
    var language = navigator.language;
    var platform = navigator.platform;
    var screenResolution = screen.width + 'x' + screen.height;
    var combinedData = `${userAgent}|${language}|${platform}|${screenResolution}`;
    return combinedData;
}

function hashData(data) {
    return CryptoJS.MD5(data).toString();
}

function getUniqueId() {
    var browserData = getBrowserData();
    return hashData(browserData);
}
    
// API Configuration
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token_partner') || localStorage.getItem('partnerAuthToken');

// Global State
let currentData = {
    user: null,
    tasks: [],
    balance: null
};

let paginationState = {
    tasks: { current: 1, page: 1, size: 12, total: 0, pages: 1, hasNext: false },
    done_tasks: { current: 1, page: 1, size: 7, total: 0, pages: 1, hasNext: false },
    withdrawals: { current: 1, page: 1, size: 10, total: 0, pages: 1, hasNext: false }
};

let countdownIntervals = {};
let paginationHandlers = {};
let incompleteTaskReloadInterval = null;
let dashboardDataReloadInterval = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        logout();
        return;
    }

    initializeEventListeners();
    loadPartnerDashboard();
    initializeTheme();
});

// Cleanup intervals on page unload
window.addEventListener('beforeunload', () => {
    if (incompleteTaskReloadInterval) {
        clearInterval(incompleteTaskReloadInterval);
    }
    if (dashboardDataReloadInterval) {
        clearInterval(dashboardDataReloadInterval);
    }
    clearCountdownIntervals();
});

// Event Listeners
function initializeEventListeners() {
    document.querySelectorAll('.sidebar .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => { 
            e.preventDefault(); 
            navigateTo(item.dataset.page); 
        });
    });
    
    document.querySelectorAll('.mobile-nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => { 
            e.preventDefault(); 
            navigateTo(item.dataset.page); 
        });
    });
    
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
    });
    
    document.addEventListener('click', (e) => {
        const container = document.querySelector('.user-menu-container');
        if (container && !container.contains(e.target)) {
            document.getElementById('userDropdown').classList.remove('active');
        }
        
        const mobileDropdown = document.getElementById('mobileProfileDropdown');
        const mobileButton = document.querySelector('.mobile-profile-menu');
        if (mobileDropdown && mobileButton && 
            !mobileDropdown.contains(e.target) && 
            !mobileButton.contains(e.target)) {
            closeMobileProfileDropdown();
        }
    });
}

function toggleUserDropdown() {
    document.getElementById('userDropdown').classList.toggle('active');
}

function toggleMobileProfileDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
        if (dropdown.classList.contains('active')) {
            const user = currentData.user;
            if (user) {
                const initial = (user.email || 'P').charAt(0).toUpperCase();
                document.getElementById('mobileDropdownUserInitial').textContent = initial;
                const nameEl = document.getElementById('mobileDropdownUserName');
                if (nameEl) nameEl.textContent = user.email.split('@')[0];
                document.getElementById('mobileDropdownUserEmail').textContent = user.email || '';
            }
        }
    }
}

function closeMobileProfileDropdown() {
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.remove('active');
    }
}

function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    document.getElementById('themeIcon').className = theme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
}

function navigateTo(page) {
    // Clear any existing intervals when navigating
    if (incompleteTaskReloadInterval) {
        clearInterval(incompleteTaskReloadInterval);
        incompleteTaskReloadInterval = null;
    }
    if (dashboardDataReloadInterval) {
        clearInterval(dashboardDataReloadInterval);
        dashboardDataReloadInterval = null;
    }
    
    document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
    document.querySelector(`.mobile-nav-item[data-page="${page}"]`)?.classList.add('active');

    switch(page) {
        case 'dashboard': loadPartnerDashboard(); break;
        case 'balance': loadBalanceManagement(); break;
    }
}

function updateUserInfo(user) {
    if (!user) return;
    const email = user.email;
    const initial = email[0].toUpperCase();
    const name = email.split('@')[0];
    
    document.getElementById('userInitial').textContent = initial;
    document.getElementById('userName').textContent = name;
    document.getElementById('userEmail').textContent = email;
    
    const mobileAvatar = document.getElementById('mobileUserAvatar');
    if (mobileAvatar) mobileAvatar.textContent = initial;
}

async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: { 
                'Session-Token': sessionToken, 
                'Content-Type': 'application/json', 
                ...(options.headers || {}) 
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        if (error.message) {
            throw error;
        }
        throw new Error('Network error: Failed to connect to server');
    }
}

function callPaginationHandler(handlerId, page) {
    if (paginationHandlers[handlerId]) {
        paginationHandlers[handlerId](page);
    }
}

// Helper function to safely extract pagination data
function getPaginationData(pagination, page = 1, fallbackTotal = 0) {
    if (pagination && pagination.tasks) {
        return {
            current: pagination.tasks.current || page,
            page: pagination.tasks.current || page,
            size: pagination.tasks.size || 12,
            total: pagination.tasks.total || fallbackTotal,
            pages: pagination.tasks.pages || 1,
            hasNext: pagination.tasks.has_next || false
        };
    }
    return {
        current: page,
        page: page,
        size: 12,
        total: fallbackTotal,
        pages: 1,
        hasNext: false
    };
}

async function loadPartnerDashboard(page = 1, showLoader = true) {
    try {
        if (showLoader) {
            showSpinner();
        }
        
        const response = await api(`/partner/dashboard?page=${page}&page_size=12`);
        
        if (!response || !response.data) {
            throw new Error('Invalid API response');
        }
        
        const { data, pagination } = response;
        
        // Update user info
        if (data.user) {
            currentData.user = data.user;
            updateUserInfo(data.user);
        }
        
        if (data.incomplete_task) {
            // Store pagination info for incomplete task view
            paginationState.tasks = getPaginationData(pagination, page, 0);
            renderIncompleteTaskView(data.tasks || data.incomplete_task);
        } else {
            // Clear incomplete task reload interval if switching to available tasks
            if (incompleteTaskReloadInterval) {
                clearInterval(incompleteTaskReloadInterval);
                incompleteTaskReloadInterval = null;
            }
            
            // Process tasks
            currentData.tasks = sortTasks(data.tasks || []);
            paginationState.tasks = getPaginationData(pagination, page, currentData.tasks.length);
            
            renderAvailableTasksView();
            
            // Set up 10-second data refresh for available tasks view (without full reload)
            if (dashboardDataReloadInterval) {
                clearInterval(dashboardDataReloadInterval);
            }
            
            // Use a flag to prevent multiple simultaneous requests
            let isRefreshing = false;
            
            dashboardDataReloadInterval = setInterval(async () => {
                // Prevent multiple simultaneous requests
                if (isRefreshing) {
                    return;
                }
                
                try {
                    isRefreshing = true;
                    const refreshResponse = await api(`/partner/dashboard?page=${paginationState.tasks.current}&page_size=12`);
                    
                    if (!refreshResponse || !refreshResponse.data) {
                        return; // Silently fail on refresh errors
                    }
                    
                    const { data: refreshData, pagination: refreshPagination } = refreshResponse;
                    
                    // Only update if we're still on the available tasks view
                    if (!refreshData.incomplete_task) {
                        if (refreshData.user) {
                            currentData.user = refreshData.user;
                            updateUserInfo(refreshData.user);
                        }
                        currentData.tasks = sortTasks(refreshData.tasks || []);
                        paginationState.tasks = getPaginationData(refreshPagination, paginationState.tasks.current, currentData.tasks.length);
                        
                        // Update the view without showing spinner
                        renderAvailableTasksView();
                    } else {
                        // Task became incomplete, reload properly
                        clearInterval(dashboardDataReloadInterval);
                        dashboardDataReloadInterval = null;
                        loadPartnerDashboard(1, true);
                    }
                } catch (error) {
                    console.error('Data refresh error:', error);
                    // Don't show error to user for background refresh failures
                } finally {
                    isRefreshing = false;
                }
            }, 60000); // 10 seconds
        }
    } catch (error) {
        console.error('Dashboard error:', error);
        showErrorState('Failed to load dashboard data: ' + (error.message || 'Unknown error'));
    }
}

function sortTasks(tasks) {
    return tasks.sort((a, b) => {
        const priorityDiff = (b.task_priority || 0) - (a.task_priority || 0);
        if (priorityDiff !== 0) return priorityDiff;
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
    });
}

function getPriorityLevel(priority) {
    if (priority >= 0.15) return { class: 'high', text: 'High Priority' };
    if (priority >= 0.12) return { class: 'medium', text: 'Medium' };
    return { class: 'low', text: 'Standard' };
}

function renderIncompleteTaskView(task) {
    // Clear any existing reload interval
    if (incompleteTaskReloadInterval) {
        clearInterval(incompleteTaskReloadInterval);
        incompleteTaskReloadInterval = null;
    }
    
    if (!task) {
        console.error('No task data provided to renderIncompleteTaskView');
        return;
    }
    
    const randomKeyword = (task.keywords && Array.isArray(task.keywords) && task.keywords.length > 0)
        ? task.keywords[Math.floor(Math.random() * task.keywords.length)]
        : '';

    const searchSite = (task.url || '').replace(/(^\w+:|^)\/\//, '').replace(/^www\./, '');
    const totalTasks = paginationState.tasks?.total || 0;

    document.getElementById('content').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"><i class="ri-wallet-3-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">$${(currentData.user?.credit || 0).toFixed(2)}</div>
                    <div class="stat-label">Current Credit</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><i class="ri-check-double-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">${totalTasks}</div>
                    <div class="stat-label">Tasks Available</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; gap: 0.75rem;">
                <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0; flex: 1;">
                    <i class="ri-information-line"></i> How to Complete Your Task
                </h3>
                <button class="cancel-task-btn" onclick="cancelInProgressTask('${task._id}')" title="Cancel Task">
                    <i class="ri-close-circle-line"></i>
                    <span>Cancel</span>
                </button>
            </div>
            <div class="card-body">
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    Follow these steps carefully to earn your reward.
                </p>

                <div class="instructions-container">
                    <h4 class="instructions-title">Your Instructions:</h4>
                    <ol class="instructions-list">
                        <li>On this <strong>same device</strong>, open a new browser tab and go to <strong>Google.com</strong>.</li>
                        <li>
                            Copy the text below and paste it into the Google search bar:
                            <div class="search-query-box">
                                site:${searchSite} ${randomKeyword}
                            </div>
                        </li>
                        <li>From the search results, find and click the link for <strong>${task.url}</strong>.</li>
                        <li>Wait for the website to fully load. A special popup will appear with further instructions.</li>
                        <li>Click on all the "coins" that appear on the page as directed by the popup.</li>
                        <li>Once all coins are collected, you will be <strong>automatically redirected back here</strong> to see your updated balance. âœ…</li>
                    </ol>
                </div>
            </div>
        </div>
    `;
    
    // Set up 10-second auto-reload for incomplete task
    // Use a flag to prevent multiple simultaneous requests
    let isIncompleteRefreshing = false;
    
    incompleteTaskReloadInterval = setInterval(async () => {
        // Prevent multiple simultaneous requests
        if (isIncompleteRefreshing) {
            return;
        }
        
        try {
            isIncompleteRefreshing = true;
            const response = await api(`/partner/dashboard?page=1&page_size=12`);
            
            if (!response || !response.data) {
                return; // Silently fail on refresh errors
            }
            
            const { data, pagination } = response;
            
            // If task is no longer incomplete, reload the dashboard
            if (!data.incomplete_task) {
                clearInterval(incompleteTaskReloadInterval);
                incompleteTaskReloadInterval = null;
                
                if (data.user) {
                    currentData.user = data.user;
                    updateUserInfo(data.user);
                }
                currentData.tasks = sortTasks(data.tasks || []);
                paginationState.tasks = getPaginationData(pagination, 1, currentData.tasks.length);
                renderAvailableTasksView();
            } else {
                // Just update the credit and tasks count if task is still incomplete
                if (data.user) {
                    currentData.user = data.user;
                    updateUserInfo(data.user);
                }
                
                // Update pagination state
                paginationState.tasks = getPaginationData(pagination, 1, paginationState.tasks.total);
                
                // Update credit display without full reload
                const statCards = document.querySelectorAll('.stat-value');
                if (statCards.length >= 2) {
                    statCards[0].textContent = `$${(currentData.user?.credit || 0).toFixed(2)}`;
                    statCards[1].textContent = `${paginationState.tasks.total || 0}`;
                }
            }
        } catch (error) {
            console.error('Auto-reload error:', error);
            // Don't show error to user for background refresh failures
        } finally {
            isIncompleteRefreshing = false;
        }
    }, 10000); // 10 seconds
}

function renderAvailableTasksView() {
    clearCountdownIntervals();
    const content = document.getElementById('content');
    
    const totalTasks = paginationState.tasks.total || 0;
    
    content.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"><i class="ri-wallet-3-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">$${(currentData.user?.credit || 0).toFixed(2)}</div>
                    <div class="stat-label">Current Credit</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><i class="ri-check-double-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">${totalTasks}</div>
                    <div class="stat-label">Tasks Available</div>
                </div>
            </div>
        </div>
        <div class="task-grid">
            ${currentData.tasks.length > 0 ? currentData.tasks.map(renderTaskCard).join('') : `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon"><i class="ri-task-line"></i></div>
                    <div class="empty-state-title">No Tasks Available</div>
                    <div class="empty-state-description">Check back later for more opportunities to earn.</div>
                </div>
            `}
        </div>
        ${generatePagination('tasks', (page) => loadPartnerDashboard(page, true))}
    `;

    currentData.tasks.forEach(task => {
        if (!task.active) {
            startCountdown(task._id, task.remaining_time);
        }
    });
}

function renderTaskCard(task) {
    const credit = task.task_priority || 0;
    const isActive = task.active;
    const priority = getPriorityLevel(credit);
    
    return `
        <div class="available-task-card ${isActive ? 'active-task' : 'inactive-task'}" ${isActive ? `onclick="initiateTask('${task._id}')"` : ''}>
            <div class="task-card-header">
                <div class="task-url">${task.url}</div>
                <span class="task-priority-badge ${priority.class}">${priority.text}</span>
            </div>
            <div class="task-keywords">
                ${(task.keywords || []).slice(0, 5).map(kw => `<span class="keyword-badge">${kw}</span>`).join('')}
                ${(task.keywords || []).length > 5 ? `<span class="keyword-badge">+${(task.keywords || []).length - 5} more</span>` : ''}
            </div>
            <div class="task-footer">
                <div>
                    <span style="font-size: 0.6875rem; color: var(--text-secondary);">Reward</span>
                    <div class="task-credit" style="color: var(--success);">$${credit.toFixed(2)}</div>
                </div>
                ${isActive ? `
                    <button class="btn btn-primary btn-sm">Start Task <i class="ri-arrow-right-s-line"></i></button>
                ` : `
                    <div class="inactive-overlay">
                        <div id="countdown-${task._id}" style="font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); white-space: nowrap;">Available in ${task.remaining_time}m</div>
                        <small style="color: var(--text-tertiary); font-size: 0.625rem;">45 min cooldown</small>
                    </div>
                `}
            </div>
        </div>
    `;
}

async function initiateTask(userTaskId) {
    try {
        const uniqueId = getUniqueId();
        await api('/allocate-partner-task', {
            method: 'POST',
            body: JSON.stringify({ user_task_id: userTaskId, unique_id: uniqueId })
        });
        showToast('Task accepted! Please complete it.', 'success');
        loadPartnerDashboard();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function cancelInProgressTask(partnerTaskId) {
    if (!confirm('Are you sure? Any progress will be lost.')) return;
    try {
        await api('/cancel-task', {
            method: 'POST',
            body: JSON.stringify({ task_id: partnerTaskId })
        });
        showToast('Task cancelled.', 'info');
        loadPartnerDashboard();
    } catch (error) {
        showToast('Failed to cancel task: ' + error.message, 'error');
    }
}

async function loadBalanceManagement(doneTasksPage = 1, withdrawalsPage = 1) {
    try {
        showSpinner();
        const response = await api(`/partner/balance-management?done_tasks_page=${doneTasksPage}&done_tasks_page_size=7&withdrawal_page=${withdrawalsPage}&withdrawal_page_size=10`);
        
        const { data, pagination } = response;
        currentData.balance = data;
        
        paginationState.done_tasks = {
            current: pagination.done_tasks?.current || doneTasksPage,
            page: pagination.done_tasks?.current || doneTasksPage,
            size: pagination.done_tasks?.size || 7,
            total: pagination.done_tasks?.total || 0,
            pages: pagination.done_tasks?.pages || 1,
            hasNext: pagination.done_tasks?.has_next || false
        };
        
        paginationState.withdrawals = {
            current: pagination.withdrawals?.current || withdrawalsPage,
            page: pagination.withdrawals?.current || withdrawalsPage,
            size: pagination.withdrawals?.size || 10,
            total: pagination.withdrawals?.total || 0,
            pages: pagination.withdrawals?.pages || 1,
            hasNext: pagination.withdrawals?.has_next || false
        };

        renderBalanceView();
    } catch (error) {
        console.error('Balance error:', error);
        showErrorState('Failed to load balance information: ' + error.message);
    }
}

function renderBalanceView() {
    const data = currentData.balance;
    
    document.getElementById('content').innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
            <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">Balance & Withdrawals</h2>
            <button class="btn btn-primary btn-sm" onclick="showWithdrawalModal()">
                <i class="ri-send-plane-line"></i> Withdraw
            </button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"><i class="ri-wallet-3-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">$${(data.balance || 0).toFixed(2)}</div>
                    <div class="stat-label">Available</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><i class="ri-line-chart-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">$${(data.total_earn || 0).toFixed(2)}</div>
                    <div class="stat-label">Total Earned</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning"><i class="ri-task-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value">${data.number_of_done_tasks || 0}</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('earnings')">
                    <i class="ri-money-dollar-circle-line"></i> Earnings
                </button>
                <button class="tab" onclick="switchTab('withdrawals')">
                    <i class="ri-exchange-line"></i> Withdrawals
                </button>
            </div>
            
            <div id="earnings-tab" class="tab-content active">
                <div class="card-body" style="padding-top: 0;">
                    <!-- Desktop Table -->
                    <div class="table-container desktop-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Country</th>
                                    <th>Reward</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(data.done_tasks_details || []).length > 0 ? data.done_tasks_details.map(t => `
                                    <tr>
                                        <td style="white-space: nowrap; min-width: 100px;">${new Date(t.time).toLocaleDateString()}<br><span style="font-size: 0.75rem; color: var(--text-tertiary);">${new Date(t.time).toLocaleTimeString()}</span></td>
                                        <td style="max-width: 300px; word-break: break-word; overflow-wrap: break-word; hyphens: auto;">${t.url}</td>
                                        <td style="white-space: nowrap;">${t.country_code}</td>
                                        <td style="white-space: nowrap;"><span class="badge badge-success">$${(t.credit || 0).toFixed(2)}</span></td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 2rem;">
                                            <div style="color: var(--text-tertiary);">
                                                <i class="ri-file-list-line" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                                No earning history yet
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card List -->
                    <div class="mobile-data-list">
                        ${(data.done_tasks_details || []).length > 0 ? data.done_tasks_details.map(t => {
                            const date = new Date(t.time);
                            return `
                            <div class="mobile-data-item">
                                <div class="mobile-data-item-header">
                                    <div class="mobile-data-url">${t.url}</div>
                                    <div class="mobile-data-reward">$${(t.credit || 0).toFixed(2)}</div>
                                </div>
                                <div class="mobile-data-meta">
                                    <div class="mobile-data-meta-item">
                                        <i class="ri-calendar-line"></i>
                                        <span>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    <div class="mobile-data-meta-item">
                                        <i class="ri-map-pin-line"></i>
                                        <span>${t.country_code}</span>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('') : `
                            <div style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
                                <i class="ri-file-list-line" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                No earning history yet
                            </div>
                        `}
                    </div>
                    
                    ${generatePagination('done_tasks', (page) => loadBalanceManagement(page, paginationState.withdrawals.current))}
                </div>
            </div>
            
            <div id="withdrawals-tab" class="tab-content">
                <div class="card-body" style="padding-top: 0;">
                    <!-- Desktop Table -->
                    <div class="table-container desktop-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Address</th>
                                    <th>Status</th>
                                    <th>Transaction</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(data.withdrawals_details || []).length > 0 ? data.withdrawals_details.map(w => {
                                    const status = w.status || 'Unknown';
                                    let badgeClass = 'warning';
                                    if (status.toLowerCase() === 'complete') badgeClass = 'success';
                                    if (['failed', 'rejected'].includes(status.toLowerCase())) badgeClass = 'danger';
                                    
                                    return `
                                    <tr>
                                        <td style="white-space: nowrap; min-width: 100px;">${new Date(w.date).toLocaleDateString()}<br><span style="font-size: 0.75rem; color: var(--text-tertiary);">${new Date(w.date).toLocaleTimeString()}</span></td>
                                        <td style="font-weight: 600; white-space: nowrap;">$${(w.amount || 0).toFixed(2)}</td>
                                        <td style="font-family: monospace; font-size: 0.75rem; word-break: break-all; overflow-wrap: break-word; max-width: 200px;">${w.address.substring(0, 10)}...${w.address.substring(w.address.length - 10)}</td>
                                        <td style="white-space: nowrap;"><span class="badge badge-${badgeClass}">${status}</span></td>
                                        <td style="font-family: monospace; font-size: 0.75rem; word-break: break-all; overflow-wrap: break-word;">
                                            ${w.txID ? `
                                                <a href="https://bscscan.com/tx/${w.txID}" target="_blank" style="color: var(--primary); text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                                    ${w.txID.substring(0,10)}...
                                                    <i class="ri-external-link-line"></i>
                                                </a>
                                            ` : 'Pending'}
                                        </td>
                                    </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 2rem;">
                                            <div style="color: var(--text-tertiary);">
                                                <i class="ri-exchange-line" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                                No withdrawal history
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card List -->
                    <div class="mobile-data-list">
                        ${(data.withdrawals_details || []).length > 0 ? data.withdrawals_details.map(w => {
                            const status = w.status || 'Unknown';
                            let badgeClass = 'warning';
                            if (status.toLowerCase() === 'complete') badgeClass = 'success';
                            if (['failed', 'rejected'].includes(status.toLowerCase())) badgeClass = 'danger';
                            const date = new Date(w.date);
                            
                            return `
                            <div class="mobile-data-item">
                                <div class="mobile-data-item-header">
                                    <div class="mobile-data-url">$${(w.amount || 0).toFixed(2)}</div>
                                    <span class="badge badge-${badgeClass}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${status}</span>
                                </div>
                                <div class="mobile-data-meta">
                                    <div class="mobile-data-meta-item">
                                        <i class="ri-calendar-line"></i>
                                        <span>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    <div class="mobile-data-meta-item" style="flex: 1; min-width: 0;">
                                        <i class="ri-wallet-line"></i>
                                        <span style="font-family: monospace; font-size: 0.7rem; word-break: break-all;">${w.address}</span>
                                    </div>
                                </div>
                                ${w.txID ? `
                                    <a href="https://bscscan.com/tx/${w.txID}" target="_blank" style="display: inline-flex; align-items: center; gap: 0.375rem; margin-top: 0.5rem; padding: 0.375rem 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--primary); text-decoration: none; font-size: 0.75rem;">
                                        <i class="ri-external-link-line"></i>
                                        <span>View Transaction</span>
                                    </a>
                                ` : `
                                    <div style="margin-top: 0.5rem; padding: 0.375rem 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 0.75rem; text-align: center;">
                                        Transaction Pending
                                    </div>
                                `}
                            </div>
                            `;
                        }).join('') : `
                            <div style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
                                <i class="ri-exchange-line" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                No withdrawal history
                            </div>
                        `}
                    </div>
                    
                    ${generatePagination('withdrawals', (page) => loadBalanceManagement(paginationState.done_tasks.current, page))}
                </div>
            </div>
        </div>
    `;
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

function showWithdrawalModal() {
    const balance = currentData.balance?.balance || 0;
    const minWithdrawal = 10;
    const fee = 1;

    showModal('Withdraw Funds', `
        <form id="withdrawForm">
            <div class="form-group">
                <label class="form-label">Available Balance</label>
                <input type="text" class="form-input" value="$${balance.toFixed(2)}" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Withdrawal Amount ($)</label>
                <input type="number" class="form-input" id="withdrawAmount" name="amount" required min="${minWithdrawal}" max="${balance}" step="0.01" placeholder="Enter amount">
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; font-size: 0.8125rem;">
                    Minimum withdrawal: $${minWithdrawal.toFixed(2)}
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">USDT (BEP20) Address</label>
                <input type="text" class="form-input" name="address" required placeholder="0x...">
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; font-size: 0.8125rem;">
                    Make sure this is a valid BEP20 (BSC) address
                </small>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); font-size: 0.875rem; margin-bottom: 1.25rem;">
                <div style="display:flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Amount:</span> 
                    <span id="summaryAmount" style="font-weight: 600;">$0.00</span>
                </div>
                <div style="display:flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Network Fee:</span> 
                    <span style="color: var(--error);">-$${fee.toFixed(2)}</span>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 0.625rem 0;">
                <div style="display:flex; justify-content: space-between; font-weight: 700;">
                    <span>You Receive:</span> 
                    <span id="summaryNet" style="color: var(--success);">$0.00</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 0.75rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 2;">
                    <i class="ri-send-plane-line"></i> Request Withdrawal
                </button>
            </div>
        </form>
    `);
    
    document.getElementById('withdrawAmount').addEventListener('input', (e) => {
        const amount = parseFloat(e.target.value) || 0;
        document.getElementById('summaryAmount').textContent = `$${amount.toFixed(2)}`;
        document.getElementById('summaryNet').textContent = `$${Math.max(0, amount - fee).toFixed(2)}`;
    });

    document.getElementById('withdrawForm').addEventListener('submit', handleWithdrawal);
}

async function handleWithdrawal(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const amount = parseFloat(formData.get('amount'));
    const address = formData.get('address').trim();

    if (amount > (currentData.balance?.balance || 0)) {
        return showToast('Amount exceeds balance.', 'error');
    }
    if (amount < 10) {
        return showToast('Minimum withdrawal is $10.', 'error');
    }
    if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
        return showToast('Invalid BEP20 address format.', 'error');
    }

    try {
        await api('/partner/withdraw', { 
            method: 'POST', 
            body: JSON.stringify({ amount, address }) 
        });
        showToast('Withdrawal request submitted successfully!', 'success');
        closeModal();
        loadBalanceManagement();
    } catch (error) {
        showToast(`Withdrawal failed: ${error.message}`, 'error');
    }
}

function startCountdown(taskId, minutes) {
    const endTime = new Date().getTime() + minutes * 60 * 1000;
    const el = document.getElementById(`countdown-${taskId}`);
    if (!el) return;

    // Clear any existing interval for this task
    if (countdownIntervals[taskId]) {
        clearInterval(countdownIntervals[taskId]);
    }

    countdownIntervals[taskId] = setInterval(() => {
        const now = new Date().getTime();
        const distance = endTime - now;
        const minsLeft = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const secsLeft = Math.floor((distance % (1000 * 60)) / 1000);
        
        if (distance < 0) {
            clearInterval(countdownIntervals[taskId]);
            delete countdownIntervals[taskId];
            // Only reload if we're still on the dashboard page
            if (document.querySelector('.nav-item[data-page="dashboard"].active')) {
                loadPartnerDashboard(paginationState.tasks.current, true);
            }
        } else {
            if (el) {
                el.textContent = `Available in ${minsLeft}m ${secsLeft}s`;
            }
        }
    }, 1000);
}

function clearCountdownIntervals() {
    Object.values(countdownIntervals).forEach(clearInterval);
    countdownIntervals = {};
}

function generatePagination(type, loadFunction) {
    const pagination = paginationState[type];
    
    if (!pagination || pagination.total <= pagination.size) {
        return '';
    }

    const handlerId = `${type}_${Date.now()}`;
    paginationHandlers[handlerId] = loadFunction;

    const totalPages = Math.max(1, pagination.pages || 1);
    const currentPage = pagination.current || 1;
    const startItem = Math.max(1, ((currentPage - 1) * pagination.size) + 1);
    const endItem = Math.min(currentPage * pagination.size, pagination.total);

    let paginationHTML = '<div class="pagination">';
    paginationHTML += '<div class="pagination-controls">';

    paginationHTML += `<button class="pagination-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
    </button>`;

    if (totalPages <= 5) {
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="callPaginationHandler('${handlerId}', ${i})">${i}</button>`;
        }
    } else {
        if (currentPage > 2) {
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', 1)">1</button>`;
            if (currentPage > 3) {
                paginationHTML += '<span style="color: var(--text-tertiary);">...</span>';
            }
        }

        const startPage = Math.max(1, currentPage - 1);
        const endPage = Math.min(totalPages, currentPage + 1);

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="callPaginationHandler('${handlerId}', ${i})">${i}</button>`;
        }

        if (currentPage < totalPages - 1) {
            if (currentPage < totalPages - 2) {
                paginationHTML += '<span style="color: var(--text-tertiary);">...</span>';
            }
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', ${totalPages})">${totalPages}</button>`;
        }
    }

    paginationHTML += `<button class="pagination-btn" ${!pagination.hasNext ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
    </button>`;

    paginationHTML += '</div>';
    paginationHTML += `<div class="pagination-info">
        Page ${currentPage} of ${totalPages} | Showing ${startItem}-${endItem} of ${pagination.total}
    </div>`;

    paginationHTML += '</div>';
    return paginationHTML;
}

// Utility Functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="ri-${type === 'success' ? 'check' : type === 'error' ? 'close' : type === 'warning' ? 'alert' : 'information'}-circle-line"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function showSpinner() {
    document.getElementById('content').innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
            <div class="spinner"></div>
        </div>
    `;
}

function showErrorState(message) {
    document.getElementById('content').innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="ri-error-warning-line"></i></div>
            <div class="empty-state-title">Error</div>
            <div class="empty-state-description">${message}</div>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="ri-refresh-line"></i> Retry
            </button>
        </div>
    `;
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}

function showModal(title, content, width = '500px') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    const modal = document.querySelector('.modal');
    modal.style.width = width;
    modal.style.maxWidth = '95vw';
    document.getElementById('modalOverlay').classList.add('active');
}

async function logout() {
    document.cookie = 'session_token_partner=;path=/;domain=.seotize.net;expires=Thu, 01 Jan 1970 00:00:00 GMT';
    localStorage.removeItem('partnerAuthToken');
    window.location.href = '/partner/login';
}
</script>
</body>
</html>
