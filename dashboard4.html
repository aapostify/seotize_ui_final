<!DOCTYPE html>
<!--
Dashboard v19 Changes:
1. Fixed mobile profile dropdown to match desktop functionality - Active Sessions now shows modal
2. Backend edit-article error fix required - see notes below

BACKEND FIX REQUIRED for /edit-article/<article_id> endpoint:
=============================================================
The error "User not found" with code 500 is caused by inconsistent error response formats.

ISSUES TO FIX:
1. Inconsistent error response formats:
   - Current mixed formats: 
     {"status": "error", "code": 401, "data": {"message": "..."}}
     {"status": "error", "error": {"code": 500, "message": "..."}}
   - Should be standardized to: {"status": "error", "error": {"code": xxx, "message": "..."}}

2. Missing session token validation before database query
3. No error handling for database update failures  
4. Inconsistent error codes and messages

FIXES NEEDED:
- Line where user lookup happens: Add check if session_token is empty before query
- All error returns: Change format from "code" and "data" to use "error" object
- Add try-catch around articles.update_one() with proper error handling
- Check result.modified_count after update to ensure it succeeded
- Standardize all error responses to use: {"status": "error", "error": {"code": xxx, "message": "..."}}

Previous Dashboard v18 Changes:
1. Fixed dark/light mode for all modals (article details, edit, payment details)
2. Optimized mobile version - proper sizing, no scrolling in details modals
3. Improved billing design with full API data (amount, currency, dates, invoice, transaction, task_id, etc.)
4. Added Stripe checkout link integration for transaction IDs
5. Added mobile profile icon menu for logout and active sessions next to theme toggle
6. Enhanced "Upgrade Hosting Plan" section with better package selection UI
7. Better mobile responsive design for all sections
8. Improved SweetAlert2 modal theming for dark/light modes
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEOTIZE Dashboard - Mobile Optimized v18</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turnstile@0/turnstile.min.js" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
/* CSS Variables */
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #10b981;
    --secondary-dark: #059669;
    --accent: #f59e0b;
    --error: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    --info: #3b82f6;

    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-accent: linear-gradient(135deg, #fa709a 0%, #fee140 100%);

    --radius-sm: 8px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Light Theme */
[data-theme="light"] {
    --bg: #f8f9fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e9ecef;
    --sidebar: #ffffff;
    --card: #ffffff;
    --card-hover: #f8f9fa;
    --text: #212529;
    --text-secondary: #6c757d;
    --text-tertiary: #adb5bd;
    --border: #dee2e6;
    --input-bg: #ffffff;
    --overlay: rgba(255, 255, 255, 0.95);
    --glass: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(0, 0, 0, 0.1);
}

/* Dark Theme */
[data-theme="dark"] {
    --bg: #0a0a0a;
    --bg-secondary: #1a1a1a;
    --bg-tertiary: #2a2a2a;
    --sidebar: #141414;
    --card: #1f1f1f;
    --card-hover: #2a2a2a;
    --text: #ffffff;
    --text-secondary: #a0a0a0;
    --text-tertiary: #6b6b6b;
    --border: rgba(255, 255, 255, 0.1);
    --input-bg: #1a1a1a;
    --overlay: rgba(0, 0, 0, 0.95);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
}

/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: var(--transition);
    line-height: 1.6;
    overflow-x: hidden;
}

/* Layout */
.dashboard-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: var(--transition);
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
    text-decoration: none;
}
.logox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
    text-decoration: none;
}
.sidebar-nav {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 1.5rem;
}

.nav-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    padding: 0 0.75rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius);
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
    margin-bottom: 0.25rem;
}

.nav-item:hover {
    background: var(--card);
    color: var(--text);
}

.nav-item.active {
    background: var(--primary);
    color: white;
}

.nav-item i {
    font-size: 1.25rem;
    width: 1.5rem;
    text-align: center;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-bar {
    position: relative;
    width: 300px;
}

.search-bar input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.875rem;
    transition: var(--transition);
}

.search-bar input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-bar i {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.theme-toggle {
    padding: 0.5rem;
    border-radius: var(--radius);
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 1.25rem;
    transition: var(--transition);
}

.theme-toggle:hover {
    background: var(--card);
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    background: var(--card);
    cursor: pointer;
    transition: var(--transition);
}

.user-menu:hover {
    background: var(--card-hover);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

/* Content Area */
.content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
}

/* Cards */
.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.card-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
}

.card-body {
    padding: 1.25rem;
}

/* Improved Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.25rem;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.stat-icon.primary {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.stat-icon.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.stat-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.stat-icon.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.stat-content {
    flex: 1;
    min-width: 0;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* Buttons */
.btn {
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius);
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text);
}

.btn-secondary:hover {
    background: var(--card);
}

.btn-danger {
    background: var(--error);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
}

/* Forms */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.875rem;
    transition: var(--transition);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

/* Tables */
.table-container {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: var(--bg-tertiary);
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text);
    border-bottom: 1px solid var(--border);
}

td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

tr:hover {
    background: var(--card-hover);
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 2rem;
    padding: 1rem;
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.875rem;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-info {
    margin: 0 1rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    animation: fadeIn 0.3s;
}

.modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal {
    background: var(--card);
    border-radius: var(--radius-xl);
    max-width: 90vw;
    width: 900px;
    max-height: 90vh;
    overflow: hidden;
    animation: slideUp 0.3s;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    transition: var(--transition);
}

.modal-close:hover {
    color: var(--text);
}

.modal-body {
    padding: 1.5rem;
    max-height: calc(90vh - 140px);
    overflow-y: auto;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideInRight 0.3s;
    z-index: 2000;
}

.toast.success {
    border-left: 4px solid var(--success);
}

.toast.error {
    border-left: 4px solid var(--error);
}

.toast.warning {
    border-left: 4px solid var(--warning);
}

.toast.info {
    border-left: 4px solid var(--info);
}

/* Charts */
/* Enhanced Chart Container */
.chart-container {
    position: relative;
    height: 280px !important;
    width: 100%;
    overflow: hidden;
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
}

/* Map Container Fixed Size */
.map-container {
    height: 280px !important;
    width: 100%;
    border-radius: var(--radius);f
    overflow: hidden;
    border: 1px solid var(--border);
}

/* Custom Leaflet Styles */
.leaflet-container {
    background: var(--bg-tertiary) !important;
}

.leaflet-tile-pane {
    filter: var(--map-filter, none);
}

[data-theme="dark"] .leaflet-tile-pane {
    --map-filter: hue-rotate(180deg) invert(100%) brightness(70%) contrast(120%);
}

/* Task Cards */
.task-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1.5rem;
}

.task-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    padding: 1.25rem;
    transition: var(--transition);
    cursor: pointer;
}

.task-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.task-url {
    font-weight: 600;
    color: var(--primary);
    text-decoration: none;
    word-break: break-all;
    font-size: 12px;
}

.task-status {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.task-status.active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.task-status.paused {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.task-status.completed {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.task-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1rem 0;
}

.task-stat {
    display: flex;
    flex-direction: column;
}

.task-stat-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-bottom: 0.25rem;
}

.task-stat-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
}

.task-progress {
    margin: 1rem 0;
}

.progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.3s ease;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* Enhanced Website Preview */
.website-preview {
    width: 100%;
    height: 450px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
}

.website-preview iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #fff;
}

.preview-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    background: rgba(0, 0, 0, 0.8);
    padding: 8px;
    border-radius: var(--radius);
    z-index: 10;
}

.preview-btn {
    padding: 4px 8px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: var(--transition);
}

.preview-btn:hover {
    background: var(--primary-dark);
}

/* XPath Marker */
.xpath-marker {
    position: absolute;
    width: 28px;
    height: 28px;
    background: var(--primary);
    color: white;
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    animation: pulse 2s infinite;
    transform: translate(-50%, -50%);
    z-index: 15;
}

/* Media Grid */
.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.media-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: var(--transition);
}

.media-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.media-preview {
    height: 140px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.media-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-info {
    padding: 1rem;
}

.media-filename {
    font-weight: 600;
    margin-bottom: 0.5rem;
    word-break: break-all;
    font-size: 0.875rem;
}

.media-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
}

.empty-state-icon {
    font-size: 4rem;
    color: var(--text-tertiary);
    margin-bottom: 1rem;
}

.empty-state-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.5rem;
}

.empty-state-description {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

/* Badge */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-primary {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.badge-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

/* Loading Spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Keyword suggestions */
.keyword-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.keyword-suggestion {
    padding: 0.375rem 0.75rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
}

.keyword-suggestion:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.keyword-suggestion.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Task creation steps */
.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

/* Priority selector */
.priority-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 0.5rem;
}

.priority-option {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.priority-option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.priority-option.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.priority-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.priority-price {
    color: var(--primary);
    font-weight: 700;
    font-size: 1.125rem;
}

.priority-locations {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

/* Mobile Bottom Navigation */
.mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-top: 1px solid var(--border);
    z-index: 50;
    padding: 0.5rem;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.75rem;
    transition: var(--transition);
    border-radius: var(--radius);
    flex: 1;
}

.mobile-nav-item:active {
    transform: scale(0.95);
}

.mobile-nav-item.active {
    color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.mobile-nav-item i {
    font-size: 1.25rem;
}

/* Mobile Menu Overlay */
.mobile-menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 998;
}

.mobile-menu-overlay.active {
    display: block;
}

.mobile-menu {
    position: fixed;
    top: 0;
    left: -100%;
    bottom: 0;
    width: 85%;
    max-width: 320px;
    background: var(--card);
    transition: left 0.3s ease;
    z-index: 999;
    overflow-y: auto;
}

.mobile-menu.active {
    left: 0;
}

.mobile-menu-header {
    padding: 1.5rem;
    background: var(--primary);
    color: white;
}

.mobile-menu-content {
    padding: 1rem;
}

/* Enhanced User Menu with Dropdown */
.user-menu-container {
    position: relative;
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 220px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    display: none;
    z-index: 1000;
}

.user-dropdown.active {
    display: block;
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--text);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
}

.user-dropdown-item:hover {
    background: var(--bg-tertiary);
}

.user-dropdown-item i {
    width: 1.25rem;
}

.user-dropdown-item.danger {
    color: var(--error);
}

/* Session Management Section */
.sessions-section {
    max-height: 300px;
    overflow-y: auto;
}

.session-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.875rem;
}

.session-item:last-child {
    border-bottom: none;
}

.session-info {
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 0.5rem;
}

.session-details {
    flex: 1;
}

.session-location {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.session-delete {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--error);
    cursor: pointer;
    font-size: 0.75rem;
    transition: var(--transition);
}

.session-delete:hover {
    background: var(--error);
    color: white;
    border-color: var(--error);
}

/* Mobile Search Overlay */
.mobile-search-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--card);
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    z-index: 1001;
}

.mobile-search-overlay.active {
    display: block;
}

.mobile-search-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 1rem;
}

.mobile-search-toggle {
    display: none;
}

/* Responsive Improvements */
@media (max-width: 768px) {
    /* Hide desktop sidebar */
    .sidebar {
        display: none;
    }

    /* Show mobile navigation */
    .mobile-nav {
        display: block;
    }

    /* Adjust main content for mobile nav */
    .main-content {
        padding-bottom: 60px;
    }

    /* Mobile header adjustments */
    .header {
        padding: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg-secondary);
    }

    .search-bar {
        display: none;
    }

    .mobile-search-toggle {
        display: block;
        padding: 0.5rem;
        background: transparent;
        border: none;
        color: var(--text);
        font-size: 1.25rem;
        cursor: pointer;
    }

    /* User dropdown mobile full width */
    .user-dropdown {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        min-width: 100%;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        max-height: 50vh;
        overflow-y: auto;
    }

    /* Hide user dropdown header on mobile */
    .user-dropdown-header {
        display: none;
    }

    /* Simplify user menu on mobile */
    .user-menu {
        padding: 0.5rem;
        gap: 0.5rem;
    }

    .user-menu > div {
        display: none;
    }

    .header-left {
        flex: 1;
    }

    .header-right {
        gap: 0.5rem;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .stat-card {
        padding: 0.875rem;
    }

    .stat-card .stat-value {
        font-size: 1.5rem;
    }

    .stat-card .stat-label {
        font-size: 0.75rem;
    }

    .task-grid {
        grid-template-columns: 1fr;
    }

    .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

    .search-bar {
        width: 200px;
    }

    .header {
        padding: 1rem;
    }

    .content {
        padding: 1rem;
    }

    .modal {
        width: 95%;
        max-height: 85vh;
    }

    .priority-options {
        grid-template-columns: 1fr;
    }

    .chart-container {
        height: 200px !important;
    }

    .map-container {
        height: 250px !important;
    }

    /* Stack analytics cards vertically on mobile */
    .analytics-grid,
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }

    /* Ensure cards don't get too small */
    .card {
        min-width: 100%;
    }

    /* Improve table responsiveness */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        min-width: 600px;
    }

    /* Adjust modal for mobile */
    .modal {
        width: 100%;
        max-width: 100%;
        margin: 0;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }

    .modal-body {
        max-height: calc(100vh - 60px);
    }
}

/* Extra small screens (phones in portrait) */
@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .stat-card {
        padding: 0.75rem;
    }

    .stat-card .stat-value {
        font-size: 1.25rem;
    }

    .stat-card .stat-label {
        font-size: 0.7rem;
    }

    .card-header {
        padding: 1rem;
    }

    .card-body {
        padding: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    .table-container {
        font-size: 0.8125rem;
    }

    th, td {
        padding: 0.5rem;
    }

    .media-grid {
        grid-template-columns: 1fr;
    }

    /* Ensure header stays visible */
    .header {
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 100;
        border-bottom: 1px solid var(--border);
    }

    /* Mobile nav adjustments */
    .mobile-nav-item span {
        font-size: 0.625rem;
    }

    .mobile-nav-item i {
        font-size: 1.125rem;
    }

    /* Hide less important elements on very small screens */
    .pagination-info {
        display: none;
    }

    /* Simplify user menu even more */
    .user-menu {
        background: transparent;
        padding: 0.375rem;
    }

    .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.875rem;
    }
}

.domain-actions {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-end;
}

.domain-actions .btn {
    white-space: nowrap;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
}

@media (max-width: 580px) {
    .mobilearticle1 {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 14px!important;
    }
    .mobilearticle2{
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 14px!important;
    }
    .domain-actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-start;
    }
    .logo {
        color: white !important;
    }
   
    .user-menu-container {
        display: none!important;
    }
}
    /* Desktop/Mobile visibility classes */
.desktop-only {
    display: block !important;
}

.mobile-only {
    display: none !important;
}

@media (max-width: 768px) {
    .desktop-only {
        display: none !important;
    }

    .mobile-only {
        display: block !important;
    }
}
div#modalBody {
    padding-bottom: 100px;
}

/* ADD THIS CSS to your main <style> block */

.swal2-popup.swal2-toast {
    box-shadow: var(--shadow-xl) !important;
    background: var(--card) !important;
}
.swal2-title {
    color: var(--text) !important;
}

/* Custom CSS for our new Image Details Modal */
.image-details-modal-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    text-align: left;
}
.image-details-modal-container .modal-header-section {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}
.image-details-modal-container .modal-preview-container {
    text-align: center;
}
.image-details-modal-container .modal-image-preview {
    max-width: 100%;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 2px solid var(--border);
    cursor: pointer;
}
.image-details-modal-container .modal-info-list {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.7;
}
.image-details-modal-container .modal-info-list strong {
    color: var(--text);
    font-weight: 600;
}
.image-details-modal-container .modal-info-list code {
    background: var(--bg-tertiary);
    padding: 0.2rem 0.4rem;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    word-break: break-all;
}
.image-details-modal-container .modal-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.image-details-modal-container .modal-stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}
.image-details-modal-container .modal-chart-container {
    height: 250px;
    background: var(--card);
    padding: 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}
.image-details-modal-container .analytics-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
}

@media (min-width: 769px) {
    .image-details-modal-container .modal-header-section {
        grid-template-columns: 300px 1fr; /* Two columns on desktop */
    }
}

.swal2-toast button:where(.swal2-close) {
    grid-column: 3 / 3;
    grid-row: 1 / 99;
    align-self: flex-start!important;
    margin: 0!important;
    font-size: 3em!important;
}

/* ADD THIS CSS to your main <style> block */

/* Custom CSS for the new Task Details Modal */
.task-details-modal-container {
    text-align: left;
}
.task-modal-header {
    background: var(--bg-tertiary);
    padding: 1.5rem;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    border-bottom: 1px solid var(--border);
}
.task-modal-header h3 {
    font-size: 1.25rem;
    margin: 0 0 0.5rem 0;
    word-break: break-all;
    color: var(--primary);
}
.task-modal-header .header-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1.5rem;
}
.task-modal-stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.task-modal-stat-card {
    background: var(--card);
    padding: 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    text-align: center;
}
.task-modal-stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}
.task-modal-stat-card .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}
.task-modal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}
.task-modal-section {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    padding: 1.25rem;
}
.task-modal-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.xpath-list {
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg-tertiary);
    border-radius: var(--radius);
    padding: 1rem;
}
.xpath-list code {
    display: block;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.75rem;
    line-height: 1.4;
    word-break: break-all;
}
.xpath-list code:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
.views-by-date-list {
    max-height: 280px;
    overflow-y: auto;
}
.views-by-date-list .list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
}
.views-by-date-list .list-item:nth-child(odd) {
    background: var(--bg-tertiary);
}

/* Mobile responsive styles for task details modal */
@media (max-width: 768px) {
    .task-modal-header h3 {
        font-size: 1rem !important;
        word-break: break-all;
        line-height: 1.3;
    }
    
    .task-modal-header .header-meta {
        font-size: 0.7rem !important;
        flex-direction: column;
        gap: 0.25rem !important;
    }
    
    .task-modal-stat-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
        margin-bottom: 1rem !important;
    }
    
    .task-modal-stat-card {
        padding: 0.75rem !important;
    }
    
    .task-modal-stat-card .stat-value {
        font-size: 1.25rem !important;
    }
    
    .task-modal-stat-card .stat-label {
        font-size: 0.7rem !important;
    }
    
    .task-modal-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    .task-modal-section {
        padding: 0.875rem !important;
    }
    
    .task-modal-section-title {
        font-size: 0.95rem !important;
        margin-bottom: 0.75rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    .task-modal-section canvas {
        max-height: 180px !important;
    }
    
    .views-by-date-list {
        max-height: 200px !important;
    }
    
    .views-by-date-list .list-item {
        padding: 0.5rem !important;
        font-size: 0.85rem;
    }
    
    .install-instructions {
        padding: 0.75rem !important;
        font-size: 0.8rem !important;
    }
    
    .install-instructions code {
        padding: 0.5rem !important;
        font-size: 0.7rem !important;
    }
    
    .copy-btn {
        padding: 0.35rem 0.6rem !important;
        font-size: 0.75rem !important;
    }
}
.task-modal-header {
    background: transparent!important;
}

/* ADD THIS CSS to your main <style> block */

/* Custom CSS for the new Recharge Modal */
.recharge-modal-container {
    text-align: left;
    padding-top: 1rem;
}
.recharge-modal-section {
    margin-bottom: 1.5rem;
}
.recharge-modal-label {
    display: block;
    margin-bottom: 0.75rem;
    font-weight: 600;
    color: var(--text);
    font-size: 1rem;
}
.recharge-preset-amounts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}
.recharge-preset-btn {
    padding: 0.75rem;
    font-size: 1rem;
    font-weight: 700;
    border: 2px solid var(--border);
    background: var(--card);
    color: var(--primary);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
}
.recharge-preset-btn:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}
.recharge-payment-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
.recharge-payment-option {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}
.recharge-payment-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}
.recharge-payment-option.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}
.recharge-payment-option i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: var(--primary);
}
.recharge-payment-option .provider-name {
    font-weight: 600;
    color: var(--text);
}
.recharge-summary {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-top: 1.5rem;
}
.recharge-summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.9rem;
}
    /* ADD THIS CSS to your main <style> block */

/* Custom width for the Recharge Task modal */
.swal2-popup.recharge-modal-custom {
    width: 95vw !important; /* Mobile-first: default width */
}

@media (min-width: 550px) { /* On screens wider than 550px... */
    .swal2-popup.recharge-modal-custom {
        width: 500px !important; /* ...lock the width to 500px */
    }
}
    .recharge-modal-custom > .swal2-actions > .swal2-cancel {
    background: #df0e0e;
}
@media (min-width: 550px) {
    .hidedesktop{
     display:none!important;
    }
    .mobile-profile-menu {
        display: none !important;
    }
}

/* Mobile Profile Menu Icon - Google Style */
.mobile-profile-menu {
    display: none;
    padding: 0;
    border-radius: 50%;
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 1.25rem;
    transition: var(--transition);
    position: relative;
}

.mobile-profile-menu:hover .user-avatar {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.mobile-profile-menu .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    transition: box-shadow 0.2s ease;
}

/* Google-style Profile Dropdown */
.mobile-profile-dropdown {
    display: none;
    position: fixed;
    top: 60px;
    right: 1rem;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 10001;
    overflow: hidden;
    animation: slideDown 0.2s ease;
    min-width: 280px;
}

.mobile-profile-dropdown.active {
    display: block;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 550px) {
    .mobile-profile-menu {
        display: flex;
    }
    .user-menu-container {
        display: none !important;
    }
}
@media (max-width: 600px){
    .stat-card > .stat-icon {
        display: none!important;
    }
}
.swal2-popup-custom-task {
    margin: 0 !important;
    padding: 0 !important;
}
/* ADD THIS CSS to your main <style> block */

/* Custom CSS for the new Active Sessions Modal */
.sessions-modal-custom {
    width: 95vw !important;
}
@media (min-width: 900px) {
    .sessions-modal-custom {
        width: 800px !important; /* Lock width on larger screens */
    }
}

.sessions-modal-container {
    text-align: left;
    font-size: 0.9rem;
}
.sessions-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 1.5rem 0 1rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.sessions-section-title:first-child {
    margin-top: 0;
}
.session-card {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-bottom: 1rem;
}
.session-card--current {
    border-left: 4px solid var(--success);
    background: rgba(16, 185, 129, 0.05);
}
.session-icon {
    font-size: 1.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}
.session-details {
    flex: 1;
}
.session-main-info {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.5rem;
}
.session-meta-info {
    font-size: 0.8rem;
    color: var(--text-secondary);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.session-actions {
    margin-left: auto;
}
.swal2-footer {
    border-top: 1px solid var(--border) !important;
    margin-top: 1.5rem !important;
    padding-top: 1.5rem !important;
}

/* Enhanced SweetAlert2 Dark/Light Mode Support */
.swal2-popup {
    background: var(--card) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
}

.swal2-title {
    color: var(--text) !important;
}

.swal2-html-container {
    color: var(--text) !important;
}

.swal2-html-container .card {
    background: var(--bg-tertiary) !important;
    border-color: var(--border) !important;
}

.swal2-html-container .card-header {
    border-bottom-color: var(--border) !important;
}

.swal2-html-container .card-title {
    color: var(--text) !important;
}

.swal2-html-container .form-label {
    color: var(--text) !important;
}

.swal2-html-container .form-input,
.swal2-html-container .form-select,
.swal2-html-container .form-textarea {
    background: var(--input-bg) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}

.swal2-html-container code {
    background: var(--bg-tertiary) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
}

.swal2-html-container .empty-state-title {
    color: var(--text) !important;
}

.swal2-html-container .empty-state-description {
    color: var(--text-secondary) !important;
}

/* Better mobile modal sizing - prevent overflow */
@media (max-width: 768px) {
    .swal2-popup {
        max-height: 85vh !important;
        width: 95vw !important;
        padding: 1rem !important;
        padding-top: 3rem !important;
    }
    
    .swal2-html-container {
        max-height: 60vh !important;
        overflow-y: auto !important;
        padding: 0.5rem !important;
        padding-bottom: 2rem !important;
    }
    
    /* Fix close button positioning on mobile for swal2-toast modals */
    .swal2-toast button:where(.swal2-close) {
        position: absolute !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
        grid-column: unset !important;
        grid-row: unset !important;
        font-size: 2em !important;
        z-index: 2 !important;
    }
    
    /* Move close button into html container on mobile */
    .swal2-html-container {
        position: relative !important;
    }
    
    .swal2-html-container button:where(.swal2-close) {
        position: absolute !important;
        top: -2.5rem !important;
        right: -0.5rem !important;
        z-index: 10 !important;
    }
    
    .swal2-html-container .card-body {
        padding: 0.75rem !important;
        max-height: none !important;
    }
    
    /* Fix AI Keywords button layout on mobile */
    #aiKeywordsBtn {
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
    }
    
    #aiKeywordsBtn i {
        margin-right: 0.25rem !important;
    }
    
    /* Improve budget input on mobile */
    #taskBudget {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        padding: 0.75rem 1rem 0.75rem 2.25rem !important;
    }
    
    /* Images grid - show 2 images per line on mobile */
    .card-body > div[style*="grid-template-columns"] {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem !important;
    }
    
    #current-images-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem !important;
    }
    
    /* Cancel Previous Tasks container on mobile */
    #cancelPreviousContainer {
        padding: 1rem !important;
        margin-bottom: 1rem !important;
    }
    
    #cancelPreviousContainer label {
        font-size: 0.85rem !important;
        line-height: 1.4 !important;
    }
    
    #previousTasksWarning {
        font-size: 0.8rem !important;
        padding: 0.65rem !important;
    }
    
    .swal2-html-container canvas {
        max-height: 200px !important;
    }
    
    /* Better chart display on mobile */
    .chart-container {
        height: 250px !important;
        margin-bottom: 1rem;
    }
    
    /* Improved stat cards on mobile */
    .stat-card .stat-value {
        font-size: 1.5rem !important;
    }
    
    .stat-card .stat-label {
        font-size: 0.75rem !important;
    }
    
    /* Better spacing for cards */
    .card {
        margin-bottom: 1rem;
    }
    
    /* Improved button sizing on mobile */
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* Better table display on mobile */
    .table-responsive {
        font-size: 0.8rem;
    }
    
    /* Modal analytics grid */
    .modal-analytics-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    /* Stat cards grid optimization */
    .stat-card-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }
    
    .swal2-title {
        font-size: 1.1rem !important;
        padding: 0.5rem 0 !important;
    }
    
    .swal2-actions {
        flex-wrap: wrap !important;
        gap: 0.5rem !important;
    }
    
    .swal2-actions button {
        font-size: 0.85rem !important;
        padding: 0.5rem 1rem !important;
        margin: 0 !important;
    }
}
</style>
</head>
<body data-theme="light">
<div class="dashboard-layout">
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<a href="#" class="logo">
<i class="ri-seo-line"></i>
<span>SEOTIZE</span>
</a>
</div>

<nav class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">Main</div>
<a href="#" class="nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>SEO Tasks</span>
</a>
</div>

<div class="nav-section">
<div class="nav-section-title">Hosting</div>
<a href="#" class="nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
</div>

<div class="nav-section">
<div class="nav-section-title">Account</div>
<a href="#" class="nav-item" data-page="billing">
<i class="ri-bank-card-line"></i>
<span>Billing</span>
</a>
<!-- Logout moved to user dropdown menu -->
</div>
</nav>
</aside>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
<div class="mobile-menu" id="mobileMenu">
<div class="mobile-menu-header">
<div style="display: flex; justify-content: space-between; align-items: center; padding: 0 1rem;">
    <div class="logo">
        <i class="ri-seo-line"></i>
        <span>SEOTIZE</span>
    </div>
    <button onclick="closeMobileMenu()" style="background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">
        <i class="ri-close-line"></i>
    </button>
</div>
</div>
<div class="mobile-menu-content">
    <!-- Profile Section -->
    <div style="padding: 1.5rem 1rem; background: var(--bg-tertiary); border-radius: var(--radius); margin: 0 1rem 1rem 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
            <div class="user-avatar" style="width: 50px; height: 50px; font-size: 1.5rem;">
                <span id="mobileMenuUserInitial">U</span>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 1.125rem; color: var(--text); margin-bottom: 0.25rem;" id="mobileMenuUserName">User</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);" id="mobileMenuUserEmail">user@example.com</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
            <div style="text-align: center;">
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);" id="mobileMenuTaskCount">0</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Tasks</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--secondary);" id="mobileMenuArticleCount">0</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Articles</div>
            </div>
        </div>
    </div>

    <!-- Account Section -->
    <div class="nav-section">
        <div class="nav-section-title">Account</div>
        <a href="#" class="nav-item" onclick="showSessionsModal(); closeMobileMenu();">
            <i class="ri-device-line"></i>
            <span>Active Sessions</span>
            <span class="badge badge-primary" id="sessionCountMobile"></span>
        </a>
        <a href="#" class="nav-item" data-page="profile" onclick="closeMobileMenu()">
            <i class="ri-user-line"></i>
            <span>Profile Settings</span>
        </a>
        <a href="#" class="nav-item" data-page="billing" onclick="closeMobileMenu()">
            <i class="ri-bank-card-line"></i>
            <span>Billing & Plans</span>
        </a>
    </div>
    
    <div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
    
    <!-- Logout Section -->
    <div class="nav-section">
        <a href="#" class="nav-item danger" style="color: var(--error);" onclick="logout()">
            <i class="ri-logout-box-line"></i>
            <span>Logout</span>
        </a>
    </div>
</div>
</div>

<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav" id="mobileNav">
<div class="mobile-nav-items">
<a href="#" class="mobile-nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="mobile-nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>Tasks</span>
</a>
<a href="#" class="mobile-nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="mobile-nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
<a href="#" class="mobile-nav-item" data-page="billing">
<i class="ri-bill-line"></i>
<span>Billing</span>
</a>
</div>
</nav>

<!-- Main Content -->
<main class="main-content">
<!-- Header -->
<header class="header">
<div class="header-left">
<a class="logox hidedesktop">
<i class="ri-seo-line"></i>
<span>SEOTIZE</span>
</a>
</div>

<div class="header-right">
<button class="theme-toggle" onclick="toggleTheme()">
<i class="ri-moon-line" id="themeIcon"></i>
</button>

<!-- Mobile Profile Menu Icon - Google Style -->
<button class="mobile-profile-menu" onclick="toggleMobileProfileDropdown(event)">
<div class="user-avatar" id="mobileUserAvatar">U</div>
</button>

<!-- Mobile Profile Dropdown (Google Style) -->
<div id="mobileProfileDropdown" class="mobile-profile-dropdown">
    <div style="padding: 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="user-avatar" style="width: 48px; height: 48px; font-size: 1.25rem;">
                <span id="mobileDropdownUserInitial">U</span>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text);" id="mobileDropdownUserName">User</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);" id="mobileDropdownUserEmail">user@example.com</div>
            </div>
        </div>
    </div>
    <div style="padding: 0.5rem 0;">
        <a href="#" class="nav-item" onclick="showSessionsModal(); closeMobileProfileDropdown()" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="ri-device-line"></i>
            <span>Active Sessions</span>
            <span class="badge badge-primary" id="mobileDropdownSessionCount" style="margin-left: auto;"></span>
        </a>
        <div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
        <a href="#" class="nav-item" onclick="logout(); closeMobileProfileDropdown()" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--error);">
            <i class="ri-logout-box-line"></i>
            <span>Sign Out</span>
        </a>
    </div>
</div>

<div class="user-menu-container">
<div class="user-menu" onclick="toggleUserDropdown()">
<div class="user-avatar">
<span id="userInitial">U</span>
</div>
<div>
<div style="font-weight: 500;" id="userName">User</div>
<div style="font-size: 0.75rem; color: var(--text-secondary);" id="userEmail">user@example.com</div>
</div>
</div>

<div class="user-dropdown" id="userDropdown">


<a href="#" class="user-dropdown-item" onclick="showSessionsModal()">
<i class="ri-device-line"></i>
<span>Active Sessions</span>
<span class="badge badge-primary" id="sessionCount"></span>
</a>

<div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>

<a href="#" class="user-dropdown-item danger" onclick="logout()">
<i class="ri-logout-box-line"></i>
<span>Logout</span>
</a>
</div>
</div>
</div>
</header>

<!-- Mobile Search Overlay -->
<div class="mobile-search-overlay" id="mobileSearchOverlay">
<div style="display: flex; gap: 0.5rem; align-items: center;">
<button onclick="toggleMobileSearch()" style="background: transparent; border: none; color: var(--text); font-size: 1.5rem; padding: 0.5rem;">
<i class="ri-arrow-left-line"></i>
</button>
<input type="text" class="mobile-search-input" placeholder="Search..." autofocus>
</div>
</div>

<!-- Content Area -->
<div class="content" id="content">
<!-- Dynamic content will be loaded here -->
</div>
</main>
</div>

<!-- Modal Container -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle">Modal Title</h3>
<button class="modal-close" onclick="closeModal()">
<i class="ri-close-line"></i>
</button>
</div>
<div class="modal-body" id="modalBody">
<!-- Modal content -->
</div>
</div>
</div>

<!-- JavaScript -->
<script>
// API Configuration
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token') || localStorage.getItem('authToken');

// Add this right after your paginationState object
let paginationHandlers = {};
function callPaginationHandler(handlerId, page) {
    if (paginationHandlers[handlerId]) {
        paginationHandlers[handlerId](page);
    }
}

    
// Global State
let currentData = {
    user: null,
    tasks: [],
    images: [],
    articles: [],
    domains: [],
    billing: [],
    selectedLocations: [],
    currentStep: 1,
    taskPriority: 'standard',
    selectedKeywords: []
};

let charts = {};
let globalMap = null;
let paginationState = {
    tasks: { page: 1, pageSize: 10, total: 0, hasNext: false },
    images: { page: 1, pageSize: 20, total: 0, hasNext: false },
    articles: { page: 1, pageSize: 10, total: 0, hasNext: false },
    billing: { page: 1, pageSize: 10, total: 0, hasNext: false }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }

    initializeEventListeners();
    loadDashboard();
    initializeTheme();

    // Initialize user info after dashboard loads
    setTimeout(() => {
        updateUserInfo();
    }, 100);
});

// Event Listeners
function initializeEventListeners() {
    // Desktop navigation
    document.querySelectorAll('.sidebar .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });

    // Mobile navigation
    document.querySelectorAll('.mobile-nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });

    // Mobile menu navigation
    document.querySelectorAll('.mobile-menu .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            closeMobileMenu();
            navigateTo(item.dataset.page);
        });
    });

    // Modal click outside to close
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            closeModal();
        }
    });

    // Close user dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const userMenuContainer = document.querySelector('.user-menu-container');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenuContainer.contains(e.target)) {
            userDropdown.classList.remove('active');
        }
    });

    // Mobile menu overlay close
    document.getElementById('mobileMenuOverlay')?.addEventListener('click', closeMobileMenu);
}

// Mobile Menu Functions
function openMobileMenu() {
    document.getElementById('mobileMenu').classList.add('active');
    document.getElementById('mobileMenuOverlay').classList.add('active');
}

function closeMobileMenu() {
    document.getElementById('mobileMenu').classList.remove('active');
    document.getElementById('mobileMenuOverlay').classList.remove('active');
}

// New Google-style mobile profile dropdown functions
function toggleMobileProfileDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
        if (dropdown.classList.contains('active')) {
            // Update user info when opening
            const user = currentData.user;
            if (user) {
                const initial = (user.email || 'U').charAt(0).toUpperCase();
                document.getElementById('mobileDropdownUserInitial').textContent = initial;
                // Hide the name element and show only email
                const nameEl = document.getElementById('mobileDropdownUserName');
                if (nameEl) nameEl.style.display = 'none';
                document.getElementById('mobileDropdownUserEmail').textContent = user.email || '';
                
                // Update session count (include current session)
                const otherSessions = getOtherSessions();
                const sessionCount = otherSessions.length + 1;
                document.getElementById('mobileDropdownSessionCount').textContent = sessionCount;
            }
        }
    }
}

function closeMobileProfileDropdown() {
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.remove('active');
    }
}

// Mobile Search Functions
function toggleMobileSearch() {
    const overlay = document.getElementById('mobileSearchOverlay');
    overlay.classList.toggle('active');
    if (overlay.classList.contains('active')) {
        overlay.querySelector('input').focus();
    }
}

// User Dropdown Toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}

// Get Other Sessions (excluding current)
function getOtherSessions() {
    const sessions = currentData.user?.sessions || [];
    // Filter out current session token
    return sessions.filter(session => session.token !== sessionToken);
}

// Get Current Session
function getCurrentSession() {
    const sessions = currentData.user?.sessions || [];
    // Find current session token
    return sessions.find(session => session.token === sessionToken);
}

// [NEW] Rebuilt Active Sessions Modal using SweetAlert2
function showSessionsModal() {
    // Close any other open modals first
    document.getElementById('userDropdown').classList.remove('active');

    const otherSessions = getOtherSessions();
    const currentSession = getCurrentSession();

    // Helper to create a single session card
    const createSessionCard = (session, isCurrent = false) => {
        const createdDate = new Date(session.timestamp);
        const expiresDate = new Date(session.expires_at);
        const isExpired = expiresDate < new Date();
        
        return `
        <div class="session-card ${isCurrent ? 'session-card--current' : ''}">
            <div class="session-icon">
                <i class="ri-computer-line"></i>
            </div>
            <div class="session-details">
                <div class="session-main-info">
                    ${session.country_code} - ${session.ip_address}
                    ${isCurrent ? '<span class="badge badge-success" style="margin-left: 0.5rem;">This Device</span>' : ''}
                    ${isExpired ? '<span class="badge badge-danger" style="margin-left: 0.5rem;">Expired</span>' : ''}
                </div>
                <div class="session-meta-info">
                    <span><strong>Created:</strong> ${createdDate.toLocaleString()}</span>
                    <span><strong>Expires:</strong> ${isExpired ? 'Already Expired' : expiresDate.toLocaleString()}</span>
                </div>
            </div>
            ${!isCurrent ? `
                <div class="session-actions">
                    <button class="btn btn-sm btn-danger" onclick="revokeSession('${session.token}')">Revoke</button>
                </div>
            ` : ''}
        </div>
        `;
    };

    let modalHtml = `
    <div class="sessions-modal-container">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Manage your active login sessions. For security, revoke any sessions you don't recognize.</p>
        
        ${currentSession ? `
            <h3 class="sessions-section-title"><i class="ri-shield-check-line"></i>Current Session</h3>
            ${createSessionCard(currentSession, true)}
        ` : ''}
        
        ${otherSessions.length > 0 ? `
            <h3 class="sessions-section-title"><i class="ri-device-line"></i>Other Active Sessions</h3>
            <div>
                ${otherSessions.map(session => createSessionCard(session)).join('')}
            </div>
            <button class="btn btn-danger" onclick="revokeAllSessions()"><i class="ri-logout-box-r-line"></i> Revoke All Other Sessions (${otherSessions.length})</button>
        ` : `
            <div class="empty-state" style="padding: 1rem 0;">
                <div class="empty-state-icon"><i class="ri-shield-star-line"></i></div>
                <div class="empty-state-title" style="font-size: 1.2rem;">You're only logged in here.</div>
                <p class="empty-state-description">No other active sessions were found.</p>
            </div>
        `}
    </div>`;

    Swal.fire({
        title: 'Active Sessions',
        html: modalHtml,
        showConfirmButton: false,
        showCloseButton: true,
        width: '95vw',
        customClass: {
            popup: 'sessions-modal-custom',
            footer: 'swal2-footer',
            closeButton: 'swal2-close'
        }
    });
}

// [NEW] Updated to work with SweetAlert2
async function revokeSession(token) {
    Swal.fire({
        title: 'Revoke this session?',
        text: "The user logged in on that device will be signed out.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        confirmButtonText: 'Yes, revoke it!',
        customClass: { popup: 'swal2-toast' }
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Revoking...',
                didOpen: () => Swal.showLoading(),
                customClass: { popup: 'swal2-toast' }
            });

            try {
                // The API endpoint for revoking a single session is the logout endpoint with that session's token.
                await fetch(`${API_BASE}/logout`, {
                    method: 'GET',
                    headers: { 'Session-Token': token, 'Content-Type': 'application/json' }
                });
                
                // Update local data
                if (currentData.user && currentData.user.sessions) {
                    currentData.user.sessions = currentData.user.sessions.filter(s => s.token !== token);
                }
                
                Swal.close(); // Close the "Revoking..." popup
                showToast('Session revoked successfully', 'success');
                showSessionsModal(); // Refresh the main sessions modal
                updateUserInfo(); // Update session count badges
            } catch (error) {
                Swal.fire('Error!', 'Failed to revoke session: ' + error.message, 'error');
            }
        }
    });
}

// [NEW] Updated to work with SweetAlert2
async function revokeAllSessions() {
    Swal.fire({
        title: 'Revoke all other sessions?',
        text: "You will be logged out from all other devices immediately.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        confirmButtonText: 'Yes, revoke all!',
        customClass: { popup: 'swal2-toast' }
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Revoking all...',
                didOpen: () => Swal.showLoading(),
                customClass: { popup: 'swal2-toast' }
            });
            try {
                await api('/sessions/revoke-all', { method: 'POST' });

                // Keep only current session in local data
                if (currentData.user && currentData.user.sessions) {
                    currentData.user.sessions = currentData.user.sessions.filter(s => s.token === sessionToken);
                }

                Swal.close(); // Close loading popup
                showToast('All other sessions revoked!', 'success');
                showSessionsModal(); // Refresh the main sessions modal
                updateUserInfo(); // Update session count badges
            } catch (error) {
                Swal.fire('Error!', 'Failed to revoke sessions: ' + error.message, 'error');
            }
        }
    });
}

// Theme Management
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);

    // Refresh charts and map with new theme
    if (charts.traffic) {
        setTimeout(updateCharts, 100);
    }
}

function updateThemeIcon(theme) {
    document.getElementById('themeIcon').className = theme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
}

// Navigation
function navigateTo(page) {
    // Update desktop nav
    document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.sidebar .nav-item[data-page="${page}"]`)?.classList.add('active');

    // Update mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.mobile-nav-item[data-page="${page}"]`)?.classList.add('active');

    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'images': loadImages(); break;
        case 'articles': loadArticles(); break;
        case 'billing': loadBilling(); break;
        case 'profile': loadProfile(); break;
    }
}

// Update User Info
function updateUserInfo() {
    const user = currentData.user;
    if (!user) return;

    const email = user.email;
    const name = email.split('@')[0];
    const initial = email[0].toUpperCase();

    // Update all user display elements
    document.getElementById('userInitial').textContent = initial;
    document.getElementById('userName').textContent = name;
    document.getElementById('userEmail').textContent = email;
    
    // Update mobile profile avatar
    const mobileAvatar = document.getElementById('mobileUserAvatar');
    if (mobileAvatar) mobileAvatar.textContent = initial;
    
    // Update mobile menu profile section
    const mobileMenuInitial = document.getElementById('mobileMenuUserInitial');
    if (mobileMenuInitial) mobileMenuInitial.textContent = initial;
    
    const mobileMenuName = document.getElementById('mobileMenuUserName');
    if (mobileMenuName) mobileMenuName.textContent = name;
    
    const mobileMenuEmail = document.getElementById('mobileMenuUserEmail');
    if (mobileMenuEmail) mobileMenuEmail.textContent = email;
    
    // Update mobile menu task and article counts
    const mobileMenuTaskCount = document.getElementById('mobileMenuTaskCount');
    if (mobileMenuTaskCount && currentData.tasks) {
        mobileMenuTaskCount.textContent = currentData.tasks.length;
    }
    
    const mobileMenuArticleCount = document.getElementById('mobileMenuArticleCount');
    if (mobileMenuArticleCount && currentData.articles) {
        mobileMenuArticleCount.textContent = currentData.articles.length;
    }

    // Update session count (excluding current session)
    const otherSessions = getOtherSessions();
    const totalSessions = otherSessions.length + 1;

    // Update both desktop and mobile session counts
    const desktopCountEl = document.getElementById('sessionCount');
    if (desktopCountEl) desktopCountEl.textContent = totalSessions;

    const mobileCountEl = document.getElementById('sessionCountMobile');
    if (mobileCountEl) mobileCountEl.textContent = totalSessions;
}

// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
        
        // Check for 401/403 BEFORE parsing JSON
        if (response.status === 401 || response.status === 403) {
            // Clear cookies and redirect to login
            document.cookie = 'session_token=; path=/; Domain=.seotize.net; Secure; SameSite=Lax; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return; // Stop execution
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error?.message || data.message || 'API Error');
        }
        
        return data;
    } catch (error) {
        console.error('API Error:', error);
        showToast(error.message, 'error');
        throw error;
    }
}

// Helper function to format numbers with K/M abbreviations
function formatNumber(num) {
    if (num < 1000) {
        return num.toString();
    } else if (num < 1000000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'k';
    } else if (num < 1000000000) {
        return (num / 1000000).toFixed(1).replace('.0', '') + 'M';
    } else {
        return (num / 1000000000).toFixed(1).replace('.0', '') + 'B';
    }
}

// Dashboard
async function loadDashboard(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.user = user;

        // Update pagination state for dashboard tasks
        paginationState.tasks = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };

        // Sort tasks by date (newest first)
        const sortedTasks = (user.tasks || []).sort((a, b) =>
            new Date(b.date_created) - new Date(a.date_created)
        );

        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userName').textContent = user.email.split('@')[0];
        document.getElementById('userInitial').textContent = user.email[0].toUpperCase();

        updateUserInfo();
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="stats-grid">
        <div class="stat-card">
        <div class="stat-icon primary">
        <i class="ri-task-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_tasks || 0}</div>
        <div class="stat-label">Total Tasks</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon success">
        <i class="ri-eye-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${formatNumber(user.usage_summary?.total_views || 0)}</div>
        <div class="stat-label">Total Views</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon warning">
        <i class="ri-key-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_keywords || 0}</div>
        <div class="stat-label">Keywords</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon error">
        <i class="ri-wallet-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">$${(user.task_statistics?.available_charge || 0).toFixed(2)}</div>
        <div class="stat-label">Available Budget</div>
        </div>
        </div>
        </div>

        <div class="analytics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Task Performance</h3>
        </div>
        <div class="card-body">
        <div class="chart-container" style="height: 280px; position: relative;">
        <canvas id="taskChart"></canvas>
        </div>
        </div>
        </div>

        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Views by Country</h3>
        </div>
        <div class="card-body">
        <div class="map-container" id="countryMap" style="height: 280px;"></div>
        </div>
        </div>
        </div>

        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Recent Tasks</h3>
        <button class="btn btn-primary btn-sm" onclick="navigateTo('tasks')">View All</button>
        </div>
        <div class="card-body">

        <!-- Desktop Table Version -->
        <div class="table-container desktop-only">
        <table>
        <thead>
        <tr>
        <th>URL</th>
        <th>Created</th>
        <th>Keywords</th>
        <th>Views</th>
        <th>Budget Status</th>
        <th>Available</th>
        <th>Status</th>
        <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        ${sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Budget calculation with used and remaining display
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);

            // Calculate used amount and display values
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%

            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;

                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }

                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }

            return `
            <tr>
            <td>
            <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none;">
            ${task.url.length > 30 ? task.url.substring(0, 30) + '...' : task.url}
            </a>
            </td>
            <td style="font-size: 0.875rem; color: var(--text-secondary);">${createdDate}</td>
            <td>
            <span class="badge badge-primary">${task.keywords_count}</span>
            </td>
            <td>
            <span class="badge badge-success">${formatNumber(task.views_count)}</span>
            </td>
            <td>
            <div style="display: flex; flex-direction: column; gap: 0.25rem; min-width: 120px;">
            <div style="font-size: 0.75rem; text-align: center;">
            Used: $${usedAmount.toFixed(2)} ${remainingPercent.toFixed(0)}%
            </div>
            <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
            <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>
            </td>
            <td style="font-weight: 600;">$${availableCharge.toFixed(2)}</td>
            <td>
            <span class="badge badge-${availableCharge > 0 ? 'success' : 'warning'}">
            ${availableCharge > 0 ? 'Active' : 'Depleted'}
            </span>
            </td>
            <td>
            <button class="btn btn-sm" onclick="viewTaskDetails('${task._id}')" title="View Details">
            <i class="ri-eye-line"></i>
            </button>
            </td>
            </tr>
            `;
        }).join('')}
        </tbody>
        </table>
        </div>

        <!-- Mobile Card Version -->
        <div class="mobile-only">
        ${sortedTasks.length > 0 ? sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Same calculation logic as desktop version
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);

            // Calculate used amount and display values - SAME AS DESKTOP
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%

            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;

                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }

                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }

            return `
            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: var(--transition);" onclick="viewTaskDetails('${task._id}')" ontouchstart="this.style.background='var(--card-hover)'" ontouchend="this.style.background='var(--bg-secondary)'">

                <!-- Header: URL and Status -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;    flex-direction: column;">
                    <div style="flex: 1; min-width: 0;">
                        <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.9rem; display: block; word-break: break-all; line-height: 1.3;" onclick="event.stopPropagation()">
                            ${task.url.length > 45 ? task.url.substring(0, 45) + '...' : task.url}
                        </a>
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            ${createdDate}
                        </div>
                    </div>
                    <span class="badge badge-${availableCharge > 0 ? 'success' : 'warning'}" style="margin-left: 0rem; flex-shrink: 0; font-size: 0.7rem;">
                        ${availableCharge > 0 ? 'Active' : 'Depleted'}
                    </span>
                </div>

                <!-- Stats Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm);flex-direction: column;    align-items: flex-start;gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Keywords:</span>
                        <span class="badge badge-primary" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${task.keywords_count}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Views:</span>
                        <span class="badge badge-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${formatNumber(task.views_count)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Available:</span>
                        <span style="font-weight: 600; font-size: 0.8rem; color: var(--text);">$${availableCharge.toFixed(2)}</span>
                    </div>
                </div>

                <!-- Budget Progress -->
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Budget Remaining</span>
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${remainingPercent.toFixed(0)}% (Used: $${usedAmount.toFixed(2)})</span>
                    </div>
                    <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-eye-line"></i> Details
                    </button>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); rechargeTask('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-wallet-line"></i> Recharge
                    </button>
                </div>
            </div>
            `;
        }).join('') : `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="ri-task-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                <p style="margin: 0; font-weight: 500;">No tasks yet</p>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Create your first SEO task</p>
            </div>
        `}
        </div>

        <!-- Fixed pagination with proper structure -->
        <div class="pagination">
        <button class="pagination-btn" ${pagination.current <= 1 ? 'disabled' : ''} onclick="loadDashboard(${pagination.current - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
        </button>

        ${(() => {
            let paginationButtons = '';
            const totalPages = Math.max(1, pagination.pages);
            const currentPage = pagination.current;

            if (totalPages <= 5) {
                // Show all pages if 5 or fewer
                for (let i = 1; i <= totalPages; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }
            } else {
                // Show condensed pagination for more than 5 pages
                if (currentPage > 2) {
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(1)">1</button>`;
                    if (currentPage > 3) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                }

                const startPage = Math.max(1, currentPage - 1);
                const endPage = Math.min(totalPages, currentPage + 1);

                for (let i = startPage; i <= endPage; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }

                if (currentPage < totalPages - 1) {
                    if (currentPage < totalPages - 2) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(${totalPages})">${totalPages}</button>`;
                }
            }

            return paginationButtons;
        })()}

        <button class="pagination-btn" ${!pagination.has_next ? 'disabled' : ''} onclick="loadDashboard(${pagination.current + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
        </button>

        <div class="pagination-info">
        Page ${pagination.current} of ${Math.max(1, pagination.pages)} | Showing ${sortedTasks.length} of ${pagination.total} tasks
        </div>
        </div>
        </div>
        </div>
        `;

        // Initialize charts and map
        setTimeout(() => {
            initializeCharts(user);
            initializeCountryMap(user);
        }, 100);

    } catch (error) {
        console.error('Dashboard error:', error);
        showErrorState('Failed to load dashboard');
        if (error.message === 'Invalid session. Please log in again.') logout();
    }
}

// Tasks
async function loadTasks(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.tasks = user.tasks || [];

        // Ensure pagination state is properly set
        paginationState.tasks = {
            page: pagination.current || 1,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">SEO Tasks</h2>
        <button class="btn btn-primary" onclick="showTaskModal()">
        <i class="ri-add-line"></i> Create New Task
        </button>
        </div>

        <div class="task-grid">
        ${currentData.tasks.map(task => `
            <div class="task-card" onclick="viewTaskDetails('${task._id}')">
            <div class="task-header">
            <a href="${task.url}" target="_blank" class="task-url" onclick="event.stopPropagation()">${task.url}</a>
            <span class="task-status active">Active</span>
            </div>

            <div class="task-stats">
            <div class="task-stat">
            <div class="task-stat-label">Keywords</div>
            <div class="task-stat-value">${task.keywords_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Views</div>
            <div class="task-stat-value">${task.views_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Budget Used</div>
            <div class="task-stat-value">$${(task.total_charge - task.available_charge).toFixed(2)}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Available</div>
            <div class="task-stat-value">$${task.available_charge.toFixed(2)}</div>
            </div>
            </div>

            <div class="task-progress">
            <div class="progress-bar">
            <div class="progress-fill" style="width: ${task.remaining_percentage}%; background: ${task.remaining_percentage >= 100 ? '#8b5cf6' : task.remaining_percentage >= 10 ? '#10b981' : '#ef4444'}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>

            <div class="task-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')">
            <i class="ri-eye-line"></i> Details
            </button>
            <button class="btn btn-sm" onclick="event.stopPropagation(); rechargeTask('${task._id}')">
            <i class="ri-wallet-line"></i> Recharge
            </button>
            </div>
            </div>
            `).join('')}
            </div>

            ${currentData.tasks.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-task-line"></i>
                </div>
                <div class="empty-state-title">No Tasks Yet</div>
                <div class="empty-state-description">Create your first SEO task to start optimizing your website</div>
                <button class="btn btn-primary" onclick="showTaskModal()">Create First Task</button>
                </div>
                ` : generatePagination('tasks', loadTasks)}
                `;

    } catch (error) {
        console.error('Tasks error:', error);
        showErrorState('Failed to load tasks');
    }
}

// Images
async function loadImages(page = 1) {
    try {
        showSpinner();
        const response = await api(`/images/dashboard?page=${page}&page_size=20`);
        const { data, pagination } = response;

        currentData.images = data.images || [];
        paginationState.images = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">Image Hosting</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
        ${data.user?.uploaded || 0}/${(data.user?.uploaded || 0) + (data.user?.remaining || 0)} images used
        </div>
        <button class="btn btn-primary" onclick="showImageUploadModal()">
        <i class="ri-upload-line"></i> Upload Images
        </button>
        </div>
        </div>

        <div class="media-grid">
        ${currentData.images.map(image => `
    <div class="media-card">
        <div class="media-preview" onclick="window.open('${image.cdn_url}', '_blank')" style="cursor: pointer;" title="Click to open full image">
            <img src="${image.cdn_url}" alt="${image.original_filename}" loading="lazy">
        </div>
        <div class="media-info">
            <div class="media-filename">${image.original_filename}</div>
            <div class="media-stats">
                <span>${image.total_views} views</span>
                <span>${new Date(image.upload_date).toLocaleDateString()}</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                <button class="btn btn-sm" onclick="showImageDetails('${image.image_id}')">
                    <i class="ri-eye-line"></i> Details
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.image_id}')">
                    <i class="ri-delete-bin-line"></i> Delete
                </button>
            </div>
        </div>
    </div>
        `).join('')}
        </div>

            ${currentData.images.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-image-line"></i>
                </div>
                <div class="empty-state-title">No Images Uploaded</div>
                <div class="empty-state-description">Upload images to host them on our CDN with analytics</div>
                <button class="btn btn-primary" onclick="showImageUploadModal()">Upload First Image</button>
                </div>
                ` : ''}

                ${paginationState.images.total > paginationState.images.pageSize ? generatePagination('images', loadImages) : ''}
                `;

    } catch (error) {
        console.error('Images error:', error);
        showErrorState('Failed to load images');
    }
}

// Articles with Domains
async function loadArticles(page = 1) {
    try {
        showSpinner();

        // Single API call gets both articles and domains
        const response = await api(`/dashboard/articles?page=${page}&page_size=10`);
        const { data, pagination } = response;

        // Extract articles and domains from the response
        currentData.articles = data.articles || [];
        currentData.domains = data.user?.domains || [];

        // Update pagination state
        paginationState.articles = {
            page: pagination.current || page,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Articles & Domains</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" id="addDomainBtn">
                    <i class="ri-global-line"></i> Add Domain
                </button>
                <button class="btn btn-primary" id="createArticleBtn">
                    <i class="ri-add-line"></i> Create Article
                </button>
            </div>
        </div>

        <!-- Domains Section -->
        <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
                <h3 class="card-title">Domain Verification</h3>
                <span class="badge badge-primary">${currentData.domains.length} domains</span>
            </div>
            <div class="card-body" id="domainsList">
                ${currentData.domains.length > 0 ? currentData.domains.map(domain => `
                    <div class="mobilearticle1" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 0.5rem; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 1rem; min-width: 0;">
                            <span class="badge badge-${domain.verified ? 'success' : 'warning'}">
                                ${domain.verified ? '&#10003; Verified' : '&#9203; Pending'}
                            </span>
                            <span style="font-weight: 500;">${domain.domain}</span>
                        </div>
                        <div class="domain-actions">
                            ${!domain.verified ? `
                                <button class="btn btn-sm btn-verify-instructions" data-domain="${domain.domain}" data-txt="${domain.txt_record || ''}">Instructions</button>
                                <button class="btn btn-sm btn-primary btn-verify-domain" data-domain="${domain.domain}">Verify Now</button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger btn-delete-domain" data-domain="${domain.domain}">
                                <i class="ri-delete-bin-line"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('') : `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No domains added yet. Add a domain to start publishing articles.
                    </div>
                `}
            </div>
        </div>

        <!-- Articles Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Published Articles</h3>
                <span class="badge badge-primary">${paginationState.articles.total} articles</span>
            </div>
            <div class="card-body">
                <!-- Desktop Table Version -->
                <div class="table-container desktop-only">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Domain</th>
                                <th>Published</th>
                                <th>Views</th>
                                <th>Images</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentData.articles.map(article => `
                                <tr>
                                    <td>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${article.subject}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${article.article_id}</div>
                                    </td>
                                    <td>
                                        <a href="https://${article.url}" target="_blank" class="badge badge-primary" style="text-decoration: none;">
                                            ${article.url}
                                        </a>
                                    </td>
                                    <td style="font-size: 0.875rem; color: var(--text-secondary);">
                                        ${new Date(article.creation_date).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </td>
                                    <td>
                                        <span class="badge badge-success">${article.total_views || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-warning">${(article.images || []).length}</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="btn btn-sm btn-view-article" data-article-id="${article.article_id}" title="View Details">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-edit-article" data-article-id="${article.article_id}" title="Edit">
                                                <i class="ri-edit-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-view-live" data-url="${article.url}" title="View Live">
                                                <i class="ri-external-link-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger btn-delete-article" data-article-id="${article.article_id}" title="Delete">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card Version -->
                <div class="mobile-only">
                    ${currentData.articles.length > 0 ? currentData.articles.map(article => {
                        const publishedDate = new Date(article.creation_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: new Date(article.creation_date).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                        });

                        return `
                        <div class="mobile-article-card" data-article-id="${article.article_id}" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: var(--transition);">

                            <!-- Header: Title and Domain -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; line-height: 1.3; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${article.subject}</h4>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <a href="https://${article.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 0.85rem; font-weight: 500;" onclick="event.stopPropagation()">
                                            <i class="ri-global-line" style="font-size: 0.8rem;"></i> ${article.url}
                                        </a>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                        Published ${publishedDate}
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Row -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Views:</span>
                                    <span class="badge badge-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${formatNumber(article.total_views || 0)}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Images:</span>
                                    <span class="badge badge-warning" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${(article.images || []).length}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">ID:</span>
                                    <code style="font-size: 0.65rem; background: var(--bg); padding: 0.2rem 0.4rem; border-radius: 3px;">${article.article_id.substring(0, 8)}...</code>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-view-article-mobile" data-article-id="${article.article_id}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-eye-line"></i> Details
                                </button>
                                <button class="btn btn-sm btn-edit-article-mobile" data-article-id="${article.article_id}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-edit-line"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-view-live-mobile" data-url="${article.url}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-external-link-line"></i> Live
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete-article-mobile" data-article-id="${article.article_id}" style="padding: 0.4rem 0.6rem; font-size: 0.75rem;">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('') : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="ri-article-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-weight: 500;">No articles published</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Create your first article to start publishing content</p>
                        </div>
                    `}
                </div>

                ${currentData.articles.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="ri-article-line"></i>
                        </div>
                        <div class="empty-state-title">No Articles Published</div>
                        <div class="empty-state-description">Create your first article to start publishing content</div>
                        <button class="btn btn-primary" id="emptyStateCreateBtn">Create First Article</button>
                    </div>
                ` : generatePagination('articles', loadArticles)}
            </div>
        </div>
        `;

        // Add event listeners after DOM is updated
        document.getElementById('addDomainBtn')?.addEventListener('click', showDomainModal);
        document.getElementById('createArticleBtn')?.addEventListener('click', () => showArticleModal());
        document.getElementById('emptyStateCreateBtn')?.addEventListener('click', () => showArticleModal());

        // Domain action buttons
        document.querySelectorAll('.btn-verify-instructions').forEach(btn => {
            btn.addEventListener('click', () => {
                showVerificationInstructions(btn.dataset.domain, btn.dataset.txt);
            });
        });

        document.querySelectorAll('.btn-verify-domain').forEach(btn => {
            btn.addEventListener('click', () => verifyDomain(btn.dataset.domain));
        });

        document.querySelectorAll('.btn-delete-domain').forEach(btn => {
            btn.addEventListener('click', () => confirmDeleteDomain(btn.dataset.domain));
        });

        // Article action buttons - Desktop
        document.querySelectorAll('.btn-view-article').forEach(btn => {
            btn.addEventListener('click', () => viewArticle(btn.dataset.articleId));
        });

        document.querySelectorAll('.btn-edit-article').forEach(btn => {
            btn.addEventListener('click', () => showArticleModal(btn.dataset.articleId));
        });

        document.querySelectorAll('.btn-view-live').forEach(btn => {
            btn.addEventListener('click', () => window.open(`https://${btn.dataset.url}`, '_blank'));
        });

        document.querySelectorAll('.btn-delete-article').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                    deleteArticle(btn.dataset.articleId);
                }
            });
        });

        // Article action buttons - Mobile
        document.querySelectorAll('.mobile-article-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('button') && !e.target.closest('a')) {
                    viewArticle(card.dataset.articleId);
                }
            });
        });

        document.querySelectorAll('.btn-view-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                viewArticle(btn.dataset.articleId);
            });
        });

        document.querySelectorAll('.btn-edit-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showArticleModal(btn.dataset.articleId);
            });
        });

        document.querySelectorAll('.btn-view-live-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                window.open(`https://${btn.dataset.url}`, '_blank');
            });
        });

        document.querySelectorAll('.btn-delete-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                    deleteArticle(btn.dataset.articleId);
                }
            });
        });

    } catch (error) {
        console.error('Articles error:', error);
        showErrorState('Failed to load articles and domains');
    }
}
// Upgraded Billing Function
async function loadBilling(page = 1, type = 'all') {
    try {
        showSpinner();
        // We now need two API calls: one for subscription status and one for billing history.
        const [planResponse, historyResponse] = await Promise.all([
            api('/hosting/subscription-status'),
            api(`/dashboard/billings?page=${page}&limit=10&type=${type}`)
        ]);

        const planData = planResponse.data;
        const historyData = historyResponse.data;

        // --- 1. Current Plan Data ---
        const planName = planData.current_plan || 'free';
        const isSubscribed = planData.is_subscription;
        let expiryHTML = '';
        if (planData.expiry_date) {
            const expiry = new Date(planData.expiry_date);
            const now = new Date();
            const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            expiryHTML = `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                ${isSubscribed ? 'Renews' : 'Expires'} in <strong>${daysLeft > 0 ? daysLeft : 0} days</strong> (${expiry.toLocaleDateString()})
            </div>`;
        }
        const imagesUsedPercent = (planData.images_uploads / (planData.images_limit || 1)) * 100;
        const articlesUsedPercent = (planData.article_uploads / (planData.articles_limit || 1)) * 100;


        // --- 2. Transaction History Data ---
        const taskPayments = historyData.tasks || [];
        const hostingPayments = historyData.hosting || [];
        const allPayments = [...taskPayments, ...hostingPayments];
        paginationState.billing = {
            page: historyData.pagination.page,
            pageSize: historyData.pagination.limit,
            total: historyData.pagination.total,
            hasNext: historyData.pagination.page < historyData.pagination.pages
        };

        // --- 3. Render everything together ---
        const content = document.getElementById('content');
        content.innerHTML = `
        <style>
            /* Add some new styles for the plan cards, harmonized with your app */
            .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
            .plan-card { padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-lg); cursor: pointer; transition: var(--transition); background: var(--card); }
            .plan-card:hover { border-color: var(--primary-light); transform: translateY(-3px); box-shadow: var(--shadow); }
            .plan-card.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
            .plan-card h4 { margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; }
            .plan-card ul { list-style: none; padding: 0; margin: 0; font-size: 0.875rem; color: var(--text-secondary); }
            .plan-card ul li { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text); }
            .plan-card ul li::before { content: '?'; color: var(--success); font-weight: 600; }
            .duration-selector { display: flex; gap: 0.5rem; background: var(--bg-tertiary); padding: 0.5rem; border-radius: var(--radius); margin-bottom: 1.5rem; justify-content: center; flex-wrap: wrap; }
            .duration-selector label { flex: 1; text-align: center; min-width: 100px; }
            .duration-selector input { display: none; }
            .duration-selector span { padding: 0.5rem 1rem; border-radius: var(--radius-sm); display: block; cursor: pointer; transition: var(--transition); font-weight: 500; font-size: 0.875rem; color: var(--text); }
            .duration-selector input:checked + span { background: var(--primary); color: white; }
            
            @media (max-width: 768px) {
                .billing-plan-grid { grid-template-columns: 1fr !important; }
                .plan-grid { grid-template-columns: 1fr; gap: 0.75rem; }
                .plan-card { padding: 1rem; }
                .plan-card h4 { font-size: 1rem; margin-bottom: 0.75rem; }
                .plan-card ul { font-size: 0.8rem; }
                .plan-card ul li { margin-bottom: 0.4rem; }
                .duration-selector { padding: 0.4rem; gap: 0.4rem; }
                .duration-selector label { min-width: 80px; }
                .duration-selector span { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
            }
            @media (max-width: 480px) {
                .plan-card { padding: 0.85rem; }
                .plan-card h4 { font-size: 0.95rem; }
                .plan-card ul { font-size: 0.75rem; }
                .duration-selector { flex-direction: column; }
                .duration-selector label { min-width: 100%; }
            }
        </style>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Billing & Plans</h2>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">Current Hosting Plan</h3>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="badge badge-primary" style="text-transform: capitalize;">${planName}</span>
                    ${!isSubscribed ? `<button class="btn btn-sm btn-primary" onclick="showUpgradePlans()" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;"><i class="ri-arrow-up-circle-line" style="margin-right: 0.25rem;"></i>Upgrade</button>` : ''}
                </div>
            </div>
            <div class="card-body">
                ${expiryHTML}
                <div style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                        <span>Images Used</span>
                        <span style="color: var(--text-secondary);">${planData.images_uploads} / ${planData.images_limit || 0}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${imagesUsedPercent}%"></div></div>
                </div>
                 <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                        <span>Articles Published</span>
                        <span style="color: var(--text-secondary);">${planData.article_uploads} / ${planData.articles_limit || 0}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${articlesUsedPercent}%"></div></div>
                </div>
                ${isSubscribed ? '<button class="btn btn-secondary" style="width:100%; margin-top:1.5rem;" onclick="cancelSubscription()">Manage Subscription</button>' : ''}
                
                <!-- Upgrade Plan Section -->
                ${!isSubscribed ? `
                <div id="upgradePlansSection" style="display: none; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--text);">
                        <i class="ri-arrow-up-circle-line" style="color: var(--primary);"></i> Available Plans
                    </h4>
                    <div class="plan-grid">` : '<div style="display: none;">'}
                        ${Object.keys(hostingConfig.packages).map(planKey => `
                            <div class="plan-card" id="plan-${planKey}" onclick="selectPlan('${planKey}')">
                                <h4>${hostingConfig.packages[planKey].name}</h4>
                                <ul>${hostingConfig.packages[planKey].features.map(f => `<li>${f}</li>`).join('')}</ul>
                            </div>
                        `).join('')}
                    </div>
                    <div class="duration-selector">
                        <label><input type="radio" name="duration" value="3month" onchange="selectDuration('3month')" checked><span>3 Months</span></label>
                        <label><input type="radio" name="duration" value="6month" onchange="selectDuration('6month')"><span>6 Months</span></label>
                        <label><input type="radio" name="duration" value="12month" onchange="selectDuration('12month')"><span>12 Months</span></label>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 1.5rem; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-lg);">
                         <div>
                            <label for="payment-provider" style="font-size: 0.8125rem; color: var(--text-secondary); display:block; margin-bottom: 0.25rem;">Payment Method</label>
                            <select id="payment-provider" class="form-select" style="padding: 0.5rem;">
                                <option value="stripe">Card (Stripe)</option>
                                <option value="oxapay">Crypto (OxaPay)</option>
                            </select>
                        </div>
                        <div style="text-align:right">
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">Total Price</span>
                            <div id="price-display" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$0.00</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top: 1rem; padding: 0.75rem; justify-content: center;" onclick="purchasePlan()">Purchase Plan</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Transaction History</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Filter:</span>
                    <select class="form-select" style="width: auto; padding: 0.5rem;" onchange="loadBilling(1, this.value)">
                        <option value="all" ${type === 'all' ? 'selected' : ''}>All Types</option>
                        <option value="tasks" ${type === 'tasks' ? 'selected' : ''}>Tasks Only</option>
                        <option value="hosting" ${type === 'hosting' ? 'selected' : ''}>Hosting Only</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <!-- Desktop Table -->
                <div class="table-container desktop-only">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${allPayments.map(payment => {
                                let paymentType = '', description = '', badgeClass = '';
                                if (payment.method === 'create_task') {
                                    paymentType = 'SEO Task'; badgeClass = 'primary'; description = payment.details?.url || 'Task Creation';
                                } else if (payment.method === 'recharge') {
                                    paymentType = 'Recharge'; badgeClass = 'success'; description = `Task Recharge`;
                                } else if (payment.method === 'buy_package') {
                                    paymentType = 'Hosting'; badgeClass = 'warning'; description = `${payment.details?.package || ''} Package`;
                                } else {
                                    paymentType = payment.method || 'Payment'; badgeClass = 'primary'; description = 'Payment';
                                }
                                let statusClass = 'warning'; let statusText = payment.status || 'Unknown';
                                switch (payment.status?.toLowerCase()) {
                                    case 'paid': statusClass = 'success'; statusText = 'Paid'; break;
                                    case 'pending': statusClass = 'warning'; statusText = 'Pending'; break;
                                    case 'cancelled': statusClass = 'danger'; statusText = 'Cancelled'; break;
                                    case 'expired': statusClass = 'error'; statusText = 'Expired'; break;
                                }
                                return `
                                <tr>
                                    <td>${new Date(payment.dates?.created || Date.now()).toLocaleDateString()}</td>
                                    <td><span class="badge badge-${badgeClass}">${paymentType}</span></td>
                                    <td style="max-width: 250px; word-break: break-all;">${description}</td>
                                    <td style="font-weight: 600;">$${(payment.total_payment || 0).toFixed(2)}</td>
                                    <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                                    <td>
                                        ${payment.status?.toLowerCase() === 'paid' ? `<button class="btn btn-sm" onclick="viewPaymentDetails('${payment.billing_id}')"><i class="ri-eye-line"></i> Details</button>` : ''}
                                        ${payment.status?.toLowerCase() === 'pending' && payment.payment_url ? `<button class="btn btn-sm btn-primary" onclick="window.open('${payment.payment_url}', '_blank')" style="margin-left: 0.25rem;"><i class="ri-external-link-line"></i> Pay</button>` : ''}
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card Version -->
                <div class="mobile-only">
                    ${allPayments.length > 0 ? allPayments.map(payment => {
                        let paymentType = '', description = '', badgeClass = '';
                        if (payment.method === 'create_task') {
                            paymentType = 'SEO Task'; badgeClass = 'primary'; description = payment.details?.url || 'Task Creation';
                        } else if (payment.method === 'recharge') {
                            paymentType = 'Recharge'; badgeClass = 'success'; description = `Task Recharge`;
                        } else if (payment.method === 'buy_package') {
                            paymentType = 'Hosting'; badgeClass = 'warning'; description = `${payment.details?.package || ''} Package`;
                        } else {
                            paymentType = payment.method || 'Payment'; badgeClass = 'primary'; description = 'Payment';
                        }
                        let statusClass = 'warning'; let statusText = payment.status || 'Unknown';
                        switch (payment.status?.toLowerCase()) {
                            case 'paid': statusClass = 'success'; statusText = 'Paid'; break;
                            case 'pending': statusClass = 'warning'; statusText = 'Pending'; break;
                            case 'cancelled': statusClass = 'danger'; statusText = 'Cancelled'; break;
                            case 'expired': statusClass = 'error'; statusText = 'Expired'; break;
                        }
                        
                        const paymentDate = new Date(payment.dates?.created || Date.now()).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: new Date(payment.dates?.created || Date.now()).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                        });
                        
                        return `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; transition: var(--transition);">
                            <!-- Header -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span class="badge badge-${badgeClass}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${paymentType}</span>
                                        <span class="badge badge-${statusClass}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${statusText}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text); margin-bottom: 0.25rem; line-height: 1.3; word-break: break-word;">${description}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">${paymentDate}</div>
                                </div>
                                <div style="text-align: right; margin-left: 0.5rem;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);">$${(payment.total_payment || 0).toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            ${payment.status?.toLowerCase() === 'paid' || (payment.status?.toLowerCase() === 'pending' && payment.payment_url) ? `
                            <div style="display: flex; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                                ${payment.status?.toLowerCase() === 'paid' ? `<button class="btn btn-sm" onclick="viewPaymentDetails('${payment.billing_id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;"><i class="ri-eye-line"></i> Details</button>` : ''}
                                ${payment.status?.toLowerCase() === 'pending' && payment.payment_url ? `<button class="btn btn-sm btn-primary" onclick="window.open('${payment.payment_url}', '_blank')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;"><i class="ri-external-link-line"></i> Pay Now</button>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('') : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="ri-file-list-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-weight: 500;">No Transactions Found</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Your transaction history will appear here</p>
                        </div>
                    `}
                </div>
                
                ${allPayments.length === 0 ? `<div class="empty-state desktop-only" style="padding: 2rem 0;"><div class="empty-state-icon"><i class="ri-file-list-line"></i></div><div class="empty-state-title">No Transactions Found</div></div>` : ''}
            </div>
        </div>

         ${paginationState.billing.total > paginationState.billing.pageSize ? generatePagination('billing', (page) => loadBilling(page, type)) : ''}
        `;

        // Initialize the interactive plan selection
        selectPlan('professional');

    } catch (error) {
        console.error('Billing error:', error);
        showErrorState('Failed to load billing data. Please check your connection and try again.');
    }
}

// Profile Page
function loadProfile() {
    const user = currentData.user;
    const content = document.getElementById('content');
    content.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Profile Settings</h2>

            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" value="${user.email}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Account Created</label>
                        <input type="text" class="form-input" value="${new Date(user.created_at).toLocaleDateString()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Hosting Plan</label>
                        <input type="text" class="form-input" value="${user.hosting.type.toUpperCase()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Plan Expiry</label>
                        <input type="text" class="form-input" value="${new Date(user.hosting.expiry_date).toLocaleDateString()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Images Uploaded</label>
                        <input type="text" class="form-input" value="${user.hosting.images_uploads}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Articles Published</label>
                        <input type="text" class="form-input" value="${user.hosting.article_uploads}" readonly>
                    </div>

                    <button class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    `;

    // Close dropdown
    document.getElementById('userDropdown').classList.remove('active');
}

// Modal Functions
// function showModal(title, content) {
//     document.getElementById('modalTitle').textContent = title;
//     document.getElementById('modalBody').innerHTML = content;
//     document.getElementById('modalOverlay').classList.add('active');
// }
function showModal(title, content, width = '900px') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    const modal = document.querySelector('.modal');
    modal.style.width = width;
    modal.style.maxWidth = '95vw';
    document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    // Reset task creation state
    currentData.selectedLocations = [];
    currentData.selectedKeywords = [];
    currentData.currentStep = 1;
}






function loadWebsitePreview(url) {
    const iframe = document.getElementById('taskPreviewFrame');
    const loader = document.getElementById('websiteLoader');
    const overlay = document.getElementById('xpathOverlay');
    
    // State
    let selectedElements = [];
    let maxSelections = getPriorityMaxLocations(currentData.taskPriority);
    let zoomLevel = 1;
    let isReady = false;
    let useOverlayMode = false;
    
    // Reset
    if (!url.startsWith('http')) url = 'https://' + url;
    loader.style.display = 'flex';
    iframe.style.display = 'none';
    overlay.innerHTML = '';
    overlay.style.display = 'none';
    currentData.selectedLocations = [];
    selectedElements = [];
    
    // Override display functions but let the app handle the header
    window.updateSelectedLocationsDisplay = () => {};
    window.showLocations = () => {};
    
    // Single display update function - NO HEADER, just content
    function updateDisplay() {
        const container = document.getElementById('selectedLocations');
        if (!container) return;
        
        const count = selectedElements.length;
        
        // Update currentData first so the app's header function can read it
        currentData.selectedLocations = [...selectedElements];
        
        // Find existing header and preserve it, only update the content below it
        const existingHeader = container.querySelector('h4');
        let headerHTML = '';
        if (existingHeader) {
            headerHTML = existingHeader.outerHTML;
        }
        
        // Only provide the content, no header
        const contentHTML = count === 0 ? `
            <div style="text-align:center;padding:2rem;color:var(--text-secondary)">
                <p>Click on any element in the website preview above.</p>
                <p>You can select up to ${maxSelections} locations for ${currentData.taskPriority} priority.</p>
                <p><small>${useOverlayMode ? 'Using overlay mode' : 'Direct element selection enabled'}</small></p>
            </div>
        ` : `
            ${selectedElements.map((loc, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.75rem;border-left:4px solid var(--success)">
                    <div style="flex:1">
                        <div style="font-weight:600;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem">
                            <span style="background:var(--primary);color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem">${i+1}</span>
                            ${loc.tag ? loc.tag.toUpperCase() + ' Element' : 'Element'}
                            <span style="background:var(--success);color:white;padding:0.2rem 0.4rem;border-radius:4px;font-size:0.7rem">? Selected</span>
                        </div>
                        ${loc.text ? `<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem;padding:0.5rem;background:var(--bg-tertiary);border-radius:4px">"${loc.text}"</div>` : ''}
                        <code style="background:var(--bg);padding:0.5rem;border-radius:4px;font-size:0.75rem;word-break:break-all;display:block;border:1px solid var(--border)">${loc.xpath}</code>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeXPathElement('${loc.id}')" style="margin-left:1rem">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `).join('')}
        `;
        
        // Clear container and add preserved header + new content
        container.innerHTML = headerHTML + contentHTML;
        
        updateZoomControls();
    }
    
    // Enhanced zoom controls
    function updateZoomControls() {
        const previewControls = document.getElementById('preview-controls');
        if (!previewControls) return;
        
        previewControls.innerHTML = `
            <div class="zoom-controls-container" style="display:flex;gap:6px;align-items:center;justify-content:center;padding:16px;background:linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);border-radius:16px;border:1px solid #e2e8f0;box-shadow:0 4px 12px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);">
                
                <button id="zoomOutBtn" style="
                    background:linear-gradient(145deg, #ef4444 0%, #dc2626 100%);
                    color:white;
                    border:none;
                    width:42px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-weight:bold;
                    font-size:18px;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(239,68,68,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Zoom Out (Ctrl/Cmd + -)">
                    <span style="z-index:1;">?</span>
                </button>
                
                <div style="
                    display:flex;
                    align-items:center;
                    padding:0 20px;
                    height:42px;
                    font-size:16px;
                    color:var(--text);
                    min-width:75px;
                    justify-content:center;
                    font-weight:700;
                    background:linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
                    border-radius:10px;
                    border:1px solid #cbd5e1;
                    box-shadow:inset 0 2px 4px rgba(0,0,0,0.06);
                    font-family:monospace;
                ">
                    ${Math.round(zoomLevel * 100)}%
                </div>
                
                <button id="zoomInBtn" style="
                    background:linear-gradient(145deg, #10b981 0%, #059669 100%);
                    color:white;
                    border:none;
                    width:42px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-weight:bold;
                    font-size:18px;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(16,185,129,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Zoom In (Ctrl/Cmd + +)">
                    <span style="z-index:1;">+</span>
                </button>
                
                <div style="width:1px;height:24px;background:linear-gradient(to bottom, transparent, #cbd5e1, transparent);margin:0 12px;"></div>
                
                <button id="zoomResetBtn" style="
                    background:linear-gradient(145deg, #6366f1 0%, #4f46e5 100%);
                    color:white;
                    border:none;
                    padding:0 16px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:13px;
                    font-weight:600;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(99,102,241,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Reset Zoom (Ctrl/Cmd + 0)">
                    <i class="ri-restart-line" style="margin-right:6px;font-size:14px;"></i>
                    <span>Reset</span>
                </button>
                
            </div>
        `;
        
        // Add working event listeners
        document.getElementById('zoomOutBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(zoomLevel - 0.25);
        });
        
        document.getElementById('zoomInBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(zoomLevel + 0.25);
        });
        
        document.getElementById('zoomResetBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(1);
        });
    }
    
    function setZoom(scale) {
        zoomLevel = Math.max(0.25, Math.min(4, scale));
        iframe.style.transform = `scale(${zoomLevel})`;
        iframe.style.transformOrigin = '0 0';
        iframe.style.width = `${100/zoomLevel}%`;
        iframe.style.height = `${100/zoomLevel}%`;
        
        // Update zoom display
        const zoomDisplay = document.querySelector('.zoom-controls-container div[style*="font-family:monospace"]');
        if (zoomDisplay) {
            zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        }
    }
    
    // Element management
    function addElement(data) {
        if (selectedElements.length >= maxSelections) {
            if (window.showToast) {
                showToast(`Maximum ${maxSelections} selections reached`, 'warning');
            }
            return;
        }
        
        if (selectedElements.some(el => el.xpath === data.xpath)) {
            return;
        }
        
        const element = {
            id: data.id || 'xpath_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            xpath: data.xpath,
            text: (data.text || '').slice(0, 50),
            tag: data.tag || 'unknown',
            timestamp: Date.now()
        };
        
        selectedElements.push(element);
        updateDisplay(); // This will update currentData.selectedLocations
        
        if (window.showToast) {
            showToast(`Selected ${element.tag ? element.tag.toUpperCase() : 'element'}`, 'success');
        }
    }
    
    function removeElement(id) {
        const index = selectedElements.findIndex(el => el.id === id);
        if (index === -1) return;
        
        if (!useOverlayMode) {
            try {
                iframe.contentWindow?.postMessage({ type: 'remove_element', id }, '*');
            } catch (e) {}
        }
        
        selectedElements.splice(index, 1);
        updateDisplay(); // This will update currentData.selectedLocations
        
        if (window.showToast) showToast('Element removed', 'info');
    }
    
    // Message handling
    function handleMessage(event) {
        if (event.source !== iframe.contentWindow) return;
        
        const { type, data } = event.data;
        
        switch (type) {
            case 'xpath_selected':
                addElement(data);
                break;
            case 'iframe_ready':
                isReady = true;
                useOverlayMode = false;
                console.log('XPath selector ready - direct mode');
                updateDisplay();
                break;
            case 'fallback_to_overlay':
                useOverlayMode = true;
                setupOverlay();
                console.log('Falling back to overlay mode');
                break;
        }
    }
    
    // Setup overlay as fallback
    function setupOverlay() {
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            cursor: crosshair;
            display: block;
            background: rgba(59, 130, 246, 0.02);
        `;
        
        overlay.onclick = (e) => {
            if (selectedElements.length >= maxSelections) return;
            
            const rect = overlay.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            let xpath;
            if (y < 20) {
                const index = Math.min(8, Math.max(1, Math.floor(x / 12.5) + 1));
                xpath = `/html/body/header//nav//li[${index}]//a[1]`;
            } else if (y > 80) {
                const index = Math.min(6, Math.max(1, Math.floor(x / 16.67) + 1));
                xpath = `/html/body/footer//li[${index}]//a[1]`;
            } else {
                const row = Math.min(4, Math.max(1, Math.floor((y-20) / 15) + 1));
                const col = Math.min(3, Math.max(1, Math.floor((x-15) / 23.33) + 1));
                xpath = `/html/body//main//section[${row}]//div[${col}]//a[1]`;
            }
            
            addElement({
                xpath: xpath,
                tag: 'element',
                text: 'Overlay selection'
            });
        };
        
        updateDisplay();
    }
    
    // Global functions
    window.removeXPathElement = removeElement;
    
    // Setup iframe
    iframe.src = `https://cors.seotize.workers.dev/?url=${encodeURIComponent(url)}`;
    iframe.setAttribute('scrolling', 'yes');
    iframe.style.cssText = 'width:100%;height:100%;border:none;overflow:auto;';
    
    window.addEventListener('message', handleMessage);
    
    iframe.onload = () => {
        loader.style.display = 'none';
        iframe.style.display = 'block';
        
        setTimeout(() => {
            const script = `
                (function() {
                    console.log('Injecting XPath selector...');
                    
                    try {
                        let selectedElements = new Map();
                        let selectedCount = 0;
                        const maxSelections = ${maxSelections};
                        let isActive = true;
                        
                        document.documentElement.style.overflow = 'auto';
                        document.body.style.overflow = 'auto';
                        document.body.style.height = 'auto';
                        
                        const style = document.createElement('style');
                        style.textContent = \`
                            .xpath-hover { 
                                outline: 3px solid #3b82f6 !important; 
                                background: rgba(59, 130, 246, 0.1) !important; 
                                cursor: crosshair !important;
                            }
                            .xpath-selected { 
                                outline: 3px solid #10b981 !important; 
                                background: rgba(16, 185, 129, 0.15) !important; 
                                position: relative !important;
                            }
                            .xpath-marker { 
                                position: absolute !important; 
                                top: -12px !important; 
                                left: -12px !important; 
                                background: #10b981 !important; 
                                color: white !important; 
                                width: 20px !important; 
                                height: 20px !important; 
                                border-radius: 50% !important; 
                                display: flex !important; 
                                align-items: center !important; 
                                justify-content: center !important; 
                                font: bold 11px sans-serif !important; 
                                z-index: 999999 !important; 
                                border: 2px solid white !important;
                                pointer-events: none !important;
                            }
                            body { 
                                overflow: auto !important; 
                                height: auto !important;
                                user-select: none !important;
                            }
                        \`;
                        document.head.appendChild(style);
                        
                        function generateXPath(element) {
                            if (element.id && document.querySelectorAll('#' + element.id).length === 1) {
                                return '//*[@id="' + element.id + '"]';
                            }
                            
                            const path = [];
                            let current = element;
                            
                            while (current && current.nodeType === 1 && current !== document.documentElement) {
                                let selector = current.tagName.toLowerCase();
                                
                                if (current.className && typeof current.className === 'string') {
                                    const classes = current.className.trim();
                                    if (classes && !classes.includes('xpath-')) {
                                        selector += '[@class="' + classes + '"]';
                                    }
                                }
                                
                                const siblings = Array.from(current.parentElement?.children || [])
                                    .filter(s => s.tagName === current.tagName);
                                
                                if (siblings.length > 1) {
                                    const index = siblings.indexOf(current) + 1;
                                    if (index > 0) selector += '[' + index + ']';
                                }
                                
                                path.unshift(selector);
                                current = current.parentElement;
                            }
                            
                            return '//' + path.join('/');
                        }
                        
                        function onMouseOver(e) {
                            if (!isActive || selectedElements.has(e.target)) return;
                            
                            document.querySelectorAll('.xpath-hover').forEach(el => 
                                el.classList.remove('xpath-hover')
                            );
                            e.target.classList.add('xpath-hover');
                        }
                        
                        function onMouseOut(e) {
                            if (!isActive) return;
                            e.target.classList.remove('xpath-hover');
                        }
                        
                        function onClick(e) {
                            if (!isActive) return;
                            
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            if (selectedElements.has(e.target)) return false;
                            if (selectedCount >= maxSelections) return false;
                            if (e.target.classList.contains('xpath-marker')) return false;
                            
                            const xpath = generateXPath(e.target);
                            if (!xpath) return false;
                            
                            e.target.classList.remove('xpath-hover');
                            e.target.classList.add('xpath-selected');
                            
                            const marker = document.createElement('div');
                            marker.className = 'xpath-marker';
                            marker.textContent = selectedCount + 1;
                            marker.dataset.id = 'xpath_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            
                            e.target.style.position = 'relative';
                            e.target.appendChild(marker);
                            
                            selectedElements.set(e.target, {
                                id: marker.dataset.id,
                                marker: marker,
                                xpath: xpath
                            });
                            selectedCount++;
                            
                            window.parent.postMessage({
                                type: 'xpath_selected',
                                data: {
                                    id: marker.dataset.id,
                                    xpath: xpath,
                                    text: (e.target.textContent || '').trim().slice(0, 50),
                                    tag: e.target.tagName.toLowerCase()
                                }
                            }, '*');
                            
                            return false;
                        }
                        
                        function onMessage(e) {
                            if (e.data.type === 'remove_element') {
                                for (const [element, data] of selectedElements.entries()) {
                                    if (data.id === e.data.id) {
                                        element.classList.remove('xpath-selected');
                                        if (data.marker) data.marker.remove();
                                        selectedElements.delete(element);
                                        selectedCount--;
                                        
                                        let index = 1;
                                        for (const [el, elData] of selectedElements.entries()) {
                                            if (elData.marker) elData.marker.textContent = index++;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        document.addEventListener('mouseover', onMouseOver, { capture: true, passive: true });
                        document.addEventListener('mouseout', onMouseOut, { capture: true, passive: true });
                        document.addEventListener('click', onClick, { capture: true, passive: false });
                        window.addEventListener('message', onMessage);
                        
                        window.xpathCleanup = function() {
                            isActive = false;
                            document.removeEventListener('mouseover', onMouseOver, true);
                            document.removeEventListener('mouseout', onMouseOut, true);
                            document.removeEventListener('click', onClick, true);
                            window.removeEventListener('message', onMessage);
                            
                            selectedElements.forEach(data => {
                                if (data.marker) data.marker.remove();
                            });
                            selectedElements.clear();
                        };
                        
                        window.parent.postMessage({ type: 'iframe_ready' }, '*');
                        
                    } catch (error) {
                        console.error('XPath selector failed:', error);
                        window.parent.postMessage({ type: 'fallback_to_overlay' }, '*');
                    }
                })();
            `;
            
            try {
                const doc = iframe.contentDocument;
                if (doc && doc.body) {
                    const scriptEl = doc.createElement('script');
                    scriptEl.textContent = script;
                    doc.body.appendChild(scriptEl);
                } else {
                    useOverlayMode = true;
                    setupOverlay();
                }
            } catch (e) {
                useOverlayMode = true;
                setupOverlay();
            }
        }, 1500);
    };
    
    iframe.onerror = () => {
        loader.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--danger)">Failed to load website</div>';
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    setZoom(zoomLevel + 0.25);
                    break;
                case '-':
                    e.preventDefault();
                    setZoom(zoomLevel - 0.25);
                    break;
                case '0':
                    e.preventDefault();
                    setZoom(1);
                    break;
            }
        }
    });
    
    // Cleanup
    function cleanup() {
        window.removeEventListener('message', handleMessage);
        
        try {
            iframe.contentWindow?.postMessage({ type: 'cleanup' }, '*');
        } catch (e) {}
        
        if (iframe.contentWindow?.xpathCleanup) {
            iframe.contentWindow.xpathCleanup();
        }
        
        overlay.innerHTML = '';
        overlay.style.display = 'none';
        window.removeXPathElement = null;
    }
    
    iframe.xpathCleanup = cleanup;
    
    // Initialize
    updateDisplay();
    updateZoomControls();
    
    return {
        getSelectedElements: () => [...selectedElements],
        clearSelections: () => {
            selectedElements = [];
            currentData.selectedLocations = [];
            if (!useOverlayMode) {
                try {
                    iframe.contentWindow?.postMessage({ type: 'clear_all' }, '*');
                } catch (e) {}
            }
            overlay.innerHTML = '';
            updateDisplay();
        },
        setZoom,
        destroy: cleanup
    };
}


// Get priority max locations
function getPriorityMaxLocations(priority) {
    const limits = { basic: 1, standard: 3, premium: 5 };
    return limits[priority] || 3;
}

// Generate XPath based on click position
function generateXPath(x, y, index) {
    // Enhanced XPath generation based on click position
    const sections = [
        '/html/body/header//a',
        '/html/body/nav//a',
        '/html/body/main//a',
        '/html/body/section//a',
        '/html/body/aside//a',
        '/html/body/footer//a'
    ];

    let sectionIndex = Math.floor((y / 100) * sections.length);
    if (sectionIndex >= sections.length) sectionIndex = sections.length - 1;

    const elementIndex = Math.max(1, Math.floor((x / 100) * 10) + 1);
    return `${sections[sectionIndex]}[${elementIndex}]`;
}

// Set zoom for website preview
function setZoom(scale) {
    const iframe = document.getElementById('taskPreviewFrame');
    if (iframe) {
        iframe.style.transform = `scale(${scale})`;
        iframe.style.transformOrigin = '0 0';
        iframe.style.width = `${100/scale}%`;
        iframe.style.height = `${100/scale}%`;
    }
}



// Update order summary
function updateOrderSummary() {
    const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
    const priority = currentData.taskPriority;
    const keywordCount = currentData.selectedKeywords.length;
    const locationCount = currentData.selectedLocations.length;
    const paymentType = document.getElementById('paymentType')?.value || 'one-time';

    // Update all order summary elements if they exist
    const orderBudget = document.getElementById('orderBudget');
    const orderPriority = document.getElementById('orderPriority');
    const orderKeywords = document.getElementById('orderKeywords');
    const orderLocations = document.getElementById('orderLocations');
    const orderTotal = document.getElementById('orderTotal');

    if (orderBudget) orderBudget.textContent = `$${budget.toFixed(2)}`;
    if (orderPriority) orderPriority.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
    if (orderKeywords) orderKeywords.textContent = keywordCount;
    if (orderLocations) orderLocations.textContent = locationCount;
    if (orderTotal) orderTotal.textContent = `$${budget.toFixed(2)}${paymentType === 'subscription' ? '/mo' : ''}`;

    console.log('Order summary updated:', { budget, priority, keywordCount, locationCount }); // Debug log
}

// Toggle subscription options
function toggleSubscriptionOptions() {
    const paymentType = document.getElementById('paymentType')?.value;
    const subscriptionOptions = document.getElementById('subscriptionOptions');

    if (subscriptionOptions) {
        if (paymentType === 'subscription') {
            subscriptionOptions.style.display = 'block';
        } else {
            subscriptionOptions.style.display = 'none';
        }
    }

    updateOrderSummary();
}



// ADD THIS NEW, ALL-IN-ONE AND CORRECTED FUNCTION
async function showTaskModal() {
    // Reset state before showing the modal
    currentData.currentStep = 1;
    currentData.selectedLocations = [];
    currentData.selectedKeywords = [];
    currentData.taskPriority = 'standard';

    const modalHtml = `
    <div style="text-align: left;">
        <div class="step-content active" id="step1">
            <div class="form-group">
                <label class="form-label">Website URL</label>
                <input type="url" class="form-input" id="taskUrl" required placeholder="https://example.com">
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    Enter the full URL of your website.
                </small>
            </div>
            <div class="form-group">
                <label class="form-label">Task Priority</label>
                <div class="priority-options">
                    <div class="priority-option" data-priority="basic">
                        <div class="priority-title">Basic</div>
                        <div class="priority-price">$0.10/click</div>
                        <div class="priority-locations">1 location</div>
                    </div>
                    <div class="priority-option selected" data-priority="standard">
                        <div class="priority-title">Standard</div>
                        <div class="priority-price">$0.12/click</div>
                        <div class="priority-locations">3 locations</div>
                    </div>
                    <div class="priority-option" data-priority="premium">
                        <div class="priority-title">Premium</div>
                        <div class="priority-price">$0.15/click</div>
                        <div class="priority-locations">5 locations</div>
                    </div>
                </div>
            </div>
            <div class="step-navigation">
                <div></div> <button class="btn btn-primary" id="goToStep3Btn">Next: Keywords & Payment</button>
            </div>
        </div>

        <div class="step-content" id="step3">
            <div class="form-group">
                <label class="form-label">Keywords</label>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <input type="text" class="form-input" id="keywordsInput" placeholder="Enter keywords separated by commas">
                    <button class="btn btn-secondary" id="aiKeywordsBtn">
                        <i class="ri-magic-line"></i> AI Suggest
                    </button>
                </div>
                <div id="keywordSuggestions" class="keyword-suggestions"></div>
                <div id="selectedKeywordsDisplay" style="margin-top: 1rem;"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Total Budget ($)</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: 500;">$</span>
                        <input type="number" class="form-input" id="taskBudget" min="10" value="150" style="padding-left: 2rem; font-size: 1rem; font-weight: 500;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Clicks</label>
                    <input type="text" class="form-input" id="estimatedClicks" readonly>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="stripe">Stripe (Credit/Debit Cards)</option>
                        <option value="oxapay">OxaPay (Cryptocurrency)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Type</label>
                    <select class="form-select" id="paymentType">
                        <option value="one-time">One-time Payment</option>
                        <option value="subscription">Recurring Subscription</option>
                    </select>
                </div>
            </div>

            <div id="subscriptionOptions" style="display: none; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Billing Cycle</label>
                    <select class="form-select" id="billingCycle">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly (3 months)</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
            </div>
            <div id="cancelPreviousContainer" style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="checkbox" id="cancelPrevious" style="margin-top: 0.25rem;">
                    <label for="cancelPrevious" style="font-size: 0.875rem; cursor: pointer;">
                        <strong>Cancel Previous Tasks</strong><br>
                        <span style="color: var(--text-secondary);">Automatically cancel any pending or active payments for previous tasks. This will stop any ongoing SEO campaigns and refund unused credits.</span>
                    </label>
                </div>
                <div id="previousTasksWarning" style="display: none; background: var(--warning); color: white; padding: 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem;">
                    <i class="ri-alert-line"></i> This will cancel <span id="previousTaskCount">0</span> active task(s) and any pending payments.
                </div>
            </div>

            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body">
                    <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Order Summary</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span>Task Budget:</span><span id="orderBudget">$150.00</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"><span>Priority:</span><span id="orderPriority">Standard</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"><span>Keywords:</span><span id="orderKeywords">0</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"><span>Click Locations:</span><span id="orderLocations">0</span></div>
                    <div style="border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.25rem;"><span>Total:</span><span id="orderTotal">$150.00</span></div>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="btn btn-secondary" id="backToStep1Btn">Back</button>
                <button class="btn btn-primary" id="createTaskBtn">
                    <i class="ri-wallet-line"></i> Create Task & Pay
                </button>
            </div>
        </div>
    </div>
    `;

    Swal.fire({
        title: 'Create New SEO Task',
        html: modalHtml,
        width: '95vw',
        maxWidth: '900px',
        showCloseButton: true,
        showConfirmButton: false,
        showCancelButton: false,
        
        didOpen: () => {
            // --- NESTED HELPER FUNCTIONS ---
            
            const goToStep = (step) => {
                if (currentData.currentStep === 1 && step === 3) {
                    const url = document.getElementById('taskUrl').value.trim();
                    if (!url) {
                        showToast('Please enter a valid URL', 'error');
                        return;
                    }
                    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);
                    currentData.selectedLocations = Array(maxLocations).fill('-');
                }
                document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
                const targetStep = document.getElementById(`step${step}`);
                if (targetStep) {
                    targetStep.classList.add('active');
                    currentData.currentStep = step;
                    updateOrderSummary();
                }
            };

            const selectPriority = (priority) => {
                document.querySelectorAll('.priority-option').forEach(option => option.classList.remove('selected'));
                const selectedOption = document.querySelector(`.priority-option[data-priority="${priority}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                    currentData.taskPriority = priority;
                    updateOrderSummary();
                }
            };

            // ADDED LOGIC: Show/hide subscription options
            const toggleSubscriptionOptions = () => {
                const paymentType = document.getElementById('paymentType').value;
                const subscriptionOptions = document.getElementById('subscriptionOptions');
                subscriptionOptions.style.display = (paymentType === 'subscription') ? 'block' : 'none';
                updateOrderSummary();
            };
            
            const updateOrderSummary = () => {
                const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
                const priority = currentData.taskPriority;
                const keywordCount = currentData.selectedKeywords.length;
                const locationCount = getPriorityMaxLocations(priority);
                const paymentType = document.getElementById('paymentType')?.value || 'one-time'; // ADDED
                const rates = { basic: 0.10, standard: 0.12, premium: 0.15 };
                const rate = rates[priority] || 0.12;
                const estimatedClicks = Math.floor(budget / rate);

                document.getElementById('estimatedClicks').value = estimatedClicks.toLocaleString() + ' clicks';
                document.getElementById('orderBudget').textContent = `$${budget.toFixed(2)}`;
                document.getElementById('orderPriority').textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
                document.getElementById('orderKeywords').textContent = keywordCount;
                document.getElementById('orderLocations').textContent = locationCount;
                // MODIFIED: Add subscription text to total
                document.getElementById('orderTotal').textContent = `$${budget.toFixed(2)}${paymentType === 'subscription' ? '/mo' : ''}`;
            };

            const toggleKeyword = (keyword, element) => {
                const index = currentData.selectedKeywords.indexOf(keyword);
                if (index === -1) {
                    currentData.selectedKeywords.push(keyword);
                    if (element) element.classList.add('selected');
                } else {
                    currentData.selectedKeywords.splice(index, 1);
                    if (element) element.classList.remove('selected');
                }
                updateSelectedKeywordsDisplay();
            };

            const updateSelectedKeywordsDisplay = () => {
                const container = document.getElementById('selectedKeywordsDisplay');
                document.getElementById('keywordsInput').value = currentData.selectedKeywords.join(', ');
                if (currentData.selectedKeywords.length === 0) {
                    container.innerHTML = '';
                } else {
                    container.innerHTML = `
                        <strong style="font-size: 0.9rem;">Selected Keywords (${currentData.selectedKeywords.length}):</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                            ${currentData.selectedKeywords.map(keyword => `
                                <span class="badge badge-primary" data-keyword-badge="${keyword}">
                                    ${keyword} <span class="remove-keyword" style="cursor: pointer; margin-left: 0.25rem;">?</span>
                                </span>
                            `).join('')}
                        </div>`;
                }
                updateOrderSummary();
            };
            
            const generateAIKeywords = async () => {
                const url = document.getElementById('taskUrl').value;
                const btn = document.getElementById('aiKeywordsBtn');
                if (!url) {
                    showToast('Please enter a URL first', 'error');
                    return;
                }
                btn.innerHTML = '<i class="ri-loader-line"></i> Generating...';
                btn.disabled = true;
                try {
                    const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, { headers: { 'Session-Token': sessionToken } });
                    if (!response.ok) throw new Error('Failed to generate keywords');
                    const data = await response.json();
                    const container = document.getElementById('keywordSuggestions');
                    container.innerHTML = (data.keywords || []).slice(0, 15).map(keyword =>
                        `<span class="keyword-suggestion">${keyword}</span>`
                    ).join('');
                } catch (error) {
                    showToast('Failed to generate AI keywords', 'error');
                } finally {
                    btn.innerHTML = '<i class="ri-magic-line"></i> AI Suggest';
                    btn.disabled = false;
                }
            };
            
            const checkForActiveTasks = () => {
                const activeTasks = (currentData.user?.tasks || []).filter(task => task.available_charge > 0);
                const container = document.getElementById('cancelPreviousContainer');
                if (activeTasks.length > 0) {
                    container.style.display = 'block';
                    document.getElementById('previousTaskCount').textContent = activeTasks.length;
                    document.getElementById('cancelPrevious').addEventListener('change', (e) => {
                        document.getElementById('previousTasksWarning').style.display = e.target.checked ? 'block' : 'none';
                    });
                }
            };

            const createTask = async () => {
                // MODIFIED: Gather new values
                const url = document.getElementById('taskUrl').value.trim();
                const budget = parseFloat(document.getElementById('taskBudget').value);
                const keywords = currentData.selectedKeywords;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentType = document.getElementById('paymentType').value;
                const billingCycle = document.getElementById('billingCycle')?.value;
                const cancelPrevious = document.getElementById('cancelPrevious').checked;
                
                if (!url || !/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(url)) {
                    return showToast('Please enter a valid URL', 'error');
                }
                if (!keywords.length) {
                    return showToast('Please add at least one keyword', 'error');
                }
                if (!budget || budget < 10) {
                    return showToast('Minimum budget is $10', 'error');
                }

                // MODIFIED: Build the complete task data object
                const taskData = {
                    task_details: {
                        url: url.startsWith('http') ? url : `https://${url}`,
                        keywords: keywords,
                        html_locations: currentData.selectedLocations
                    },
                    task_priority: currentData.taskPriority,
                    total_charge: budget,
                    payment_method: paymentMethod,
                    is_subscription: paymentType === 'subscription',
                    cancel_previous: cancelPrevious
                };

                if (taskData.is_subscription && billingCycle) {
                    taskData.billing_cycle = billingCycle;
                }

                Swal.fire({
                    title: 'Creating Task...',
                    didOpen: () => Swal.showLoading(),
                    allowOutsideClick: false,
                    customClass: { popup: 'swal2-toast' }
                });

                try {
                    const response = await api('/add-task', {
                        method: 'POST',
                        body: JSON.stringify(taskData)
                    });
                    
                    if (response.data?.payment_url) {
                        window.open(response.data.payment_url, '_blank');
                        Swal.close();
                        showToast('Task created! Complete payment to activate.', 'success');
                    } else {
                        Swal.close();
                        showToast('Task created successfully!', 'success');
                    }
                    
                    if (document.querySelector('.nav-item[data-page="tasks"]').classList.contains('active')) {
                        loadTasks();
                    } else {
                        loadDashboard();
                    }

                } catch (error) {
                    // Handle 409 error for pending tasks
                    if (error.code === 409 && error.message === 'Pending task exists') {
                        // Show the cancel previous tasks container
                        document.getElementById('cancelPreviousContainer').style.display = 'block';
                        
                        // Scroll to the checkbox
                        document.getElementById('cancelPreviousContainer').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        
                        Swal.fire({
                            icon: 'warning',
                            title: 'Pending Task Exists',
                            html: 'You have a pending task from the last 24 hours.<br><br>Please check the <strong>"Cancel Previous Tasks"</strong> option below to cancel it and create a new task.',
                            confirmButtonText: 'Got it',
                            customClass: { popup: 'swal2-toast' }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Creation Failed',
                            text: error.message || 'An unexpected error occurred.',
                            customClass: { popup: 'swal2-toast' }
                        });
                    }
                }
            };

            // --- ATTACH EVENT LISTENERS ---
            
            document.querySelectorAll('.priority-option').forEach(el => {
                el.addEventListener('click', () => selectPriority(el.dataset.priority));
            });

            document.getElementById('goToStep3Btn').addEventListener('click', () => goToStep(3));
            document.getElementById('backToStep1Btn').addEventListener('click', () => goToStep(1));
            document.getElementById('aiKeywordsBtn').addEventListener('click', generateAIKeywords);
            document.getElementById('taskBudget').addEventListener('input', updateOrderSummary);
            document.getElementById('createTaskBtn').addEventListener('click', createTask);

            // ADDED: Listener for payment type change
            document.getElementById('paymentType').addEventListener('change', toggleSubscriptionOptions);

            // Unchanged listeners...
            document.getElementById('keywordSuggestions').addEventListener('click', (e) => {
                if (e.target.classList.contains('keyword-suggestion')) {
                    toggleKeyword(e.target.textContent, e.target);
                }
            });
            document.getElementById('selectedKeywordsDisplay').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-keyword')) {
                    const badge = e.target.closest('.badge');
                    const keyword = badge.dataset.keywordBadge;
                    const suggestionEl = document.querySelector(`.keyword-suggestion.selected`);
                    if (suggestionEl && suggestionEl.textContent === keyword) {
                        suggestionEl.classList.remove('selected');
                    }
                    toggleKeyword(keyword, null);
                }
            });
            document.getElementById('keywordsInput').addEventListener('change', (e) => {
                currentData.selectedKeywords = e.target.value.split(',').map(k => k.trim()).filter(Boolean);
                updateSelectedKeywordsDisplay();
            });

            // --- INITIALIZE ---
            checkForActiveTasks();
            updateOrderSummary();
        }
    });
}



// [NEW] Rebuilt Task Details Modal using SweetAlert2
async function viewTaskDetails(taskId) {
    try {
        const response = await api('/get-task-details', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });
        const task = response.data;

        // --- 1. Process Data (All original logic preserved) ---
        const totalCharge = task.total_charge || 0;
        const availableCharge = task.available_charge || 0;
        const usedCharge = Math.max(0, totalCharge - availableCharge);
        const remainingPercentage = totalCharge > 0 ? (availableCharge / totalCharge) * 100 : 0;
        const priorityRate = parseFloat(task.task_priority) || 0.12;
        const priorityName = priorityRate <= 0.10 ? 'Basic' : priorityRate <= 0.12 ? 'Standard' : 'Premium';
        const priorityBadge = priorityName === 'Basic' ? 'warning' : priorityName === 'Standard' ? 'primary' : 'success';

        const viewsByDate = task.views_by_date || {};
        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
        const totalViews = Object.values(viewsByDate).reduce((sum, views) => sum + views, 0);
        const hasAnalytics = sortedDates.length > 0;

        // --- 2. Construct Modal HTML (New Responsive Layout) ---
        const modalHtml = `
        <div class="task-details-modal-container">
            <div class="task-modal-header">
                <h3>${task.url}</h3>
                <div class="header-meta">
                    <span><i class="ri-calendar-line"></i> Created: ${new Date(task.date_created).toLocaleString()}</span>
                    <span><i class="ri-key-line"></i> ID: ${task._id}</span>
                </div>
            </div>

            <div class="task-modal-stat-grid">
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--success);">$${totalCharge.toFixed(2)}</div>
                    <div class="stat-label">Total Budget</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--primary);">$${availableCharge.toFixed(2)}</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--warning);">$${usedCharge.toFixed(2)}</div>
                    <div class="stat-label">Used</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--info);">${formatNumber(totalViews)}</div>
                    <div class="stat-label">Total Views</div>
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <span style="font-weight: 600;">Budget Remaining</span>
                    <span style="color: var(--text-secondary);">${remainingPercentage.toFixed(1)}%</span>
                </div>
                <div class="progress-bar" style="height: 10px;">
                    <div class="progress-fill" style="width: ${remainingPercentage}%; background: ${remainingPercentage >= 50 ? 'var(--success)' : remainingPercentage >= 20 ? 'var(--warning)' : 'var(--error)'};"></div>
                </div>
            </div>

            <div class="task-modal-grid">
                ${hasAnalytics ? `
                    <div class="task-modal-section">
                        <h3 class="task-modal-section-title" style="color: var(--primary);"><i class="ri-line-chart-line"></i>Views Analytics</h3>
                        <div style="height: 250px; margin-bottom: 1.5rem;"><canvas id="taskViewsTimelineChart"></canvas></div>
                        <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Daily Breakdown</h4>
                        <div class="views-by-date-list">
                            ${sortedDates.map(([date, views]) => `
                                <div class="list-item">
                                    <span>${new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                    <span class="badge badge-primary">${formatNumber(views)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="task-modal-section">
                        <div class="empty-state" style="padding: 1rem 0;">
                            <div class="empty-state-icon"><i class="ri-bar-chart-line"></i></div>
                            <div class="empty-state-title" style="font-size: 1.2rem;">No Analytics Yet</div>
                            <p class="empty-state-description">View data will appear here once the campaign receives traffic.</p>
                        </div>
                    </div>
                `}

                <div class="task-modal-section">
                  <style>
                    .install-instructions {
                      background-color: var(--bg-tertiary);
                      border: 1px solid var(--border);
                      border-radius: 8px;
                      padding: 1rem;
                      margin-top: 0.5rem;
                      font-size: 0.85rem;
                      line-height: 1.6;
                      color: var(--text);
                    }
                    .install-instructions p {
                      color: var(--text);
                    }
                    .install-instructions strong {
                      color: var(--text);
                    }
                    .install-instructions code {
                      display: block;
                      background: #282c34;
                      color: #f8f8f2;
                      padding: 0.75rem;
                      border-radius: 6px;
                      overflow-x: auto;
                      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
                      margin-top: 0.5rem;
                      font-size: 0.8rem;
                    }
                    .copy-btn {
                      background-color: var(--info);
                      color: white;
                      border: none;
                      padding: 0.4rem 0.8rem;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 0.8rem;
                      margin-top: 0.5rem;
                    }
                    .copy-btn:hover {
                      background-color: #0a7ac2;
                    }
                  </style>
                
                  <h3 class="task-modal-section-title" style="color: var(--info);">
                    <i class="ri-settings-3-line"></i>Configuration
                  </h3>
                
                  <div style="font-size: 0.9rem; line-height: 2;">
                    <p>
                      <strong>Priority:</strong>
                      <span class="badge badge-${priorityBadge}">${priorityName}</span>
                      ($${priorityRate.toFixed(3)}/click)
                    </p>
                
                    <p><strong>Keywords:</strong></p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: -0.5rem;">
                      ${(task.keywords || []).map(k => `<span class="badge badge-primary">${k}</span>`).join('')}
                    </div>
                
                    ${task.sitekey ? `
                      <div class="install-instructions">
                        <p><strong>Installation Instruction:</strong></p>
                        <p>Add the following code into your website?s &lt;head&gt; section, right before &lt;/head&gt;:</p>
                        <code id="install-code">&lt;script type="text/javascript" src="https://seotize.net/seotize-engine.js?id=${task.sitekey}"&gt;&lt;/script&gt;</code>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('install-code').innerText)">Copy Code</button>
                      </div>
                    ` : ''}
                  </div>
                </div>


                
            </div>
        </div>
        `;

        // --- 3. Fire SweetAlert2 Modal ---
        Swal.fire({
            html: modalHtml,
            showCloseButton: true,
            showConfirmButton: false,
            width: '95vw',
            maxWidth: '1100px', // Large on desktop, as requested
            padding: '1.5rem',
            customClass: { 
                popup: 'swal2-toast swal2-popup-custom-task',
                closeButton: 'swal2-close'
            }, 
            showClass: { popup: 'swal2-show-super-fast' },
            hideClass: { popup: 'swal2-hide-super-fast' },
            didOpen: () => {
                if (hasAnalytics) {
                    initializeTaskAnalyticsChart(sortedDates);
                }
            },
            // Add action buttons to the footer for better UX
            showDenyButton: true,
            showCancelButton: true,
            denyButtonText: `<i class="ri-wallet-line"></i> Recharge`,
            cancelButtonText: `<i class="ri-external-link-line"></i> View Website`,

        }).then((result) => {
            if (result.isDenied) {
                // The "Recharge" button was clicked
                rechargeTask(taskId);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                // The "View Website" button was clicked
                window.open(task.url, '_blank');
            }
        });

    } catch (error) {
        console.error('Task details error:', error);
        showToast('Failed to load task details', 'error');
    }
}

// [NEW] Helper function to initialize the chart inside the task modal
function initializeTaskAnalyticsChart(sortedDates) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#a0a0a0' : '#6c757d';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    
    const timelineCtx = document.getElementById('taskViewsTimelineChart');
    if (timelineCtx) {
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: sortedDates.map(([date]) => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                datasets: [{
                    label: 'Views',
                    data: sortedDates.map(([, views]) => views),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true }
                }
            }
        });
    }
}
// Recharge Task
// [NEW] Rebuilt Recharge Task Modal using SweetAlert2
async function rechargeTask(taskId) {
    // Find the task to show its URL in the modal
    const task = currentData.tasks.find(t => t._id === taskId);
    const taskUrl = task ? task.url : `Task ID: ${taskId}`;

    const modalHtml = `
    <div class="recharge-modal-container">
        <div class="recharge-modal-section">
            <label class="recharge-modal-label">Choose an amount to add:</label>
            <div class="recharge-preset-amounts">
                <button class="recharge-preset-btn" data-amount="25">$25</button>
                <button class="recharge-preset-btn" data-amount="50">$50</button>
                <button class="recharge-preset-btn" data-amount="100">$100</button>
                <button class="recharge-preset-btn" data-amount="200">$200</button>
            </div>
            <label class="recharge-modal-label">Or enter a custom amount (min $10):</label>
            <input type="number" id="rechargeAmount" class="form-input" min="10" value="50" placeholder="">
        </div>

        <div class="recharge-modal-section">
            <label class="recharge-modal-label">Select payment method:</label>
            <div class="recharge-payment-options">
                <div class="recharge-payment-option selected" id="payment-stripe" data-provider="stripe">
                    <i class="ri-bank-card-line"></i>
                    <div class="provider-name">Card (Stripe)</div>
                </div>
                <div class="recharge-payment-option" id="payment-oxapay" data-provider="oxapay">
                    <i class="ri-bit-coin-line"></i>
                    <div class="provider-name">Crypto (OxaPay)</div>
                </div>
            </div>
        </div>

        <div class="recharge-summary">
            <div class="recharge-summary-item">
                <span>Recharging Task:</span>
                <strong style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${taskUrl}">${taskUrl}</strong>
            </div>
            <div class="recharge-summary-item" style="border-top: 1px solid var(--border); margin-top: 0.5rem; padding-top: 0.5rem;">
                <strong style="font-size: 1.1rem;">Total to Add:</strong>
                <strong id="rechargeTotal" style="font-size: 1.2rem; color: var(--primary);">$50.00</strong>
            </div>
        </div>
    </div>
    `;

    Swal.fire({
        title: 'Recharge Task Budget',
        html: modalHtml,
        showCancelButton: true,
        cancelButtonText: 'Cancel',
        confirmButtonText: '<i class="ri-wallet-3-line"></i> Proceed to Payment',
        confirmButtonColor: 'var(--primary)',
        // REMOVED width and maxWidth properties from here
        customClass: {
            popup: 'recharge-modal-custom' // ADDED our new class here
        },
        didOpen: () => {
            // --- Logic for the interactive modal ---
            const amountInput = document.getElementById('rechargeAmount');
            const totalDisplay = document.getElementById('rechargeTotal');

            const updateTotal = () => {
                const amount = parseFloat(amountInput.value) || 0;
                totalDisplay.textContent = `$${amount.toFixed(2)}`;
            };

            amountInput.addEventListener('input', updateTotal);

            document.querySelectorAll('.recharge-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    amountInput.value = btn.dataset.amount;
                    updateTotal();
                });
            });

            document.querySelectorAll('.recharge-payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.recharge-payment-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        },
        preConfirm: () => {
            // --- Gather data before confirming ---
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const provider = document.querySelector('.recharge-payment-option.selected').dataset.provider;

            if (!amount || amount < 10) {
                Swal.showValidationMessage('Minimum recharge amount is $10');
                return false;
            }

            return { amount, provider, taskId };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            const { amount, provider, taskId } = result.value;

            try {
                // This API call now correctly includes the amount
                const response = await api('/recharge', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_id: taskId,
                        amount: amount,
                        payment_method: provider
                    })
                });

                if (response.data.payment_url) {
                    Swal.fire({
                        title: 'Redirecting...',
                        text: 'Redirecting you to the payment page to complete your recharge.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false,
                        customClass: { popup: 'swal2-toast' }
                    });
                    window.open(response.data.payment_url, '_blank');
                } else {
                    showToast('Task recharged successfully!', 'success');
                }
                
                // Refresh the list to show the new budget
                if (document.querySelector('.nav-item[data-page="tasks"]').classList.contains('active')) {
                    loadTasks();
                } else {
                    loadDashboard();
                }

            } catch (error) {
                Swal.fire('Error!', 'Failed to initiate recharge: ' + error.message, 'error');
            }
        }
    });
}

// ADD THIS NEW, UNIFIED FUNCTION
async function showDomainModal() {
    const modalHtml = `
    <div style="text-align: left;">
        <div class="form-group">
            <label class="form-label">Domain URL</label>
            <input type="text" id="swal-domain-url" class="form-input" name="url" required placeholder="example.com/blog">
            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                Enter your domain or subdomain where articles will be published.
            </small>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin-top: 1.5rem;">
            <p style="font-size: 0.875rem; margin: 0;">
                <strong>Note:</strong> You will need to verify ownership by adding a TXT record to your DNS settings after adding the domain.
            </p>
        </div>
    </div>
    `;

    Swal.fire({
        title: 'Add New Domain',
        html: modalHtml,
        showCloseButton: true, // Adds the 'X' button
        confirmButtonText: 'Add Domain',
        confirmButtonColor: 'var(--primary)',
        showCancelButton: true,
        customClass: {
            popup: 'swal2-toast', // Use our theme
        },
        didOpen: () => {
            // Focus the input field when the modal opens
            document.getElementById('swal-domain-url').focus();
        },
        preConfirm: () => {
            // Validate the input before closing the modal
            const url = document.getElementById('swal-domain-url').value;
            if (!url) {
                Swal.showValidationMessage('Please enter a domain URL.');
                return false;
            }
            return url;
        }
    }).then(async (result) => {
        // This block runs only if preConfirm validation passes
        if (result.isConfirmed) {
            const url = result.value;

            Swal.fire({
                title: 'Adding Domain...',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                customClass: { popup: 'swal2-toast' }
            });

            try {
                const response = await api('/add-domain', {
                    method: 'POST',
                    body: JSON.stringify({ url: url })
                });

                // If a TXT record is returned, open the verification instructions modal
                if (response.data.txt_record) {
                    showVerificationInstructions(url, response.data.txt_record);
                } else {
                    // Otherwise, the domain might be auto-verified
                    Swal.close();
                    showToast('Domain added and verified successfully!', 'success');
                    loadArticles();
                }

            } catch (error) {
                console.error('Add domain error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to Add',
                    text: error.message,
                    customClass: { popup: 'swal2-toast' }
                });
            }
        }
    });
}

async function verifyDomain(url) {
    try {
        await api('/verify-domain', {
            method: 'POST',
            body: JSON.stringify({ url })
        });

        showToast('Domain verified successfully', 'success');
        closeModal();
        loadArticles();

    } catch (error) {
        console.error('Verify domain error:', error);
        showToast('Verification failed. Please check your DNS settings and try again.', 'error');
    }
}

function confirmDeleteDomain(domain) {
    Swal.fire({
        title: 'Delete Domain?',
        html: `<p style="margin: 0;">Are you sure you want to remove <strong>${domain}</strong> from your account?</p>
               <span style="display: block; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">If the domain was verified, related articles will also be removed.</span>`,
        icon: 'warning',
        showCancelButton: true,
        focusCancel: true,
        confirmButtonText: 'Delete',
        confirmButtonColor: '#d33',
        cancelButtonText: 'Cancel',
        customClass: { popup: 'swal2-toast' }
    }).then((result) => {
        if (result.isConfirmed) {
            deleteDomain(domain);
        }
    });
}

async function deleteDomain(domain) {
    Swal.fire({
        title: 'Deleting domain...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
        customClass: { popup: 'swal2-toast' }
    });

    try {
        await api('/delete-domain', {
            method: 'POST',
            body: JSON.stringify({ url: domain })
        });

        Swal.close();
        showToast('Domain deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        Swal.close();
        console.error('Delete domain error:', error);
        const message = error?.data?.message || error?.message || 'Failed to delete domain. Please try again.';
        showToast(message, 'error');
    }
}

// ADD THIS NEW, IMPROVED FUNCTION
function showVerificationInstructions(domain, txtRecord = '') {
    const modalHtml = `
    <div style="text-align: left;">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            To use <strong>${domain}</strong> for publishing articles, you must first prove you own it by adding a simple record to its DNS settings.
        </p>

        ${txtRecord ? `
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <h5 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text);">Your TXT Record:</h5>
                <div style="background: var(--bg); padding: 0.75rem; border-radius: var(--radius-sm); font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
                    ${txtRecord}
                </div>
            </div>
        ` : ''}

        <ol style="margin: 1.5rem 0; padding-left: 1.5rem;" class="mobileol">
            <li style="margin-bottom: 1rem;">
                <strong>Access your DNS provider:</strong> Log in to your domain registrar (like Cloudflare, GoDaddy, etc.).
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Find DNS management:</strong> Look for "DNS Settings" or "Zone Editor".
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Add a new TXT record</strong> with these settings:
                <ul style="margin-left: 1rem; margin-top: 0.5rem; list-style-type: disc;">
                    <li><strong>Type:</strong> TXT</li>
                    <li><strong>Name/Host:</strong> @ (or your root domain)</li>
                    <li><strong>Value/Content:</strong> Paste the TXT record from above.</li>
                </ul>
            </li>
            <li>
                <strong>Wait & Verify:</strong> DNS changes can take a few minutes or hours. Once done, click the "Verify Now" button.
            </li>
        </ol>
    </div>
    `;

    Swal.fire({
        title: 'Domain Verification',
        html: modalHtml,
        width: '95vw',
        maxWidth: '700px',
        showCloseButton: true, // Adds the 'X' button
        showConfirmButton: true,
        confirmButtonText: '<i class="ri-check-line"></i> Verify Now',
        confirmButtonColor: 'var(--primary)',
        showDenyButton: true,
        denyButtonText: '<i class="ri-file-copy-line"></i> Copy Record',
    }).then((result) => {
        if (result.isConfirmed) {
            // User clicked "Verify Now"
            verifyDomain(domain);
        } else if (result.isDenied) {
            // User clicked "Copy Record"
            copyToClipboard(txtRecord);
            // We return false to prevent the modal from closing, so they can see the 'copied' toast.
            return false; 
        }
    });
}





// ADD THIS NEW, IMPROVED FUNCTION
async function viewArticle(articleId) {
    try {
        const response = await api(`/dashboard/articles?article_id=${articleId}`);
        const article = response.data.article;

        // --- Data processing (This part is unchanged) ---
        const stats = article.stats || {};
        const countries = {}, browsers = {}, devices = {}, viewsByDate = {};
        Object.entries(stats).forEach(([month, monthStats]) => {
            if (monthStats.country) Object.entries(monthStats.country).forEach(([k, v]) => { countries[k.toUpperCase()] = (countries[k.toUpperCase()] || 0) + v; });
            if (monthStats.browser) Object.entries(monthStats.browser).forEach(([k, v]) => { browsers[k] = (browsers[k] || 0) + v; });
            if (monthStats.devices) Object.entries(monthStats.devices).forEach(([k, v]) => { devices[k] = (devices[k] || 0) + v; });
            if (monthStats.daily) Object.entries(monthStats.daily).forEach(([day, views]) => {
                const [year, monthNum] = month.split('-');
                const fullDate = `${year}-${monthNum}-${String(day).padStart(2, '0')}`;
                viewsByDate[fullDate] = (viewsByDate[fullDate] || 0) + views;
            });
        });
        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
        const haveStats = Object.keys(stats).length > 0;
        
        // --- Build new responsive HTML for Swal ---
        const modalHtml = `
        <div style="text-align: left;">
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                ${haveStats ? `
                    <div class="card">
                        <div class="card-header"><h3 class="card-title" style="font-size: 1rem;">Views Timeline</h3></div>
                        <div class="card-body" style="height: 220px; padding: 0.75rem;"><canvas id="articleViewsChart"></canvas></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title" style="font-size: 0.9rem;">Top Countries</h3></div>
                            <div class="card-body" style="height: 180px; padding: 0.75rem;"><canvas id="articleCountriesChart"></canvas></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title" style="font-size: 0.9rem;">Browsers</h3></div>
                            <div class="card-body" style="height: 180px; padding: 0.75rem;"><canvas id="articleBrowsersChart"></canvas></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title" style="font-size: 0.9rem;">Devices</h3></div>
                            <div class="card-body" style="height: 180px; padding: 0.75rem;"><canvas id="articleDevicesChart"></canvas></div>
                        </div>
                    </div>
                ` : `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <div class="empty-state-icon"><i class="ri-bar-chart-line"></i></div>
                        <div class="empty-state-title">No Analytics Yet</div>
                        <p class="empty-state-description">Data will appear once your article receives views.</p>
                    </div>
                `}

                ${article.images && article.images.length > 0 ? `
                    <div class="card">
                        <div class="card-header"><h3 class="card-title" style="font-size: 0.95rem;">Images (${article.images.length})</h3></div>
                        <div class="card-body" style="padding: 0.75rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.5rem;">
                                ${article.images.map(img => `
                                    <div onclick="window.open('${img}', '_blank')" style="cursor: pointer; aspect-ratio: 1; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-tertiary);">
                                        <img src="${img}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
                <div class="card">
                    <div class="card-header"><h3 class="card-title" style="font-size: 0.95rem;">Content Preview</h3></div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto; font-family: Georgia, serif; line-height: 1.6; font-size: 0.85rem; padding: 0.75rem;">
                        ${article.body}
                    </div>
                </div>
            </div>
        </div>
        `;

        Swal.fire({
            title: `<div style="text-align: left; line-height: 1.3; font-size: 1.2rem;">${article.subject}</div>`,
            html: modalHtml,
            width: '95vw',
            maxWidth: '1200px', // Allow it to be nice and wide on desktop
            showCloseButton: true, // Adds the 'X' button
            showConfirmButton: true,
            confirmButtonText: '<i class="ri-external-link-line"></i> View Live',
            confirmButtonColor: 'var(--primary)',
            showDenyButton: true,
            denyButtonText: '<i class="ri-edit-line"></i> Edit',
            showCancelButton: true,
            cancelButtonText: 'Delete',
            customClass: {
                actions: 'swal2-actions-separated', // Optional: adds a bit more space
                cancelButton: 'swal2-cancel btn-danger', // Style delete button
                closeButton: 'swal2-close'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                window.open(`https://${article.url}`, '_blank');
            } else if (result.isDenied) {
                editArticle(articleId);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                // We call your existing confirm delete logic
                deleteArticle(articleId); 
            }
        });
        
        // Initialize charts after the modal is in the DOM
        setTimeout(() => {
            initializeArticleCharts(countries, browsers, devices, sortedDates);
        }, 100);

    } catch (error) {
        console.error('View article error:', error);
        showToast('Failed to load article details', 'error');
    }
}

// Charts
function initializeArticleCharts(countries, browsers, devices, sortedDates) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 0 },
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: textColor,
                    usePointStyle: true,
                    padding: 6,
                    font: { size: 10 }
                }
            },
            tooltip: {
                backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)',
                titleColor: textColor,
                bodyColor: textColor,
                borderWidth: 1,
                cornerRadius: 6,
                padding: 8,
                titleFont: { size: 11 },
                bodyFont: { size: 10 }
            }
        }
    };

    // Timeline
    if (sortedDates && sortedDates.length > 0) {
        const viewsChart = document.getElementById('articleViewsChart');
        if (viewsChart) {
            new Chart(viewsChart, {
                type: 'line',
                data: {
                    labels: sortedDates.map(([date]) =>
                        new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    ),
                    datasets: [{
                        label: 'Views',
                        data: sortedDates.map(([, views]) => views),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.12)',
                        tension: 0.35,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2.5,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, maxRotation: 0, autoSkipPadding: 8 }
                        },
                        y: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, beginAtZero: true }
                        }
                    },
                    plugins: { ...commonOptions.plugins, legend: { display: false } }
                }
            });
        }
    }

    // Doughnuts
    const chartConfigs = [
        { id: 'articleCountriesChart', data: countries, colors: ['#10b981', '#059669', '#047857', '#065f46', '#064e3b'] },
        { id: 'articleBrowsersChart', data: browsers, colors: ['#6366f1', '#4f46e5', '#4338ca', '#3730a3', '#312e81'] },
        { id: 'articleDevicesChart', data: devices, colors: ['#f59e0b', '#d97706', '#b45309', '#92400e', '#78350f'] }
    ];

    chartConfigs.forEach(({ id, data, colors }) => {
        if (data && Object.keys(data).length > 0) {
            const el = document.getElementById(id);
            if (!el) return;
            const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);
            new Chart(el, {
                type: 'doughnut',
                data: {
                    labels: sortedData.map(([key]) => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        data: sortedData.map(([, v]) => v),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...commonOptions,
                    cutout: '60%',
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            display: true
                        }
                    }
                }
            });
        }
    });
}

// ADD THIS NEW, ALL-IN-ONE FUNCTION
async function showArticleModal(articleId = null) {
    const isEdit = !!articleId;
    let articleData = null;

    if (isEdit) {
        Swal.fire({
            title: 'Loading Article...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            customClass: { popup: 'swal2-toast' }
        });
        try {
            const response = await api(`/dashboard/articles?article_id=${articleId}`);
            articleData = response.data.article;
            Swal.close();
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Failed to load article',
                text: error.message,
                customClass: { popup: 'swal2-toast' }
            });
            return;
        }
    }

    const modalHtml = `
    <style>
        .article-modal-wrapper {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.25rem;
            text-align: left;
            max-height: calc(90vh - 80px);
            overflow: auto;
        }
        
        .article-main-content {
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        .article-main-content form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .article-main-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .article-main-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .article-main-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .article-main-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        .article-sidebar {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            border-left: 2px solid var(--border);
            padding-left: 1.25rem;
        }
        
        .article-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .article-sidebar::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .article-sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .article-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0.85rem;
            transition: var(--transition);
            width: 100%;
            box-sizing: border-box;
        }
        
        .article-section:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }
        
        .form-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }
        
        .form-label i {
            font-size: 1rem;
            color: var(--primary);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        .section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title i {
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        .ai-btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .ai-btn {
            padding: 0.35rem 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.35rem;
            white-space: nowrap;
        }
        
        .ai-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .ai-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .ai-btn.generating {
            background: linear-gradient(270deg, #667eea, #764ba2, #667eea);
            background-size: 200% 200%;
            animation: gradientShift 2s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .ai-btn i {
            font-size: 0.85rem;
        }
        
        .ai-btn.generating i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .progress-dots {
            display: inline-flex;
            gap: 2px;
            margin-left: 4px;
        }
        
        .progress-dots span {
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }
        
        .progress-dots span:nth-child(1) { animation-delay: -0.32s; }
        .progress-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .body-editor-container {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 0.35rem;
            padding: 0.5rem;
            background: var(--card);
            border-radius: var(--radius);
            flex-wrap: wrap;
        }
        
        .editor-btn {
            padding: 0.35rem 0.65rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .editor-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .editor-btn i {
            font-size: 0.85rem;
        }
        
        .form-textarea-enhanced {
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            resize: vertical;
        }
        
        .form-textarea-enhanced:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .usage-stats {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-lg);
            padding: 0.85rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.15rem;
        }
        
        .usage-item {
            text-align: center;
        }
        
        .usage-value {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .usage-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.65rem;
        }
        
        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid var(--border);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .image-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }
        
        .image-item.marked-delete {
            opacity: 0.4;
            border-color: var(--error);
        }
        
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            gap: 0.5rem;
        }
        
        .image-item:hover .image-overlay {
            opacity: 1;
        }
        
        .img-btn {
            padding: 0.35rem 0.55rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .img-btn.view { background: var(--primary); }
        .img-btn.delete { background: var(--error); }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--card-hover);
        }
        
        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .upload-icon {
            font-size: 2rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.65rem;
        }
        
        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 2px solid var(--success);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            z-index: 2;
        }
        
        .preview-refresh {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            z-index: 2;
            transition: var(--transition);
        }
        
        .preview-refresh:hover {
            transform: rotate(180deg);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .preview-refresh.loading {
            animation: spin 1s linear infinite;
        }
        
        .char-count {
            text-align: right;
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.35rem;
        }
        
        .generation-status {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius);
            padding: 0.85rem;
            margin-top: 0.75rem;
            display: none;
            align-items: center;
            gap: 0.65rem;
        }
        
        .generation-status.active {
            display: flex;
        }
        
        .status-spinner {
            width: 18px;
            height: 18px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .status-text {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 500;
        }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .article-modal-wrapper {
                grid-template-columns: 1fr;
                gap: 1rem;
                max-height: calc(85vh - 80px);
            }
            
            .article-sidebar {
                border-left: none;
                border-top: 2px solid var(--border);
                padding-left: 0;
                padding-top: 1rem;
            }
            
            .image-gallery {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .usage-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-textarea-enhanced {
                min-height: 280px;
                max-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .article-modal-wrapper {
                max-height: calc(85vh - 60px);
            }
            
            .article-section {
                padding: 0.75rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.65rem;
            }
            
            .ai-btn-group {
                width: 100%;
            }
            
            .ai-btn {
                justify-content: center;
                font-size: 0.7rem;
                padding: 0.3rem 0.55rem;
            }
            
            .image-gallery,
            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .usage-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .editor-toolbar {
                padding: 0.4rem;
            }
            
            .editor-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .form-textarea-enhanced {
                min-height: 220px;
                max-height: 300px;
                font-size: 0.8rem;
            }
        }
        
        /* Fix swal2-title gap and mobile responsiveness */
        .article-modal-swal .swal2-title {
            padding: 0.5rem 0 !important;
            margin: 0 !important;
            font-size: 1.15rem !important;
        }
        
        @media (max-width: 768px) {
            .article-modal-swal .swal2-title {
                padding: 0.25rem 0 !important;
                font-size: 1rem !important;
            }
            
            .article-modal-swal {
                padding: 0.75rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.75rem !important;
                max-height: 90vh !important;
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .article-modal-swal .swal2-html-container {
                max-height: 75vh !important;
                padding: 0.25rem !important;
                padding-bottom: 1rem !important;
            }
            
            #ai-generate-all-btn {
                font-size: 0.65rem !important;
                padding: 0.25rem 0.4rem !important;
                white-space: nowrap !important;
            }
            
            #ai-generate-all-btn span {
                display: inline !important;
            }
            
            #ai-generate-all-btn i {
                font-size: 0.7rem !important;
                margin-right: 0.15rem !important;
            }
        }
        
        @media (max-width: 480px) {
            #ai-generate-all-btn span {
                display: none !important;
            }
            
            #ai-generate-all-btn {
                padding: 0.3rem 0.45rem !important;
                font-size: 0.65rem !important;
            }
            
            #ai-generate-all-btn i {
                font-size: 0.75rem !important;
                margin-right: 0 !important;
            }
        }
        
        /* Hide default action buttons */
        .article-modal-swal .swal2-actions {
            display: none !important;
        }
        
        /* Custom action buttons in sidebar */
        .article-section.action-buttons-wrapper {
            margin-top: auto;
        }
        
        .article-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .article-actions button {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .article-actions .btn-save {
            background: var(--primary);
            color: white;
        }
        
        .article-actions .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .article-actions .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .article-actions .btn-cancel:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
    </style>

    <div class="article-modal-wrapper">
        <div class="article-main-content">
            <form id="articleForm">
                <!-- Title -->
                <div class="article-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label class="form-label" style="margin-bottom: 0;"><i class="ri-text"></i> Title</label>
                        <button type="button" class="ai-btn" id="ai-generate-all-btn">
                            <i class="ri-magic-line"></i> <span>Generate All</span>
                        </button>
                    </div>
                    <input type="text" id="article-subject" class="form-input" name="subject" required 
                        placeholder="Enter article title..." value="${articleData ? articleData.subject : ''}" maxlength="200">
                    <div class="char-count"><span id="title-count">0</span>/200</div>
                </div>

                <!-- Content -->
                <div class="article-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label class="form-label" style="margin-bottom: 0;"><i class="ri-file-text-line"></i> Content</label>
                        <button type="button" class="ai-btn" id="ai-content-btn">
                            <i class="ri-magic-line"></i> <span>Generate</span>
                        </button>
                    </div>
                    
                    <div class="body-editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" data-tag="h1">
                                <i class="ri-h-1"></i> H1
                            </button>
                            <button type="button" class="editor-btn" data-tag="h2">
                                <i class="ri-h-2"></i> H2
                            </button>
                            <button type="button" class="editor-btn" data-tag="p">
                                <i class="ri-paragraph"></i> P
                            </button>
                            <button type="button" class="editor-btn" data-tag="strong">
                                <i class="ri-bold"></i> Bold
                            </button>
                            <button type="button" class="editor-btn" data-tag="em">
                                <i class="ri-italic"></i> Italic
                            </button>
                            <button type="button" class="editor-btn" data-tag="a">
                                <i class="ri-link"></i> Link
                            </button>
                        </div>
                        <textarea class="form-textarea-enhanced" id="article-body" name="body" required 
                            placeholder="<h1>Main Heading</h1>&#10;<p>Your content here...</p>&#10;&#10;<h2>Subheading</h2>&#10;<p>More content...</p>">${articleData ? articleData.body : ''}</textarea>
                    </div>
                    <div class="char-count"><span id="body-count">0</span> characters</div>
                    
                    <div class="generation-status" id="gen-status">
                        <div class="status-spinner"></div>
                        <div class="status-text" id="gen-status-text">Generating content...</div>
                    </div>
                </div>

                <input type="hidden" id="delete-images" name="delete_image_ids" value="">
                <input type="hidden" id="image-urls" name="image_urls" value="">
            </form>
        </div>

        <div class="article-sidebar">
            <!-- Domain -->
            <div class="article-section">
                <label class="form-label"><i class="ri-global-line"></i> Domain</label>
                <select class="form-select" id="article-url" name="url" required>
                    <option value="">Select domain...</option>
                    ${currentData.domains.filter(d => d.verified).map(d => `
                        <option value="${d.domain}" ${articleData && articleData.url === d.domain ? 'selected' : ''}>${d.domain}</option>
                    `).join('')}
                </select>
            </div>

            <!-- Current Images -->
            ${isEdit && articleData && articleData.images && articleData.images.length > 0 ? `
            <div class="article-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-image-line"></i> Current (${articleData.images.length})</h3>
                </div>
                <div class="image-gallery" id="current-images">
                    ${articleData.images.map((img, i) => {
                        const url = typeof img === 'string' ? img : (img.url || img);
                        const id = typeof img === 'object' ? (img.id || img.image_id || 'img_' + i) : 'img_' + i;
                        return `
                        <div class="image-item" data-id="${id}">
                            <img src="${url}" alt="Image ${i + 1}" loading="lazy">
                            <div class="image-overlay">
                                <button type="button" class="img-btn view" onclick="window.open('${url}', '_blank')">
                                    <i class="ri-eye-line"></i> View
                                </button>
                                <button type="button" class="img-btn delete" onclick="window.toggleDeleteImage('${id}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Upload New -->
            <div class="article-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-upload-line"></i> ${isEdit ? 'Add New' : 'Upload'}</h3>
                    <button type="button" class="ai-btn" id="ai-image-btn">
                        <i class="ri-magic-line"></i> <span>AI</span>
                    </button>
                </div>
                <div class="upload-area" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" name="image_data" multiple accept="image/*" style="display:none;">
                    <div class="upload-icon"><i class="ri-upload-cloud-line"></i></div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Click or drop images</div>
                    <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-top: 0.25rem;">Max 10 files, 5MB each</div>
                </div>
                <div id="preview-container" class="preview-grid"></div>
            </div>

            <!-- AI Usage Stats -->
            <div class="article-section" id="usage-section" style="display: block;">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-pie-chart-line"></i> AI Usage</h3>
                </div>
                <div class="usage-stats">
                    <div class="usage-item">
                        <span class="usage-value" id="usage-used">0</span>
                        <span class="usage-label">Used</span>
                    </div>
                    <div class="usage-item">
                        <span class="usage-value" id="usage-limit">0</span>
                        <span class="usage-label">Limit</span>
                    </div>
                    <div class="usage-item">
                        <span class="usage-value" id="usage-remaining">0</span>
                        <span class="usage-label">Remaining</span>
                    </div>
                    <div class="usage-item">
                        <span class="usage-value" id="usage-percentage">0%</span>
                        <span class="usage-label">Available</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="article-section action-buttons-wrapper">
                <div class="article-actions">
                    <button type="button" class="btn-save" id="article-save-btn">
                        <i class="ri-save-line"></i> ${isEdit ? 'Update Article' : 'Create Article'}
                    </button>
                    <button type="button" class="btn-cancel" id="article-cancel-btn">
                        <i class="ri-close-line"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    `;

    Swal.fire({
        title: `<div style="font-size: 1.15rem; font-weight: 700;">${isEdit ? '<i class="ri-edit-line"></i> Edit Article' : '<i class="ri-add-line"></i> Create Article'}</div>`,
        html: modalHtml,
        width: '95vw',
        showCloseButton: true,
        showCancelButton: true,
        confirmButtonText: `<i class="ri-save-line"></i> ${isEdit ? 'Update' : 'Create'}`,
        cancelButtonText: 'Cancel',
        confirmButtonColor: 'var(--primary)',
        customClass: { popup: 'article-modal-swal' },
        didOpen: () => {
            // State
            window.articleFiles = [];
            window.deleteImageIds = [];
            window.imageUrls = [];

            // Counters
            const titleInput = document.getElementById('article-subject');
            const bodyInput = document.getElementById('article-body');
            const updateCounters = () => {
                document.getElementById('title-count').textContent = titleInput.value.length;
                document.getElementById('body-count').textContent = bodyInput.value.length;
            };
            titleInput.addEventListener('input', updateCounters);
            bodyInput.addEventListener('input', updateCounters);
            updateCounters();

            // File input
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    if (!file.type.startsWith('image/')) return;
                    if (file.size > 5 * 1024 * 1024) {
                        showToast(file.name + ' exceeds 5MB', 'error');
                        return;
                    }
                    const totalImages = window.articleFiles.length + window.imageUrls.length;
                    if (totalImages >= 10) {
                        showToast('Max 10 images', 'warning');
                        return;
                    }
                    window.articleFiles.push(file);
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `
                            <img src="${ev.target.result}" alt="${file.name}">
                            <button type="button" class="preview-remove" onclick="window.removePreview('${file.name}', this)">
                                <i class="ri-close-line"></i>
                            </button>
                        `;
                        document.getElementById('preview-container').appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                fileInput.value = '';
            });

            // Drag & drop
            const zone = document.getElementById('upload-zone');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
            zone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            // Helper: Update usage display
            window.updateUsageDisplay = (usage) => {
                if (!usage) return;
                document.getElementById('usage-used').textContent = usage.used || 0;
                document.getElementById('usage-limit').textContent = usage.limit || 0;
                document.getElementById('usage-remaining').textContent = usage.remaining || 0;
                document.getElementById('usage-percentage').textContent = usage.percentage || '0%';
            };

            // Helper: Show status
            window.showGenStatus = (text) => {
                const status = document.getElementById('gen-status');
                const statusText = document.getElementById('gen-status-text');
                statusText.textContent = text;
                status.classList.add('active');
            };

            // Helper: Hide status
            window.hideGenStatus = () => {
                document.getElementById('gen-status').classList.remove('active');
            };

            // Global functions
            window.removePreview = (name, btn) => {
                window.articleFiles = window.articleFiles.filter(f => f.name !== name);
                btn.closest('.preview-item').remove();
            };

            window.toggleDeleteImage = (id) => {
                const item = document.querySelector(`[data-id="${id}"]`);
                const idx = window.deleteImageIds.indexOf(id);
                if (idx > -1) {
                    window.deleteImageIds.splice(idx, 1);
                    item.classList.remove('marked-delete');
                } else {
                    window.deleteImageIds.push(id);
                    item.classList.add('marked-delete');
                }
                document.getElementById('delete-images').value = window.deleteImageIds.join(',');
            };

            // Editor functions - FIXED SYNTAX ERROR
            document.querySelectorAll('.editor-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tagName = btn.getAttribute('data-tag');
                    const textarea = document.getElementById('article-body');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    const selectedText = text.substring(start, end);
                    
                    let openTag, closeTag;
                    if (tagName === 'a') {
                        openTag = '<a href="">';
                        closeTag = '</a>';
                    } else {
                        openTag = `<${tagName}>`;
                        closeTag = `</${tagName}>`;
                    }
                    
                    const newText = text.substring(0, start) + openTag + selectedText + closeTag + text.substring(end);
                    textarea.value = newText;
                    textarea.focus();
                    
                    const cursorPos = start + openTag.length + selectedText.length;
                    textarea.setSelectionRange(cursorPos, cursorPos);
                    document.getElementById('body-count').textContent = newText.length;
                });
            });

            // AI Generate All (Title + Body + Image)
            document.getElementById('ai-generate-all-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                const btn = e.currentTarget;
                const body = document.getElementById('article-body').value.trim();
                
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = '<i class="ri-loader-4-line"></i> <span>Generating</span><div class="progress-dots"><span></span><span></span><span></span></div>';
                window.showGenStatus('Generating complete article with AI...');
                
                try {
                    const payload = body ? { subject: body.substring(0, 100) } : { auto_generate: true };
                    
                    const response = await fetch(`${API_BASE}/generate-article`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Session-Token': sessionToken 
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        // Set title
                        if (data.data.title || data.data.subject) {
                            const title = data.data.title || data.data.subject;
                            document.getElementById('article-subject').value = title;
                            document.getElementById('title-count').textContent = title.length;
                        }
                        
                        // Set body
                        if (data.data.body) {
                            document.getElementById('article-body').value = data.data.body;
                            document.getElementById('body-count').textContent = data.data.body.length;
                        }
                        
                        // Handle AI-generated image URL
                        if (data.data.image_url) {
                            window.imageUrls.push(data.data.image_url);
                            document.getElementById('image-urls').value = window.imageUrls.join(',');
                            
                            // Add preview
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.dataset.isAiGenerated = 'true';
                            div.innerHTML = `
                                <img src="${data.data.image_url}" alt="AI Generated">
                                <button type="button" class="preview-refresh" onclick="window.refreshAiImage('${data.data.image_url}', this)" title="Reload image">
                                    <i class="ri-refresh-line"></i>
                                </button>
                                <button type="button" class="preview-remove" onclick="window.removeUrlPreview('${data.data.image_url}', this)">
                                    <i class="ri-close-line"></i>
                                </button>
                            `;
                            document.getElementById('preview-container').appendChild(div);
                        }
                        
                        // Update usage
                        if (data.data.usage) {
                            window.updateUsageDisplay(data.data.usage);
                        }
                        
                        showToast('Article generated successfully!', 'success');
                    } else {
                        throw new Error(data.error?.message || 'Failed to generate');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('generating');
                    btn.innerHTML = '<i class="ri-magic-line"></i> <span>Generate All</span>';
                    window.hideGenStatus();
                }
            });

            // AI Generate Content Only
            document.getElementById('ai-content-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                const btn = e.currentTarget;
                const subject = document.getElementById('article-subject').value.trim();
                
                if (!subject) {
                    showToast('Enter a title first', 'warning');
                    return;
                }
                
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = '<i class="ri-loader-4-line"></i> <span>Generating</span><div class="progress-dots"><span></span><span></span><span></span></div>';
                window.showGenStatus('Creating article content with AI...');
                
                try {
                    const response = await fetch(`${API_BASE}/generate-article`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Session-Token': sessionToken 
                        },
                        body: JSON.stringify({ subject })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        // Set body
                        if (data.data.body) {
                            document.getElementById('article-body').value = data.data.body;
                            document.getElementById('body-count').textContent = data.data.body.length;
                        }
                        
                        // Handle AI-generated image URL
                        if (data.data.image_url) {
                            window.imageUrls.push(data.data.image_url);
                            document.getElementById('image-urls').value = window.imageUrls.join(',');
                            
                            // Add preview
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.dataset.isAiGenerated = 'true';
                            div.innerHTML = `
                                <img src="${data.data.image_url}" alt="AI Generated">
                                <button type="button" class="preview-refresh" onclick="window.refreshAiImage('${data.data.image_url}', this)" title="Reload image">
                                    <i class="ri-refresh-line"></i>
                                </button>
                                <button type="button" class="preview-remove" onclick="window.removeUrlPreview('${data.data.image_url}', this)">
                                    <i class="ri-close-line"></i>
                                </button>
                            `;
                            document.getElementById('preview-container').appendChild(div);
                        }
                        
                        // Update usage
                        if (data.data.usage) {
                            window.updateUsageDisplay(data.data.usage);
                        }
                        
                        showToast('Content generated successfully!', 'success');
                    } else {
                        throw new Error(data.error?.message || 'Failed to generate');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('generating');
                    btn.innerHTML = '<i class="ri-magic-line"></i> <span>Generate</span>';
                    window.hideGenStatus();
                }
            });

            // AI Generate Image Only
            document.getElementById('ai-image-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                const btn = e.currentTarget;
                const subject = document.getElementById('article-subject').value.trim();
                
                if (!subject) {
                    showToast('Enter a title first', 'warning');
                    return;
                }
                
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = '<i class="ri-loader-4-line"></i> <span>AI</span><div class="progress-dots"><span></span><span></span><span></span></div>';
                window.showGenStatus('Generating AI image...');
                
                try {
                    const response = await fetch(`${API_BASE}/generate-article`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Session-Token': sessionToken 
                        },
                        body: JSON.stringify({ subject })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        // Handle AI-generated image URL
                        if (data.data.image_url) {
                            const totalImages = window.articleFiles.length + window.imageUrls.length;
                            if (totalImages >= 10) {
                                showToast('Max 10 images reached', 'warning');
                                return;
                            }
                            
                            window.imageUrls.push(data.data.image_url);
                            document.getElementById('image-urls').value = window.imageUrls.join(',');
                            
                            // Add preview
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.dataset.isAiGenerated = 'true';
                            div.innerHTML = `
                                <img src="${data.data.image_url}" alt="AI Generated">
                                <button type="button" class="preview-refresh" onclick="window.refreshAiImage('${data.data.image_url}', this)" title="Reload image">
                                    <i class="ri-refresh-line"></i>
                                </button>
                                <button type="button" class="preview-remove" onclick="window.removeUrlPreview('${data.data.image_url}', this)">
                                    <i class="ri-close-line"></i>
                                </button>
                            `;
                            document.getElementById('preview-container').appendChild(div);
                            
                            showToast('AI image generated!', 'success');
                        }
                        
                        // Update usage
                        if (data.data.usage) {
                            window.updateUsageDisplay(data.data.usage);
                        }
                    } else {
                        throw new Error(data.error?.message || 'Failed to generate');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('generating');
                    btn.innerHTML = '<i class="ri-magic-line"></i> <span>AI</span>';
                    window.hideGenStatus();
                }
            });

            // Remove URL preview
            window.removeUrlPreview = (url, btn) => {
                window.imageUrls = window.imageUrls.filter(u => u !== url);
                document.getElementById('image-urls').value = window.imageUrls.join(',');
                btn.closest('.preview-item').remove();
            };
            
            // Refresh AI-generated image (reload the same image)
            window.refreshAiImage = (imageUrl, btn) => {
                const previewItem = btn.closest('.preview-item');
                const img = previewItem.querySelector('img');
                const refreshIcon = btn.querySelector('i');
                
                btn.disabled = true;
                refreshIcon.classList.add('loading');
                
                // Add cache-busting parameter to force reload
                const url = new URL(imageUrl);
                url.searchParams.set('t', Date.now());
                
                // Create a temporary image to test if it loads
                const tempImg = new Image();
                
                tempImg.onload = () => {
                    // Image loaded successfully, update the main image
                    img.src = url.toString();
                    showToast('Image reloaded successfully!', 'success');
                    btn.disabled = false;
                    refreshIcon.classList.remove('loading');
                };
                
                tempImg.onerror = () => {
                    showToast('Failed to reload image', 'error');
                    btn.disabled = false;
                    refreshIcon.classList.remove('loading');
                };
                
                // Start loading the image
                tempImg.src = url.toString();
            };

            // Custom save button handler
            document.getElementById('article-save-btn').addEventListener('click', () => {
                Swal.clickConfirm();
            });

            // Custom cancel button handler
            document.getElementById('article-cancel-btn').addEventListener('click', () => {
                Swal.clickCancel();
            });
        },
        preConfirm: () => {
            const url = document.getElementById('article-url').value;
            const subject = document.getElementById('article-subject').value.trim();
            const body = document.getElementById('article-body').value.trim();

            if (!url) { Swal.showValidationMessage('Select a domain'); return false; }
            if (!subject) { Swal.showValidationMessage('Enter a title'); return false; }
            if (!body) { Swal.showValidationMessage('Enter content'); return false; }
            
            // Validate that we have at least one image (file or URL)
            if (window.articleFiles.length === 0 && window.imageUrls.length === 0 && !isEdit) {
                Swal.showValidationMessage('At least one image is required');
                return false;
            }

            const formData = new FormData();
            formData.append('url', url);
            formData.append('subject', subject);
            formData.append('body', body);
            if (window.deleteImageIds.length) formData.append('delete_image_ids', window.deleteImageIds.join(','));
            if (window.imageUrls.length) formData.append('image_urls', window.imageUrls.join(','));
            window.articleFiles.forEach(f => formData.append('image_data', f));

            return formData;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({ title: isEdit ? 'Updating...' : 'Creating...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

            try {
                const endpoint = isEdit ? `/edit-article/${articleId}` : '/add-article';
                const method = isEdit ? 'PUT' : 'POST';
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method,
                    headers: { 'Session-Token': sessionToken },
                    body: result.value
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || data.message || 'Failed');

                Swal.close();
                showToast(`Article ${isEdit ? 'updated' : 'created'}!`, 'success');
                loadArticles();
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Failed', text: error.message, customClass: { popup: 'swal2-toast' } });
            }
        }
    });
}
   
// ADD THIS SMALL HELPER FUNCTION BACK
function editArticle(articleId) {
    // This now simply closes the details modal and opens the new edit modal
    Swal.close();
    showArticleModal(articleId);
}


async function deleteArticle(articleId) {
    if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
        return;
    }

    try {
        await api(`/delete-article/${articleId}`, { method: 'DELETE' });
        showToast('Article deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        console.error('Delete article error:', error);
        showToast('Failed to delete article: ' + error.message, 'error');
    }
}
// ADD THIS NEW, COMBINED FUNCTION
async function showImageUploadModal() {
    const swalHtml = `
        <form id="imageUploadForm" enctype="multipart/form-data" style="text-align: left;">
            <div class="form-group">
                <label class="form-label">Select Images</label>
                <input type="file" id="swal-file-input" class="form-input" name="file" multiple accept="image/*" required>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    Maximum 10 files, 5MB per file. Supported formats: JPG, PNG, GIF, WebP
                </small>
            </div>
            <div id="uploadPreview" style="margin-top: 1rem; display: none;">
                <h4 style="font-size: 0.9rem; font-weight: 500; margin-bottom: 0.75rem;">Preview:</h4>
                <div id="previewContainer" style="display: flex; flex-wrap: wrap; gap: 0.75rem; background: var(--bg-tertiary); padding: 0.75rem; border-radius: var(--radius);"></div>
            </div>
        </form>
    `;

    Swal.fire({
        title: 'Upload Images',
        html: swalHtml,
        showCloseButton: true, // This adds the 'X' button to the top-right
        showCancelButton: true,
        confirmButtonText: '<i class="ri-upload-2-line"></i> Upload',
        confirmButtonColor: 'var(--primary)',
        customClass: { popup: 'swal2-toast' }, // Re-use toast class for theming
        didOpen: () => {
            // Attach the preview logic after the modal opens
            const fileInput = document.getElementById('swal-file-input');
            const previewContainer = document.getElementById('previewContainer');
            const uploadPreview = document.getElementById('uploadPreview');

            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    uploadPreview.style.display = 'block';
                    previewContainer.innerHTML = ''; // Clear previous previews
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius-sm); border: 2px solid var(--border);';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    uploadPreview.style.display = 'none';
                }
            });
        },
        preConfirm: () => {
            // This function runs when the confirm button is clicked, before the modal closes.
            // It's used for validation.
            const fileInput = document.getElementById('swal-file-input');
            const files = fileInput.files;

            if (files.length === 0) {
                Swal.showValidationMessage('Please select at least one image to upload.');
                return false; // Prevent closing
            }
            if (files.length > 10) {
                Swal.showValidationMessage('You can upload a maximum of 10 images at a time.');
                return false; // Prevent closing
            }

            // If validation passes, return the form data for the next step
            const formData = new FormData(document.getElementById('imageUploadForm'));
            return formData;
        }
    }).then(async (result) => {
        // This block runs after preConfirm is successful and the user has confirmed
        if (result.isConfirmed) {
            const formData = result.value;

            // Show a loading indicator
            Swal.fire({
                title: 'Uploading...',
                text: 'Please wait while your images are being uploaded.', 
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                customClass: { popup: 'swal2-toast' }
            });

            try {
                const response = await fetch(`${API_BASE}/images/upload`, {
                    method: 'POST',
                    headers: { 'Session-Token': sessionToken },
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error?.message || data.message || 'Upload failed');
                }

                Swal.close(); // <-- ADD THIS LINE
                showToast(`Successfully uploaded ${data.data.uploaded_images.length} images!`, 'success');
                loadImages(); // Refresh the images list

            } catch (error) {
                console.error('Upload error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: error.message,
                    customClass: { popup: 'swal2-toast' }
                });
            }
        }
    });
}

    
// [NEW] Enhanced Image Details using SweetAlert2
async function showImageDetails(imageId) {
    const image = currentData.images.find(img => img.image_id === imageId);
    if (!image) {
        showToast('Image not found', 'error');
        return;
    }

    // --- 1. Process Analytics Data (Same logic, preserved) ---
    const monthlyStats = image.monthly_stats || {};
    const countries = {}, browsers = {}, devices = {}, viewsByDate = {};
    Object.entries(monthlyStats).forEach(([month, stats]) => {
        if (stats.country) Object.entries(stats.country).forEach(([k, v]) => { countries[k.toUpperCase()] = (countries[k.toUpperCase()] || 0) + v; });
        if (stats.browser) Object.entries(stats.browser).forEach(([k, v]) => { browsers[k] = (browsers[k] || 0) + v; });
        if (stats.devices) Object.entries(stats.devices).forEach(([k, v]) => { devices[k] = (devices[k] || 0) + v; });
        if (stats.daily) Object.entries(stats.daily).forEach(([day, views]) => {
            const [year, monthNum] = month.split('-');
            viewsByDate[`${year}-${monthNum}-${day.padStart(2, '0')}`] = views;
        });
    });
    const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
    const topCountries = Object.entries(countries).sort(([,a], [,b]) => b - a).slice(0, 5);
    const topBrowsers = Object.entries(browsers).sort(([,a], [,b]) => b - a).slice(0, 5);

    // --- 2. Construct Modal HTML (New Responsive Layout) ---
    const modalHtml = `
    <div class="image-details-modal-container">
        <div class="modal-header-section">
            <div class="modal-preview-container">
                <img src="${image.cdn_url}" alt="${image.original_filename}" class="modal-image-preview" onclick="window.open('${image.cdn_url}', '_blank')">
            </div>
            <div class="modal-info-list">
                <p><strong>Filename:</strong><br><code>${image.original_filename}</code></p>
                <p><strong>Uploaded:</strong><br>${new Date(image.upload_date).toLocaleString()}</p>
                <p><strong>Total Views:</strong><br><span class="badge badge-primary" style="font-size: 1rem;">${formatNumber(image.total_views)}</span></p>
                <p><strong>CDN URL:</strong><br>
                    <button class="btn btn-sm" onclick="copyToClipboard('${image.cdn_url}')"><i class="ri-file-copy-line"></i> Copy URL</button>
                </p>
                <p><strong>Image ID:</strong><br><code>${image.image_id}</code></p>
            </div>
        </div>

        ${sortedDates.length > 0 ? `
            <div>
                <h3 class="modal-section-title" style="color: var(--primary);"><i class="ri-bar-chart-2-line"></i>Analytics Overview</h3>
                <div class="modal-stat-grid">
                    <div class="modal-chart-container">
                        <canvas id="imageViewsTimelineChart"></canvas>
                    </div>
                    <div class="modal-chart-container">
                        <canvas id="imageCountriesChart"></canvas>
                    </div>
                </div>
            </div>
            <div>
                <h3 class="modal-section-title" style="color: var(--warning);"><i class="ri-list-check"></i>Top Referrers</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Browsers</h4>
                        ${topBrowsers.map(b => `<div class="analytics-list-item"><span>${b[0]}</span><span class="badge badge-primary">${formatNumber(b[1])}</span></div>`).join('')}
                    </div>
                    <div>
                        <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Devices</h4>
                        ${Object.entries(devices).map(d => `<div class="analytics-list-item"><span>${d[0]}</span><span class="badge badge-warning">${formatNumber(d[1])}</span></div>`).join('')}
                    </div>
                </div>
            </div>
        ` : `
            <div class="empty-state" style="padding: 1rem 0;">
                <div class="empty-state-icon"><i class="ri-bar-chart-line"></i></div>
                <div class="empty-state-title" style="font-size: 1.2rem;">No Analytics Yet</div>
                <div class="empty-state-description">View data will appear here once the image is viewed.</div>
            </div>
        `}
    </div>`;

    // --- 3. Fire SweetAlert2 Modal ---
    Swal.fire({
        title: 'Image Details',
        html: modalHtml,
        showCloseButton: true,
        showConfirmButton: false,
        width: '90vw',
        maxWidth: '900px',
        customClass: {
            popup: 'swal2-toast', // Re-use toast class for theming
            closeButton: 'swal2-close'
        },
        showClass: { popup: 'swal2-show-super-fast' },
        hideClass: { popup: 'swal2-hide-super-fast' },
        didOpen: () => {
            // Initialize charts only if there is data
            if (sortedDates.length > 0) {
                initializeImageAnalyticsCharts(sortedDates, topCountries);
            }
        }
    });
}

// [NEW] Helper function to initialize charts inside the modal
function initializeImageAnalyticsCharts(sortedDates, topCountries) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#a0a0a0' : '#6c757d';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';

    // Views Timeline Chart (Line Chart)
    const timelineCtx = document.getElementById('imageViewsTimelineChart');
    if (timelineCtx) {
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: sortedDates.map(([date]) => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                datasets: [{
                    label: 'Views',
                    data: sortedDates.map(([, views]) => views),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Views Over Time', color: textColor } },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true }
                }
            }
        });
    }

    // Top Countries Chart (Bar Chart - better for ranking)
    const countriesCtx = document.getElementById('imageCountriesChart');
    if (countriesCtx) {
        new Chart(countriesCtx, {
            type: 'bar',
            data: {
                labels: topCountries.map(([country]) => country),
                    datasets: [{
                        label: 'Views',
                        data: topCountries.map(([, views]) => views),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y', // Horizontal bars
                plugins: { legend: { display: false }, title: { display: true, text: 'Top 5 Countries', color: textColor } },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { display: false } }
                }
            }
        });
    }
}

// [NEW] Improved delete function with confirmation via SweetAlert2
async function deleteImage(imageId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'Yes, delete it!',
        customClass: { popup: 'swal2-toast' } // Use our theme
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                await api('/images', {
                    method: 'DELETE',
                    body: JSON.stringify({ image_ids: [imageId] })
                });
                showToast('Image deleted successfully', 'success');
                // Close any open modal and reload the list
                Swal.close();
                loadImages(paginationState.images.page); // Reload current page
            } catch (error) {
                showToast('Failed to delete image: ' + error.message, 'error');
            }
        }
    });
}

function deleteImageFromModal(imageId) {
    closeModal();
    setTimeout(() => deleteImage(imageId), 100);
}

// [NEW] Rebuilt Payment Details Modal using SweetAlert2
async function viewPaymentDetails(billingId) {

    // Show a loading indicator immediately for a better user experience
    Swal.fire({
        title: 'Fetching Payment Details...',
        showConfirmButton: false,
        customClass: { popup: 'swal2-toast' }
    });

    try {
        const response = await api(`/get-payment-status?payment_id=${billingId}`);
        const payment = response.data;

        if (!payment) {
            throw new Error('Payment details not found in API response.');
        }

        // --- 1. Prepare Data for Display ---
        const status = (payment.payment_status || 'unknown').toLowerCase();
        let statusInfo = {
            text: 'Unknown',
            color: 'var(--text-secondary)',
            icon: 'ri-question-mark'
        };
        if (status === 'paid' || status === 'succeeded') {
            statusInfo = { text: 'Paid', color: 'var(--success)', icon: 'ri-checkbox-circle-fill' };
        } else if (status === 'pending') {
            statusInfo = { text: 'Pending', color: 'var(--warning)', icon: 'ri-time-line' };
        } else if (status === 'failed' || status === 'cancelled') {
            statusInfo = { text: 'Failed', color: 'var(--error)', icon: 'ri-close-circle-fill' };
        }

        const type = (payment.type || 'unknown').replace('_', ' ');
        const paymentMethod = (payment.payment_method || 'N/A').toLowerCase();
        
        // Extract Stripe link from transaction_id if it's a Stripe checkout session
        let stripeLink = null;
        if (payment.transaction_id && payment.transaction_id.startsWith('cs_')) {
            // Build Stripe checkout link
            stripeLink = `https://checkout.stripe.com/c/pay/${payment.transaction_id}`;
        }
        
        // --- 2. Construct Modal HTML with Embedded Styles ---
        const modalHtml = `
        <style>
            /* Custom styles ONLY for this modal */
            .payment-details-custom {
                width: 95vw !important;
            }
            @media (min-width: 800px) {
                .payment-details-custom {
                    width: 750px !important;
                }
            }
            .payment-receipt {
                text-align: left;
            }
            .receipt-header {
                text-align: center;
                padding-bottom: 1.5rem;
                border-bottom: 2px dashed var(--border);
                margin-bottom: 1.5rem;
            }
            .receipt-header .amount {
                font-size: 2.5rem;
                font-weight: 800;
                line-height: 1;
                color: var(--text);
            }
            .receipt-header .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: var(--radius-lg);
                font-weight: 600;
                margin-top: 1rem;
            }
            .detail-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .detail-item {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 0.85rem 0;
                border-bottom: 1px solid var(--border);
                font-size: 0.9rem;
                gap: 1rem;
            }
            .detail-item:last-child {
                border-bottom: none;
            }
            .detail-item .label {
                color: var(--text-secondary);
                white-space: nowrap;
                min-width: 120px;
            }
            .detail-item .value {
                color: var(--text);
                font-weight: 500;
                text-align: right;
                word-break: break-all;
                flex: 1;
            }
            .detail-item .value code {
                background: var(--bg-tertiary);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
                font-size: 0.85rem;
                border: 1px solid var(--border);
            }
            .detail-item .value a {
                color: var(--primary);
                text-decoration: none;
            }
            .detail-item .value a:hover {
                text-decoration: underline;
            }
            @media (max-width: 600px) {
                .detail-item {
                    flex-direction: column;
                    gap: 0.25rem;
                }
                .detail-item .label {
                    min-width: auto;
                }
                .detail-item .value {
                    text-align: left;
                }
                .receipt-header .amount {
                    font-size: 2rem;
                }
            }
        </style>

        <div class="payment-receipt">
            <div class="receipt-header">
                <div class="amount">$${(payment.amount || 0).toFixed(2)} ${(payment.currency || 'USD').toUpperCase()}</div>
                <div class="status-badge" style="background-color: ${statusInfo.color}; color: white;">
                    <i class="${statusInfo.icon}"></i>
                    <span>${statusInfo.text}</span>
                </div>
            </div>

            <ul class="detail-list">
                <li class="detail-item">
                    <span class="label">Invoice Number</span>
                    <span class="value"><code>${payment.invoice_number || 'N/A'}</code> ${payment.invoice_number ? `<i class="ri-file-copy-line" style="cursor: pointer; margin-left: 0.5rem;" onclick="copyToClipboard('${payment.invoice_number}')"></i>` : ''}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Transaction ID</span>
                    <span class="value">
                        ${stripeLink ? `<a href="${stripeLink}" target="_blank" title="View on Stripe"><i class="ri-external-link-line"></i> ${payment.transaction_id}</a>` : `<code>${payment.transaction_id || 'N/A'}</code>`}
                        ${payment.transaction_id ? `<i class="ri-file-copy-line" style="cursor: pointer; margin-left: 0.5rem;" onclick="copyToClipboard('${payment.transaction_id}')"></i>` : ''}
                    </span>
                </li>
                ${payment.task_id ? `
                <li class="detail-item">
                    <span class="label">Related Task ID</span>
                    <span class="value"><code>${payment.task_id}</code> <i class="ri-file-copy-line" style="cursor: pointer; margin-left: 0.5rem;" onclick="copyToClipboard('${payment.task_id}')"></i></span>
                </li>
                ` : ''}
                <li class="detail-item">
                    <span class="label">Payment Type</span>
                    <span class="value" style="text-transform: capitalize;">${type}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Payment Method</span>
                    <span class="value" style="text-transform: capitalize;">${paymentMethod}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Payment Status</span>
                    <span class="value" style="text-transform: capitalize;">${payment.status || 'N/A'}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Billed To</span>
                    <span class="value">${payment.customer_email || 'N/A'}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Date Created</span>
                    <span class="value">${payment.date_created ? new Date(payment.date_created).toLocaleString() : 'N/A'}</span>
                </li>
                <li class="detail-item">
                    <span class="label">Last Updated</span>
                    <span class="value">${payment.date_updated ? new Date(payment.date_updated).toLocaleString() : 'N/A'}</span>
                </li>
            </ul>
        </div>
        `;

        // --- 3. Update the Swal Modal with the Final Content ---
        Swal.update({
            title: 'Payment Receipt',
            html: modalHtml,
            showLoading: false,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'payment-details-custom',
                closeButton: 'swal2-close'
            },
        });

    } catch (error) {
        console.error('Payment details error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load payment details. Please try again.',
            customClass: { popup: 'swal2-toast' }
        });
    }
}

// Charts
function initializeCharts(user) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    // Task Performance Chart
    const taskCtx = document.getElementById('taskChart');
    if (taskCtx) {
        if (charts.task) {
            charts.task.destroy();
        }

        const taskData = generateTaskChartData(user);
        const hasRealData = taskData.labels[0] !== 'No Data';

        charts.task = new Chart(taskCtx, {
            type: 'line',
            data: {
                labels: taskData.labels,
                datasets: [{
                    label: 'Views',
                    data: taskData.views,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }, {
                    label: 'Active Tasks',
                    data: taskData.tasks,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: textColor,
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        enabled: hasRealData,
                        backgroundColor: isDark ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: textColor,
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 },
                            maxRotation: 45
                        }
                    },
                    y: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 }
                        },
                        beginAtZero: true
                    }
                },
                elements: {
                    point: {
                        hoverRadius: hasRealData ? 6 : 0
                    }
                }
            }
        });

        // Add "No data available" message if needed
        if (!hasRealData) {
            const chartContainer = taskCtx.parentElement;
            const noDataMsg = document.createElement('div');
            noDataMsg.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-align: center;
                pointer-events: none;
                z-index: 10;
            `;
            noDataMsg.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                <div>No analytics data available yet</div>
                <div style="font-size: 0.75rem; margin-top: 0.25rem;">Data will appear when tasks receive views</div>
            `;
            chartContainer.style.position = 'relative';
            chartContainer.appendChild(noDataMsg);
        }
    }
}

function generateTaskChartData(user) {
    const analytics = user.analytics || {};
    const monthlyStats = analytics.monthly_stats || {};

    // Collect all date-view pairs from the analytics
    const dateViews = [];

    // Parse analytics data: "2025-02": {"daily": {"04": 1, "09": 3}}
    Object.entries(monthlyStats).forEach(([monthKey, stats]) => {
        if (stats.daily) {
            Object.entries(stats.daily).forEach(([day, views]) => {
                // Convert "2025-02" and "04" to "2025-02-04"
                const fullDate = `${monthKey}-${day.padStart(2, '0')}`;
                const dateObj = new Date(fullDate);

                if (!isNaN(dateObj.getTime())) {
                    dateViews.push({
                        date: dateObj,
                        dateString: fullDate,
                        views: views || 0
                    });
                }
            });
        }
    });

    // Sort by date
    dateViews.sort((a, b) => a.date - b.date);

    // If we have analytics data, use the actual dates and views
    if (dateViews.length > 0) {
        // Take last 10 data points or all if less than 10
        const recentData = dateViews.slice(-10);

        const labels = recentData.map(item =>
            item.date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            })
        );
        const views = recentData.map(item => item.views);
        const tasks = new Array(recentData.length).fill(user.usage_summary?.active_tasks || 0);

        return { labels, views, tasks };
    }

    // Fallback: if no analytics data, show empty chart with message
    return {
        labels: ['No Data'],
        views: [0],
        tasks: [user.usage_summary?.active_tasks || 0]
    };
}

// amCharts v5 World Map ? Indigo ramp, hover = green
function initializeCountryMap(user) {
  const container = document.getElementById('countryMap');
  if (!container) return;
  if (!container.style.height) container.style.height = '420px';

  // Dispose previous instance
  if (container.__am5root && !container.__am5root.isDisposed()) {
    try { container.__am5root.dispose(); } catch (_) {}
    container.__am5root = null;
  }

  // ---- Colors ----
  const RAMP_MIN   = '#a5b4fc'; // light indigo
  const RAMP_MAX   = '#4338ca'; // deep indigo
  const HOVER_FILL = '#10b981'; // green on hover
  const HOVER_EDGE = '#065f46'; // darker green stroke
  const BASE_EDGE  = '#374151'; // indigo border

  // ---- Build data ----
  const src = user?.data?.data?.user ?? user?.data?.user ?? user?.user ?? user;
  const counts = {};
  const monthly = src?.analytics?.monthly_stats || {};
  Object.values(monthly).forEach(m => {
    const cc = m?.country || {};
    for (const [iso2, v] of Object.entries(cc)) {
      const k = String(iso2).toUpperCase();
      counts[k] = (counts[k] || 0) + (Number(v) || 0);
    }
  });
  if (Object.keys(counts).length === 0 && Array.isArray(src?.sessions)) {
    src.sessions.forEach(s => {
      const k = (s.country_code || s.country || '').toUpperCase();
      if (k) counts[k] = (counts[k] || 0) + 1;
    });
  }

  const data = Object.entries(counts).map(([id, value]) => ({
    id,
    value: Number(value) || 0
  }));

  container.innerHTML = `<div id="countryMapCanvas" style="width:100%;height:100%;"></div>`;

  // ---- Helpers ----
  const ready = () =>
    typeof window.am5 !== 'undefined' &&
    typeof window.am5map !== 'undefined' &&
    typeof window.am5geodata_worldLow !== 'undefined';

  const add = (id, src) => new Promise((res, rej) => {
    if (document.getElementById(id)) return res();
    const s = document.createElement('script');
    s.id = id; s.src = src; s.async = true; s.setAttribute('data-cfasync','false');
    s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });

  function hexToNum(hex) {
    const s = String(hex || '').trim();
    const m = s.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (m) { const r=+m[1], g=+m[2], b=+m[3]; return (r<<16) + (g<<8) + b; }
    let h = s.replace('#', '');
    if (h.length === 3) h = h.split('').map(x=>x+x).join('');
    if (!/^[0-9a-f]{6}$/i.test(h)) return 0x000000;
    return parseInt(h, 16);
  }
  function numToRgb(n){ return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
  function rgbToNum(r,g,b){ return ((r&255)<<16)|((g&255)<<8)|(b&255); }
  function lerp(a,b,t){ return Math.round(a + (b - a) * t); }
  function gradient(minHex, maxHex, t) {
    t = Math.max(0, Math.min(1, t || 0));
    const a = numToRgb(hexToNum(minHex));
    const b = numToRgb(hexToNum(maxHex));
    return rgbToNum(lerp(a.r,b.r,t), lerp(a.g,b.g,t), lerp(a.b,b.b,t));
  }

  function boot() {
    const root = am5.Root.new("countryMapCanvas");
    container.__am5root = root;
    if (typeof am5themes_Animated !== 'undefined') {
      root.setThemes([ am5themes_Animated.new(root) ]);
    }

    const chart = root.container.children.push(am5map.MapChart.new(root, {}));

    const polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow,
        exclude: ["AQ"],
        valueField: "value",
        calculateAggregates: true
      })
    );

    const maxVal = Math.max(...data.map(d => d.value), 1);
    const minVal = Math.min(...data.map(d => d.value), 0);
    const range  = Math.max(1, maxVal - minVal);

    const polyTpl = polygonSeries.mapPolygons.template;
    polyTpl.setAll({
      tooltipText: "{name}: [bold]{value}[/]",
      strokeOpacity: 0.7,
      stroke: am5.color(hexToNum(BASE_EDGE)),
      fillOpacity: 1,
      interactive: true,
      cursorOverStyle: "pointer"
    });

    // Hover turns country fill GREEN
    polyTpl.states.create("hover", {
      fill: am5.color(hexToNum(HOVER_FILL)),
      stroke: am5.color(hexToNum(HOVER_EDGE)),
      strokeWidth: 1.2
    });

    // Adapter: indigo ramp for normal state
    polyTpl.adapters.add("fill", (current, target) => {
      const v = target?.dataItem?.get("value");
      if (v == null || isNaN(v)) return am5.color(hexToNum(RAMP_MIN));
      const t = (v - minVal) / range;
      return am5.color(gradient(RAMP_MIN, RAMP_MAX, t));
    });

    if (data.length > 0) polygonSeries.data.setAll(data);

    polyTpl.events.on("pointerover", ev => ev.target.toFront());
    chart.set("wheelY", "zoom");
    chart.set("wheelX", "zoom");

    const ro = new ResizeObserver(() => root.resize());
    ro.observe(container);
    root.__ro = ro;
  }

  if (ready()) {
    boot();
  } else {
    Promise.resolve()
      .then(() => add('am5-core',     'https://cdn.amcharts.com/lib/5/index.js'))
      .then(() => add('am5-map',      'https://cdn.amcharts.com/lib/5/map.js'))
      .then(() => add('am5-worldlow', 'https://cdn.amcharts.com/lib/5/geodata/worldLow.js'))
      .then(() => add('am5-animated', 'https://cdn.amcharts.com/lib/5/themes/Animated.js'))
      .then(() => {
        let tries = 0;
        const t = setInterval(() => {
          if (ready() || tries++ > 40) {
            clearInterval(t);
            if (ready()) boot();
            else console.error('amCharts libs not ready.');
          }
        }, 100);
      })
      .catch(err => console.error('Map libs failed to load:', err));
  }
}


function updateCharts() {
    if (currentData.user) {
        setTimeout(() => {
            initializeCharts(currentData.user);
            if (globalMap) {
                globalMap.remove();
                initializeCountryMap(currentData.user);
            }
        }, 100);
    }
}

// Pagination
// USE THIS REPLACEMENT FUNCTION
function generatePagination(type, loadFunction) {
    const pagination = paginationState[type];
    if (!pagination) return '';

    // Create a unique ID for this specific pagination instance and store the handler function
    const handlerId = `${type}_${Date.now()}`;
    paginationHandlers[handlerId] = loadFunction;

    const totalPages = Math.max(1, Math.ceil(pagination.total / pagination.pageSize));
    const currentPage = pagination.page || 1;
    const hasMultiplePages = totalPages > 1;

    let paginationHTML = '<div class="pagination">';

    // Previous button
    paginationHTML += `<button class="pagination-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
    </button>`;

    // Page numbers
    if (hasMultiplePages) {
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', 1)">1</button>`;
            if (startPage > 2) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="callPaginationHandler('${handlerId}', ${i})">${i}</button>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', ${totalPages})">${totalPages}</button>`;
        }
    } else {
        paginationHTML += `<button class="pagination-btn active">1</button>`;
    }

    // Next button
    paginationHTML += `<button class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
    </button>`;

    // Info text
    const startItem = Math.max(1, ((currentPage - 1) * pagination.pageSize) + 1);
    const endItem = Math.min(currentPage * pagination.pageSize, pagination.total);

    paginationHTML += `<div class="pagination-info">
        ${pagination.total > 0 ? `Showing ${startItem} to ${endItem} of ${pagination.total} results` : 'No results'}
    </div>`;

    paginationHTML += '</div>';
    return paginationHTML;
}

// Toast Notifications
function showToast(message, type = 'info') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
    <i class="ri-${type === 'success' ? 'check' : type === 'error' ? 'close' : type === 'warning' ? 'alert' : 'information'}-circle-line"></i>
    <span>${message}</span>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// New Hosting Plan & Subscription Logic (Add this before Utility Functions)
const hostingConfig = {
    packages: {
        "basic": {
            name: "Basic",
            price: { "3month": 10, "6month": 18, "12month": 32 },
            limits: { articles: 200, images: 1000 },
            features: ['1,000 Images', '200 Articles', 'Email Support']
        },
        "professional": {
            name: "Professional",
            price: { "3month": 25, "6month": 45, "12month": 80 },
            limits: { articles: 600, images: 4000 },
            features: ['4,000 Images', '600 Articles', 'Priority Support']
        },
        "enterprise": {
            name: "Enterprise",
            price: { "3month": 50, "6month": 90, "12month": 160 },
            limits: { articles: 2000, images: 20000 },
            features: ['20,000 Images', '2,000 Articles', 'Dedicated Support']
        }
    }
};

let purchaseSelection = { plan: 'professional', duration: '3month' };

function selectPlan(planKey) {
    purchaseSelection.plan = planKey;
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`plan-${planKey}`)?.classList.add('selected');
    updatePriceDisplay();
}

function selectDuration(duration) {
    purchaseSelection.duration = duration;
    updatePriceDisplay();
}

function updatePriceDisplay() {
    if (!purchaseSelection.plan || !purchaseSelection.duration) return;
    const price = hostingConfig.packages[purchaseSelection.plan]?.price[purchaseSelection.duration];
    const priceDisplay = document.getElementById('price-display');
    if (priceDisplay) {
        priceDisplay.textContent = `$${price.toFixed(2)}`;
    }
}

async function purchasePlan() {
    if (!purchaseSelection.plan) {
        showToast("Please select a plan.", "error");
        return;
    }

    const payload = {
        package: purchaseSelection.plan,
        duration: purchaseSelection.duration,
        provider: document.getElementById('payment-provider').value,
        subscription: false,
        cancel_previous: true
    };

    try {
        const { data } = await api('/hosting/buy-package', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        showToast("Redirecting to payment...", "success");
        window.open(data.payment_url, '_blank');
    } catch (error) {
        console.error("Failed to initiate purchase", error);
        showToast('Failed to start purchase: ' + error.message, 'error');
    }
}

async function cancelSubscription() {
    if (confirm("Are you sure you want to cancel your subscription? Your plan will remain active until the end of the current billing period.")) {
        try {
            await api('/hosting/cancel-subscription');
            showToast('Subscription cancelled successfully.', 'success');
            loadBilling(); // Reload the billing page to show updated status
        } catch (error) {
            console.error('Failed to cancel subscription:', error);
            showToast('Failed to cancel subscription: ' + error.message, 'error');
        }
    }
}

function showUpgradePlans() {
    const section = document.getElementById('upgradePlansSection');
    if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
        if (section.style.display === 'block') {
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Utility Functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function showSpinner() {
    document.getElementById('content').innerHTML = `
    <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
    <div class="spinner"></div>
    </div>
    `;
}

function showErrorState(message) {
    document.getElementById('content').innerHTML = `
    <div class="empty-state">
    <div class="empty-state-icon">
    <i class="ri-error-warning-line"></i>
    </div>
    <div class="empty-state-title">Error Loading Data</div>
    <div class="empty-state-description">${message}</div>
    <button class="btn btn-primary" onclick="location.reload()">
    <i class="ri-refresh-line"></i> Retry
    </button>
    </div>
    `;
}

async function logout() {
    try {
        await api('/logout');
    } catch (error) {
        console.error('Logout error:', error);
    } finally {
        // Clear cookie with correct Domain attribute
        document.cookie = 'session_token=; path=/; Domain=.seotize.net; Secure; SameSite=Lax; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
    }
}

// Mobile responsiveness
window.addEventListener('resize', () => {
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (window.innerWidth <= 768) {
        sidebarToggle.style.display = 'block';
    } else {
        sidebarToggle.style.display = 'none';
        document.getElementById('sidebar').classList.remove('active');
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('mobileProfileDropdown');
    const button = document.querySelector('.mobile-profile-menu');
    if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
        closeMobileProfileDropdown();
    }
});

// Initialize theme on page load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
});
</script>
</body>
</html>
