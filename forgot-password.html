<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - SEOTIZE | Reset Your Password</title>
    <meta name="description" content="Reset your SEOTIZE account password securely with email verification.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}:root{--bg:#ffffff;--bg-light:#f8fafc;--bg-dark:#0f172a;--text:#1e293b;--text-light:#64748b;--text-muted:#94a3b8;--border:#e2e8f0;--primary:#2563eb;--card-bg:#ffffff;--nav-bg:rgba(255,255,255,0.95);--success:#059669;--error:#dc2626}body.dark{--bg:#0f172a;--bg-light:#1e293b;--text:#f1f5f9;--text-light:#cbd5e1;--text-muted:#94a3b8;--border:#334155;--card-bg:#1e293b;--nav-bg:rgba(15,23,42,0.95)}body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;transition:all .3s ease;overflow:hidden;height:100vh}

        nav{position:fixed;top:0;width:100%;padding:.75rem 1.5rem;background:var(--nav-bg);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:100;transition:all .3s ease}nav>div{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}.logo{font-size:1.3rem;font-weight:800;color:var(--primary);text-decoration:none}.nav-links{display:flex;list-style:none;gap:1.5rem}.nav-links a{text-decoration:none;color:var(--text);font-weight:500;transition:color .2s ease;font-size:.9rem}.nav-links a:hover{color:var(--primary)}.nav-actions{display:flex;gap:.75rem;align-items:center}.theme-toggle{background:var(--bg-light);border:1px solid var(--border);padding:.4rem;border-radius:6px;cursor:pointer;transition:all .2s ease;color:var(--text);font-size:.9rem}.theme-toggle:hover{transform:scale(1.05)}.mobile-menu-toggle{display:none;background:var(--bg-light);border:1px solid var(--border);padding:.4rem;border-radius:6px;cursor:pointer;color:var(--text);font-size:1rem}

        .main-container{height:100vh;display:flex;padding-top:60px}.content-pane{flex:1;background:linear-gradient(135deg,var(--bg-light),var(--bg));display:flex;flex-direction:column;justify-content:center;align-items:center;padding:1rem;position:relative;overflow:hidden}.forgot-pane{flex:1;background:var(--card-bg);display:flex;align-items:center;justify-content:center;padding:1rem;position:relative;overflow-y:auto}

        .content-showcase{text-align:center;max-width:450px;position:relative;z-index:10}.showcase-image{width:clamp(200px,25vw,280px);height:clamp(200px,25vw,280px);border-radius:20px;margin-bottom:1.5rem;box-shadow:0 15px 30px rgba(37,99,235,.15);transition:all .4s ease;object-fit:cover}.showcase-title{font-size:clamp(1.8rem,4vw,2.2rem);font-weight:800;color:var(--text);margin-bottom:1rem;line-height:1.2}.showcase-text{font-size:clamp(1rem,2.5vw,1.1rem);color:var(--text-light);margin-bottom:1.5rem;min-height:50px;display:flex;align-items:center;justify-content:center}.typewriter-cursor{display:inline-block;width:2px;height:1.2em;background:var(--primary);margin-left:2px;animation:blink 1s infinite}@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}

        .forgot-card{background:var(--card-bg);padding:clamp(1.5rem,4vw,2.5rem);border-radius:16px;border:1px solid var(--border);box-shadow:0 15px 25px rgba(0,0,0,.1);width:100%;max-width:400px;position:relative;margin:auto}

        .forgot-header{text-align:center;margin-bottom:1.5rem}.forgot-header h1{font-size:clamp(1.6rem,4vw,2rem);font-weight:800;color:var(--text);margin-bottom:.5rem}.forgot-header p{color:var(--text-light);font-size:clamp(.9rem,2.5vw,1rem)}

        .step-indicator{display:flex;justify-content:center;gap:.75rem;margin-bottom:1.5rem}.step{width:10px;height:10px;border-radius:50%;background:var(--border);transition:all .3s ease}.step.active{background:var(--primary);transform:scale(1.3)}.step.completed{background:var(--primary)}

        .form-container{position:relative;overflow:hidden}.form-step{transition:all .5s cubic-bezier(0.4,0,0.2,1)}.form-step.hidden{transform:translateX(100%);opacity:0;position:absolute;top:0;left:0;width:100%;pointer-events:none}.form-step.prev{transform:translateX(-100%);opacity:0;position:absolute;top:0;left:0;width:100%;pointer-events:none}

        .form-group{margin-bottom:1.2rem;position:relative}.form-label{display:block;margin-bottom:.4rem;font-weight:600;color:var(--text);font-size:.85rem}.form-input{width:100%;padding:.9rem;border:2px solid var(--border);border-radius:8px;font-size:.95rem;background:var(--bg-light);color:var(--text);transition:all .3s ease}.form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--card-bg)}.form-input.error{border-color:var(--error);background:rgba(220,38,38,.05)}.form-input.success{border-color:var(--success);background:rgba(5,150,105,.05)}.input-icon{position:absolute;right:.8rem;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:.9rem}.input-icon.success{color:var(--success)}.input-icon.error{color:var(--error)}

        .password-requirements{margin-top:.5rem;font-size:.75rem;color:var(--text-muted);line-height:1.4}.requirement{display:flex;align-items:center;gap:.3rem;margin:.2rem 0;transition:color .3s ease}.requirement.valid{color:var(--success)}.requirement.invalid{color:var(--error)}.requirement-icon{font-size:.7rem;width:12px;text-align:center}

        .otp-container{display:flex;gap:.5rem;justify-content:center;margin:1rem 0}.otp-input{width:40px;height:40px;text-align:center;border:2px solid var(--border);border-radius:8px;font-size:1.1rem;font-weight:600;background:var(--bg-light);color:var(--text);transition:all .3s ease}.otp-input:focus{outline:none;border-color:var(--primary);transform:scale(1.05);box-shadow:0 0 0 3px rgba(37,99,235,.1)}.otp-input.filled{border-color:var(--success);background:rgba(5,150,105,.05)}

        .password-strength{margin-top:.5rem;height:4px;background:var(--border);border-radius:2px;overflow:hidden}.strength-bar{height:100%;transition:all .4s ease;border-radius:2px;width:0%}.strength-bar.weak{width:25%;background:var(--error)}.strength-bar.medium{width:50%;background:#f59e0b}.strength-bar.strong{width:75%;background:var(--success)}.strength-bar.very-strong{width:100%;background:linear-gradient(135deg,var(--success),var(--primary))}.strength-text{font-size:.75rem;margin-top:.3rem;color:var(--text-muted)}

        .captcha-container{margin:1rem 0;display:flex;justify-content:center}.captcha-placeholder{width:280px;height:60px;background:var(--bg-light);border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:.85rem;cursor:pointer;transition:all .3s ease}.captcha-placeholder:hover{border-color:var(--primary);background:rgba(37,99,235,.05)}.captcha-placeholder.completed{border-color:var(--success);background:rgba(5,150,105,.05);color:var(--success);border-style:solid}

        .timer{text-align:center;margin:.5rem 0;color:var(--text-muted);font-size:.8rem;padding:.4rem;background:var(--bg-light);border-radius:6px}.timer.warning{color:var(--error);background:rgba(220,38,38,.05)}

        .form-btn{width:100%;padding:.9rem 1.5rem;border:none;border-radius:8px;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .3s ease;margin-bottom:1rem}.form-btn:disabled{cursor:not-allowed;opacity:.6}.form-btn.primary{background:var(--primary);color:white}.form-btn.primary:hover:not(:disabled){background:#1e40af;transform:translateY(-1px)}.form-btn.primary:disabled{background:var(--text-muted)}.form-btn.secondary{background:var(--bg-light);color:var(--text);border:1px solid var(--border)}.form-btn.secondary:hover{background:var(--card-bg);border-color:var(--primary)}

        .spinner{width:14px;height:14px;border:2px solid transparent;border-top:2px solid white;border-radius:50%;animation:spin 1s linear infinite;margin-right:.5rem}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

        .back-link{text-align:center;margin-top:1rem}.back-link a{color:var(--primary);text-decoration:none;font-weight:600;font-size:.85rem}.back-link a:hover{color:#1e40af}

        .mobile-menu{position:fixed;top:0;left:-100%;width:80%;height:100vh;background:var(--card-bg);border-right:1px solid var(--border);transition:left .3s ease;z-index:200;padding:2rem}.mobile-menu.active{left:0}.mobile-menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}.mobile-menu-close{background:none;border:none;font-size:1.5rem;color:var(--text);cursor:pointer}.mobile-menu-links{list-style:none}.mobile-menu-links li{margin:1rem 0}.mobile-menu-links a{text-decoration:none;color:var(--text);font-size:1.125rem;font-weight:500;display:block;padding:.5rem 0}.mobile-menu-links a:hover{color:var(--primary)}.mobile-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:150;opacity:0;visibility:hidden;transition:all .3s ease}.mobile-overlay.active{opacity:1;visibility:visible}

        .notification{position:fixed;top:80px;right:1rem;padding:.8rem 1.2rem;border-radius:8px;color:white;font-weight:500;transform:translateX(100%);transition:transform .3s ease;z-index:1000;font-size:.9rem;opacity:0;visibility:hidden}.notification.success{background:var(--success)}.notification.error{background:var(--error)}.notification.show{transform:translateX(0);opacity:1;visibility:visible}

        /* Mobile Bottom Navigation */
        .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);z-index:100;padding:0.625rem 0.875rem;box-shadow:0 -4px 12px rgba(0,0,0,0.05);height:68px}
        .mobile-items{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;max-width:600px;height:100%;margin:0 auto}
        .mobile-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.25rem;padding:0.375rem;color:var(--text-muted);text-decoration:none;font-size:0.75rem;font-weight:500;border-radius:8px;transition:all 0.3s ease}
        .mobile-item.active{color:var(--primary);background:rgba(37,99,235,0.1)}
        body.dark .mobile-item{color:var(--text-light)}
        body.dark .mobile-item.active{color:var(--primary);background:rgba(59,130,246,0.15)}
        .mobile-item i{font-size:1.375rem}

        @media(max-width:1200px){.main-container{flex-direction:column}.content-pane{flex:none;height:40vh;padding:.5rem}.forgot-pane{flex:1;height:60vh;padding:4rem}.forgot-card{max-width:350px}}@media(max-width:768px){.nav-links{display:none}.mobile-menu-toggle{display:block}.mobile-nav{display:block}body{padding-bottom:68px}.content-pane{display:none}.forgot-pane{height:100vh}.forgot-card{padding:1.5rem;margin-top:0}.otp-input{width:35px;height:35px;font-size:1rem}.mobile-item{font-size:0.6875rem;gap:0.2rem}.mobile-item i{font-size:1.25rem}}@media(max-width:480px){nav{padding:1.5rem 1rem}.forgot-card{padding:4.7rem;max-width:90vw}.forgot-header h1{font-size:1.5rem}.otp-input{width:32px;height:32px;font-size:.9rem}.mobile-menu{width:90%;max-width:280px;padding:1.5rem}}@media(max-height:700px){.main-container{padding-top:50px}.content-pane{height:35vh}.forgot-pane{height:65vh}}@media(max-height:600px){.content-pane{display:none}.forgot-pane{height:100vh;padding-top:60px}}
    </style>
</head>
<body>
    <nav>
        <div>
            <a href="index.html" class="logo">SEOTIZE</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#features">Features</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="blogs.html">Blog</a></li>
            </ul>
            <div class="nav-actions">
                <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            </div>
        </div>
    </nav>

    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span class="logo">SEOTIZE</span>
            <button class="mobile-menu-close" onclick="toggleMobileMenu()">‚úï</button>
        </div>
        <ul class="mobile-menu-links">
            <li><a href="index.html" onclick="toggleMobileMenu()">Home</a></li>
            <li><a href="index.html#features" onclick="toggleMobileMenu()">Features</a></li>
            <li><a href="index.html#about" onclick="toggleMobileMenu()">About</a></li>
            <li><a href="blogs.html" onclick="toggleMobileMenu()">Blog</a></li>
        </ul>
    </div>
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-items">
            <a href="index.html" class="mobile-item">
                <i class="ri-home-5-line"></i>
                <span>Home</span>
            </a>
            <a href="index.html#features" class="mobile-item">
                <i class="ri-flashlight-line"></i>
                <span>Features</span>
            </a>
            <a href="blogs.html" class="mobile-item">
                <i class="ri-article-line"></i>
                <span>Blog</span>
            </a>
            <a href="login.html" class="mobile-item active">
                <i class="ri-lock-password-line"></i>
                <span>Reset</span>
            </a>
        </div>
    </nav>

    <main class="main-container">
        <section class="content-pane">
            <div class="content-showcase">
                <img id="showcaseImage" class="showcase-image" src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=280&h=280&fit=crop" alt="Password Reset">
                <h1 class="showcase-title">Reset Your <span style="color:var(--primary)">Password</span></h1>
                <div class="showcase-text" id="typewriterText">Secure password recovery process<span class="typewriter-cursor"></span></div>
            </div>
        </section>

        <section class="forgot-pane">
            <div class="forgot-card" id="forgotCard">
                <div class="forgot-header">
                    <h1>Forgot Password</h1>
                    <p id="stepDescription">Enter your email to reset your password</p>
                </div>

                <div class="step-indicator">
                    <div class="step active" id="step1"></div>
                    <div class="step" id="step2"></div>
                </div>

                <div class="form-container">
                    <!-- Step 1: Email -->
                    <div class="form-step" id="formStep1">
                        <div class="form-group">
                            <label class="form-label" for="email">Email Address</label>
                            <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
                            <div class="input-icon" id="emailIcon"></div>
                        </div>
                        <div class="captcha-container">
                            <div class="cf-turnstile" data-sitekey="0x4AAAAAABi0oSEk-fxks-xg" data-callback="onCaptchaSuccess" style="display:none"></div>
                            <div class="captcha-placeholder" id="captchaPlaceholder" onclick="toggleCaptcha()">
                                üîí Click to verify you're human
                            </div>
                        </div>
                        <button type="submit" class="form-btn primary" id="emailBtn" disabled>Send Reset Code</button>
                        <div class="back-link">
                            <a href="login.html">‚Üê Back to Sign In</a>
                        </div>
                    </div>

                    <!-- Step 2: New Password -->
                    <div class="form-step hidden" id="formStep2">
                        <div class="form-group">
                            <label class="form-label">Verification Code</label>
                            <p style="color:var(--text-light);font-size:.85rem;margin-bottom:1rem;">Enter the 6-digit code sent to your email</p>
                            <div class="otp-container">
                                <input type="text" class="otp-input" maxlength="1" data-index="0">
                                <input type="text" class="otp-input" maxlength="1" data-index="1">
                                <input type="text" class="otp-input" maxlength="1" data-index="2">
                                <input type="text" class="otp-input" maxlength="1" data-index="3">
                                <input type="text" class="otp-input" maxlength="1" data-index="4">
                                <input type="text" class="otp-input" maxlength="1" data-index="5">
                            </div>
                            <div class="timer" id="timer">Code expires in 5:00</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="newPassword">New Password</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="Enter new password" required>
                            <div class="input-icon" id="newPasswordIcon"></div>
                            <div class="password-requirements" id="passwordRequirements">
                                <div class="requirement" id="lengthReq">
                                    <span class="requirement-icon">‚Ä¢</span>
                                    <span>At least 8 characters long</span>
                                </div>
                                <div class="requirement" id="numberReq">
                                    <span class="requirement-icon">‚Ä¢</span>
                                    <span>Include a number</span>
                                </div>
                                <div class="requirement" id="uppercaseReq">
                                    <span class="requirement-icon">‚Ä¢</span>
                                    <span>Include an uppercase letter</span>
                                </div>
                                <div class="requirement" id="lowercaseReq">
                                    <span class="requirement-icon">‚Ä¢</span>
                                    <span>Include a lowercase letter</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password" required>
                            <div class="input-icon" id="confirmPasswordIcon"></div>
                        </div>
                        <button type="submit" class="form-btn primary" id="resetBtn" disabled>Reset Password</button>
                        <button type="button" class="form-btn secondary" onclick="goBackToStep1()">Back</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div class="notification" id="notification"></div>

    <script>
        // --- COOKIE HELPER FUNCTIONS ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        const API_BASE = 'https://api.seotize.net';
        const showcaseData = [
            {text: "Secure password recovery process", image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=280&h=280&fit=crop"},
            {text: "Get back to your SEO dashboard quickly", image: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=280&h=280&fit=crop"},
            {text: "Protect your account with strong passwords", image: "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=280&h=280&fit=crop"}
        ];
        let currentIndex = 0, typewriterTimeline, captchaToken = 'localhost-dev-token', timerInterval, currentStep = 1, userEmail = '', isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1', notificationTimeout;

        gsap.registerPlugin(TextPlugin);
        
        document.addEventListener('DOMContentLoaded', () => {
            // First, check if the user is already logged in.
            if (getCookie('session_token')) {
                // If a token exists, go directly to the dashboard.
                window.location.href = '/dashboard'; 
                return; // Stop further execution of forgot password page scripts.
            }

            // If not logged in, proceed with initializing the page.
            init();
        });

        function init() {
            animateEntrance();
            setupFormValidation();
            setupOTPInputs();
            startShowcase();
            loadTheme();
            if (isLocalhost) setupLocalhostMode();
        }

        function setupLocalhostMode() {
            document.querySelector('.captcha-placeholder').classList.add('completed');
            document.querySelector('.captcha-placeholder').innerHTML = '‚úÖ Localhost Mode - Captcha Bypassed';
            validateEmail();
        }

        function toggleCaptcha() {
            if (isLocalhost) {
                captchaToken = 'localhost-dev-token';
                document.querySelector('.captcha-placeholder').classList.add('completed');
                document.querySelector('.captcha-placeholder').innerHTML = '‚úÖ Localhost Mode - Captcha Bypassed';
                validateEmail();
                return;
            }
            const turnstile = document.querySelector('.cf-turnstile'), placeholder = document.querySelector('.captcha-placeholder');
            turnstile.style.display = 'block';
            placeholder.style.display = 'none';
        }

        function animateEntrance() {
            gsap.fromTo('.content-showcase', {opacity: 0, x: -30}, {opacity: 1, x: 0, duration: .6});
            gsap.fromTo('.forgot-card', {opacity: 0, x: 30}, {opacity: 1, x: 0, duration: .6, delay: .2});
        }

        function startShowcase() {
            typeText(currentIndex);
            setInterval(() => {
                currentIndex = (currentIndex + 1) % showcaseData.length;
                updateShowcase();
            }, 4000);
        }

        function updateShowcase() {
            const image = document.getElementById('showcaseImage');
            gsap.to(image, {
                scale: .9, opacity: .8, duration: .3,
                onComplete: () => {
                    image.src = showcaseData[currentIndex].image;
                    gsap.to(image, {scale: 1, opacity: 1, duration: .4});
                }
            });
            setTimeout(() => typeText(currentIndex), 300);
        }

        function typeText(index) {
            if (typewriterTimeline) typewriterTimeline.kill();
            const element = document.getElementById('typewriterText');
            const text = showcaseData[index].text;
            element.innerHTML = '<span class="typewriter-cursor"></span>';
            typewriterTimeline = gsap.timeline();
            typewriterTimeline.to(element, {
                duration: text.length * 0.04,
                ease: "none",
                text: {value: text, delimiter: ""},
                onUpdate: () => {
                    if (!element.innerHTML.includes('typewriter-cursor')) {
                        element.innerHTML += '<span class="typewriter-cursor"></span>';
                    }
                }
            });
        }

        function setupFormValidation() {
            document.getElementById('email').addEventListener('input', validateEmail);
            document.getElementById('email').addEventListener('keypress', e => {
                if (e.key === 'Enter') document.getElementById('emailBtn').click();
            });
            document.getElementById('newPassword').addEventListener('input', () => {
                validatePassword();
                updatePasswordRequirements();
            });
            document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);
            document.getElementById('emailBtn').addEventListener('click', handleEmailSubmit);
            document.getElementById('resetBtn').addEventListener('click', handleResetSubmit);
        }

        function setupOTPInputs() {
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', e => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                    if (value && index < 5) otpInputs[index + 1].focus();
                    if (value) e.target.classList.add('filled');
                    else e.target.classList.remove('filled');
                    checkOTPComplete();
                });
                input.addEventListener('keydown', e => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                    if (e.key === 'Enter' && checkOTPComplete()) {
                        document.getElementById('resetBtn').click();
                    }
                });
                input.addEventListener('paste', e => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                    if (pastedData.length >= 6) {
                        for (let i = 0; i < 6 && i < pastedData.length; i++) {
                            otpInputs[i].value = pastedData[i];
                            otpInputs[i].classList.add('filled');
                        }
                        otpInputs[Math.min(5, pastedData.length - 1)].focus();
                        checkOTPComplete();
                    } else if (pastedData.length > 0) {
                        const startIndex = index;
                        for (let i = 0; i < pastedData.length && (startIndex + i) < 6; i++) {
                            otpInputs[startIndex + i].value = pastedData[i];
                            otpInputs[startIndex + i].classList.add('filled');
                        }
                        const nextIndex = Math.min(5, startIndex + pastedData.length);
                        otpInputs[nextIndex].focus();
                        checkOTPComplete();
                    }
                });
            });
        }

        function validateEmail() {
            const email = document.getElementById('email').value.trim();
            const icon = document.getElementById('emailIcon');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const emailBtn = document.getElementById('emailBtn');
            
            if (email && emailRegex.test(email)) {
                setFieldState(document.getElementById('email'), icon, 'success');
                emailBtn.disabled = !captchaToken;
                return true;
            } else if (email) {
                setFieldState(document.getElementById('email'), icon, 'error');
                emailBtn.disabled = true;
                return false;
            } else {
                setFieldState(document.getElementById('email'), icon, 'neutral');
                emailBtn.disabled = true;
                return false;
            }
        }

        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            const isValid = isPasswordValid(password);
            const icon = document.getElementById('newPasswordIcon');
            
            if (isValid) {
                setFieldState(document.getElementById('newPassword'), icon, 'success');
            } else if (password.length > 0) {
                document.getElementById('newPassword').classList.remove('success', 'error');
                icon.innerHTML = '';
                icon.className = 'input-icon';
            } else {
                setFieldState(document.getElementById('newPassword'), icon, 'neutral');
            }
            
            if (document.getElementById('confirmPassword').value) {
                validateConfirmPassword();
            }
            checkResetFormValidity();
        }

        function isPasswordValid(password) {
            return password.length >= 8 && /[a-z]/.test(password) && /[A-Z]/.test(password) && /[0-9]/.test(password);
        }

        function updatePasswordRequirements() {
            const password = document.getElementById('newPassword').value;
            updateRequirement('lengthReq', password.length >= 8);
            updateRequirement('lowercaseReq', /[a-z]/.test(password));
            updateRequirement('uppercaseReq', /[A-Z]/.test(password));
            updateRequirement('numberReq', /[0-9]/.test(password));
        }

        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            const icon = element.querySelector('.requirement-icon');
            element.className = `requirement ${isValid ? 'valid' : 'invalid'}`;
            icon.textContent = isValid ? '‚úì' : '‚Ä¢';
        }

        function validateConfirmPassword() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const icon = document.getElementById('confirmPasswordIcon');
            
            if (confirmPassword && password === confirmPassword) {
                setFieldState(document.getElementById('confirmPassword'), icon, 'success');
                checkResetFormValidity();
                return true;
            } else if (confirmPassword) {
                setFieldState(document.getElementById('confirmPassword'), icon, 'error');
                checkResetFormValidity();
                return false;
            } else {
                setFieldState(document.getElementById('confirmPassword'), icon, 'neutral');
                checkResetFormValidity();
                return false;
            }
        }

        function setFieldState(input, icon, state) {
            input.classList.remove('error', 'success');
            icon.className = 'input-icon';
            if (state === 'success') {
                input.classList.add('success');
                icon.innerHTML = '‚úì';
                icon.className = 'input-icon success';
            } else if (state === 'error') {
                input.classList.add('error');
                icon.innerHTML = '‚úó';
                icon.className = 'input-icon error';
            } else {
                icon.innerHTML = '';
            }
        }

        function checkOTPComplete() {
            const otp = Array.from(document.querySelectorAll('.otp-input')).map(input => input.value).join('');
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = otp.length !== 6;
            return otp.length === 6;
        }

        function checkResetFormValidity() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetBtn = document.getElementById('resetBtn');
            const isValid = isPasswordValid(password) && password === confirmPassword && confirmPassword.length > 0;
            resetBtn.disabled = !isValid;
        }

        function onCaptchaSuccess(token) {
            captchaToken = token;
            document.querySelector('.captcha-placeholder').style.display = 'none';
            validateEmail();
        }

        async function handleEmailSubmit(e) {
            e.preventDefault();
            const emailBtn = document.getElementById('emailBtn');
            const email = document.getElementById('email').value.trim();
            
            if (!validateEmail()) {
                showNotification('Please enter a valid email', 'error');
                return;
            }
            if (!captchaToken) {
                showNotification('Please complete the captcha', 'error');
                return;
            }
            
            emailBtn.innerHTML = '<div class="spinner"></div>Sending...';
            emailBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/forget-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        'cf-turnstile-response': captchaToken
                    })
                });
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    userEmail = email;
                    showNotification(data.data?.message || 'Reset code sent!', 'success');
                    goToStep2();
                } else {
                    showNotification(data.error?.message || 'Failed to send reset code', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            } finally {
                emailBtn.innerHTML = 'Send Reset Code';
                validateEmail();
            }
        }

        async function handleResetSubmit(e) {
            e.preventDefault();
            const resetBtn = document.getElementById('resetBtn');
            const otp = Array.from(document.querySelectorAll('.otp-input')).map(input => input.value).join('');
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!isPasswordValid(password)) {
                showNotification('Password must be at least 8 characters long, include a number, an uppercase and a lowercase letter.', 'error');
                return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            resetBtn.innerHTML = '<div class="spinner"></div>Resetting...';
            resetBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/verify-forget-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: userEmail,
                        otp: otp,
                        new_password: password
                    })
                });
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    showNotification('Password reset successfully! Redirecting to login...', 'success');
                    
                    // Set the session token in a cookie
                    setCookie('session_token', data.data.session_token);
                    
                    // Redirect to the dashboard
                    setTimeout(() => window.location.href = '/dashboard', 1500);
                } else {
                    showNotification(data.error?.message || 'Password reset failed', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            } finally {
                resetBtn.innerHTML = 'Reset Password';
                checkOTPComplete();
            }
        }

        function goToStep2() {
            currentStep = 2;
            updateStepIndicator();
            document.getElementById('stepDescription').textContent = 'Enter verification code and new password';
            animateStepTransition('formStep1', 'formStep2');
            startTimer();
            setTimeout(() => document.querySelectorAll('.otp-input')[0].focus(), 500);
        }

        function goBackToStep1() {
            currentStep = 1;
            updateStepIndicator();
            document.getElementById('stepDescription').textContent = 'Enter your email to reset your password';
            animateStepTransition('formStep2', 'formStep1', 'prev');
            if (timerInterval) clearInterval(timerInterval);
            document.querySelectorAll('.otp-input').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 2; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        function animateStepTransition(fromStep, toStep, direction = 'next') {
            const from = document.getElementById(fromStep);
            const to = document.getElementById(toStep);
            const timeline = gsap.timeline();
            
            if (direction === 'next') {
                timeline.to(from, {x: -30, opacity: 0, duration: 0.3, ease: "power2.in"})
                    .set(from, {className: 'form-step prev'})
                    .set(to, {className: 'form-step', x: 30, opacity: 0})
                    .to(to, {x: 0, opacity: 1, duration: 0.4, ease: "power2.out"});
            } else {
                timeline.to(from, {x: 30, opacity: 0, duration: 0.3, ease: "power2.in"})
                    .set(from, {className: 'form-step hidden'})
                    .set(to, {className: 'form-step', x: -30, opacity: 0})
                    .to(to, {x: 0, opacity: 1, duration: 0.4, ease: "power2.out"});
            }
        }

        function startTimer() {
            let timeLeft = 300;
            const timerElement = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `Code expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft <= 60) timerElement.classList.add('warning');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = 'Code expired';
                    showNotification('Verification code expired. Please request a new one.', 'error');
                }
                timeLeft--;
            }, 1000);
        }

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            if (notificationTimeout) clearTimeout(notificationTimeout);
            n.textContent = msg;
            n.className = `notification ${type} show`;
            notificationTimeout = setTimeout(() => n.classList.remove('show'), 3000);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileOverlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const toggle = document.querySelector('.theme-toggle');
            const isDark = document.body.classList.contains('dark');
            toggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }
    </script>
</body>
</html>
