<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEOTIZE Dashboard</title>
<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
:root {
  --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8; --secondary: #10b981;
  --secondary-dark: #059669; --accent: #f59e0b; --error: #ef4444; --warning: #f59e0b;
  --success: #10b981; --info: #3b82f6; --danger: #e63946;
  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-accent: linear-gradient(135deg, #fa709a 0%, #fee140 100%); --radius-sm: 8px;
  --radius: 12px; --radius-lg: 16px; --radius-xl: 24px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1); --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
[data-theme="light"] {
  --bg: #f8f9fa; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef; --sidebar: #ffffff;
  --card: #ffffff; --card-hover: #f8f9fa; --text: #212529; --text-secondary: #6c757d;
  --text-tertiary: #adb5bd; --border: #dee2e6; --input-bg: #ffffff;
  --overlay: rgba(255, 255, 255, 0.95); --glass: rgba(255, 255, 255, 0.7); --glass-border: rgba(0, 0, 0, 0.1);
}
[data-theme="dark"] {
  --bg: #0a0a0a; --bg-secondary: #1a1a1a; --bg-tertiary: #2a2a2a; --sidebar: #141414;
  --card: #1f1f1f; --card-hover: #2a2a2a; --text: #ffffff; --text-secondary: #a0a0a0;
  --text-tertiary: #6b6b6b; --border: rgba(255, 255, 255, 0.1); --input-bg: #1a1a1a;
  --overlay: rgba(0, 0, 0, 0.95); --glass: rgba(255, 255, 255, 0.05); --glass-border: rgba(255, 255, 255, 0.1);
}
* {
  margin: 0; padding: 0; box-sizing: border-box;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg);
  color: var(--text); min-height: 100vh; transition: var(--transition); line-height: 1.6; overflow-x: hidden;
}
.dashboard-layout {
  display: flex; min-height: 100vh;
}
.sidebar {
  width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex;
  flex-direction: column; transition: var(--transition);
}
.sidebar-header {
  padding: 1.5rem; border-bottom: 1px solid var(--border);
}
.logo {
  display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 800;
  color: var(--primary); text-decoration: none;
}
.logox {
  display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 800;
  color: var(--primary); text-decoration: none;
}
.logo-icon {
  display: flex; align-items: flex-end; gap: 4px; height: 24px;
}
.logo-bar {
  width: 6px; border-radius: 2px; transform-origin: bottom; transition: all 0.3s ease;
}
.logo-b1 {
  height: 40%; background: linear-gradient(180deg, #f59e0b 0%, #f97316 100%);
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
}
.logo-b2 {
  height: 70%; background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
  box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
}
.logo-b3 {
  height: 100%; background: linear-gradient(180deg, #06b6d4 0%, #0891b2 100%);
  box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);
}
.sidebar-nav {
  flex: 1; padding: 1rem; overflow-y: auto;
}
.nav-section {
  margin-bottom: 1.5rem;
}
.nav-section-title {
  font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase;
  letter-spacing: 0.05em; margin-bottom: 0.5rem; padding: 0 0.75rem;
}
.nav-item {
  display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: var(--radius);
  color: var(--text-secondary); text-decoration: none; transition: var(--transition);
  cursor: pointer; margin-bottom: 0.25rem;
}
.nav-item:hover {
  background: var(--card); color: var(--text);
}
.nav-item.active {
  background: var(--primary); color: white;
}
.nav-item i {
  font-size: 1.25rem; width: 1.5rem; text-align: center;
}
.main-content {
  flex: 1; display: flex; flex-direction: column; overflow: hidden;
}
.header {
  background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem;
  display: flex; justify-content: space-between; align-items: center;
}
.header-left {
  display: flex; align-items: center; gap: 1rem;
}
.search-bar {
  position: relative; width: 300px;
}
.search-bar input {
  width: 100%; padding: 0.625rem 1rem 0.625rem 2.5rem; border: 1px solid var(--border);
  border-radius: var(--radius); background: var(--input-bg); color: var(--text);
  font-size: 0.875rem; transition: var(--transition);
}
.search-bar input:focus {
  outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
.search-bar i {
  position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);
}
.header-right {
  display: flex; align-items: center; gap: 1rem;
}
.theme-toggle {
  padding: 0.5rem; border-radius: var(--radius); background: transparent; border: none;
  color: var(--text); cursor: pointer; font-size: 1.25rem; transition: var(--transition);
}
.theme-toggle:hover {
  background: var(--card);
}
.user-menu {
  display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem;
  border-radius: var(--radius); background: var(--card); cursor: pointer; transition: var(--transition);
}
.user-menu:hover {
  background: var(--card-hover);
}
.user-avatar {
  width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-primary);
  display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;
}
.content {
  flex: 1; padding: 1.5rem; overflow-y: auto;
}
.card {
  background: var(--card); border-radius: var(--radius-lg); border: 1px solid var(--border);
  transition: var(--transition);
}
.card-header {
  padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex;
  justify-content: space-between; align-items: center;
}
.card-title {
  font-size: 1.125rem; font-weight: 600; color: var(--text);
}
.card-body {
  padding: 1.25rem;
}
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;
}
.stat-card {
  background: var(--card); border-radius: var(--radius); padding: 1.25rem;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 1rem;
  transition: var(--transition); position: relative; overflow: hidden;
}
.stat-card:hover {
  transform: translateY(-2px); box-shadow: var(--shadow-lg);
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary);
}
.stat-icon {
  width: 40px; height: 40px; border-radius: var(--radius); display: flex; align-items: center;
  justify-content: center; font-size: 1.25rem; flex-shrink: 0;
}
.stat-icon.primary {
  background: rgba(99, 102, 241, 0.1); color: var(--primary);
}
.stat-icon.success {
  background: rgba(16, 185, 129, 0.1); color: var(--success);
}
.stat-icon.warning {
  background: rgba(245, 158, 11, 0.1); color: var(--warning);
}
.stat-icon.error {
  background: rgba(239, 68, 68, 0.1); color: var(--error);
}
.stat-content {
  flex: 1; min-width: 0;
}
.stat-value {
  font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.25rem;
}
.stat-label {
  font-size: 0.875rem; color: var(--text-secondary);
}
.btn {
  padding: 0.625rem 1.25rem; border-radius: var(--radius); font-weight: 500; font-size: 0.875rem;
  border: none; cursor: pointer; transition: var(--transition); display: inline-flex;
  align-items: center; gap: 0.5rem; text-decoration: none;
}
.btn-primary {
  background: var(--primary); color: white;
}
.btn-primary:hover {
  background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow);
}
.btn-secondary {
  background: var(--bg-tertiary); color: var(--text);
}
.btn-secondary:hover {
  background: var(--card);
}
.btn-danger {
  background: var(--error); color: white;
}
.btn-danger:hover {
  background: #dc2626;
}
.btn-sm {
  padding: 0.375rem 0.75rem; font-size: 0.8125rem;
}
.form-group {
  margin-bottom: 1.5rem;
}
.form-label {
  display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text);
}
.form-input,
.form-select,
.form-textarea {
  width: 100%; padding: 0.625rem 1rem; border: 1px solid var(--border);
  border-radius: var(--radius); background: var(--input-bg); color: var(--text);
  font-size: 0.875rem; transition: var(--transition);
}
.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
.form-textarea {
  resize: vertical; min-height: 100px;
}
.table-container {
  overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border);
}
table {
  width: 100%; border-collapse: collapse;
}
th {
  background: var(--bg-tertiary); padding: 0.75rem 1rem; text-align: left; font-weight: 600;
  color: var(--text); border-bottom: 1px solid var(--border);
}
td {
  padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); color: var(--text-secondary);
}
tr:hover {
  background: var(--card-hover);
}
.pagination {
  display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem;
  padding: 1rem; background: var(--card); border-radius: var(--radius); border: 1px solid var(--border);
}
.pagination-btn {
  padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--bg-secondary); color: var(--text); cursor: pointer;
  transition: var(--transition); font-size: 0.875rem;
}
.pagination-btn:hover:not(:disabled) {
  background: var(--primary); color: white; border-color: var(--primary);
}
.pagination-btn:disabled {
  opacity: 0.5; cursor: not-allowed;
}
.pagination-btn.active {
  background: var(--primary); color: white; border-color: var(--primary);
}
.pagination-info {
  margin: 0 1rem; color: var(--text-secondary); font-size: 0.875rem;
}
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; animation: fadeIn 0.3s;
}
.modal-overlay.active {
  display: flex; align-items: center; justify-content: center;
}
.modal {
  background: var(--card); border-radius: var(--radius-xl); max-width: 90vw; width: 900px;
  max-height: 90vh; overflow: hidden; animation: slideUp 0.3s;
}
.modal-header {
  padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex;
  justify-content: space-between; align-items: center;
}
.modal-title {
  font-size: 1.25rem; font-weight: 600; color: var(--text);
}
.modal-close {
  background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem;
  cursor: pointer; padding: 0.25rem; transition: var(--transition);
}
.modal-close:hover {
  color: var(--text);
}
.modal-body {
  padding: 1.5rem; max-height: calc(90vh - 40px); overflow-y: auto;
}
.toast {
  position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; background: var(--card);
  border-radius: var(--radius); box-shadow: var(--shadow-xl); display: flex; align-items: center;
  gap: 0.75rem; animation: slideInRight 0.3s; z-index: 2000;
}
.toast.success {
  border-left: 4px solid var(--success);
}
.toast.error {
  border-left: 4px solid var(--error);
}
.toast.warning {
  border-left: 4px solid var(--warning);
}
.toast.info {
  border-left: 4px solid var(--info);
}
.chart-container {
  position: relative; height: 280px !important; width: 100%; overflow: hidden;
}
.chart-container canvas {
  width: 100% !important; height: 100% !important; max-width: 100%; max-height: 100%;
}
.map-container {
  height: 280px !important; width: 100%; border-radius: var(--radius);f; overflow: hidden;
  border: 1px solid var(--border);
}
.leaflet-container {
  background: var(--bg-tertiary) !important;
}
.leaflet-tile-pane {
  filter: var(--map-filter, none);
}
[data-theme="dark"] .leaflet-tile-pane {
  --map-filter: hue-rotate(180deg) invert(100%) brightness(70%) contrast(120%);
}
.task-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;
}
.task-card {
  background: var(--card); border-radius: var(--radius-lg); border: 1px solid var(--border);
  padding: 1.25rem; transition: var(--transition); cursor: pointer;
}
.task-card:hover {
  transform: translateY(-2px); box-shadow: var(--shadow-lg);
}
.task-header {
  display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;
}
.task-url-wrapper {
  flex: 1; min-width: 0;
}
.task-url {
  font-weight: 600; color: var(--primary); text-decoration: none; word-break: break-all;
  font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.35rem;
}
.task-url i {
  font-size: 0.85rem; opacity: 0.8;
}
.task-date {
  font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;
}
.task-status {
  padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;
}
.task-status.active {
  background: rgba(16, 185, 129, 0.1); color: var(--success);
}
.task-status.paused {
  background: rgba(245, 158, 11, 0.1); color: var(--warning);
}
.task-status.completed {
  background: rgba(99, 102, 241, 0.1); color: var(--primary);
}
.task-status.unverified {
  background: rgba(239, 68, 68, 0.1); color: var(--error);
}
.task-card.unverified {
  opacity: 0.7; border: 1px dashed var(--border);
}
.task-card.unverified .task-url {
  color: var(--text-secondary);
}
.task-stats {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 1rem 0;
}
.task-stat {
  display: flex; flex-direction: column;
}
.task-stat-label {
  font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;
}
.task-stat-value {
  font-size: 1.125rem; font-weight: 600; color: var(--text);
}
.task-progress {
  margin: 1rem 0;
}
.progress-bar {
  height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: var(--gradient-primary); transition: width 0.3s ease;
}
.task-actions {
  display: flex; gap: 0.5rem; margin-top: 1rem;
}
.btn-recharge-task {
  background: var(--success); color: #fff;
}
.btn-recharge-task:hover {
  filter: brightness(0.95); transform: translateY(-1px); box-shadow: var(--shadow);
}
.btn-delete-task-mobile {
  display: none;
}
.website-preview {
  width: 100%; height: 450px; border: 2px solid var(--border); border-radius: var(--radius);
  background: #fff; position: relative; overflow: hidden; margin-bottom: 1rem;
}
.website-preview iframe {
  width: 100%; height: 100%; border: none; background: #fff;
}
.preview-controls {
  position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;
  background: rgba(0, 0, 0, 0.8); padding: 8px; border-radius: var(--radius); z-index: 10;
}
.preview-btn {
  padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px;
  font-size: 0.75rem; cursor: pointer; transition: var(--transition);
}
.preview-btn:hover {
  background: var(--primary-dark);
}
.xpath-marker {
  position: absolute; width: 28px; height: 28px; background: var(--primary); color: white;
  border: 3px solid white; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-weight: 700; font-size: 0.875rem; cursor: pointer;
  box-shadow: var(--shadow-lg); animation: pulse 2s infinite; transform: translate(-50%, -50%); z-index: 15;
}
.media-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;
}
.media-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  overflow: hidden; transition: var(--transition);
}
.media-card:hover {
  transform: translateY(-2px); box-shadow: var(--shadow);
}
.media-preview {
  height: 140px; background: var(--bg-tertiary); display: flex; align-items: center;
  justify-content: center; overflow: hidden;
}
.media-preview img {
  width: 100%; height: 100%; object-fit: cover;
}
.media-info {
  padding: 1rem;
}
.media-filename {
  font-weight: 600; margin-bottom: 0.5rem; word-break: break-all; font-size: 0.875rem;
}
.media-stats {
  display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;
  color: var(--text-secondary); margin-bottom: 0.75rem;
}
.empty-state {
  text-align: center; padding: 3rem;
}
.empty-state-icon {
  font-size: 4rem; color: var(--text-tertiary); margin-bottom: 1rem;
}
.empty-state-title {
  font-size: 1.5rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem;
}
.empty-state-description {
  color: var(--text-secondary); margin-bottom: 1.5rem;
}
.badge {
  display: inline-block; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;
}
.badge-primary {
  background: rgba(99, 102, 241, 0.1); color: var(--primary);
}
.badge-success {
  background: rgba(16, 185, 129, 0.1); color: var(--success);
}
.badge-warning {
  background: rgba(245, 158, 11, 0.1); color: var(--warning);
}
.badge-danger {
  background: rgba(239, 68, 68, 0.1); color: var(--error);
}
.spinner {
  width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 1s linear infinite;
}
.seo-task-creator {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 9998; display: none;
  animation: fadeIn 0.3s ease;
}
.seo-task-creator.active {
  display: flex; align-items: center; justify-content: center;
}
.task-creator-container {
  background: var(--bg-secondary); border-radius: 1.5rem; width: 95vw; max-width: 1200px;
  max-height: 90vh; overflow: hidden; display: flex; box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.3);
  animation: slideUpDesktop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative;
}
@keyframes slideUpDesktop {
from {
  transform: translateY(30px) scale(0.95); opacity: 0;
}
to {
  transform: translateY(0) scale(1); opacity: 1;
}
}
.task-creator-sidebar {
  width: 280px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  padding: 2rem; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 1.5rem;
}
.task-creator-main {
  flex: 1; display: flex; flex-direction: column; position: relative;
}
.task-creator-header {
  padding: 2rem; border-bottom: 1px solid var(--border); background: var(--bg-secondary); position: relative;
}
.task-creator-title {
  font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text);
}
.task-creator-subtitle {
  color: var(--text-secondary); font-size: 0.875rem;
}
.task-creator-close {
  position: absolute; top: 1.5rem; right: 1.5rem; width: 2.5rem; height: 2.5rem; border-radius: 50%;
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(249,250,251,0.95) 100%);
  border: 2px solid rgba(229,231,235,1); color: #6b7280; font-size: 1.25rem; cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center;
  justify-content: center; z-index: 1010; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}
.task-creator-close:hover {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;
  transform: rotate(90deg) scale(1.1); border-color: transparent; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
}
.task-creator-close:active {
  transform: rotate(90deg) scale(1); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}
.task-creator-body {
  flex: 1; padding: 2rem; overflow-y: auto;
}
.progress-steps {
  margin-bottom: 2rem;
}
.progress-step {
  display: flex; align-items: center; margin-bottom: 1.5rem; cursor: pointer; transition: var(--transition);
}
.progress-step:last-child {
}
.step-indicator {
  width: 3rem; height: 3rem; border-radius: 50%; background: var(--bg-tertiary);
  border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
  font-weight: 600; margin-right: 1rem; transition: all 0.3s;
}
.progress-step.completed .step-indicator {
  background: var(--success); border-color: var(--success); color: white;
}
.progress-step.active .step-indicator {
  background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}
.step-info {
  flex: 1;
}
.step-title {
  font-weight: 600; margin-bottom: 0.25rem; color: var(--text-secondary);
}
.progress-step.active .step-title,
.progress-step.completed .step-title {
  color: var(--text);
}
.step-description {
  font-size: 0.75rem; color: var(--text-secondary);
}
.step-content {
  display: none; animation: fadeIn 0.3s ease;
}
.step-content.active {
  display: block;
}
.step-navigation {
  display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem;
  border-top: 1px solid var(--border);
}
.pending-task-alert {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem;
  padding: 2rem; margin-bottom: 2rem; color: white; display: none;
}
.pending-task-alert.show {
  display: block; animation: slideDown 0.3s ease;
}
.pending-task-header {
  display: flex; align-items: center; margin-bottom: 1rem;
}
.pending-task-icon {
  width: 3rem; height: 3rem; background: rgba(255, 255, 255, 0.2); border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 1rem;
}
.pending-task-info {
  flex: 1;
}
.pending-task-title {
  font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem;
}
.pending-task-details {
  background: rgba(0, 0, 0, 0.2); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;
}
.pending-task-actions {
  display: flex; gap: 1rem;
}
.pending-task-actions .btn {
  flex: 1;
}
.priority-options {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;
}
.priority-option {
  border: 2px solid var(--border); border-radius: 1rem; padding: 1.25rem 1rem; cursor: pointer;
  transition: all 0.3s; position: relative; overflow: hidden; text-align: center;
  min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;
}
.priority-option::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: var(--border); transition: all 0.3s;
}
.priority-option:hover {
  transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border-color: var(--primary);
}
.priority-option.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(99, 102, 241, 0.1) 100%);
}
.priority-option.selected::before {
  background: var(--primary);
}
.priority-badge {
  display: inline-flex; padding: 0.25rem 0.75rem; background: var(--bg-tertiary);
  border-radius: 999px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 0.75rem; align-self: center;
}
.priority-option[data-priority="basic"] .priority-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
}
.priority-option[data-priority="standard"] .priority-badge {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;
}
.priority-option[data-priority="premium"] .priority-badge {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;
}
.priority-title {
  font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;
}
.priority-price {
  font-size: 1.35rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;
}
.priority-price small {
  font-size: 0.875rem; color: var(--text-secondary); font-weight: 400;
}
.priority-locations {
  font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;
}
.keyword-suggestions {
  display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.5rem;
}
.keyword-suggestion {
  padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 2px solid transparent;
  border-radius: 999px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
  display: inline-flex; align-items: center; gap: 0.5rem;
}
.keyword-suggestion:hover {
  background: var(--primary); color: white; transform: scale(1.05);
}
.keyword-suggestion.selected {
  background: var(--primary); color: white; border-color: var(--primary);
}
.selected-keywords {
  background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;
}
.keyword-tags {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
}
.keyword-tag {
  display: inline-flex; align-items: center; padding: 0.5rem 0.75rem; background: var(--primary);
  color: white; border-radius: 0.5rem; font-size: 0.875rem; animation: fadeIn 0.2s;
}
.keyword-tag-text {
  margin-right: 0.5rem;
}
.keyword-tag-remove {
  width: 1.25rem; height: 1.25rem; background: rgba(255, 255, 255, 0.2); border-radius: 50%;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
  transition: all 0.2s; color: white; font-size: 0.75rem;
}
.keyword-tag-remove:hover {
  background: var(--error); transform: scale(1.2);
}
.payment-options {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;
}
.payment-card {
  border: 2px solid var(--border); border-radius: 1rem; padding: 1.5rem; cursor: pointer;
  transition: all 0.3s; position: relative;
}
.payment-card:hover {
  border-color: var(--primary); transform: translateY(-2px);
}
.payment-card.selected {
  border-color: var(--primary); background: rgba(99, 102, 241, 0.05);
}
.payment-card.selected::after {
  content: '✓'; position: absolute; top: 1rem; right: 1rem; width: 1.5rem; height: 1.5rem;
  background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 0.75rem;
}
.payment-icon {
  width: 3rem; height: 3rem; background: var(--bg-tertiary); border-radius: 0.75rem; display: flex;
  align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary);
}
.payment-title {
  font-weight: 600; margin-bottom: 0.5rem; color: var(--text);
}
.payment-description {
  font-size: 0.875rem; color: var(--text-secondary);
}
.payment-type-toggle {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(99, 102, 241, 0.1) 100%);
  border-radius: 1rem; padding: 0.375rem; display: flex; margin-bottom: 2rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid var(--border);
}
.payment-type-option {
  flex: 1; padding: 0.875rem 1rem; border: none; background: transparent; border-radius: 0.75rem;
  font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.3s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.payment-type-option:hover {
  transform: translateY(-1px);
}
.payment-type-option.active {
  background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); color: white;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transform: scale(1.02);
}
.payment-type-option i {
  font-size: 1.125rem;
}
.budget-calculator {
  background: var(--bg-tertiary); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;
}
.budget-input-group {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;
}
.budget-field {
  position: relative;
}
.budget-field label {
  font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;
}
.budget-field input {
  width: 100%; padding: 0.75rem 1rem; padding-left: 2.5rem; border: 2px solid var(--border);
  border-radius: 0.5rem; font-size: 1.25rem; font-weight: 600; background: var(--card); color: var(--text);
}
.budget-field .currency-symbol {
  position: absolute; left: 1rem; bottom: 0.875rem; color: var(--text-secondary); font-size: 1.25rem; font-weight: 600;
}
.budget-summary {
  background: var(--card); border-radius: 0.75rem; padding: 1rem; display: grid;
  grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem;
}
.budget-summary-period {
  font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem; opacity: 0.8;
}
.budget-summary-item {
  text-align: center; padding: 0.75rem; background: var(--bg-primary); border-radius: 0.5rem;
  border: 1px solid var(--border);
}
.budget-summary-label {
  font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 0.25rem;
}
.budget-summary-value {
  font-size: 1.25rem; font-weight: 700; color: var(--text);
}
.billing-cycle-options {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;
}
.billing-option {
  position: relative; border: 1.5px solid var(--border); border-radius: 1.25rem;
  padding: 1.5rem 1.25rem 1.25rem; cursor: pointer; transition: all 0.3s ease;
  background: var(--card); display: flex; flex-direction: column; gap: 0.75rem; text-align: left;
  min-height: 170px; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.05);
}
.billing-option-top {
  display: flex; align-items: center; gap: 0.85rem; width: 100%;
}
.billing-icon {
  width: 3rem; height: 3rem; border-radius: 0.85rem; background: rgba(99, 102, 241, 0.12);
  color: var(--primary); display: flex; align-items: center; justify-content: center;
  font-size: 1.35rem; flex-shrink: 0; box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.15);
}
.billing-option-header {
  display: flex; flex-direction: column; align-items: flex-start; gap: 0.15rem; margin-bottom: 0;
}
.billing-period {
  font-size: 1.15rem; font-weight: 700; color: var(--text);
}
.billing-frequency {
  font-size: 0.85rem; color: var(--text-secondary);
}
.billing-save {
  display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem;
  font-weight: 600; margin-left: auto;
}
.billing-price {
  font-size: 0.95rem; color: var(--text); font-weight: 600;
}
.billing-note {
  font-size: 0.85rem; color: var(--text-secondary);
}
.billing-option:hover {
  border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 20px 35px rgba(99, 102, 241, 0.2);
}
.billing-option.selected {
  border-color: transparent; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  box-shadow: 0 30px 45px rgba(99, 102, 241, 0.35); color: white;
}
.billing-option.selected .billing-icon {
  background: rgba(255, 255, 255, 0.18); color: white; box-shadow: none;
}
.billing-option.selected .billing-period,
.billing-option.selected .billing-frequency,
.billing-option.selected .billing-price,
.billing-option.selected .billing-note {
  color: rgba(255, 255, 255, 0.95);
}
.billing-option.selected::after {
  content: '✓'; position: absolute; top: 0.85rem; right: 0.85rem; width: 1.65rem; height: 1.65rem;
  background: rgba(255, 255, 255, 0.15); color: white; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;
  border: 1px solid rgba(255, 255, 255, 0.4);
}
.billing-badge {
  position: absolute; top: 1rem; right: 1.25rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
  padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;
  white-space: nowrap; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.35);
}
.billing-popular {
  position: relative;
}
.billing-option[data-cycle="monthly"] .billing-icon {
  background: rgba(59, 130, 246, 0.15); color: #3b82f6; box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.25);
}
.billing-option[data-cycle="quarterly"] .billing-icon {
  background: rgba(249, 115, 22, 0.15); color: #f97316; box-shadow: inset 0 0 0 1px rgba(249, 115, 22, 0.2);
}
.billing-option[data-cycle="yearly"] .billing-icon {
  background: rgba(16, 185, 129, 0.15); color: #059669; box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.2);
}
.task-creator-footer {
  padding: 1.5rem 2rem; background: var(--bg-secondary); border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.footer-info {
  display: flex; align-items: center; gap: 1rem; color: var(--text-secondary); font-size: 0.875rem;
}
.footer-actions {
  display: flex; gap: 1rem;
}
.btn-ghost {
  padding: 0.75rem 1.5rem; background: transparent; border: 2px solid var(--border);
  color: var(--text); border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.btn-ghost:hover {
  background: var(--bg-tertiary);
}
.btn-primary-gradient {
  padding: 0.75rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;
}
.btn-primary-gradient:hover {
  transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}
.btn-primary-gradient:disabled {
  opacity: 0.5; cursor: not-allowed; transform: none;
}
@keyframes fadeIn {
from {
  opacity: 0;
}
to {
  opacity: 1;
}
}
@keyframes slideUp {
from {
  transform: translateY(20px); opacity: 0;
}
}
@keyframes slideDown {
from {
  transform: translateY(-20px); opacity: 0;
}
to {
  transform: translateY(0); opacity: 1;
}
}
.mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--card);
  border-top: 1px solid var(--border); z-index: 50; padding: 0.5rem; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}
.mobile-nav-items {
  display: flex; justify-content: space-around; align-items: center;
}
.mobile-nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem;
  color: var(--text-secondary); text-decoration: none; font-size: 0.75rem;
  transition: var(--transition); border-radius: var(--radius); flex: 1;
}
.mobile-nav-item:active {
  transform: scale(0.95);
}
.mobile-nav-item.active {
  color: var(--primary); background: rgba(99, 102, 241, 0.1);
}
.mobile-nav-item i {
  font-size: 1.25rem;
}
.mobile-menu-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;
}
.mobile-menu-overlay.active {
  display: block;
}
.mobile-menu {
  position: fixed; top: 0; left: -100%; bottom: 0; width: 85%; max-width: 320px;
  background: var(--card); transition: left 0.3s ease; z-index: 999; overflow-y: auto;
}
.mobile-menu.active {
  left: 0;
}
.mobile-menu-header {
  padding: 1.5rem; background: var(--primary); color: white;
}
.mobile-menu-content {
  padding: 1rem;
}
.user-menu-container {
  position: relative;
}
.user-dropdown {
  position: absolute; top: calc(100% + 0.5rem); right: 0; min-width: 220px;
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  box-shadow: var(--shadow-xl); display: none; z-index: 1000;
}
.user-dropdown.active {
  display: block;
}
.user-dropdown-item {
  display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text);
  text-decoration: none; transition: var(--transition); cursor: pointer;
}
.user-dropdown-item:hover {
  background: var(--bg-tertiary);
}
.user-dropdown-item i {
  width: 1.25rem;
}
.user-dropdown-item.danger {
  color: var(--error);
}
.sessions-section {
  max-height: 300px; overflow-y: auto;
}
.session-item {
  padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.875rem;
}
.session-item:last-child {
  border-bottom: none;
}
.session-info {
  display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;
}
.session-location {
  display: flex; align-items: center; gap: 0.25rem; color: var(--text-secondary);
  font-size: 0.8rem; margin-top: 0.25rem;
}
.session-delete {
  padding: 0.25rem 0.5rem; background: transparent; border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--error); cursor: pointer; font-size: 0.75rem;
  transition: var(--transition);
}
.session-delete:hover {
  background: var(--error); color: white; border-color: var(--error);
}
.mobile-search-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; background: var(--card);
  padding: 1rem; border-bottom: 1px solid var(--border); z-index: 1001;
}
.mobile-search-overlay.active {
  display: block;
}
.mobile-search-input {
  width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--input-bg); color: var(--text); font-size: 1rem;
}
.mobile-search-toggle {
  display: none;
}
.domain-item {
  display: flex; flex-direction: column; padding: 1rem; border: 1px solid var(--border);
  border-radius: var(--radius); margin-bottom: 0.75rem; gap: 0.875rem; transition: all 0.2s ease;
  background: var(--card);
}
.domain-item:hover {
  border-color: var(--primary) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transform: translateY(-1px);
}
.domain-url-row {
  display: flex; align-items: center; width: 100%; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);
}
.domain-url-text {
  font-weight: 600; font-size: 0.95rem; word-break: break-all; color: var(--text);
}
.domain-actions-row {
  display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; width: 100%;
}
.domain-status-actions {
  display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; flex-wrap: wrap;
}
.domain-status-row {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; width: 100%;
}
.domain-buttons-row {
  display: flex; align-items: center; gap: 0.5rem; width: 100%;
}
.domain-verify-delete {
  display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;
}
.domain-verify-delete-desktop {
  display: none;
}
.domain-status-badge {
  font-size: 0.8rem; padding: 0.4rem 0.75rem; font-weight: 600; white-space: nowrap; flex-shrink: 0;
}
.domain-actions-row .btn {
  white-space: nowrap; font-size: 0.85rem; display: inline-flex; align-items: center; justify-content: center;
}
.btn-verify-instructions i,
.btn-verify-domain i,
.btn-delete-domain i {
  font-size: 1rem; margin-right: 0.25rem;
}
@media (min-width: 581px) and (max-width: 768px) {
.domain-status-row {
  gap: 0.5rem;
}
.domain-buttons-row {
  gap: 0.5rem;
}
.domain-status-row .domain-verify-delete {
  display: none !important;
}
.domain-verify-delete-desktop {
  display: flex !important;
}
.domain-actions-row {
  flex-direction: row; flex-wrap: wrap;
}
.domain-actions-row .btn {
  font-size: 0.85rem; padding: 0.4rem 0.8rem;
}
}
@keyframes fadeIn {
from { opacity: 0; }; to { opacity: 1; };
}
@keyframes slideUp {
from {
  transform: translateY(20px); opacity: 0;
}
to {
  transform: translateY(0); opacity: 1;
}
}
@keyframes slideInRight {
from {
  transform: translateX(100%); opacity: 0;
}
to {
  transform: translateX(0); opacity: 1;
}
}
@keyframes spin {
to { transform: rotate(360deg); };
}
@keyframes pulse {
0%, 100% { transform: translate(-50%, -50%) scale(1); };
50% { transform: translate(-50%, -50%) scale(1.1); };
}
@keyframes slideInMobile {
from {
  transform: translateY(100%); opacity: 0;
}
to {
  transform: translateY(0); opacity: 1;
}
}
@keyframes pulseGlow {
0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); };
50% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); };
}
.usage-category {
  transition: transform 0.2s ease;
}
.usage-category:hover {
  transform: translateY(-2px);
}
.desktop-only {
  display: block !important;
}
.mobile-only {
  display: none !important;
}
div#modalBody { padding-bottom: 100px; }
.swal2-popup.swal2-toast {
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 40px rgba(99, 102, 241, 0.08) !important;
  background: linear-gradient(135deg, var(--card) 0%, var(--bg-secondary) 100%) !important;
  border: 1px solid var(--border) !important; border-radius: 1rem !important;
}
/* =====================================================
IMAGE DETAILS MODAL - Premium Design
===================================================== */
.image-details-modal-container {
  display: flex; flex-direction: column; gap: 1rem; text-align: left; width: 100%; box-sizing: border-box;
}
.image-hero-section {
  display: flex; flex-direction: column; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);
}
.image-hero-preview {
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.03), rgba(99, 102, 241, 0.05));
  border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; display: flex;
  align-items: center; justify-content: center; min-height: 220px; position: relative;
}
.image-hero-img {
  max-width: 100%; max-height: 200px; width: auto; height: auto; object-fit: contain;
  border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.image-hero-img:hover {
  transform: scale(1.03); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
}
.image-info-bar {
  display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;
}
.image-info-left {
  display: flex; flex-direction: column; gap: 0.5rem; flex: 1; min-width: 0;
}
.image-filename {
  font-size: 1rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 0.5rem; margin: 0;
}
.image-filename i {
  color: var(--primary); font-size: 1.1rem;
}
.image-filename span {
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.image-meta-row {
  display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-secondary);
}
.image-meta-row span {
  display: inline-flex; align-items: center; gap: 0.3rem;
}
.image-meta-row i {
  font-size: 0.85rem; opacity: 0.7;
}
.image-actions-bar {
  display: flex; gap: 0.5rem; flex-shrink: 0;
}
.image-action-btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem;
  padding: 0.55rem 0.85rem; border-radius: var(--radius); font-size: 0.8rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border);
  background: var(--bg-tertiary); color: var(--text);
}
.image-action-btn:hover {
  background: var(--card-hover); border-color: var(--primary); color: var(--primary); transform: translateY(-1px);
}
.image-action-btn.btn-copy {
  background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); color: var(--primary);
}
.image-action-btn.btn-copy:hover {
  background: rgba(99, 102, 241, 0.2);
}
.image-action-btn.btn-open {
  background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success);
}
.image-action-btn.btn-open:hover {
  background: rgba(16, 185, 129, 0.2);
}
.image-action-btn.btn-delete {
  background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--error);
}
.image-action-btn.btn-delete:hover {
  background: rgba(239, 68, 68, 0.2);
}
.image-action-btn i {
  font-size: 1rem;
}
.image-stats-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
}
.image-stat-card {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 0.85rem 0.5rem; text-align: center; transition: all 0.2s ease;
}
.image-stat-card:hover {
  border-color: rgba(99, 102, 241, 0.3); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}
.image-stat-card .stat-value {
  font-size: 1.4rem; font-weight: 800; line-height: 1.2; margin-bottom: 0.25rem;
}
.image-stat-card .stat-label {
  font-size: 0.68rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em;
}
.image-modal-tabs {
  display: flex; align-items: center; justify-content: center; gap: 0.35rem; padding: 0.3rem;
  border-radius: 999px; background: var(--bg-tertiary); border: 1px solid var(--border);
  width: 100%; max-width: 320px; margin: 0 auto;
}
.image-modal-tab {
  appearance: none; border: 1px solid transparent; background: transparent; color: var(--text);
  border-radius: 999px; padding: 0.5rem 1.25rem; font-weight: 700; font-size: 0.85rem;
  cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem;
  transition: all 0.2s ease; flex: 1;
}
.image-modal-tab:hover:not(:disabled) {
  background: rgba(99, 102, 241, 0.08);
}
.image-modal-tab[data-tab="analytics"].active {
  background: rgba(99, 102, 241, 0.14); border-color: rgba(99, 102, 241, 0.5);
  color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
}
.image-modal-tab[data-tab="traffic"].active {
  background: rgba(245, 158, 11, 0.14); border-color: rgba(245, 158, 11, 0.5);
  color: var(--warning); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
}
.image-modal-panels {
  width: 100%;
}
.image-modal-panel {
  width: 100%;
}
.image-modal-panel.panel-in {
  animation: imagePanelIn 180ms ease-out;
}
@keyframes imagePanelIn {
}
.image-modal-panel[hidden] {
  display: none !important;
}
.image-analytics-content {
  display: grid; grid-template-columns: 1fr; gap: 0.75rem;
}
.image-chart-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
}
.image-chart-card .chart-header {
  padding: 0.6rem 0.85rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
  font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; gap: 0.4rem;
}
.image-chart-card .chart-header i {
  color: var(--primary); font-size: 1rem;
}
.image-chart-card .chart-body {
  padding: 0.65rem; height: 180px;
}
.image-traffic-content {
  display: grid; grid-template-columns: 1fr; gap: 0.75rem;
}
.image-traffic-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
}
.image-traffic-card .card-header {
  padding: 0.6rem 0.85rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
  font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; gap: 0.4rem;
}
.image-traffic-card .card-header i {
  font-size: 1rem;
}
.image-traffic-card .card-header i.ri-window-line { color: var(--primary); }
.image-traffic-card .card-header i.ri-device-line { color: var(--warning); }
.image-traffic-card .card-header i.ri-earth-line { color: var(--success); }
.image-traffic-card .card-body {
  padding: 0.65rem;
}
.image-traffic-list {
  display: flex; flex-direction: column; gap: 0.4rem;
}
.image-traffic-item {
  display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.7rem;
  background: var(--bg-tertiary); border-radius: var(--radius-sm); border: 1px solid var(--border);
  transition: all 0.15s ease;
}
.image-traffic-item:hover {
  background: var(--card-hover); border-color: rgba(99, 102, 241, 0.25);
}
.image-traffic-item .item-name {
  font-weight: 600; color: var(--text); font-size: 0.85rem;
}
.image-empty-state {
  padding: 2rem 1rem; text-align: center; background: var(--bg-tertiary);
  border-radius: var(--radius); border: 1px solid var(--border);
}
.image-empty-state i {
  font-size: 2.5rem; color: var(--text-secondary); opacity: 0.5; margin-bottom: 0.75rem;
}
.image-empty-state h4 {
  margin: 0 0 0.35rem; font-size: 1rem; color: var(--text);
}
.image-empty-state p {
  margin: 0; font-size: 0.85rem; color: var(--text-secondary);
}
.swal2-popup.image-details-swal {
  margin: 0 !important; width: min(800px, 92vw) !important; max-width: 92vw !important;
  box-sizing: border-box !important; padding: 1rem !important;
}
.swal2-popup.image-details-swal .swal2-html-container {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
  margin: 0 !important; padding: 0 !important; overflow-x: hidden !important; overflow-y: auto !important;
}
.swal2-popup.image-details-swal .swal2-title,
.swal2-popup.image-details-swal .swal2-actions {
  display: none !important;
}
/* =====================================================
ARTICLE DETAILS MODAL - Premium Design with Tabs
===================================================== */
.article-details-modal-container {
  display: flex; flex-direction: column; gap: 0; text-align: left; width: 100%; max-width: 100%; box-sizing: border-box;
}
.article-modal-header {
  background: transparent; padding: 0 0 1rem 0; margin: 0 0 1rem 0; border-bottom: 1px solid var(--border);
}
.article-modal-header-row {
  display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;
}
.article-modal-title {
  flex: 1; min-width: 0;
}
.article-modal-title h3 {
  margin: 0; font-size: 1.1rem; font-weight: 700; line-height: 1.35;
}
.article-modal-url-pill {
  display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.85rem;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.08));
  border: 1px solid rgba(99, 102, 241, 0.35); border-radius: 999px; color: var(--primary);
  text-decoration: none; font-weight: 600; font-size: 0.85rem; max-width: 100%; transition: all 0.2s ease;
}
.article-modal-url-pill:hover {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.12));
  transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}
.article-modal-url-pill span {
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.article-header-meta-row {
  display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
  margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);
}
.article-modal-actions-desktop {
  display: flex; gap: 0.75rem; flex-shrink: 0;
}
.article-modal-actions-desktop .btn {
  padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: var(--radius); display: inline-flex;
  align-items: center; gap: 0.4rem; transition: all 0.2s ease;
}
.article-modal-actions-desktop .btn-edit {
  background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text);
}
.article-modal-actions-desktop .btn-edit:hover {
  background: var(--primary); border-color: var(--primary); color: white;
}
.article-modal-actions-desktop .btn-delete {
  background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger);
}
.article-modal-actions-desktop .btn-delete:hover {
  background: var(--danger); border-color: var(--danger); color: white;
}
.article-modal-actions-mobile {
  display: none;
}
.article-header-meta {
  display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; font-size: 0.8rem;
  color: var(--text-secondary); flex: 1; min-width: 0;
}
.article-header-meta span {
  display: inline-flex; align-items: center; gap: 0.35rem;
}
.article-header-meta i {
  font-size: 0.95rem; opacity: 0.7;
}
.article-modal-stat-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;
}
.article-modal-stat-card {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 0.85rem; text-align: center; transition: all 0.2s ease;
}
.article-modal-stat-card:hover {
  border-color: rgba(99, 102, 241, 0.3); transform: translateY(-1px);
}
.article-modal-stat-card .stat-value {
  font-size: 1.35rem; font-weight: 800; line-height: 1.2; margin-bottom: 0.25rem;
}
.article-modal-stat-card .stat-label {
  font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;
}
.article-modal-tabs {
  display: inline-flex; align-items: center; justify-content: space-between; gap: 0.25rem;
  padding: 0.25rem; border-radius: 999px; background: var(--bg-tertiary);
  border: 1px solid var(--border); margin: 0 0 1.25rem; width: 100%; flex-wrap: nowrap;
}
.article-modal-tab {
  appearance: none; border: 1px solid transparent; background: transparent; color: var(--text);
  border-radius: 999px; padding: 0.55rem 0.85rem; font-weight: 700; font-size: 0.9rem;
  cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
  gap: 0.45rem; transition: all 0.2s ease; flex: 1; min-width: 0; white-space: nowrap;
}
.article-modal-tab:hover {
  transform: translateY(-1px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.10);
}
.article-modal-tab:disabled {
  cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none;
}
.article-modal-tab[data-tab="analytics"].active {
  background: rgba(99, 102, 241, 0.14); border-color: rgba(99, 102, 241, 0.65); color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.20), 0 14px 40px rgba(99, 102, 241, 0.15);
}
.article-modal-tab[data-tab="images"].active {
  background: rgba(245, 158, 11, 0.14); border-color: rgba(245, 158, 11, 0.65); color: var(--warning);
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.20), 0 14px 40px rgba(245, 158, 11, 0.15);
}
.article-modal-tab[data-tab="content"].active {
  background: rgba(16, 185, 129, 0.14); border-color: rgba(16, 185, 129, 0.55); color: var(--success);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.16), 0 14px 40px rgba(16, 185, 129, 0.12);
}
.article-modal-tab .label-mobile { display: none; }
.article-modal-tab .label-desktop { display: inline; }
.article-modal-tab.icon-only .label-mobile,
.article-modal-tab.icon-only .label-desktop { display: none !important; }
.article-modal-tab.icon-only { padding-left: 0.55rem; padding-right: 0.55rem; }
.article-modal-tab.icon-only i { margin: 0; }
.article-modal-panels {
  display: grid; grid-template-columns: 1fr; gap: 1rem;
}
.article-modal-panel.panel-in {
  animation: articlePanelIn 180ms ease-out;
}
@keyframes articlePanelIn {
}
.article-modal-panel[hidden] {
  display: none !important;
}
.article-analytics-section {
  display: flex; flex-direction: column; gap: 1rem;
}
.article-chart-wrap {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; height: 280px;
}
.article-chart-wrap.small {
  height: 200px;
}
.article-mini-charts-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;
}
.article-mini-chart-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
}
.article-mini-chart-card .chart-title {
  padding: 0.6rem 0.85rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
  font-size: 0.8rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 0.4rem;
}
.article-mini-chart-card .chart-title i {
  font-size: 0.95rem; opacity: 0.7;
}
.article-mini-chart-card .chart-body {
  padding: 0.5rem; height: 160px;
}
.article-images-slider-container {
  display: flex; flex-direction: column; gap: 1rem;
}
.article-image-slider {
  position: relative; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem;
  min-height: 320px; display: flex; align-items: center; justify-content: center;
}
.article-slider-image {
  max-width: 100%; max-height: 300px; width: auto; height: auto; object-fit: contain;
  border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); cursor: pointer;
  transition: transform 0.3s ease;
}
.article-slider-image:hover {
  transform: scale(1.02);
}
.article-slider-nav {
  position: absolute; top: 50%; transform: translateY(-50%); width: 42px; height: 42px;
  border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: var(--text);
  cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
  transition: all 0.2s ease; z-index: 10; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.article-slider-nav:hover {
  background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-50%) scale(1.05);
}
.article-slider-nav.prev { left: 0.75rem; }
.article-slider-nav.next { right: 0.75rem; }
.article-slider-counter {
  text-align: center; font-size: 0.85rem; color: var(--text-secondary); font-weight: 600;
}
.article-slider-counter span {
  color: var(--primary); font-weight: 700;
}
.article-slider-thumbnails {
  display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; padding: 0.5rem;
}
.article-slider-thumb {
  width: 60px; height: 60px; border-radius: var(--radius-sm); overflow: hidden; cursor: pointer;
  border: 2px solid var(--border); transition: all 0.2s ease; opacity: 0.6;
}
.article-slider-thumb:hover {
  opacity: 1; border-color: var(--text-secondary);
}
.article-slider-thumb.active {
  opacity: 1; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}
.article-slider-thumb img {
  width: 100%; height: 100%; object-fit: cover;
}
.article-no-images {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 3rem 1.5rem; text-align: center; background: var(--bg-tertiary);
  border: 1px solid var(--border); border-radius: var(--radius);
}
.article-no-images i {
  font-size: 3rem; color: var(--text-secondary); opacity: 0.4; margin-bottom: 1rem;
}
.article-no-images h4 {
  margin: 0 0 0.5rem; font-size: 1.1rem; color: var(--text);
}
.article-no-images p {
  margin: 0; font-size: 0.85rem; color: var(--text-secondary);
}
.article-content-panel {
  display: flex; flex-direction: column; gap: 1rem;
}
.article-content-info {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;
}
.article-content-info-card {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 0.85rem; text-align: center;
}
.article-content-info-card .info-value {
  font-size: 1.1rem; font-weight: 700; color: var(--text); margin-bottom: 0.15rem;
}
.article-content-info-card .info-label {
  font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;
}
.article-content-preview {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
}
.article-content-preview-header {
  display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;
  background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
}
.article-content-preview-header h4 {
  margin: 0; font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;
}
.article-content-preview-header h4 i {
  color: var(--success);
}
.article-content-body {
  padding: 1.25rem; font-family: Georgia, 'Times New Roman', serif; font-size: 0.95rem;
  line-height: 1.8; color: var(--text); max-height: 380px; overflow-y: auto;
}
.article-content-body::-webkit-scrollbar {
  width: 6px;
}
.article-content-body::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
}
.article-content-body::-webkit-scrollbar-thumb {
  background: var(--border); border-radius: 3px;
}
.article-content-body::-webkit-scrollbar-thumb:hover {
  background: var(--text-secondary);
}
.swal2-popup.article-details-swal {
  margin: 0 !important; width: min(900px, 92vw) !important; max-width: 92vw !important;
  box-sizing: border-box !important; padding: 1rem !important;
}
.swal2-popup.article-details-swal .swal2-html-container {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
  margin: 0 !important; padding: 0 !important; overflow-x: hidden !important; overflow-y: auto !important;
}
.swal2-popup.article-details-swal .swal2-title,
.swal2-popup.article-details-swal .swal2-actions {
  display: none !important;
}
.swal2-popup.image-article-details-swal {
  width: min(900px, 95vw) !important; max-width: 95vw !important;
  box-sizing: border-box !important; padding: 1.25rem !important;
}
.swal2-popup.image-article-details-swal .swal2-html-container {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
  margin: 0.75rem 0 !important; padding: 0 !important;
}
.swal2-popup.image-article-details-swal .swal2-title {
  font-size: 1.25rem !important; padding: 0.5rem 0 !important;
}
.swal2-toast button:where(.swal2-close) {
  grid-column: 3 / 3; grid-row: 1 / 99; align-self: flex-start!important; margin: 0!important; font-size: 3em!important;
}
.task-details-modal-container {
  text-align: left; width: 100%; max-width: 100%; box-sizing: border-box;
}
.task-modal-header {
  background: transparent; padding: 0 0 1rem 0; margin: 0 0 1rem 0; border-bottom: 1px solid var(--border);
}
.task-modal-header-row {
  display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;
}
.task-modal-title {
  min-width: 0; flex: 1;
}
.task-modal-actions-slot {
  flex: 0 0 auto; display: flex; justify-content: flex-end; align-items: center;
}
.task-modal-actions-slot:empty {
  display: none;
}
.task-modal-actions-slot .swal2-actions {
  margin: 0 !important; gap: 0.5rem !important; padding: 0 !important; width: auto !important;
  justify-content: flex-end !important;
}
.task-modal-actions-slot .swal2-actions button {
  padding: 0.55rem 0.9rem !important; font-size: 0.85rem !important; line-height: 1.1 !important;
}
.task-modal-actions-slot .swal2-actions button .task-action-sub {
  display: block; margin-top: 0.2rem; font-size: 0.72rem; font-weight: 600; opacity: 0.9;
}
.task-modal-url-pill {
  display: inline-flex; align-items: center; gap: 0.55rem; max-width: 100%; padding: 0.5rem 0.75rem; border-radius: 999px; background: rgba(148, 163, 184, 0.10); border: 1px solid rgba(148, 163, 184, 0.22); color: var(--text); text-decoration: none; font-weight: 900; font-size: 0.93rem; line-height: 1.2; overflow: hidden;
  justify-content: flex-start; align-self: flex-start; margin-right: auto;
}
.task-modal-url-pill span {
  min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1 1 auto;
}
.task-modal-url-pill:hover {
  background: rgba(99, 102, 241, 0.10); border-color: rgba(99, 102, 241, 0.55);
  color: var(--primary); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.12);
}
.task-modal-url-pill i {
  font-size: 1.05em; flex: 0 0 auto; opacity: 0.9;
}
.task-modal-tabs {
  display: inline-flex; align-items: center; justify-content: space-between; gap: 0.25rem;
  padding: 0.25rem; border-radius: 999px; background: var(--bg-tertiary);
  border: 1px solid var(--border); margin: 1rem 0 1.25rem; width: 100%; flex-wrap: nowrap;
}
.task-modal-tab {
  appearance: none; border: 1px solid transparent; background: transparent; color: var(--text);
  border-radius: 999px; padding: 0.55rem 0.85rem; font-weight: 700; font-size: 0.9rem;
  cursor: pointer; display: inline-flex; align-items: center; gap: 0.45rem;
  transition: var(--transition); flex: 1 1 0; justify-content: center; white-space: nowrap;
}
.task-modal-tab:hover {
  transform: translateY(-1px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.10);
}
.task-modal-tab:disabled {
  cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none;
}
.task-modal-tab[data-tab="analytics"].active {
  background: rgba(99, 102, 241, 0.14); border-color: rgba(99, 102, 241, 0.65); color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.20), 0 14px 40px rgba(99, 102, 241, 0.15);
}
.task-modal-tab[data-tab="details"].active {
  background: rgba(16, 185, 129, 0.14); border-color: rgba(16, 185, 129, 0.55); color: var(--success);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.16), 0 14px 40px rgba(16, 185, 129, 0.12);
}
.task-modal-tab[data-tab="config"].active {
  background: rgba(14, 165, 233, 0.14); border-color: rgba(14, 165, 233, 0.65); color: var(--info);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18), 0 14px 40px rgba(14, 165, 233, 0.12);
}
.task-modal-panels {
  display: grid; grid-template-columns: 1fr; gap: 1rem;
}
.task-modal-panel.panel-in {
  animation: taskPanelIn 180ms ease-out;
}
@keyframes taskPanelIn {
from { opacity: 0; transform: translateY(6px); };
}
.task-modal-panel[hidden] {
  display: none !important;
}
.task-modal-subtitle {
  font-size: 0.9rem; margin: 0.75rem 0 0.5rem; color: var(--text-secondary); font-weight: 600;
}
.task-modal-mini-chart {
  height: 140px; position: relative; margin-bottom: 1rem;
}
.task-modal-header h3 {
  font-size: 1.25rem; margin: 0 0 0.75rem 0; word-break: break-all; color: var(--primary);
  display: flex; justify-content: flex-start; text-align: left;
}
.task-modal-header .header-meta {
  font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: flex-start;
  justify-content: space-between; gap: 0.75rem; flex-wrap: wrap;
}
.task-modal-header .header-meta .header-meta-left {
  display: flex; flex-wrap: wrap; gap: 0.5rem 1.25rem; min-width: 0; flex: 1 1 auto;
}
.task-modal-header .header-meta .header-meta-right {
  flex: 0 0 auto; margin-left: auto; display: inline-flex; justify-content: flex-end; align-items: center;
}
.task-verify-inline-btn {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
  color: white !important; border: none !important; padding: 0.5rem 1rem !important;
  border-radius: 8px !important; font-size: 0.9rem !important; font-weight: 700 !important;
  cursor: pointer !important; display: inline-flex !important; align-items: center !important;
  gap: 0.4rem !important; transition: all 0.2s ease !important; flex-shrink: 0 !important;
  box-shadow: 0 2px 8px rgba(249, 158, 11, 0.25) !important; letter-spacing: 0.01em !important;
}
.task-verify-inline-btn:hover {
  background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important; transform: translateY(-2px) !important;
  box-shadow: 0 6px 16px rgba(249, 158, 11, 0.4) !important;
}
.task-verify-inline-btn i {
  font-size: 1.1em !important;
}
.task-config-btn {
  appearance: none; border: 1px solid rgba(14, 165, 233, 0.55) !important;
  background: rgba(14, 165, 233, 0.10) !important; color: var(--info) !important;
  border-radius: 999px !important; padding: 0.5rem 0.75rem !important; font-weight: 900 !important;
  font-size: 0.85rem !important; line-height: 1.1 !important; box-shadow: none !important;
  flex: 0 0 auto !important; gap: 0.45rem !important;
}
.task-config-btn:hover {
  transform: translateY(-1px); background: rgba(14, 165, 233, 0.14) !important;
  border-color: rgba(14, 165, 233, 0.75) !important; box-shadow: 0 14px 40px rgba(14, 165, 233, 0.12) !important;
}
.task-config-btn.active {
  background: rgba(14, 165, 233, 0.16) !important;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18), 0 14px 40px rgba(14, 165, 233, 0.10) !important;
}
.task-modal-stat-grid {
  display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; margin-bottom: 2rem;
}
.task-modal-stat-card {
  background: var(--card); padding: 1rem; border-radius: var(--radius);
  border: 1px solid var(--border); text-align: center;
}
.task-modal-stat-card .stat-value {
  font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem;
}
.task-modal-stat-card .stat-label {
  font-size: 0.8rem; color: var(--text-secondary);
}
.task-modal-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;
}
.task-modal-section {
  background: var(--card); border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 1.25rem;
}
.task-modal-section-title {
  font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem;
}
.xpath-list {
  max-height: 200px; overflow-y: auto; background: var(--bg-tertiary); border-radius: var(--radius); padding: 1rem;
}
.xpath-list code {
  display: block; margin-bottom: 0.75rem; padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border); font-size: 0.75rem; line-height: 1.4; word-break: break-all;
}
.xpath-list code:last-child {
  border-bottom: none; margin-bottom: 0; padding-bottom: 0;
}
.task-budget-actions {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 1rem; margin: 0 0 1.25rem 0;
}
.task-done-table-wrap {
  border: 1px solid var(--border); border-radius: 14px; overflow: hidden; background: rgba(255, 255, 255, 0.02);
}
.task-done-table {
  width: 100%; border-collapse: collapse; font-size: 0.85rem;
}
.task-done-table thead th {
  text-align: left; padding: 0.75rem 0.85rem; color: var(--text-secondary); font-weight: 900;
  letter-spacing: 0.01em; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
}
.task-done-table tbody td {
  padding: 0.75rem 0.85rem; border-bottom: 1px solid var(--border); color: var(--text);
  font-weight: 700; vertical-align: top;
}
.task-done-table tbody tr:last-child td {
  border-bottom: none;
}
.task-done-table .muted {
  color: var(--text-secondary); font-weight: 800; font-size: 0.8rem;
}
.task-done-table .country-badge {
  display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.22rem 0.6rem;
  border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.22);
  background: rgba(148, 163, 184, 0.10); color: var(--text); font-weight: 900; font-size: 0.8rem;
  white-space: nowrap; max-width: 100%; overflow: hidden; min-width: 0;
}
.task-done-table .country-badge .country-flag {
  width: 18px; height: 18px; border-radius: 999px; display: inline-flex; align-items: center;
  justify-content: center; font-size: 0.95rem; line-height: 1;
  background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(148, 163, 184, 0.22);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.10); flex: 0 0 auto;
}
.task-done-table .country-badge .country-text {
  letter-spacing: 0.02em; color: var(--text); min-width: 0; overflow: hidden; text-overflow: ellipsis;
}
.task-done-table a.task-email {
  color: var(--info); text-decoration: none; font-weight: 900;
}
.task-done-table a.task-email:hover {
  text-decoration: underline;
}
.task-done-cards {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.85rem;
  padding: 1rem; background: rgba(0, 0, 0, 0.02); border-radius: 12px;
}
.task-done-card {
  border: 1px solid var(--border); border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  padding: 0.9rem 1rem; display: flex; flex-direction: column; gap: 0.55rem; min-width: 0;
  transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.task-done-card:hover {
  border-color: rgba(148,163,184,0.35); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px);
}
.task-done-card-top {
  display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; min-width: 0;
}
.task-done-card-top .left {
  display: inline-flex; align-items: center; gap: 0.5rem; min-width: 0; flex: 0 1 auto; overflow: hidden;
}
.task-done-idx {
  display: inline-flex; align-items: center; justify-content: center; padding: 0.22rem 0.5rem;
  border-radius: 8px; border: 1px solid rgba(148,163,184,0.18);
  background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(139,92,246,0.08));
  color: var(--primary); font-weight: 800; font-size: 0.75rem; white-space: nowrap; min-width: 28px;
}
.task-done-time {
  display: none; color: var(--text-secondary); font-weight: 600; font-size: 0.78rem;
  white-space: nowrap; padding: 0.15rem 0.45rem; background: rgba(148,163,184,0.08);
  border-radius: 6px; max-width: 50%; overflow: hidden; text-overflow: ellipsis;
}
.task-done-kv {
  display: flex; align-items: center; gap: 0.5rem; min-width: 0;
}
.task-done-kv .label {
  color: var(--text-secondary); font-weight: 800; font-size: 0.72rem; letter-spacing: 0.03em;
  text-transform: uppercase; white-space: nowrap;
}
.task-done-kv .value {
  color: var(--text); font-weight: 700; font-size: 0.9rem; line-height: 1.25; min-width: 0;
  flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.task-done-kv .value a.task-email {
  color: var(--info); text-decoration: none; font-weight: 700; display: block; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
}
.task-done-kv .value a.task-email:hover { text-decoration: underline; }
.task-done-rawtime {
  display: flex; align-items: center; gap: 0.4rem; color: var(--text-secondary); font-weight: 600;
  font-size: 0.75rem; padding: 0.35rem 0.5rem; background: rgba(148,163,184,0.08); border-radius: 6px;
}
.task-done-rawtime i { color: var(--primary); font-size: 0.9rem; opacity: 0.8; }
.task-done-card .country-badge {
  display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.2rem 0.55rem;
  border-radius: 999px; border: 1px solid rgba(148,163,184,0.22);
  background: rgba(148,163,184,0.10); color: var(--text); font-weight: 800; font-size: 0.78rem; white-space: nowrap;
}
.task-done-card .country-badge .country-flag {
  width: 16px; height: 16px; border-radius: 999px; display: inline-flex; align-items: center;
  justify-content: center; font-size: 0.85rem; line-height: 1; background: rgba(255,255,255,0.06);
}
.task-done-card .country-badge .country-text { letter-spacing: 0.02em; }
.task-done-pager {
  display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
  gap: 0.75rem; padding: 0.75rem 0.85rem; border-top: 1px solid var(--border); background: rgba(255,255,255,0.01);
}
.task-done-pager .btns {
  width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; min-width: 0;
}
.task-done-pager .pages {
  display: flex; align-items: center; justify-content: center; gap: 0.25rem; flex: 1; min-width: 0; padding: 0 0.25rem;
}
.task-done-pager .pages .task-done-page-btn.page {
  flex: 1 1 auto; max-width: 48px;
}
.task-done-pager .task-done-page-btn {
  appearance: none; display: inline-flex; align-items: center; justify-content: center;
  gap: 0.35rem; border: 1px solid var(--border); background: rgba(148,163,184,0.10);
  color: var(--text); border-radius: 999px; padding: 0.45rem 0.7rem; font-weight: 900;
  font-size: 0.82rem; min-width: 36px; height: 34px; cursor: pointer; transition: var(--transition); user-select: none;
}
.task-done-pager .task-done-page-btn:hover { transform: translateY(-1px); background: rgba(148,163,184,0.16); }
.task-done-pager .task-done-page-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
.task-done-pager .task-done-page-btn.active { border-color: rgba(16,185,129,0.65); background: rgba(16,185,129,0.12); color: var(--success); }
.task-done-pager .task-done-page-btn.nav { min-width: 78px; }
.task-done-pager .task-done-page-btn.nav i { font-size: 1.1em; }
.task-done-pager .ellipsis { color: var(--text-secondary); font-weight: 900; padding: 0 0.25rem; line-height: 1; user-select: none; }
.task-done-pager .meta { color: var(--text-secondary); font-weight: 800; font-size: 0.82rem; width: 100%; text-align: right; }
.task-done-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 0.5rem; }
.task-done-list li {
  display: flex; align-items: flex-start; gap: 0.6rem; padding: 0.75rem 0.8rem;
  border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.02);
  color: var(--text); font-weight: 700;
}
.task-done-list li i { color: var(--success); font-size: 1.05rem; margin-top: 0.05rem; }
.task-done-list li strong { font-weight: 900; }
.task-install-instructions {
  background-color: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px;
  padding: 1rem; margin-top: 0.75rem; font-size: 0.85rem; line-height: 1.6; color: var(--text);
}
.task-install-instructions p {
  color: var(--text); margin: 0.25rem 0;
}
.task-install-instructions code {
  display: block; background: #282c34; color: #f8f8f2; padding: 0.75rem; border-radius: 10px;
  overflow-x: auto; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
  margin-top: 0.5rem; font-size: 0.8rem;
}
.task-copy-btn {
  margin-top: 0.65rem; appearance: none; border: 1px solid rgba(14, 165, 233, 0.55);
  background: rgba(14, 165, 233, 0.12); color: var(--info); padding: 0.55rem 0.85rem;
  border-radius: 999px; cursor: pointer; font-size: 0.85rem; font-weight: 900;
  display: inline-flex; align-items: center; gap: 0.5rem; transition: var(--transition);
}
.task-copy-btn:hover {
  transform: translateY(-1px); border-color: rgba(14, 165, 233, 0.75);
  background: rgba(14, 165, 233, 0.16); box-shadow: 0 14px 40px rgba(14, 165, 233, 0.12);
}
.task-copy-btn:active { transform: translateY(0); }
.task-budget-split {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.65rem; margin-top: 0.75rem;
}
.task-budget-split .split-item {
  display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
  padding: 0.65rem 0.75rem; border-radius: 12px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.02);
}
.task-budget-split .split-item .left {
  display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);
  font-weight: 800; font-size: 0.8rem;
}
.task-budget-split .dot {
  width: 10px; height: 10px; border-radius: 999px; flex: 0 0 auto;
}
.task-budget-split .split-item strong {
  color: var(--text); font-weight: 900;
}
.task-budget-split .split-item.used .dot { background: var(--warning); box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.18); }
.task-budget-split .split-item.avail .dot { background: var(--success); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.16); }
.task-budget-split .split-item.total .dot { background: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.14); }
.task-budget-bar {
  width: 100%; height: 10px; border-radius: 999px; overflow: hidden;
  background: rgba(148, 163, 184, 0.18); display: flex;
}
.task-budget-bar .seg {
  height: 100%;
}
.task-budget-bar .seg.used {
  background: rgba(99, 102, 241, 0.95);
}
.task-budget-bar .seg.avail {
  background: rgba(16, 185, 129, 0.95);
}
.task-modal-chart-stack {
  display: grid; grid-template-columns: 1fr; gap: 1rem;
}
.task-modal-chart-wrap {
  height: 230px;
}
.task-modal-chart-wrap.small {
  height: 200px;
}
.analytics-mobile-switch {
  display: none; width: 100%; padding: 0.25rem; background: rgba(148, 163, 184, 0.08);
  border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1rem; gap: 0.25rem;
}
.analytics-switch-btn {
  flex: 1; appearance: none; border: 1px solid transparent; background: transparent;
  color: var(--text-secondary); border-radius: 10px; padding: 0.6rem 0.75rem; font-weight: 700;
  font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex;
  align-items: center; justify-content: center; gap: 0.4rem; white-space: nowrap;
}
.analytics-switch-btn:hover {
  color: var(--text); background: rgba(148, 163, 184, 0.1);
}
.analytics-switch-btn.active {
  background: var(--bg); color: var(--primary); border-color: rgba(99, 102, 241, 0.4);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
}
.analytics-switch-btn.active[data-view="map"] {
  color: var(--info); border-color: rgba(14, 165, 233, 0.4); box-shadow: 0 2px 8px rgba(14, 165, 233, 0.15);
}
.analytics-switch-btn i {
  font-size: 1.1em;
}
.task-modal-map {
  height: 360px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border);
  background: var(--bg-tertiary);
}
.task-modal-map-note {
  margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;
}
.task-modal-map-note .chip {
  display: inline-flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  padding: 0.35rem 0.6rem; border-radius: 999px; border: 1px solid var(--border);
  background: rgba(14, 165, 233, 0.08); font-size: 0.78rem; font-weight: 800; color: var(--text);
}
.task-modal-map-note .chip span {
  color: var(--text-secondary); font-weight: 900;
}
.task-modal-tab .label-mobile { display: none; }
.task-modal-tab .label-desktop { display: inline; }
.task-modal-tab.icon-only .label-mobile,
.task-modal-tab.icon-only .label-desktop {
  display: none !important;
}
.task-modal-tab.icon-only {
  padding-left: 0.55rem; padding-right: 0.55rem;
}
.task-modal-tab.icon-only i {
  margin: 0;
}
.task-budget-top {
  display: flex; align-items: baseline; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.65rem;
}
.task-budget-label {
  font-size: 0.85rem; font-weight: 800; color: var(--text); letter-spacing: 0.01em;
}
.task-budget-meta {
  display: inline-flex; align-items: baseline; gap: 0.6rem; flex: 0 0 auto;
}
.task-budget-amount {
  font-size: 1.15rem; font-weight: 900; color: var(--success);
}
.task-budget-percent {
  font-size: 0.85rem; font-weight: 800; color: var(--text-secondary);
}
.task-modal-recharge-btn {
  margin-top: 0.85rem; width: 100%; display: inline-flex; align-items: center;
  justify-content: center; gap: 0.5rem; padding: 0.75rem 0.95rem; border-radius: 12px;
  border: 1px solid rgba(16, 185, 129, 0.55);
  background: linear-gradient(180deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
  color: #ffffff; font-weight: 900; letter-spacing: 0.01em; cursor: pointer;
  transition: var(--transition); box-shadow: 0 18px 40px rgba(16, 185, 129, 0.18);
}
.task-modal-recharge-btn:hover {
  transform: translateY(-1px); box-shadow: 0 20px 48px rgba(16, 185, 129, 0.24);
}
.task-modal-recharge-btn:active {
  transform: translateY(0);
}
.task-modal-recharge-btn:focus-visible {
  outline: none; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.22), 0 20px 48px rgba(16, 185, 129, 0.24);
}
.task-modal-breakdown-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;
}
.task-modal-breakdown-item {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 0.85rem 0.9rem;
}
.task-modal-breakdown-item .label {
  font-size: 0.75rem; font-weight: 800; color: var(--text-secondary); margin-bottom: 0.25rem;
  letter-spacing: 0.02em; text-transform: uppercase;
}
.task-modal-breakdown-item .value {
  font-size: 1.05rem; font-weight: 900; color: var(--text);
}
.recharge-modal-container {
  text-align: left; padding-top: 1rem;
}
.recharge-modal-section {
  margin-bottom: 1.5rem;
}
.recharge-modal-label {
  display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text); font-size: 1rem;
}
.recharge-preset-amounts {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;
}
.recharge-preset-btn {
  padding: 0.75rem; font-size: 1rem; font-weight: 700; border: 2px solid var(--border);
  background: var(--card); color: var(--primary); border-radius: var(--radius); cursor: pointer;
  transition: var(--transition);
}
.recharge-preset-btn:hover {
  border-color: var(--primary); background: rgba(99, 102, 241, 0.1);
}
.recharge-payment-options {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
}
.recharge-payment-option {
  padding: 1rem; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer;
  transition: var(--transition); text-align: center;
}
.recharge-payment-option:hover {
  transform: translateY(-2px); box-shadow: var(--shadow);
}
.recharge-payment-option.selected {
  border-color: var(--primary); background: rgba(99, 102, 241, 0.1);
}
.recharge-payment-option i {
  font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary);
}
.recharge-payment-option .provider-name {
  font-weight: 600; color: var(--text);
}
.recharge-summary {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 1rem; margin-top: 1.5rem;
}
.recharge-summary-item {
  display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem;
}
.swal2-popup.recharge-modal-custom {
  width: 95vw !important; ;
}
.recharge-modal-custom > .swal2-actions > .swal2-cancel {
  background: #df0e0e;
}
.mobile-profile-menu {
  display: none; padding: 0; border-radius: 50%; background: transparent; border: none;
  color: var(--text); cursor: pointer; font-size: 1.25rem; transition: var(--transition); position: relative;
}
.mobile-profile-menu:hover .user-avatar {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.mobile-profile-menu .user-avatar {
  width: 36px; height: 36px; border-radius: 50%; background: var(--gradient-primary);
  display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;
  font-size: 0.875rem; transition: box-shadow 0.2s ease;
}
.mobile-profile-dropdown {
  display: none; position: fixed; top: 60px; right: 1rem; background: var(--card);
  border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); z-index: 10001; overflow: hidden;
  animation: slideDown 0.2s ease; min-width: 280px;
}
.mobile-profile-dropdown.active {
  display: block;
}
@keyframes slideDown {
from {
  opacity: 0; transform: translateY(-10px);
}
to {
  opacity: 1; transform: translateY(0);
}
}
.swal2-popup-custom-task {
  margin: 0 !important; padding: 0 !important;
}
.swal2-popup.task-details-swal {
  margin: 0.5rem !important; width: min(1100px, 96vw) !important; max-width: 96vw !important;
  box-sizing: border-box !important;
}
.task-details-swal .swal2-html-container {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
}
.swal2-container {
  z-index: 10000 !important;
}
.sessions-modal-custom {
  width: 95vw !important;
}
.sessions-modal-container {
  text-align: left; font-size: 0.9rem;
}
.sessions-section-title {
  font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem;
}
.sessions-section-title:first-child {
  margin-top: 0;
}
.session-card {
  display: flex; align-items: flex-start; gap: 1rem; background: var(--card);
  border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem;
}
.session-card--current {
  border-left: 4px solid var(--success); background: rgba(16, 185, 129, 0.05);
}
.session-icon {
  font-size: 1.75rem; color: var(--text-secondary); margin-top: 0.25rem;
}
.session-details {
  flex: 1;
}
.session-main-info {
  font-weight: 600; color: var(--text); margin-bottom: 0.5rem;
}
.session-meta-info {
  font-size: 0.8rem; color: var(--text-secondary); display: flex; flex-direction: column; gap: 0.25rem;
}
.session-actions {
  margin-left: auto;
}
.swal2-footer {
  border-top: 1px solid var(--border) !important; margin-top: 1.5rem !important; padding-top: 1.5rem !important;
}
.swal2-popup {
  background: var(--card) !important; color: var(--text) !important; border: none !important;
  border-radius: 1.25rem !important;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2), 0 0 80px rgba(99, 102, 241, 0.1) !important;
}
.swal2-title {
  color: var(--text) !important;
}
.swal2-html-container {
  color: var(--text) !important;
}
.swal2-html-container .card {
  background: var(--bg-tertiary) !important; border-color: var(--border) !important;
}
.swal2-html-container .card-header {
  border-bottom-color: var(--border) !important;
}
.swal2-html-container .card-title {
  color: var(--text) !important;
}
.swal2-html-container .form-label {
  color: var(--text) !important;
}
.swal2-html-container .form-input,
.swal2-html-container .form-select,
.swal2-html-container .form-textarea {
  background: var(--input-bg) !important; color: var(--text) !important; border-color: var(--border) !important;
}
.swal2-html-container code {
  background: var(--bg-tertiary) !important; color: var(--text) !important; border: 1px solid var(--border) !important;
}
.swal2-html-container .empty-state-title {
  color: var(--text) !important;
}
.swal2-html-container .empty-state-description {
  color: var(--text-secondary) !important;
}
.swal2-icon {
  margin: 1rem auto !important; width: 5rem !important; height: 5rem !important; border-width: 3px !important;
}
.swal2-icon.swal2-warning {
  border-color: var(--warning) !important; color: var(--warning) !important;
}
.swal2-icon.swal2-error {
  border-color: var(--error) !important;
}
.swal2-icon.swal2-success {
  border-color: var(--success) !important;
}
.swal2-icon.swal2-info {
  border-color: var(--primary) !important; color: var(--primary) !important;
}
.swal2-title {
  color: var(--text) !important; font-weight: 700 !important; font-size: 1.5rem !important;
  margin-bottom: 0.5rem !important;
}
.swal2-html-container {
  color: var(--text-secondary) !important; font-size: 0.9375rem !important; line-height: 1.6 !important;
}
.swal2-actions {
  gap: 0.75rem !important; margin-top: 1.5rem !important;
}
.swal2-confirm, .swal2-cancel, .swal2-deny {
  padding: 0.75rem 1.5rem !important; border-radius: 0.625rem !important;
  font-weight: 600 !important; font-size: 0.9375rem !important; transition: all 0.3s !important;
  border: none !important;
}
.swal2-confirm {
  background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%) !important;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3) !important;
}
.swal2-confirm:hover {
  transform: translateY(-2px) !important; box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4) !important;
}
.swal2-cancel {
  background: var(--bg-tertiary) !important; color: var(--text) !important; border: 2px solid var(--border) !important;
}
.swal2-cancel:hover {
  background: var(--bg-secondary) !important; border-color: var(--text-secondary) !important;
}
.swal2-input {
  background: var(--bg-secondary) !important; color: var(--text) !important;
  border: 2px solid var(--border) !important; border-radius: 0.625rem !important;
  padding: 0.75rem !important; font-size: 0.9375rem !important; transition: all 0.3s !important;
}
.swal2-input:focus {
  border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
}
/* Consolidated Media Queries */
@media (min-width: 769px) {
.domain-actions-row {
  flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: space-between; gap: 0.5rem;
}
.domain-status-row {
  display: flex; flex-direction: row; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; width: auto;
}
.domain-status-row .domain-verify-delete {
  display: none !important;
}
.domain-verify-delete-desktop {
  display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;
}
.domain-buttons-row {
  display: flex; flex-direction: row; align-items: center; gap: 0.5rem; width: auto; flex-shrink: 0;
}
.domain-verify-delete {
  gap: 0.5rem;
}
.collapsible-header {
  cursor: default !important;
}
.swal2-popup.image-details-swal {
  width: min(75vw, 850px) !important; max-width: 75vw !important; padding: 1.25rem !important;
}
.image-hero-preview {
  min-height: 280px; padding: 2rem;
}
.image-hero-img {
  max-height: 250px;
}
.image-stats-grid {
  grid-template-columns: repeat(4, 1fr);
}
.image-analytics-content {
  grid-template-columns: repeat(2, 1fr);
}
.image-chart-card .chart-body {
  height: 200px;
}
.image-traffic-content {
  grid-template-columns: repeat(3, 1fr);
}
.swal2-popup.article-details-swal {
  width: min(75vw, 950px) !important; max-width: 75vw !important; padding: 1.25rem !important;
}
.article-modal-stat-grid {
  grid-template-columns: repeat(4, 1fr);
}
.article-chart-wrap {
  height: 300px;
}
.article-mini-charts-grid {
  grid-template-columns: repeat(3, 1fr);
}
.article-slider-thumb {
  width: 70px; height: 70px;
}
.article-content-body {
  max-height: 420px;
}
}
@media (max-width: 768px) {
.step-content {
  padding: 0.5rem 0;
}
.step-content.active {
  display: flex; flex-direction: column; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;
}
.billing-cycle-options {
  display: flex; gap: 0.75rem; overflow-x: auto; padding: 0.25rem 0 0.5rem;
  scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
}
.billing-cycle-options::-webkit-scrollbar {
  display: none;
}
.billing-cycle-options .billing-option {
  min-width: 80%; max-width: 80%; border-radius: 1rem; padding: 1.25rem; align-items: flex-start;
  justify-content: flex-start; gap: 0.65rem; text-align: left; scroll-snap-align: center;
}
.billing-cycle-options .billing-option-top {
  align-items: flex-start;
}
.billing-cycle-options .billing-price {
  font-size: 0.9rem; margin-top: 0;
}
.billing-cycle-options .billing-note {
  font-size: 0.8rem;
}
.billing-cycle-options .billing-save {
  font-size: 0.7rem; padding: 0.2rem 0.6rem;
}
.billing-cycle-options .billing-badge {
  position: absolute; top: 1rem; right: 1rem; transform: none; font-size: 0.7rem; padding: 0.25rem 0.6rem;
}
.budget-summary {
  grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding: 0.75rem;
}
.seo-task-creator {
  padding: 0; align-items: stretch;
}
.seo-task-creator::before {
  content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: -1;
}
.task-creator-container {
  width: 100vw; max-width: 100vw; height: 100vh; height: 100dvh; max-height: 100vh;
  max-height: 100dvh; border-radius: 0; flex-direction: column; position: fixed; top: 0; left: 0;
  z-index: 1000; transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); overflow: hidden;
}
.seo-task-creator.active .task-creator-container {
  transform: translateY(0); display: flex;
  animation: slideUpMobileSmooth 0.35s cubic-bezier(0.34, 1.3, 0.64, 1) forwards;
}
@keyframes slideUpMobileSmooth {
0% {
  transform: translateY(100%); opacity: 0;
}
100% {
  transform: translateY(0); opacity: 1;
}
}
.task-creator-sidebar {
  width: 100%; height: auto; min-height: auto; max-height: none; border-right: none;
  border-bottom: 1px solid rgba(148, 163, 184, 0.15); padding: 0.6rem 0.75rem; order: 1; position: relative;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(14, 165, 233, 0.04) 100%), var(--bg-secondary);
  z-index: 10; box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05); display: flex; flex-direction: column;
  gap: 0; flex-shrink: 0;
}
.task-creator-main {
  width: 100%; order: 2; flex: 1; display: flex; flex-direction: column; overflow: hidden;
  height: auto; min-height: 0; background: var(--bg-primary); position: relative;
}
.task-creator-header {
  padding: 0.6rem 0.75rem; background: var(--bg-secondary); z-index: 5; flex-shrink: 0;
  display: flex; flex-direction: column; gap: 0.1rem; border-bottom: 1px solid var(--border); position: sticky; top: 0;
}
.task-creator-close {
  position: absolute !important; top: 0.6rem !important; right: 0.65rem !important;
  width: 1.9rem !important; height: 1.9rem !important; font-size: 0.95rem !important;
  flex-shrink: 0; display: flex !important; align-items: center !important;
  justify-content: center !important; z-index: 1010 !important;
  background: var(--bg-primary) !important; border: 1px solid var(--border) !important;
  border-radius: 50% !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important; transition: all 0.2s ease !important;
}
.task-creator-close:active {
  transform: scale(0.95); box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important;
}
.task-creator-title {
  font-size: 0.95rem; font-weight: 700; margin-bottom: 0.1rem; padding-right: 2.5rem;
  color: var(--text); line-height: 1.2;
}
.task-creator-subtitle {
  font-size: 0.65rem; color: var(--text-secondary); display: block; line-height: 1.2;
}
.task-creator-body {
  flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0.6rem;
  -webkit-overflow-scrolling: touch; max-height: calc(100vh - 160px);
}
.progress-steps {
  display: flex; align-items: center; justify-content: space-between; gap: 0.4rem; width: 100%; padding: 0;
}
.progress-step {
  display: flex; flex-direction: column; align-items: center; gap: 0.3rem; flex: 1;
  padding: 0.5rem 0.25rem; border-radius: 0.6rem; transition: all 0.2s ease;
  background: var(--bg-primary); border: 1.5px solid rgba(148, 163, 184, 0.25); position: relative;
  text-align: center; min-width: 0;
}
.progress-step::after {
  content: ''; display: none;
}
.progress-step.completed {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(16, 185, 129, 0.12));
  border-color: rgba(34, 197, 94, 0.4);
}
.progress-step.active {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color: transparent;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); color: white;
}
.step-info {
  display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 0; width: 100%;
}
.step-title {
  font-size: 0.65rem; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden;
  text-overflow: ellipsis; width: 100%; line-height: 1;
}
.step-indicator {
  width: 1.5rem; height: 1.5rem; border-radius: 50%; background: rgba(99, 102, 241, 0.1);
  border: 1.5px solid rgba(99, 102, 241, 0.3); display: flex; align-items: center;
  justify-content: center; font-weight: 700; font-size: 0.65rem; color: var(--text);
  transition: all 0.2s ease; flex-shrink: 0;
}
.progress-step.active .step-indicator {
  background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); color: white;
}
.progress-step.completed .step-indicator {
  background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); color: #059669;
}
.progress-step.completed .step-indicator::before {
  content: '✓'; position: absolute; font-size: 0.65rem;
}
.progress-step.active .step-title {
  color: rgba(255, 255, 255, 0.95);
}
.progress-step.completed .step-title {
  color: #059669; font-weight: 700;
}
.task-creator-footer {
  padding: 0.6rem 0.75rem; background: var(--bg-secondary); border-top: 1px solid var(--border);
  flex-shrink: 0; display: flex; flex-direction: row; gap: 0.6rem;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03); position: sticky; bottom: 0; z-index: 10;
}
.footer-actions {
  width: 100%; display: flex; gap: 0.75rem;
}
.task-creator-footer button {
  flex: 1; padding: 0.7rem 0.85rem; font-size: 0.8rem; font-weight: 600; border-radius: 0.6rem;
  display: flex; align-items: center; justify-content: center; gap: 0.4rem; border: none;
  cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
  overflow: hidden; letter-spacing: 0.01em; min-height: 40px;
}
.task-creator-footer button::before {
  content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%;
  background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s ease, height 0.6s ease;
}
.task-creator-footer button:active::before {
  width: 300px; height: 300px;
}
.btn-ghost {
  background: var(--bg-tertiary); border: 2px solid rgba(99, 102, 241, 0.2); color: var(--text);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}
.btn-ghost:active {
  transform: scale(0.97); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08); border-color: rgba(99, 102, 241, 0.3);
}
.btn-ghost i {
  transition: transform 0.3s ease;
}
.btn-ghost:active i {
  transform: translateX(-2px);
}
.btn-primary-gradient {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
  background-size: 200% 200%; color: white; box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
  animation: gradientShift 3s ease infinite;
}
@keyframes gradientShift {
0% { background-position: 0% 50%; }; 50% { background-position: 100% 50%; };
100% { background-position: 0% 50%; };
}
.btn-primary-gradient:active {
  transform: scale(0.97); box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4);
}
.btn-primary-gradient i {
  transition: transform 0.3s ease;
}
.btn-primary-gradient:active i:last-child {
  transform: translateX(3px);
}
.btn-primary-gradient:active i:first-child {
  transform: scale(1.1);
}
.form-group {
  margin-bottom: 0.9rem;
}
.form-label {
  font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem;
}
.form-input {
  padding: 0.7rem 0.85rem; font-size: 0.85rem; border-radius: 0.65rem;
}
.priority-options {
  display: grid; grid-template-columns: 1fr; gap: 0.5rem; gap: 0.875rem;
}
.priority-option {
  width: 100%; padding: 1rem; min-height: auto; display: grid; grid-template-columns: 1fr auto;
  align-items: center; gap: 1rem; border-radius: 0.875rem; position: relative; overflow: visible;
}
.priority-option::before {
  display: none;
}
.priority-badge {
  position: absolute; top: -0.5rem; right: 1rem; padding: 0.25rem 0.75rem; font-size: 0.625rem;
  border-radius: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); align-self: auto;
}
.priority-option .priority-title {
  font-size: 1rem; margin-bottom: 0.25rem;
}
.priority-option .priority-price {
  font-size: 1.375rem;
}
.priority-option .priority-locations {
  font-size: 0.75rem;
}
.priority-option.selected {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
  border-color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
}
.payment-type-toggle {
  margin-bottom: 1.25rem; padding: 0.25rem;
}
.payment-type-option {
  padding: 0.6rem 0.7rem; font-size: 0.8rem;
}
.payment-options {
  grid-template-columns: 1fr 1fr; gap: 0.75rem;
}
.payment-card {
  padding: 0.75rem; display: flex; flex-direction: column; align-items: center;
  justify-content: center; text-align: center; min-height: 90px;
}
.payment-card .payment-icon {
  font-size: 1.75rem; margin-bottom: 0.4rem;
}
.payment-card .payment-title {
  font-size: 0.8rem; font-weight: 600; margin-bottom: 0.2rem; line-height: 1.2;
}
.payment-card .payment-description {
  font-size: 0.65rem; line-height: 1.2;
}
.billing-cycle-options {
  display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem;
}
.billing-cycle-options .billing-option {
  padding: 0.6rem 0.75rem; min-height: auto; max-height: none; height: auto; display: flex;
  flex-direction: row; justify-content: space-between; align-items: center; text-align: left;
  border-radius: 0.7rem; position: relative; gap: 0.6rem; transition: all 0.2s ease;
}
.billing-cycle-options .billing-option-top {
  display: flex; align-items: center; gap: 0.6rem; flex: 1;
}
.billing-cycle-options .billing-icon {
  width: 2rem; height: 2rem; font-size: 0.95rem; border-radius: 0.5rem; flex-shrink: 0;
}
.billing-cycle-options .billing-option-header {
  display: flex; flex-direction: column; align-items: flex-start; gap: 0.1rem; flex: 1;
}
.billing-period {
  font-size: 0.85rem !important; font-weight: 700; color: var(--text); line-height: 1;
}
.billing-frequency {
  font-size: 0.65rem !important; color: var(--text-secondary); display: none;
}
.billing-save {
  font-size: 0.6rem !important; padding: 0.15rem 0.45rem !important; margin: 0;
  display: inline-block; flex-shrink: 0; border-radius: 0.35rem;
}
.billing-price {
  display: none !important;
}
.billing-note {
  display: none !important;
}
.billing-badge {
  display: none;
}
.billing-cycle-options .billing-option.selected {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color: transparent;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
}
.billing-cycle-options .billing-option.selected .billing-icon {
  background: rgba(255, 255, 255, 0.2); color: white;
}
.billing-cycle-options .billing-option.selected .billing-period,
.billing-cycle-options .billing-option.selected .billing-frequency {
  color: rgba(255, 255, 255, 0.95);
}
.billing-cycle-options .billing-option.selected .billing-save {
  background: rgba(255, 255, 255, 0.2); color: white;
}
.billing-cycle-options .billing-option.selected::after {
  content: ''; display: none;
}
.budget-calculator {
  padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.75rem;
}
.budget-input-group {
  gap: 0.7rem;
}
.budget-field input {
  padding: 0.65rem 0.65rem 0.65rem 2rem; font-size: 1rem; border-radius: 0.65rem;
}
.budget-field .currency-symbol {
  font-size: 1.125rem; left: 0.75rem; bottom: 0.75rem;
}
.budget-summary {
  padding: 0.75rem; gap: 0.5rem; grid-template-columns: repeat(3, 1fr);
}
.budget-summary-label {
  font-size: 0.625rem;
}
.budget-summary-value {
  font-size: 0.875rem;
}
.keyword-suggestions {
  gap: 0.45rem; margin-bottom: 0.7rem;
}
.keyword-suggestion {
  padding: 0.5rem 0.75rem; font-size: 0.75rem; border-radius: 0.6rem;
}
.selected-keywords {
  padding: 0.65rem; margin-bottom: 0.7rem; border-radius: 0.65rem;
}
.keyword-tags {
  gap: 0.35rem;
}
.keyword-tag {
  padding: 0.35rem 0.55rem; font-size: 0.7rem; border-radius: 0.45rem;
}
.pending-task-alert {
  margin-bottom: 0.7rem; padding: 0.7rem; border-radius: 0.65rem;
}
.pending-task-icon {
  width: 2rem; height: 2rem; font-size: 1rem;
}
.pending-task-title {
  font-size: 0.85rem; font-weight: 600;
}
.pending-task-details {
  padding: 0.65rem; margin-bottom: 0.65rem; border-radius: 0.6rem;
}
.pending-task-actions {
  gap: 0.65rem;
}
.pending-task-actions .btn {
  padding: 0.7rem; font-size: 0.8rem; border-radius: 0.6rem;
}
.sidebar {
  display: none;
}
.mobile-nav {
  display: block;
}
.main-content {
  padding-bottom: 60px;
}
.header {
  padding: 0.75rem; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary);
}
.search-bar {
  display: none;
}
.mobile-search-toggle {
  display: block; padding: 0.5rem; background: transparent; border: none; color: var(--text);
  font-size: 1.25rem; cursor: pointer;
}
.user-dropdown {
  position: fixed; top: auto; bottom: 0; left: 0; right: 0; min-width: 100%;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0; max-height: 50vh; overflow-y: auto;
}
.user-dropdown-header {
  display: none;
}
.user-menu {
  padding: 0.5rem; gap: 0.5rem;
}
.user-menu > div {
  display: none;
}
.header-left {
  flex: 1;
}
.header-right {
  gap: 0.5rem;
}
.stats-grid {
  grid-template-columns: repeat(2, 1fr); gap: 0.75rem;
}
.stat-card {
  padding: 0.875rem;
}
.stat-card .stat-value {
  font-size: 1.5rem;
}
.stat-card .stat-label {
  font-size: 0.75rem;
}
.task-grid {
  grid-template-columns: 1fr; gap: 1rem; padding: 0; margin: 0;
}
.task-card {
  position: relative; width: 100%; max-width: 100%; padding: 1rem; margin: 0;
  box-sizing: border-box; overflow: hidden; word-wrap: break-word;
}
.task-header {
  flex-direction: row; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.75rem; padding-right: 3rem; ;
}
.task-url-wrapper {
  flex: 1; min-width: 0; max-width: calc(100% - 5rem); ;
}
.task-url {
  font-size: 0.9rem; line-height: 1.4; word-break: break-word; overflow-wrap: break-word;
  max-width: 100%; display: inline-flex; flex-wrap: wrap;
}
.task-url i {
  font-size: 0.8rem;
}
.task-date {
  font-size: 0.7rem; margin-top: 0.2rem;
}
.task-status {
  align-self: flex-start; flex-shrink: 0; font-size: 0.7rem; padding: 0.2rem 0.6rem;
}
.task-stats {
  grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin: 0.75rem 0;
}
.task-stat-label {
  font-size: 0.7rem;
}
.task-stat-value {
  font-size: 1rem;
}
.task-progress {
  margin: 0.75rem 0;
}
.task-actions {
  flex-direction: row; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; width: 100%;
}
.task-actions button {
  flex: 1 1 calc(50% - 0.25rem); width: auto; justify-content: center; padding: 0.625rem 1rem; font-size: 0.875rem;
}
.task-actions .btn-sm {
  width: auto;
}
.task-actions button:only-child {
  flex-basis: 100%;
}
.btn-delete-task-desktop {
  display: none !important;
}
.btn-delete-task-mobile {
  display: inline-flex; position: absolute; top: 0.75rem; right: 0.75rem; z-index: 2;
  width: 2.25rem; height: 2.25rem; padding: 0 !important; border-radius: 999px;
  background: rgba(230, 57, 70, 0.12) !important; color: var(--danger) !important;
  border: 1px solid rgba(230, 57, 70, 0.25); align-items: center; justify-content: center; gap: 0;
}
.btn-delete-task-mobile:hover {
  background: rgba(230, 57, 70, 0.18) !important; transform: none; box-shadow: none;
}
.btn-delete-task-mobile i {
  font-size: 1.05rem;
}
.task-actions.task-actions-delete-only {
  display: none;
}
.media-grid {
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}
.search-bar {
  width: 200px;
}
.header {
  padding: 1rem;
}
.content {
  padding: 1rem;
}
.modal {
  width: 95%; max-height: 85vh;
}
.priority-options {
  grid-template-columns: 1fr;
}
.chart-container {
  height: 200px !important;
}
.map-container {
  height: 250px !important;
}
.analytics-grid,
div[style*="grid-template-columns: 1fr 1fr"] {
  grid-template-columns: 1fr !important; gap: 1rem !important;
}
.card {
  min-width: 100%;
}
.table-container {
  overflow-x: auto; -webkit-overflow-scrolling: touch;
}
table {
  min-width: 600px;
}
.modal {
  width: 100%; max-width: 100%; margin: 0; height: 100vh; max-height: 100vh; border-radius: 0;
}
.modal-body {
  max-height: calc(100vh - 60px);
}
.domains-usage-container {
  flex-direction: column !important; gap: 1rem !important;
}
.domains-usage-container .card {
  flex: 1 !important; max-width: 100% !important;
}
.seo-task-creator.active .task-creator-container {
  animation: slideUpMobile 0.3s ease forwards !important;
}
@keyframes slideUpMobile {
from {
  transform: translateY(100%); opacity: 0;
}
to {
  transform: translateY(0); opacity: 1;
}
}
.step-content {
  animation: fadeIn 0.2s ease !important;
}
.task-creator-close:active {
  transform: scale(0.95) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
}
.progress-step.active .step-indicator {
  animation: pulseGlow 2s infinite;
}
.collapsible-header {
  user-select: none;
}
.collapsible-header #domainsContentIcon,
.collapsible-header #usageContentIcon {
  display: inline-block !important;
}
.collapsible-content {
  max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease;
}
.collapsible-content.collapsed {
  max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border-top: none !important;
}
.usage-category {
  padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-sm);
}
.desktop-only {
  display: none !important;
}
.mobile-only {
  display: block !important;
}
.image-info-bar {
  flex-direction: column; align-items: stretch; gap: 0.75rem;
}
.image-actions-bar {
  justify-content: flex-start;
}
.image-stats-grid {
  grid-template-columns: repeat(4, 1fr); gap: 0.5rem;
}
.image-stat-card {
  padding: 0.7rem 0.35rem;
}
.image-stat-card .stat-value {
  font-size: 1.15rem;
}
.image-stat-card .stat-label {
  font-size: 0.6rem;
}
.image-hero-preview {
  min-height: 180px; padding: 1rem;
}
.image-hero-img {
  max-height: 160px;
}
.image-chart-card .chart-body {
  height: 160px;
}
.image-traffic-content {
  grid-template-columns: repeat(2, 1fr);
}
.article-modal-actions-desktop {
  display: none;
}
.article-modal-actions-mobile {
  display: flex; gap: 0.35rem; flex-shrink: 0;
}
.article-modal-actions-mobile .btn {
  padding: 0.3rem 0.5rem; font-size: 0.75rem;
}
.article-modal-header-row {
  flex-direction: column; align-items: stretch; gap: 0.5rem;
}
.article-modal-stat-grid {
  grid-template-columns: repeat(2, 1fr);
}
.article-modal-tabs { width: 100%; }
.article-modal-tab .label-mobile,
.article-modal-tab .label-desktop { display: none !important; }
.article-modal-tab { padding-left: 0.55rem !important; padding-right: 0.55rem !important; }
.article-modal-tab i { margin: 0 !important; }
.article-mini-charts-grid {
  grid-template-columns: 1fr;
}
.article-chart-wrap {
  height: 220px;
}
.article-mini-chart-card .chart-body {
  height: 140px;
}
.article-image-slider {
  min-height: 180px; padding: 0.75rem; display: flex; flex-direction: row; align-items: center;
  justify-content: center; gap: 0.5rem;
}
.article-slider-image {
  max-height: 160px; flex: 1; min-width: 0; object-fit: contain;
}
.article-slider-nav {
  position: static !important; transform: none !important; width: 34px !important;
  height: 34px !important; min-width: 34px !important; max-width: 34px !important;
  font-size: 0.9rem; opacity: 0.9; background: var(--card); border: 1px solid var(--border);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); flex-shrink: 0;
}
.article-slider-nav:hover {
  transform: none !important;
}
.article-slider-thumb {
  width: 50px; height: 50px;
}
.article-content-info {
  grid-template-columns: repeat(3, 1fr);
}
.article-content-body {
  max-height: 280px; padding: 1rem; font-size: 0.9rem;
}
.analytics-mobile-switch {
  display: flex;
}
.task-modal-grid .analytics-section > .task-modal-section-title,
.task-modal-grid .map-section > .task-modal-section-title {
  display: none;
}
.task-modal-grid .analytics-section,
.task-modal-grid .map-section {
  display: none !important;
}
.task-modal-grid .analytics-section.active,
.task-modal-grid .map-section.active {
  display: block !important;
}
.task-modal-tabs { width: 100%; }
.task-modal-tab .label-mobile,
.task-modal-tab .label-desktop {
  display: none !important;
}
.task-modal-tab {
  padding-left: 0.55rem !important; padding-right: 0.55rem !important;
}
.task-modal-tab i {
  margin: 0 !important;
}
.task-modal-header-row {
  flex-direction: column; align-items: stretch; gap: 0.75rem;
}
.task-modal-actions-slot {
  justify-content: flex-start;
}
.task-modal-actions-slot .swal2-actions {
  width: 100% !important; justify-content: stretch !important;
}
.task-modal-actions-slot .swal2-actions button {
  flex: 1 1 auto !important; width: 100% !important; padding: 0.65rem 0.85rem !important; font-size: 0.9rem !important;
}
.task-modal-header h3 {
  font-size: 1rem !important; word-break: break-all; line-height: 1.3;
}
.task-modal-header .header-meta {
  font-size: 0.7rem !important; flex-direction: column; gap: 0.5rem !important;
}
.task-modal-header .header-meta .header-meta-left {
  flex-direction: column; gap: 0.25rem !important;
}
.task-modal-header .header-meta .header-meta-left .task-verify-inline-btn {
  width: auto !important; max-width: none !important; padding: 0.4rem 0.85rem !important; font-size: 0.8rem !important;
}
.task-modal-header .header-meta .header-meta-right {
  width: 100%; justify-content: stretch;
}
.task-config-btn {
  width: 100% !important; justify-content: center !important; padding: 0.65rem 0.9rem !important;
}
.task-modal-stat-grid {
  grid-template-columns: repeat(2, 1fr) !important; gap: 0.5rem !important; margin-bottom: 1rem !important;
}
.task-modal-stat-card {
  padding: 0.75rem !important;
}
.task-modal-stat-card .stat-value {
  font-size: 1.25rem !important;
}
.task-modal-stat-card .stat-label {
  font-size: 0.7rem !important;
}
.task-modal-grid {
  grid-template-columns: 1fr !important; gap: 1rem !important;
}
.task-modal-section {
  padding: 0.875rem !important;
}
.task-modal-section-title {
  font-size: 0.95rem !important; margin-bottom: 0.75rem !important; padding-bottom: 0.5rem !important;
}
.task-modal-section canvas {
  max-height: 180px !important;
}
.task-modal-mini-chart {
  height: 160px;
}
.install-instructions {
  padding: 0.75rem !important; font-size: 0.8rem !important;
}
.install-instructions code {
  padding: 0.5rem !important; font-size: 0.7rem !important;
}
.copy-btn {
  padding: 0.35rem 0.6rem !important; font-size: 0.75rem !important;
}
.task-modal-chart-wrap { height: 190px; }
.task-modal-map { height: 260px; }
.task-done-table { display: block; }
.task-done-table thead { display: none; }
.task-done-table tbody { display: block; }
.task-done-table tbody tr {
  display: flex; flex-direction: column; gap: 0.5rem; padding: 0.8rem 0.85rem;
  border-bottom: 1px solid var(--border); background: rgba(255, 255, 255, 0.01);
}
.task-done-table tbody tr:last-child { border-bottom: none; }
.task-done-table tbody td {
  padding: 0 !important; border: none !important; min-width: 0;
}
.task-done-table tbody td:nth-child(1) { display: none; }
.task-done-table tbody td:nth-child(3) { order: 1; }
.task-done-table tbody td:nth-child(2) { order: 2; }
.task-done-table tbody td:nth-child(4) { order: 3; }
.task-done-table tbody td:nth-child(3) {
  font-weight: 900; font-size: 0.95rem; line-height: 1.25; word-break: break-word;
}
.task-done-table tbody td:nth-child(2) {
  display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; min-width: 0;
}
.task-done-table tbody td:nth-child(2)::before {
  content: "Country"; color: var(--text-secondary); font-weight: 900; font-size: 0.78rem;
  letter-spacing: 0.02em; text-transform: uppercase; flex: 0 0 auto;
}
.task-done-table tbody td:nth-child(2) .country-badge {
  flex: 1 1 auto; min-width: 0; max-width: 100%; justify-content: flex-start;
}
.task-done-table tbody td:nth-child(4) {
  display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;
  color: var(--text-secondary); font-weight: 800; font-size: 0.82rem; min-width: 0;
}
.task-done-table tbody td:nth-child(4)::before {
  content: "Done"; color: var(--text-secondary); font-weight: 900; font-size: 0.78rem;
  letter-spacing: 0.02em; text-transform: uppercase; flex: 0 0 auto;
}
.task-done-table tbody td:nth-child(4) > div:first-child {
  min-width: 0; text-align: right; word-break: break-word;
}
.task-done-table tbody td:nth-child(4) .muted { display: none; }
.swal2-icon {
  width: 4rem !important; height: 4rem !important;
}
.swal2-title {
  font-size: 1.25rem !important;
}
.swal2-html-container {
  font-size: 0.875rem !important;
}
.swal2-actions {
  flex-direction: column !important; gap: 0.5rem !important;
}
.swal2-confirm, .swal2-cancel {
  width: 100% !important; margin: 0 !important;
}
.swal2-popup {
  max-height: 95vh !important; width: calc(100vw - 1rem) !important; max-width: 100vw !important;
  margin: 0.5rem !important; padding: 1rem !important; border-radius: 1rem !important;
  padding-top: 2.5rem !important; box-sizing: border-box !important; overflow: hidden !important;
}
.swal2-html-container {
  max-height: calc(95vh - 120px) !important; overflow-y: auto !important;
  overflow-x: hidden !important; padding: 0.75rem !important; padding-bottom: 1.5rem !important;
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
  word-wrap: break-word !important; word-break: break-word !important; -webkit-overflow-scrolling: touch !important;
}
.swal2-html-container * {
  max-width: 100% !important; box-sizing: border-box !important; word-wrap: break-word !important;
  overflow-wrap: break-word !important;
}
.swal2-html-container img,
.swal2-html-container canvas,
.swal2-html-container video {
  max-width: 100% !important; height: auto !important; object-fit: contain !important;
}
.swal2-html-container table {
  display: block !important; width: 100% !important; overflow-x: auto !important;
  -webkit-overflow-scrolling: touch !important;
}
.swal2-html-container pre,
.swal2-html-container code {
  white-space: pre-wrap !important; word-wrap: break-word !important;
  overflow-wrap: break-word !important; max-width: 100% !important;
}
.swal2-toast button:where(.swal2-close) {
  position: absolute !important; top: 0.5rem !important; right: 0.5rem !important;
  grid-column: unset !important; grid-row: unset !important; font-size: 2em !important; z-index: 2 !important;
}
.swal2-html-container {
  position: relative !important;
}
.swal2-html-container button:where(.swal2-close) {
  position: absolute !important; top: -2.5rem !important; right: -0.5rem !important; z-index: 10 !important;
}
.swal2-html-container .card-body {
  padding: 0.75rem !important; max-height: none !important; width: 100% !important;
  box-sizing: border-box !important; overflow-x: hidden !important;
}
.swal2-html-container .card {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; margin: 0 0 1rem 0 !important;
}
.swal2-html-container .form-group,
.swal2-html-container .form-row,
.swal2-html-container .row {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
  margin-left: 0 !important; margin-right: 0 !important;
}
.swal2-html-container .form-input,
.swal2-html-container .form-select,
.swal2-html-container .form-textarea,
.swal2-html-container input,
.swal2-html-container select,
.swal2-html-container textarea {
  width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;
}
.swal2-html-container .btn,
.swal2-html-container button {
  max-width: 100% !important; box-sizing: border-box !important; white-space: normal !important;
  word-wrap: break-word !important;
}
.swal2-html-container .task-done-pager .task-done-page-btn,
.swal2-html-container .task-modal-tabs .task-modal-tab {
  width: auto !important; max-width: none !important;
}
.swal2-html-container .task-done-pager .task-done-page-btn {
  display: inline-flex !important; white-space: nowrap !important; flex: 0 0 auto !important;
  padding: 0.3rem 0.5rem !important; font-size: 0.72rem !important; min-width: 28px !important; height: 28px !important; gap: 0.2rem !important;
}
.swal2-html-container .task-done-pager .task-done-page-btn.nav { min-width: auto !important; padding: 0.3rem 0.45rem !important; }
.swal2-html-container .task-done-pager .task-done-page-btn.nav span { display: none !important; }
.swal2-html-container .task-done-pager .pages { flex: 1 !important; min-width: 0 !important; padding: 0 0.25rem !important; justify-content: center !important; gap: 0.2rem !important; }
.swal2-html-container .task-done-pager .pages .task-done-page-btn.page { flex: 1 1 auto !important; max-width: 40px !important; }
.swal2-html-container [class*="grid"], .swal2-html-container [class*="flex"] { max-width: 100% !important; overflow-x: hidden !important; }
.swal2-html-container [style*="grid-template-columns"], .swal2-html-container [style*="display: grid"] { grid-template-columns: 1fr !important; gap: 0.75rem !important; }
.swal2-html-container [style*="display: flex"] { flex-wrap: wrap !important; }
.swal2-html-container > * { max-width: 100% !important; overflow-x: hidden !important; }
#aiKeywordsBtn { white-space: nowrap !important; flex-shrink: 0 !important; padding: 0.5rem 0.75rem !important; font-size: 0.85rem !important; }
#aiKeywordsBtn i { margin-right: 0.25rem !important; }
#taskBudget { font-size: 1.1rem !important; font-weight: 600 !important; padding: 0.75rem 1rem 0.75rem 2.25rem !important; }
.card-body > div[style*="grid-template-columns"], #current-images-container { grid-template-columns: repeat(2, 1fr) !important; gap: 0.75rem !important; }
#cancelPreviousContainer { padding: 1rem !important; margin-bottom: 1rem !important; }
#cancelPreviousContainer label { font-size: 0.85rem !important; line-height: 1.4 !important; }
#previousTasksWarning { font-size: 0.8rem !important; padding: 0.65rem !important; }
.swal2-html-container canvas { max-height: 200px !important; }
.chart-container { height: 250px !important; margin-bottom: 1rem; }
.stat-card .stat-value { font-size: 1.5rem !important; }
.stat-card .stat-label { font-size: 0.75rem !important; }
.card { margin-bottom: 1rem; }
.btn {
  padding: 0.5rem 1rem; font-size: 0.875rem;
}
.btn-sm {
  padding: 0.375rem 0.75rem; font-size: 0.8rem;
}
.table-responsive {
  font-size: 0.8rem;
}
.modal-analytics-grid {
  grid-template-columns: 1fr !important; gap: 1rem !important;
}
.stat-card-grid {
  grid-template-columns: repeat(2, 1fr) !important; gap: 0.5rem !important;
}
.swal2-title {
  font-size: 1.1rem !important; padding: 0.5rem 0 !important;
}
.swal2-actions {
  flex-wrap: wrap !important; gap: 0.5rem !important;
}
.swal2-actions button {
  font-size: 0.85rem !important; padding: 0.5rem 1rem !important; margin: 0 !important;
}
}
@media (max-width: 580px) {
.mobilearticle1 {
  flex-direction: column !important; align-items: flex-start !important; gap: 14px!important;
}
.mobilearticle2{
  align-items: flex-start !important; gap: 14px!important;
}
.domains-usage-container {
  flex-direction: column-reverse !important; gap: 1rem !important;
}
.domain-item {
  padding: 0.875rem !important; gap: 0.75rem !important;
}
.domain-url-row {
  padding-bottom: 0.625rem !important;
}
.domain-url-text {
  font-size: 0.9rem !important;
}
.domain-actions-row {
  display: flex !important; flex-direction: column !important; align-items: stretch !important;
  gap: 0.75rem !important; width: 100% !important;
}
.domain-status-row {
  display: flex !important; flex-direction: row !important; align-items: center !important;
  justify-content: space-between !important; gap: 0.5rem !important; width: 100% !important;
}
.domain-status-badge {
  font-size: 0.75rem !important; padding: 0.35rem 0.65rem !important; flex-shrink: 0 !important;
}
.domain-verify-delete-desktop {
  display: none !important;
}
.domain-status-row .domain-verify-delete {
  display: flex !important; align-items: center !important; gap: 0.4rem !important;
  flex-shrink: 0 !important; margin-left: auto !important;
}
.domain-buttons-row {
  display: flex !important; flex-direction: row !important; align-items: center !important;
  gap: 0.5rem !important; width: 100% !important;
}
.btn-verify-instructions {
  padding: 0.4rem 0.6rem !important; font-size: 0.75rem !important; min-height: 32px !important;
  flex-shrink: 0 !important; flex: 1 !important;
}
.btn-verify-domain {
  padding: 0.4rem 0.6rem !important; font-size: 0.75rem !important; min-height: 32px !important;
  flex-shrink: 0 !important; flex: 1 !important;
}
.btn-delete-domain {
  padding: 0.4rem 0.6rem !important; font-size: 0.75rem !important; min-height: 32px !important;
  flex-shrink: 0 !important;
}
.btn-delete-text {
  display: inline !important;
}
.domain-actions-row .btn i {
  font-size: 0.95rem !important; margin-right: 0.3rem !important;
}
.logo {
  color: white !important;
}
.user-menu-container {
  display: none!important;
}
.usage-category {
  padding: 0.5rem !important; background: var(--bg-secondary) !important;
}
.usage-category i {
  font-size: 1rem !important;
}
}
@media (max-width: 480px) {
.task-creator-sidebar {
  padding: 0.5rem 0.65rem; min-height: auto; max-height: none;
}
.progress-steps {
  padding: 0; gap: 0.35rem;
}
.progress-step {
  padding: 0.45rem 0.2rem; border-radius: 0.55rem; border-width: 1.5px;
}
.step-indicator {
  width: 1.35rem; height: 1.35rem; font-size: 0.6rem; border-width: 1.5px;
}
.step-title {
  font-size: 0.6rem; font-weight: 700;
}
.step-description {
  display: none !important;
}
.task-creator-header {
  padding: 0.65rem 0.75rem; gap: 0.1rem;
}
.task-creator-close {
  position: absolute !important; top: 0.65rem !important; right: 0.65rem !important;
  width: 1.9rem !important; height: 1.9rem !important; font-size: 0.95rem !important;
  z-index: 1010; flex-shrink: 0; display: flex !important; align-items: center !important;
  justify-content: center !important; background: white !important;
  border: 1px solid var(--border) !important; border-radius: 50% !important; box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
.task-creator-title {
  font-size: 0.9rem; font-weight: 700;
}
.task-creator-subtitle {
  font-size: 0.65rem; line-height: 1.3;
}
.task-creator-body {
  padding: 0.65rem; max-height: calc(100vh - 260px);
}
.form-group {
  margin-bottom: 0.65rem;
}
.form-label {
  margin-bottom: 0.35rem !important; font-size: 0.8rem !important; font-weight: 600; line-height: 1.2;
}
.form-input {
  padding: 0.6rem 0.75rem; font-size: 0.8rem; border-radius: 0.6rem;
}
.payment-type-toggle {
  margin-bottom: 0.55rem; display: flex; gap: 0.4rem; padding: 0.25rem;
  background: var(--bg-tertiary); border-radius: 0.6rem;
}
.payment-type-option {
  flex: 1; padding: 0.55rem 0.65rem; font-size: 0.75rem; border-radius: 0.45rem; display: flex;
  align-items: center; justify-content: center; gap: 0.35rem;
}
.payment-type-option i {
  font-size: 0.85rem;
}
.task-creator-footer {
  padding: 0.55rem 0.65rem; gap: 0.55rem;
}
.task-creator-main {
  height: auto; min-height: 0;
}
.footer-info {
  display: none !important;
}
.task-creator-footer button {
  padding: 0.6rem 0.7rem; font-size: 0.75rem; border-radius: 0.55rem; min-height: 38px;
}
.footer-actions {
  gap: 0.65rem; width: 100%;
}
.form-group {
  margin-bottom: 0.6rem;
}
.priority-options {
  gap: 0.6rem; display: flex; flex-direction: column;
}
.priority-option {
  padding: 0.6rem 0.7rem; border-radius: 0.6rem; display: flex; flex-direction: row;
  align-items: center; justify-content: space-between; gap: 0.6rem; transition: all 0.2s ease; min-height: 52px;
}
.priority-option:active {
  transform: scale(0.98);
}
.priority-option .priority-title {
  font-size: 0.8rem; font-weight: 600; line-height: 1.2; margin-bottom: 0.15rem;
}
.priority-option .priority-price {
  font-size: 0.85rem; font-weight: 700; line-height: 1;
}
.priority-option .priority-locations {
  font-size: 0.65rem; line-height: 1.2;
}
.priority-badge {
  font-size: 0.55rem; padding: 0.18rem 0.45rem; position: absolute; top: 0.4rem; right: 0.4rem; line-height: 1;
}
.payment-type-toggle {
  margin-bottom: 1rem;
}
.payment-options {
  gap: 0.6rem; grid-template-columns: 1fr 1fr; margin-bottom: 0.85rem;
}
.payment-card {
  padding: 0.6rem; min-height: 75px; border-radius: 0.65rem; display: flex; flex-direction: column;
  align-items: center; justify-content: center; transition: all 0.2s ease;
}
.payment-card:active {
  transform: scale(0.98);
}
.payment-card .payment-icon {
  font-size: 1.5rem; margin-bottom: 0.3rem;
}
.payment-card .payment-title {
  font-size: 0.75rem; font-weight: 600; line-height: 1.2;
}
.payment-card .payment-description {
  font-size: 0.6rem; margin-top: 0.15rem; opacity: 0.85; line-height: 1.2;
}
.billing-cycle-options {
  gap: 0.45rem; margin-bottom: 0.6rem;
}
.billing-cycle-options .billing-option {
  padding: 0.55rem 0.65rem; border-radius: 0.6rem; gap: 0.5rem; min-height: 48px;
}
.billing-cycle-options .billing-option:active {
  transform: scale(0.98);
}
.billing-cycle-options .billing-option-top {
  gap: 0.5rem;
}
.billing-cycle-options .billing-icon {
  width: 1.85rem; height: 1.85rem; font-size: 0.9rem; border-radius: 0.5rem;
}
.billing-cycle-options .billing-period {
  font-size: 0.8rem !important;
}
.billing-cycle-options .billing-frequency {
  display: none !important;
}
.billing-cycle-options .billing-save {
  font-size: 0.55rem !important; padding: 0.15rem 0.4rem !important; border-radius: 0.3rem;
}
.billing-cycle-options .billing-badge {
  display: none !important;
}
.budget-calculator {
  padding: 0.6rem; border-radius: 0.65rem; margin-bottom: 0.65rem;
}
.budget-field input {
  font-size: 0.9rem; padding: 0.55rem 0.55rem 0.55rem 1.85rem; border-radius: 0.6rem;
}
.budget-field .currency-symbol {
  font-size: 0.9rem; left: 0.6rem; bottom: 0.55rem;
}
.budget-summary {
  padding: 0.55rem; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;
}
.budget-summary-value {
  font-size: 0.7rem;
}
.budget-summary-item {
  padding: 0.5rem;
}
.keyword-suggestion {
  padding: 0.3rem 0.6rem; font-size: 0.7rem; border-radius: 0.5rem;
}
.selected-keywords {
  padding: 0.6rem; margin-bottom: 0.6rem;
}
.keyword-tag {
  padding: 0.275rem 0.45rem; font-size: 0.65rem; border-radius: 0.4rem;
}
.pending-task-alert {
  padding: 0.7rem; margin-bottom: 0.6rem;
}
.pending-task-icon {
  width: 1.75rem; height: 1.75rem; font-size: 0.9rem;
}
.pending-task-title {
  font-size: 0.8rem; line-height: 1.2;
}
.pending-task-actions .btn {
  padding: 0.55rem; font-size: 0.7rem;
}
body, html {
  overflow-x: hidden !important; max-width: 100vw !important;
}
.content, .main-content, .container {
  max-width: 100% !important; overflow-x: hidden !important; box-sizing: border-box !important;
}
.task-card {
  padding: 0.875rem !important; margin: 0 !important;
}
.task-header {
  gap: 0.4rem !important; margin-bottom: 0.625rem !important;
}
.task-url-wrapper {
  max-width: calc(100% - 4.5rem) !important;
}
.task-url {
  font-size: 0.85rem !important;
}
.task-url i {
  font-size: 0.75rem !important;
}
.task-date {
  font-size: 0.65rem !important;
}
.task-status {
  font-size: 0.65rem !important; padding: 0.15rem 0.5rem !important;
}
.task-stats {
  gap: 0.5rem !important; margin: 0.625rem 0 !important;
}
.task-stat-label {
  font-size: 0.65rem !important;
}
.task-stat-value {
  font-size: 0.9rem !important;
}
.task-actions {
  gap: 0.4rem !important; margin-top: 0.625rem !important;
}
.task-actions button {
  padding: 0.5rem 0.875rem !important; font-size: 0.8rem !important;
}
.stats-grid {
  grid-template-columns: repeat(2, 1fr); gap: 0.5rem;
}
.stat-card {
  padding: 0.75rem;
}
.stat-card .stat-value {
  font-size: 1.25rem;
}
.stat-card .stat-label {
  font-size: 0.7rem;
}
.card-header {
  padding: 1rem;
}
.card-body {
  padding: 1rem;
}
.btn {
  padding: 0.5rem 1rem; font-size: 0.8125rem;
}
.table-container {
  font-size: 0.8125rem;
}
th, td {
  padding: 0.5rem;
}
.media-grid {
  grid-template-columns: 1fr;
}
.header {
  position: sticky; top: 0; background: var(--bg-secondary); z-index: 100; border-bottom: 1px solid var(--border);
}
.mobile-nav-item span {
  font-size: 0.625rem;
}
.mobile-nav-item i {
  font-size: 1.125rem;
}
.pagination-info {
  display: none;
}
.user-menu {
  background: transparent; padding: 0.375rem;
}
.user-avatar {
  width: 28px; height: 28px; font-size: 0.875rem;
}
.image-details-modal-container {
  gap: 0.85rem;
}
.image-hero-section {
  gap: 0.75rem; padding-bottom: 0.85rem;
}
.image-hero-preview {
  min-height: 150px; padding: 0.85rem;
}
.image-hero-img {
  max-height: 130px;
}
.image-filename {
  font-size: 0.9rem;
}
.image-meta-row {
  font-size: 0.75rem; gap: 0.35rem 0.65rem;
}
.image-action-btn {
  padding: 0.45rem 0.65rem; font-size: 0.75rem;
}
.image-action-btn span {
  display: none;
}
.image-stats-grid {
  display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch;
  gap: 0.5rem; padding-bottom: 0.5rem; scroll-snap-type: x mandatory;
}
.image-stats-grid::-webkit-scrollbar {
  height: 4px;
}
.image-stats-grid::-webkit-scrollbar-track {
  background: var(--bg-tertiary); border-radius: 2px;
}
.image-stats-grid::-webkit-scrollbar-thumb {
  background: var(--border); border-radius: 2px;
}
.image-stat-card {
  flex: 0 0 auto; padding: 0.65rem 0.5rem; scroll-snap-align: start;
}
.image-stat-card .stat-value {
  font-size: 1.1rem;
}
.image-modal-tabs {
  max-width: 100%;
}
.image-modal-tab {
  font-size: 0.8rem; padding: 0.45rem 0.85rem;
}
.image-chart-card .chart-body {
  height: 140px; padding: 0.5rem;
}
.image-traffic-content {
  grid-template-columns: 1fr;
}
.image-traffic-item {
  padding: 0.45rem 0.6rem;
}
.image-traffic-item .item-name {
  font-size: 0.8rem;
}
.article-modal-stat-grid {
  display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch;
  gap: 0.5rem; padding-bottom: 0.5rem; scroll-snap-type: x mandatory;
}
.article-modal-stat-grid::-webkit-scrollbar {
  height: 4px;
}
.article-modal-stat-grid::-webkit-scrollbar-track {
  background: var(--bg-tertiary); border-radius: 2px;
}
.article-modal-stat-grid::-webkit-scrollbar-thumb {
  background: var(--border); border-radius: 2px;
}
.article-modal-stat-card {
  flex: 0 0 auto; padding: 0.65rem 0.5rem; scroll-snap-align: start;
}
.article-modal-stat-card .stat-value {
  font-size: 1.1rem;
}
.article-modal-stat-card .stat-label {
  font-size: 0.65rem;
}
.article-header-meta {
  gap: 0.5rem; font-size: 0.75rem;
}
.article-image-slider {
  min-height: 140px; padding: 0.5rem; gap: 0.35rem;
}
.article-slider-image {
  max-height: 130px;
}
.article-slider-nav {
  width: 30px !important; height: 30px !important; min-width: 30px !important;
  max-width: 30px !important; font-size: 0.8rem;
}
.article-content-info-card {
  padding: 0.65rem;
}
.article-content-info-card .info-value {
  font-size: 0.95rem;
}
.article-content-body {
  max-height: 240px; font-size: 0.85rem; line-height: 1.7;
}
.swal2-popup.image-article-details-swal {
  padding: 1rem !important;
}
.swal2-popup.image-article-details-swal .swal2-title {
  font-size: 1.1rem !important;
}
.task-done-pager { flex-direction: column; align-items: stretch; }
.task-done-pager .pages { overflow-x: auto; padding-bottom: 0.15rem; -webkit-overflow-scrolling: touch; gap: 0.2rem; }
.task-done-pager .pages .task-done-page-btn.page { flex: 0 0 auto; max-width: none; min-width: 32px; }
.task-done-pager .meta { text-align: center; }
.swal2-popup {
  width: calc(100vw - 0.5rem) !important; max-width: 100vw !important; margin: 0.25rem !important;
  padding: 0.875rem !important; border-radius: 0.875rem !important;
  padding-top: 2.25rem !important; box-sizing: border-box !important;
}
.swal2-icon {
  width: 3rem !important; height: 3rem !important; border-width: 2px !important; margin: 0.5rem auto !important;
}
.swal2-title {
  font-size: 1rem !important; padding: 0 0.5rem !important; line-height: 1.3 !important;
  word-wrap: break-word !important;
}
.swal2-html-container {
  font-size: 0.8125rem !important; padding: 0.5rem !important;
  max-height: calc(95vh - 100px) !important; line-height: 1.5 !important;
}
.swal2-confirm, .swal2-cancel {
  padding: 0.625rem 1rem !important; font-size: 0.875rem !important; width: 100% !important;
  margin: 0.25rem 0 !important;
}
.swal2-actions {
  flex-direction: column !important; width: 100% !important; gap: 0.5rem !important; padding: 0 !important;
}
}
@media (max-width: 400px) {
.task-done-cards { padding: 0.45rem; gap: 0.5rem; border-radius: 8px; };
.task-done-card { padding: 0.6rem 0.55rem; gap: 0.4rem; border-radius: 8px; };
.task-done-card-top, .task-done-card-top .left { gap: 0.28rem; };
.task-done-idx { padding: 0.15rem 0.32rem; font-size: 0.65rem; min-width: 22px; border-radius: 6px; };
.task-done-card .country-badge { padding: 0.12rem 0.32rem; gap: 0.18rem; font-size: 0.65rem; };
.task-done-card .country-badge .country-flag { width: 11px; height: 11px; font-size: 0.65rem; };
.task-done-time { font-size: 0.62rem; }; .task-done-kv { gap: 0.3rem; };
.task-done-kv .label { font-size: 0.62rem; }; .task-done-kv .value { font-size: 0.75rem; };
}
@media (max-width: 550px) {
.task-done-time { display: inline-block; }; .task-done-rawtime { display: none !important; };
.mobile-profile-menu {
  display: flex;
}
.user-menu-container {
  display: none !important;
}
}
@media (max-width: 600px) {
.task-done-cards { padding: 0.6rem; grid-template-columns: 1fr; gap: 0.6rem; border-radius: 10px; }; .task-done-card { padding: 0.7rem 0.65rem; gap: 0.45rem; border-radius: 10px; }; .task-done-card:hover { transform: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }; .task-done-card-top, .task-done-card-top .left { gap: 0.35rem; }; .task-done-card-top .left { min-width: 0; }; .task-done-idx { padding: 0.18rem 0.4rem; font-size: 0.7rem; min-width: 24px; }; .task-done-card .country-badge { padding: 0.15rem 0.4rem; gap: 0.22rem; font-size: 0.7rem; }; .task-done-card .country-badge .country-flag { width: 13px; height: 13px; font-size: 0.72rem; }; .task-done-time { font-size: 0.68rem; }; .task-done-kv { gap: 0.35rem; }; .task-done-kv .label { font-size: 0.66rem; }; .task-done-kv .value { font-size: 0.8rem; };
.stat-card > .stat-icon {
  display: none!important;
}
}
@media (max-width: 980px) {
.task-modal-stat-grid {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}
}
@media (min-width: 550px) {
.swal2-popup.recharge-modal-custom {
  width: 500px !important; ;
}
.hidedesktop{
  display:none!important;
}
.mobile-profile-menu {
  display: none !important;
}
}
@media (min-width: 900px) {
.sessions-modal-custom {
  width: 800px !important; ;
}
}
</style>
</head>
<body data-theme="light">
<div class="dashboard-layout">
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<a href="#" class="logo" onmouseenter="animLogo()" onclick="animLogo()">
    <div class="logo-icon">
        <div class="logo-bar logo-b1"></div>
        <div class="logo-bar logo-b2"></div>
        <div class="logo-bar logo-b3"></div>
    </div>
    SEOTIZE
</a>
</div>
<nav class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">Main</div>
<a href="#" class="nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>SEO Tasks</span>
</a>
</div>
<div class="nav-section">
<div class="nav-section-title">Hosting</div>
<a href="#" class="nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
</div>
<div class="nav-section">
<div class="nav-section-title">Account</div>
<a href="#" class="nav-item" data-page="billing">
<i class="ri-bank-card-line"></i>
<span>Billing</span>
</a>
<!-- Logout moved to user dropdown menu -->
</div>
</nav>
</aside>
<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
<div class="mobile-menu" id="mobileMenu">
<div class="mobile-menu-header">
<div style="display: flex; justify-content: space-between; align-items: center; padding: 0 1rem;">
    <div class="logo">
        <i class="ri-seo-line"></i>
        <span>SEOTIZE</span>
    </div>
    <button onclick="closeMobileMenu()" style="background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">
        <i class="ri-close-line"></i>
    </button>
</div>
</div>
<div class="mobile-menu-content">
    <!-- Profile Section -->
    <div style="padding: 1.5rem 1rem; background: var(--bg-tertiary); border-radius: var(--radius); margin: 0 1rem 1rem 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
            <div class="user-avatar" style="width: 50px; height: 50px; font-size: 1.5rem;">
                <span id="mobileMenuUserInitial">U</span>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 1.125rem; color: var(--text); margin-bottom: 0.25rem;" id="mobileMenuUserName">User</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);" id="mobileMenuUserEmail">user@example.com</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
            <div style="text-align: center;">
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);" id="mobileMenuTaskCount">0</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Tasks</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--secondary);" id="mobileMenuArticleCount">0</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Articles</div>
            </div>
        </div>
    </div>
    <!-- Account Section -->
    <div class="nav-section">
        <div class="nav-section-title">Account</div>
        <a href="#" class="nav-item" onclick="showSessionsModal(); closeMobileMenu();">
            <i class="ri-device-line"></i>
            <span>Active Sessions</span>
            <span class="badge badge-primary" id="sessionCountMobile"></span>
        </a>
        <a href="#" class="nav-item" data-page="profile" onclick="closeMobileMenu()">
            <i class="ri-user-line"></i>
            <span>Profile Settings</span>
        </a>
        <a href="#" class="nav-item" data-page="billing" onclick="closeMobileMenu()">
            <i class="ri-bank-card-line"></i>
            <span>Billing & Plans</span>
        </a>
    </div>
    <div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
    <!-- Logout Section -->
    <div class="nav-section">
        <a href="#" class="nav-item danger" style="color: var(--error);" onclick="logout()">
            <i class="ri-logout-box-line"></i>
            <span>Logout</span>
        </a>
    </div>
</div>
</div>
<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav" id="mobileNav">
<div class="mobile-nav-items">
<a href="#" class="mobile-nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="mobile-nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>Tasks</span>
</a>
<a href="#" class="mobile-nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="mobile-nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
<a href="#" class="mobile-nav-item" data-page="billing">
<i class="ri-bill-line"></i>
<span>Billing</span>
</a>
</div>
</nav>
<!-- Main Content -->
<main class="main-content">
<!-- Header -->
<header class="header">
<div class="header-left">
<a class="logox hidedesktop" onmouseenter="animLogo()" onclick="animLogo()">
    <div class="logo-icon">
        <div class="logo-bar logo-b1"></div>
        <div class="logo-bar logo-b2"></div>
        <div class="logo-bar logo-b3"></div>
    </div>
    SEOTIZE
</a>
</div>
<div class="header-right">
<button class="theme-toggle" onclick="toggleTheme()">
<i class="ri-moon-line" id="themeIcon"></i>
</button>
<!-- Mobile Profile Menu Icon - Google Style -->
<button class="mobile-profile-menu" onclick="toggleMobileProfileDropdown(event)">
<div class="user-avatar" id="mobileUserAvatar">U</div>
</button>
<!-- Mobile Profile Dropdown (Google Style) -->
<div id="mobileProfileDropdown" class="mobile-profile-dropdown">
    <div style="padding: 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="user-avatar" style="width: 48px; height: 48px; font-size: 1.25rem;">
                <span id="mobileDropdownUserInitial">U</span>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text);" id="mobileDropdownUserName">User</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);" id="mobileDropdownUserEmail">user@example.com</div>
            </div>
        </div>
    </div>
    <div style="padding: 0.5rem 0;">
        <a href="#" class="nav-item" onclick="showSessionsModal(); closeMobileProfileDropdown()" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="ri-device-line"></i>
            <span>Active Sessions</span>
            <span class="badge badge-primary" id="mobileDropdownSessionCount" style="margin-left: auto;"></span>
        </a>
        <div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
        <a href="#" class="nav-item" onclick="logout(); closeMobileProfileDropdown()" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--error);">
            <i class="ri-logout-box-line"></i>
            <span>Sign Out</span>
        </a>
    </div>
</div>
<div class="user-menu-container">
<div class="user-menu" onclick="toggleUserDropdown()">
<div class="user-avatar">
<span id="userInitial">U</span>
</div>
<div>
<div style="font-weight: 500;" id="userName">User</div>
<div style="font-size: 0.75rem; color: var(--text-secondary);" id="userEmail">user@example.com</div>
</div>
</div>
<div class="user-dropdown" id="userDropdown">
<a href="#" class="user-dropdown-item" onclick="showSessionsModal()">
<i class="ri-device-line"></i>
<span>Active Sessions</span>
<span class="badge badge-primary" id="sessionCount"></span>
</a>
<div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
<a href="#" class="user-dropdown-item danger" onclick="logout()">
<i class="ri-logout-box-line"></i>
<span>Logout</span>
</a>
</div>
</div>
</div>
</header>
<!-- Mobile Search Overlay -->
<div class="mobile-search-overlay" id="mobileSearchOverlay">
<div style="display: flex; gap: 0.5rem; align-items: center;">
<button onclick="toggleMobileSearch()" style="background: transparent; border: none; color: var(--text); font-size: 1.5rem; padding: 0.5rem;">
<i class="ri-arrow-left-line"></i>
</button>
<input type="text" class="mobile-search-input" placeholder="Search..." autofocus>
</div>
</div>
<!-- Content Area -->
<div class="content" id="content">
<!-- Dynamic content will be loaded here -->
</div>
</main>
</div>
<!-- Modal Container -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle">Modal Title</h3>
<button class="modal-close" onclick="closeModal()">
<i class="ri-close-line"></i>
</button>
</div>
<div class="modal-body" id="modalBody">
<!-- Modal content -->
</div>
</div>
</div>
<!-- SEO Task Creator - New Design -->
<div class="seo-task-creator" id="seoTaskCreator">
    <div class="task-creator-container">
        <!-- Sidebar Progress -->
        <div class="task-creator-sidebar">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-indicator">1</div>
                        <div class="step-info">
                            <div class="step-title">Website</div>
                            <div class="step-description">Set up your website URL and task priority</div>
                        </div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-indicator">2</div>
                    <div class="step-info">
                        <div class="step-title">Keywords</div>
                        <div class="step-description">Choose target keywords for SEO</div>
                    </div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-indicator">3</div>
                    <div class="step-info">
                        <div class="step-title">Payment</div>
                        <div class="step-description">Select payment method and complete</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Main Content Area -->
        <div class="task-creator-main">
            <!-- Header -->
            <div class="task-creator-header">
                <button class="task-creator-close" onclick="closeSeoTaskCreator()">
                    <i class="ri-close-line"></i>
                </button>
                <div class="task-creator-title">Create New SEO Task</div>
                <div class="task-creator-subtitle">Configure your SEO campaign in three simple steps</div>
            </div>
            <!-- Body -->
            <div class="task-creator-body">
                <!-- Pending Task Alert -->
                <div class="pending-task-alert" id="pendingTaskAlert">
                    <div class="pending-task-header">
                        <div class="pending-task-icon">
                            <i class="ri-error-warning-line"></i>
                        </div>
                        <div class="pending-task-info">
                            <div class="pending-task-title">You have a pending payment</div>
                            <div>Complete or cancel your previous task before creating a new one</div>
                        </div>
                    </div>
                    <div class="pending-task-details" id="pendingTaskDetails">
                        <!-- Pending task details will be populated here -->
                    </div>
                    <div class="pending-task-actions">
                        <button class="btn btn-secondary" onclick="cancelPendingTask()">
                            <i class="ri-close-circle-line"></i> Cancel Task
                        </button>
                        <button class="btn btn-primary" onclick="completePendingPayment()">
                            <i class="ri-bank-card-line"></i> Complete Payment
                        </button>
                    </div>
                </div>
                <!-- Step 1: Website & Priority -->
                <div class="step-content active" id="step1">
                    <div class="form-group">
                        <label class="form-label">Website URL</label>
                        <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                            Enter the full URL of your website that you want to optimize
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Task Priority</label>
                        <div class="priority-options">
                            <div class="priority-option" data-priority="basic">
                                <span class="priority-badge">Basic</span>
                                <div class="priority-title">Basic Plan</div>
                                <div class="priority-price">$0.10<small>/click</small></div>
                                <div class="priority-locations">
                                    <i class="ri-map-pin-line"></i> 1 HTML location
                                </div>
                            </div>
                            <div class="priority-option selected" data-priority="standard">
                                <span class="priority-badge">Standard</span>
                                <div class="priority-title">Standard Plan</div>
                                <div class="priority-price">$0.12<small>/click</small></div>
                                <div class="priority-locations">
                                    <i class="ri-map-pin-line"></i> 3 HTML locations
                                </div>
                            </div>
                            <div class="priority-option" data-priority="premium">
                                <span class="priority-badge">Premium</span>
                                <div class="priority-title">Premium Plan</div>
                                <div class="priority-price">$0.15<small>/click</small></div>
                                <div class="priority-locations">
                                    <i class="ri-map-pin-line"></i> 5 HTML locations
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Step 2: Keywords -->
                <div class="step-content" id="step2">
                    <div class="form-group">
                        <label class="form-label">Target Keywords</label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div style="flex: 1; position: relative;">
                                <i class="ri-search-line" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                                <input type="text" class="form-input" id="keywordsInput"
                                       placeholder="Enter keywords separated by commas"
                                       style="padding-left: 2.5rem;"
                                       oninput="handleKeywordInput(this.value)">
                            </div>
                            <button class="btn btn-secondary" id="aiKeywordsBtn" onclick="generateAIKeywords()">
                                <i class="ri-magic-line"></i> AI Suggest
                            </button>
                        </div>
                        <div id="keywordSuggestions" class="keyword-suggestions">
                            <!-- AI suggested keywords will appear here -->
                        </div>
                        <div class="selected-keywords" id="selectedKeywordsSection" style="display: none;">
                            <div class="selected-keywords-header">Selected Keywords</div>
                            <div class="keyword-tags" id="selectedKeywordsDisplay">
                                <!-- Selected keywords will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Step 3: Payment -->
                <div class="step-content" id="step3">
                    <!-- Payment Type Toggle - Now positioned at top with better design -->
                    <div class="payment-type-toggle">
                        <button class="payment-type-option active" data-type="subscription" onclick="selectPaymentType('subscription')">
                            <i class="ri-refresh-line"></i>
                            <span>Subscription</span>
                        </button>
                        <button class="payment-type-option" data-type="one-time" onclick="selectPaymentType('one-time')">
                            <i class="ri-bank-card-line"></i>
                            <span>One-time</span>
                        </button>
                    </div>
                    <!-- Payment Method Selection -->
                    <div class="payment-options">
                        <div class="payment-card selected" data-method="stripe" onclick="selectPaymentMethod('stripe')" style="display: block;">
                            <div class="payment-icon">
                                <i class="ri-bank-card-2-line"></i>
                            </div>
                            <div class="payment-title">Stripe</div>
                            <div class="payment-description">Pay with credit/debit cards</div>
                        </div>
                        <div class="payment-card" data-method="oxapay" onclick="selectPaymentMethod('oxapay')" style="display: none;">
                            <div class="payment-icon">
                                <i class="ri-bit-coin-line"></i>
                            </div>
                            <div class="payment-title">OxaPay</div>
                            <div class="payment-description">Pay with cryptocurrency</div>
                        </div>
                    </div>
                    <!-- Subscription Options (Shown by default since subscription is default) -->
                    <div id="subscriptionOptions" style="display: block;">
                        <div class="form-group">
                            <label class="form-label" style="margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Billing Cycle</label>
                            <div class="billing-cycle-options">
                                <div class="billing-option" data-cycle="monthly" onclick="selectBillingCycle('monthly', this)">
                                    <div class="billing-option-top">
                                        <div class="billing-icon">
                                            <i class="ri-calendar-line"></i>
                                        </div>
                                        <div class="billing-option-header">
                                            <span class="billing-period">Monthly</span>
                                            <span class="billing-frequency">Billed every 30 days</span>
                                        </div>
                                    </div>
                                    <div class="billing-price">Pay monthly</div>
                                    <div class="billing-note">Cancel anytime for full flexibility</div>
                                </div>
                                <div class="billing-option billing-popular selected" data-cycle="quarterly" onclick="selectBillingCycle('quarterly', this)">
                                    <div class="billing-badge">Popular</div>
                                    <div class="billing-option-top">
                                        <div class="billing-icon">
                                            <i class="ri-calendar-check-line"></i>
                                        </div>
                                        <div class="billing-option-header">
                                            <span class="billing-period">Quarterly</span>
                                            <span class="billing-frequency">Billed every 3 months</span>
                                        </div>
                                        <span class="billing-save">Save 10%</span>
                                    </div>
                                    <div class="billing-price">3 months billing</div>
                                    <div class="billing-note">Ideal balance of savings and agility</div>
                                </div>
                                <div class="billing-option" data-cycle="yearly" onclick="selectBillingCycle('yearly', this)">
                                    <div class="billing-badge" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Best Value</div>
                                    <div class="billing-option-top">
                                        <div class="billing-icon">
                                            <i class="ri-calendar-todo-line"></i>
                                        </div>
                                        <div class="billing-option-header">
                                            <span class="billing-period">Yearly</span>
                                            <span class="billing-frequency">Billed every 12 months</span>
                                        </div>
                                        <span class="billing-save">Save 20%</span>
                                    </div>
                                    <div class="billing-price">12 months billing</div>
                                    <div class="billing-note">Maximize savings for long-term growth</div>
                                </div>
                            </div>
                            <select class="form-select" id="billingCycle" style="display: none;">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly" selected>Quarterly (Save 10%)</option>
                                <option value="yearly">Yearly (Save 20%)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Budget Calculator -->
                    <div class="budget-calculator">
                        <div class="budget-input-group">
                            <div class="budget-field">
                                <label>Total Budget</label>
                                <input type="number" id="taskBudget" value="150" min="10" onchange="updateBudgetSummary()">
                                <span class="currency-symbol">$</span>
                            </div>
                            <div class="budget-field">
                                <label>Estimated Clicks</label>
                                <input type="text" id="estimatedClicks" readonly value="1,250">
                                <span class="currency-symbol">
                                    <i class="ri-mouse-line"></i>
                                </span>
                            </div>
                        </div>
                        <div class="budget-summary">
                            <div class="budget-summary-item">
                                <div class="budget-summary-label">Provider Fee</div>
                                <div class="budget-summary-value" id="providerFee">$0.00</div>
                            </div>
                            <div class="budget-summary-item">
                                <div class="budget-summary-label">Platform Fee</div>
                                <div class="budget-summary-value" id="platformFee">$0.00</div>
                            </div>
                            <div class="budget-summary-item">
                                <div class="budget-summary-label">Total Amount</div>
                                <div class="budget-summary-value" id="finalAmount" style="color: var(--success); font-size: 1.25rem;">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="task-creator-footer">
                <div class="footer-info">
                    <i class="ri-lock-password-line"></i>
                    <span>Encrypted & Secure Payment</span>
                </div>
                <div class="footer-actions">
                    <button class="btn-ghost" id="prevStepBtn" onclick="previousStep()" style="display: none;">
                        <i class="ri-arrow-left-line"></i> Previous
                    </button>
                    <button class="btn-primary-gradient" id="nextStepBtn" onclick="nextStep()">
                        Next Step <i class="ri-arrow-right-line"></i>
                    </button>
                    <button class="btn-primary-gradient" id="createTaskBtn" onclick="createSeoTask()" style="display: none;">
                        <i class="ri-check-line"></i> Create Task
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript -->
<script>
// API Configuration
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token') || localStorage.getItem('authToken');
// Add this right after your paginationState object
let paginationHandlers = {};
function callPaginationHandler(handlerId, page) {
    if (paginationHandlers[handlerId]) {
        paginationHandlers[handlerId](page);
    }
}
// Global State
let currentData = {
    user: null,
    tasks: [],
    images: [],
    articles: [],
    domains: [],
    billing: [],
    selectedLocations: [],
    currentStep: 1,
    taskPriority: 'standard',
    selectedKeywords: [],
    usage: null,
    plan: null
};
let charts = {};
let globalMap = null;
let paginationState = {
    tasks: { page: 1, pageSize: 10, total: 0, hasNext: false },
    images: { page: 1, pageSize: 20, total: 0, hasNext: false },
    articles: { page: 1, pageSize: 10, total: 0, hasNext: false },
    billing: { page: 1, pageSize: 10, total: 0, hasNext: false }
};
// Initialize
/**
 * [NEW FUNCTION]
 * Handles the redirect back from a payment provider (Stripe, OxaPay).
 * It checks the URL for 'transaction_status' and 'payment_id'.
 */
function handlePaymentRedirect() {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('transaction_status');
    const paymentId = urlParams.get('payment_id');
    if (status === 'success' && paymentId) {
        // Payment was successful, show the details modal
        // We use a small timeout to let the dashboard load first
        setTimeout(() => {
            viewPaymentDetails(paymentId);
        }, 1000);
        // Clean the URL so the popup doesn't show on every refresh
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (status === 'cancel') {
        // Payment was cancelled
        setTimeout(() => {
            showToast('Your payment was cancelled.', 'warning');
        }, 1000);
        // Clean the URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}
gsap.registerPlugin(TextPlugin);
// --- LOGO ANIMATION FUNCTION ---
function animLogo() {
    gsap.fromTo(".logo-bar",
        { scaleY: 0.3, opacity: 0 },
        {
            scaleY: 1,
            opacity: 1,
            duration: 0.6,
            stagger: 0.15,
            ease: "elastic.out(1, 0.5)",
            overwrite: true
        }
    );
}
// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }
    initializeEventListeners();
    handlePaymentRedirect(); // <-- THIS IS THE NEW LINE YOU ARE ADDING
    loadDashboard();
    initializeTheme();
    // Initialize user info after dashboard loads
    setTimeout(() => {
        updateUserInfo();
        animLogo();
    }, 100);
});
// Event Listeners
function initializeEventListeners() {
    // Desktop navigation
    document.querySelectorAll('.sidebar .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });
    // Mobile navigation
    document.querySelectorAll('.mobile-nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });
    // Mobile menu navigation
    document.querySelectorAll('.mobile-menu .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            closeMobileMenu();
            navigateTo(item.dataset.page);
        });
    });
    // Modal click outside to close
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            closeModal();
        }
    });
    // Close user dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const userMenuContainer = document.querySelector('.user-menu-container');
        const userDropdown = document.getElementById('userDropdown');
        if (!userMenuContainer.contains(e.target)) {
            userDropdown.classList.remove('active');
        }
    });
    // Mobile menu overlay close
    document.getElementById('mobileMenuOverlay')?.addEventListener('click', closeMobileMenu);
}
// Mobile Menu Functions
function openMobileMenu() {
    document.getElementById('mobileMenu').classList.add('active');
    document.getElementById('mobileMenuOverlay').classList.add('active');
}
function closeMobileMenu() {
    document.getElementById('mobileMenu').classList.remove('active');
    document.getElementById('mobileMenuOverlay').classList.remove('active');
}
// New Google-style mobile profile dropdown functions
function toggleMobileProfileDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
        if (dropdown.classList.contains('active')) {
            // Update user info when opening
            const user = currentData.user;
            if (user) {
                const initial = (user.email || 'U').charAt(0).toUpperCase();
                document.getElementById('mobileDropdownUserInitial').textContent = initial;
                // Hide the name element and show only email
                const nameEl = document.getElementById('mobileDropdownUserName');
                if (nameEl) nameEl.style.display = 'none';
                document.getElementById('mobileDropdownUserEmail').textContent = user.email || '';
                // Update session count (include current session)
                const otherSessions = getOtherSessions();
                const sessionCount = otherSessions.length + 1;
                document.getElementById('mobileDropdownSessionCount').textContent = sessionCount;
            }
        }
    }
}
function closeMobileProfileDropdown() {
    const dropdown = document.getElementById('mobileProfileDropdown');
    if (dropdown) {
        dropdown.classList.remove('active');
    }
}
// Mobile Search Functions
function toggleMobileSearch() {
    const overlay = document.getElementById('mobileSearchOverlay');
    overlay.classList.toggle('active');
    if (overlay.classList.contains('active')) {
        overlay.querySelector('input').focus();
    }
}
// User Dropdown Toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}
// Get Other Sessions (excluding current)
function getOtherSessions() {
    const sessions = currentData.user?.sessions || [];
    // Filter out current session token
    return sessions.filter(session => session.token !== sessionToken);
}
// Get Current Session
function getCurrentSession() {
    const sessions = currentData.user?.sessions || [];
    // Find current session token
    return sessions.find(session => session.token === sessionToken);
}
// [NEW] Rebuilt Active Sessions Modal using SweetAlert2
function showSessionsModal() {
    // Close any other open modals first
    document.getElementById('userDropdown').classList.remove('active');
    const otherSessions = getOtherSessions();
    const currentSession = getCurrentSession();
    // Helper to create a single session card
    const createSessionCard = (session, isCurrent = false) => {
        const createdDate = new Date(session.timestamp);
        const expiresDate = new Date(session.expires_at);
        const isExpired = expiresDate < new Date();
        return `
        <div class="session-card ${isCurrent ? 'session-card--current' : ''}">
            <div class="session-icon">
                <i class="ri-computer-line"></i>
            </div>
            <div class="session-details">
                <div class="session-main-info">
                    ${session.country_code} - ${session.ip_address}
                    ${isCurrent ? '<span class="badge badge-success" style="margin-left: 0.5rem;">This Device</span>' : ''}
                    ${isExpired ? '<span class="badge badge-danger" style="margin-left: 0.5rem;">Expired</span>' : ''}
                </div>
                <div class="session-meta-info">
                    <span><strong>Created:</strong> ${createdDate.toLocaleString()}</span>
                    <span><strong>Expires:</strong> ${isExpired ? 'Already Expired' : expiresDate.toLocaleString()}</span>
                </div>
            </div>
            ${!isCurrent ? `
                <div class="session-actions">
                    <button class="btn btn-sm btn-danger" onclick="revokeSession('${session.token}')">Revoke</button>
                </div>
            ` : ''}
        </div>
        `;
    };
    let modalHtml = `
    <div class="sessions-modal-container">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Manage your active login sessions. For security, revoke any sessions you don't recognize.</p>
        ${currentSession ? `
            <h3 class="sessions-section-title"><i class="ri-shield-check-line"></i>Current Session</h3>
            ${createSessionCard(currentSession, true)}
        ` : ''}
        ${otherSessions.length > 0 ? `
            <h3 class="sessions-section-title"><i class="ri-device-line"></i>Other Active Sessions</h3>
            <div>
                ${otherSessions.map(session => createSessionCard(session)).join('')}
            </div>
            <button class="btn btn-danger" onclick="revokeAllSessions()"><i class="ri-logout-box-r-line"></i> Revoke All Other Sessions (${otherSessions.length})</button>
        ` : `
            <div class="empty-state" style="padding: 1rem 0;">
                <div class="empty-state-icon"><i class="ri-shield-star-line"></i></div>
                <div class="empty-state-title" style="font-size: 1.2rem;">You're only logged in here.</div>
                <p class="empty-state-description">No other active sessions were found.</p>
            </div>
        `}
    </div>`;
    Swal.fire({
        title: 'Active Sessions',
        html: modalHtml,
        showConfirmButton: false,
        showCloseButton: true,
        width: '95vw',
        customClass: {
            popup: 'sessions-modal-custom',
            footer: 'swal2-footer',
            closeButton: 'swal2-close'
        }
    });
}
// [NEW] Updated to work with SweetAlert2
async function revokeSession(token) {
    Swal.fire({
        title: 'Revoke this session?',
        text: "The user logged in on that device will be signed out.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        confirmButtonText: 'Yes, revoke it!',
        customClass: { popup: 'swal2-toast' }
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Revoking...',
                didOpen: () => Swal.showLoading(),
                customClass: { popup: 'swal2-toast' }
            });
            try {
                // The API endpoint for revoking a single session is the logout endpoint with that session's token.
                await fetch(`${API_BASE}/logout`, {
                    method: 'GET',
                    headers: { 'Session-Token': token, 'Content-Type': 'application/json' }
                });
                // Update local data
                if (currentData.user && currentData.user.sessions) {
                    currentData.user.sessions = currentData.user.sessions.filter(s => s.token !== token);
                }
                Swal.close(); // Close the "Revoking..." popup
                showToast('Session revoked successfully', 'success');
                showSessionsModal(); // Refresh the main sessions modal
                updateUserInfo(); // Update session count badges
            } catch (error) {
                Swal.fire('Error!', 'Failed to revoke session: ' + error.message, 'error');
            }
        }
    });
}
// [NEW] Updated to work with SweetAlert2
// [NEW] Updated function to revoke sessions one-by-one in a loop
async function revokeAllSessions() {
    // 1. Get all sessions *except* the current one
    const sessionsToRevoke = getOtherSessions();
    const total = sessionsToRevoke.length;
    // 2. If there are no other sessions, just inform the user.
    if (total === 0) {
        Swal.fire({
            title: 'No Other Sessions',
            text: 'You are only logged in on this device.',
            icon: 'info',
            customClass: { popup: 'swal2-toast' }
        });
        return;
    }
    // 3. Ask for confirmation first
    Swal.fire({
        title: `Revoke all ${total} other sessions?`,
        text: "You will be logged out from all other devices immediately.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        confirmButtonText: 'Yes, revoke all!',
        customClass: { popup: 'swal2-toast' }
    }).then(async (result) => {
        // 4. If user confirms, start the loop
        if (result.isConfirmed) {
            // Open the progress modal. We will update this modal's title.
            Swal.fire({
                title: `Revoking 1 of ${total}...`,
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                allowEscapeKey: false,
                customClass: { popup: 'swal2-toast' }
            });
            let successCount = 0;
            let failCount = 0;
            const tokensToRevoke = sessionsToRevoke.map(s => s.token);
            const successfulTokens = [];
            // 5. Loop through each token
            for (let i = 0; i < total; i++) {
                const token = tokensToRevoke[i];
                // Update progress title
                Swal.update({
                    title: `Revoking ${i + 1} of ${total}...`
                });
                try {
                    // Call the single-revoke endpoint (which is /logout with that session's token)
                    // We use fetch directly here since api() helper might not be set up for this
                    await fetch(`${API_BASE}/logout`, {
                        method: 'GET',
                        headers: { 'Session-Token': token, 'Content-Type': 'application/json' }
                    });
                    // If successful:
                    successCount++;
                    successfulTokens.push(token);
                } catch (error) {
                    // If one fails, log it and continue
                    console.error('Failed to revoke session:', token, error);
                    failCount++;
                }
            }
            // 6. Update local data: keep only the current session AND any sessions that failed to revoke
            if (currentData.user && currentData.user.sessions) {
                currentData.user.sessions = currentData.user.sessions.filter(s => {
                    // Keep if it's the current session
                    if (s.token === sessionToken) return true;
                    // Keep if it was *not* in the successfully revoked list
                    if (!successfulTokens.includes(s.token)) return true;
                    // Otherwise, remove it
                    return false;
                });
            }
            // 7. Close the progress modal
            Swal.close();
            // 8. Show final status
            if (failCount === 0) {
                // All succeeded
                showToast(`All ${total} other sessions revoked!`, 'success');
            } else {
                // Some failed
                Swal.fire({
                    title: 'Partial Success',
                    text: `Successfully revoked ${successCount} of ${total} sessions. ${failCount} failed.`,
                    icon: 'warning',
                    customClass: { popup: 'swal2-toast' }
                });
            }
            // 9. Refresh the UI
            showSessionsModal(); // Refresh the main sessions modal
            updateUserInfo(); // Update session count badges
        }
    });
}
// Theme Management
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
    // Refresh charts and map with new theme
    if (charts.traffic) {
        setTimeout(updateCharts, 100);
    }
}
function updateThemeIcon(theme) {
    document.getElementById('themeIcon').className = theme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
}
// Navigation
function navigateTo(page) {
    // Update desktop nav
    document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.sidebar .nav-item[data-page="${page}"]`)?.classList.add('active');
    // Update mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.mobile-nav-item[data-page="${page}"]`)?.classList.add('active');
    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'images': loadImages(); break;
        case 'articles': loadArticles(); break;
        case 'billing': loadBilling(); break;
        case 'profile': loadProfile(); break;
    }
}
// Update User Info
function updateUserInfo() {
    const user = currentData.user;
    if (!user) return;
    const email = user.email;
    const name = email.split('@')[0];
    const initial = email[0].toUpperCase();
    // Update all user display elements
    document.getElementById('userInitial').textContent = initial;
    document.getElementById('userName').textContent = name;
    document.getElementById('userEmail').textContent = email;
    // Update mobile profile avatar
    const mobileAvatar = document.getElementById('mobileUserAvatar');
    if (mobileAvatar) mobileAvatar.textContent = initial;
    // Update mobile menu profile section
    const mobileMenuInitial = document.getElementById('mobileMenuUserInitial');
    if (mobileMenuInitial) mobileMenuInitial.textContent = initial;
    const mobileMenuName = document.getElementById('mobileMenuUserName');
    if (mobileMenuName) mobileMenuName.textContent = name;
    const mobileMenuEmail = document.getElementById('mobileMenuUserEmail');
    if (mobileMenuEmail) mobileMenuEmail.textContent = email;
    // Update mobile menu task and article counts
    const mobileMenuTaskCount = document.getElementById('mobileMenuTaskCount');
    if (mobileMenuTaskCount && currentData.tasks) {
        mobileMenuTaskCount.textContent = currentData.tasks.length;
    }
    const mobileMenuArticleCount = document.getElementById('mobileMenuArticleCount');
    if (mobileMenuArticleCount && currentData.articles) {
        mobileMenuArticleCount.textContent = currentData.articles.length;
    }
    // Update session count (excluding current session)
    const otherSessions = getOtherSessions();
    const totalSessions = otherSessions.length + 1;
    // Update both desktop and mobile session counts
    const desktopCountEl = document.getElementById('sessionCount');
    if (desktopCountEl) desktopCountEl.textContent = totalSessions;
    const mobileCountEl = document.getElementById('sessionCountMobile');
    if (mobileCountEl) mobileCountEl.textContent = totalSessions;
}
// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
        // Check for 401/403 BEFORE parsing JSON
        if (response.status === 401 || response.status === 403) {
            // Clear cookies and redirect to login
            document.cookie = 'session_token=; path=/; Domain=.seotize.net; Secure; SameSite=Lax; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return; // Stop execution
        }
        const data = await response.json();
        if (!response.ok) {
            const apiError = new Error(data.error?.message || data.message || 'API Error');
            apiError.code = data.error?.code || response.status;
            apiError.data = data;
            throw apiError;
        }
        return data;
    } catch (error) {
        console.error('API Error:', error);
        // Only show toast if it's not a 409 error (pending task)
        if (error.code !== 409) {
            showToast(error.message, 'error');
        }
        throw error;
    }
}
// Helper function to format numbers with K/M abbreviations
function formatNumber(num) {
    if (num < 1000) {
        return num.toString();
    } else if (num < 1000000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'k';
    } else if (num < 1000000000) {
        return (num / 1000000).toFixed(1).replace('.0', '') + 'M';
    } else {
        return (num / 1000000000).toFixed(1).replace('.0', '') + 'B';
    }
}
// Toggle collapsible sections (for mobile)
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + 'Icon');
    if (!content) return;
    // Only apply collapse on mobile screens
    if (window.innerWidth <= 768) {
        content.classList.toggle('collapsed');
        if (icon) {
            if (content.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(-90deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }
}
// Dashboard
async function loadDashboard(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.user = user;
        // Update pagination state for dashboard tasks
        paginationState.tasks = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };
        // Sort tasks by date (newest first)
        const sortedTasks = (user.tasks || []).sort((a, b) =>
            new Date(b.date_created) - new Date(a.date_created)
        );
        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userName').textContent = user.email.split('@')[0];
        document.getElementById('userInitial').textContent = user.email[0].toUpperCase();
        updateUserInfo();
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="stats-grid">
        <div class="stat-card">
        <div class="stat-icon primary">
        <i class="ri-task-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_tasks || 0}</div>
        <div class="stat-label">Total Tasks</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon success">
        <i class="ri-eye-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${formatNumber(user.usage_summary?.total_views || 0)}</div>
        <div class="stat-label">Total Views</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon warning">
        <i class="ri-key-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_keywords || 0}</div>
        <div class="stat-label">Keywords</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon error">
        <i class="ri-wallet-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">$${(user.task_statistics?.available_charge || 0).toFixed(2)}</div>
        <div class="stat-label">Available Budget</div>
        </div>
        </div>
        </div>
        <div class="analytics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Task Performance</h3>
        </div>
        <div class="card-body">
        <div class="chart-container" style="height: 280px; position: relative;">
        <canvas id="taskChart"></canvas>
        </div>
        </div>
        </div>
        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Views by Country</h3>
        </div>
        <div class="card-body">
        <div class="map-container" id="countryMap" style="height: 280px;"></div>
        </div>
        </div>
        </div>
        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Recent Tasks</h3>
        <button class="btn btn-primary btn-sm" onclick="navigateTo('tasks')">View All</button>
        </div>
        <div class="card-body">
        <!-- Desktop Table Version -->
        <div class="table-container desktop-only">
        <table>
        <thead>
        <tr>
        <th>URL</th>
        <th>Created</th>
        <th>Keywords</th>
        <th>Views</th>
        <th>Budget Status</th>
        <th>Available</th>
        <th>Status</th>
        <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        ${sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            // Budget calculation with used and remaining display
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);
            // Calculate used amount and display values
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%
            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;
                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }
                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }
            const isVerified = task.verified !== false;
            const statusClass = isVerified ? 'success' : 'warning';
            const statusText = isVerified ? 'Active' : 'Unverified';
            const displayUrl = task.url.replace(/^https?:\/\//, '');
            return `
            <tr>
            <td>
            <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none;">
            ${displayUrl.length > 30 ? displayUrl.substring(0, 30) + '...' : displayUrl}
            </a>
            </td>
            <td style="font-size: 0.875rem; color: var(--text-secondary);">${createdDate}</td>
            <td>
            <span class="badge badge-primary">${task.keywords_count}</span>
            </td>
            <td>
            <span class="badge badge-success">${formatNumber(task.views_count)}</span>
            </td>
            <td>
            <div style="display: flex; flex-direction: column; gap: 0.25rem; min-width: 120px;">
            <div style="font-size: 0.75rem; text-align: center;">
            Used: $${usedAmount.toFixed(2)} ${remainingPercent.toFixed(0)}%
            </div>
            <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
            <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>
            </td>
            <td style="font-weight: 600;">$${availableCharge.toFixed(2)}</td>
            <td>
            <span class="badge badge-${statusClass}">
            ${statusText}
            </span>
            </td>
            <td>
            <button class="btn btn-sm" onclick="viewTaskDetails('${task._id}')" title="View Details">
            <i class="ri-eye-line"></i>
            </button>
            </td>
            </tr>
            `;
        }).join('')}
        </tbody>
        </table>
        </div>
        <!-- Mobile Card Version -->
        <div class="mobile-only">
        ${sortedTasks.length > 0 ? sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            // Same calculation logic as desktop version
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);
            // Calculate used amount and display values - SAME AS DESKTOP
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%
            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;
                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }
                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }
            const isVerified = task.verified !== false;
            const statusClass = isVerified ? 'success' : 'warning';
            const statusText = isVerified ? 'Active' : 'Unverified';
            const displayUrl = task.url.replace(/^https?:\/\//, '');
            return `
            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: var(--transition);" onclick="viewTaskDetails('${task._id}')" ontouchstart="this.style.background='var(--card-hover)'" ontouchend="this.style.background='var(--bg-secondary)'">
                <!-- Header: URL and Status -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; gap: 0.5rem;">
                    <div style="flex: 1; min-width: 0;">
                        <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.35rem; word-break: break-all; line-height: 1.3;" onclick="event.stopPropagation()">
                            ${displayUrl.length > 40 ? displayUrl.substring(0, 40) + '...' : displayUrl} <i class="ri-external-link-line" style="font-size: 0.85rem; opacity: 0.8;"></i>
                        </a>
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            ${createdDate}
                        </div>
                    </div>
                    <span class="badge badge-${statusClass}" style="flex-shrink: 0; font-size: 0.7rem;">
                        ${statusText}
                    </span>
                </div>
                <!-- Stats Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm);flex-direction: column;    align-items: flex-start;gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Keywords:</span>
                        <span class="badge badge-primary" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${task.keywords_count}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Views:</span>
                        <span class="badge badge-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${formatNumber(task.views_count)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Available:</span>
                        <span style="font-weight: 600; font-size: 0.8rem; color: var(--text);">$${availableCharge.toFixed(2)}</span>
                    </div>
                </div>
                <!-- Budget Progress -->
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Budget Remaining</span>
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${remainingPercent.toFixed(0)}% (Used: $${usedAmount.toFixed(2)})</span>
                    </div>
                    <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
                    </div>
                </div>
                <!-- Actions -->
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-eye-line"></i> Details
                    </button>
                    <button class="btn btn-sm btn-recharge-task" onclick="event.stopPropagation(); rechargeTask('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-wallet-line"></i> Recharge
                    </button>
                </div>
            </div>
            `;
        }).join('') : `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="ri-task-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                <p style="margin: 0; font-weight: 500;">No tasks yet</p>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Create your first SEO task</p>
            </div>
        `}
        </div>
        <!-- Fixed pagination with proper structure -->
        <div class="pagination">
        <button class="pagination-btn" ${pagination.current <= 1 ? 'disabled' : ''} onclick="loadDashboard(${pagination.current - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
        </button>
        ${(() => {
            let paginationButtons = '';
            const totalPages = Math.max(1, pagination.pages);
            const currentPage = pagination.current;
            if (totalPages <= 5) {
                // Show all pages if 5 or fewer
                for (let i = 1; i <= totalPages; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }
            } else {
                // Show condensed pagination for more than 5 pages
                if (currentPage > 2) {
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(1)">1</button>`;
                    if (currentPage > 3) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                }
                const startPage = Math.max(1, currentPage - 1);
                const endPage = Math.min(totalPages, currentPage + 1);
                for (let i = startPage; i <= endPage; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }
                if (currentPage < totalPages - 1) {
                    if (currentPage < totalPages - 2) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(${totalPages})">${totalPages}</button>`;
                }
            }
            return paginationButtons;
        })()}
        <button class="pagination-btn" ${!pagination.has_next ? 'disabled' : ''} onclick="loadDashboard(${pagination.current + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
        </button>
        <div class="pagination-info">
        Page ${pagination.current} of ${Math.max(1, pagination.pages)} | Showing ${sortedTasks.length} of ${pagination.total} tasks
        </div>
        </div>
        </div>
        </div>
        `;
        // Initialize charts and map
        setTimeout(() => {
            initializeCharts(user);
            initializeCountryMap(user);
        }, 100);
    } catch (error) {
        console.error('Dashboard error:', error);
        showErrorState('Failed to load dashboard');
        if (error.message === 'Invalid session. Please log in again.') logout();
    }
}
// Tasks
async function loadTasks(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.tasks = user.tasks || [];
        // Ensure pagination state is properly set
        paginationState.tasks = {
            page: pagination.current || 1,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">SEO Tasks</h2>
        <button class="btn btn-primary" onclick="showTaskModal()">
        <i class="ri-add-line"></i> Create New Task
        </button>
        </div>
        <div class="task-grid">
        ${currentData.tasks.map(task => {
            const isVerified = task.verified !== false;
            const statusClass = isVerified ? 'active' : 'unverified';
            const statusText = isVerified ? 'Active' : 'Unverified';
            const cardClass = isVerified ? '' : ' unverified';
            const displayUrl = task.url.replace(/^https?:\/\//, '');
            const createdDate = task.date_created ? new Date(task.date_created).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '';
            return `
            <div class="task-card${cardClass}" onclick="viewTaskDetails('${task._id}')">
            <button class="btn btn-sm btn-danger btn-delete-task-mobile" onclick="event.stopPropagation(); deleteTask('${task._id}')" title="Delete task" aria-label="Delete task">
            <i class="ri-delete-bin-line"></i>
            </button>
            <div class="task-header">
            <div class="task-url-wrapper">
            <a href="${task.url}" target="_blank" class="task-url" onclick="event.stopPropagation()">${displayUrl} <i class="ri-external-link-line"></i></a>
            ${createdDate ? `<div class="task-date">${createdDate}</div>` : ''}
            </div>
            <span class="task-status ${statusClass}">${statusText}</span>
            </div>
            <div class="task-stats">
            <div class="task-stat">
            <div class="task-stat-label">Keywords</div>
            <div class="task-stat-value">${task.keywords_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Views</div>
            <div class="task-stat-value">${task.views_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Budget Used</div>
            <div class="task-stat-value">$${(task.total_charge - task.available_charge).toFixed(2)}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Available</div>
            <div class="task-stat-value">$${task.available_charge.toFixed(2)}</div>
            </div>
            </div>
            <div class="task-progress">
            <div class="progress-bar">
            <div class="progress-fill" style="width: ${task.remaining_percentage}%; background: ${task.remaining_percentage >= 100 ? '#8b5cf6' : task.remaining_percentage >= 10 ? '#10b981' : '#ef4444'}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>
            <div class="task-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')">
            <i class="ri-eye-line"></i> Details
            </button>
            <button class="btn btn-sm btn-recharge-task" onclick="event.stopPropagation(); rechargeTask('${task._id}')">
            <i class="ri-wallet-line"></i> Recharge
            </button>
            </div>
            <div class="task-actions task-actions-secondary ${isVerified ? 'task-actions-delete-only' : ''}" style="margin-top: 8px;">
            <button class="btn btn-sm btn-danger btn-delete-task-desktop" onclick="event.stopPropagation(); deleteTask('${task._id}')" style="background: var(--danger); color: white;">
            <i class="ri-delete-bin-line"></i> Delete
            </button>
            ${!isVerified ? `
            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); verifyTask('${task._id}')" style="background: var(--warning); color: white;">
            <i class="ri-shield-check-line"></i> Verify Task
            </button>
            ` : ''}
            </div>
            </div>
            `;
        }).join('')}
            </div>
            ${currentData.tasks.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-task-line"></i>
                </div>
                <div class="empty-state-title">No Tasks Yet</div>
                <div class="empty-state-description">Create your first SEO task to start optimizing your website</div>
                <button class="btn btn-primary" onclick="showTaskModal()">Create First Task</button>
                </div>
                ` : generatePagination('tasks', loadTasks)}
                `;
    } catch (error) {
        console.error('Tasks error:', error);
        showErrorState('Failed to load tasks');
    }
}
// Images
async function loadImages(page = 1) {
    try {
        showSpinner();
        const response = await api(`/images/dashboard?page=${page}&page_size=20`);
        const { data, pagination } = response;
        currentData.images = data.images || [];
        paginationState.images = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">Image Hosting</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
        ${data.user?.uploaded || 0}/${(data.user?.uploaded || 0) + (data.user?.remaining || 0)} images used
        </div>
        <button class="btn btn-primary" onclick="showImageUploadModal()">
        <i class="ri-upload-line"></i> Upload Images
        </button>
        </div>
        </div>
        <div class="media-grid">
        ${currentData.images.map(image => `
    <div class="media-card">
        <div class="media-preview" onclick="window.open('${image.cdn_url}', '_blank')" style="cursor: pointer;" title="Click to open full image">
            <img src="${image.cdn_url}" alt="${image.original_filename}" loading="lazy">
        </div>
        <div class="media-info">
            <div class="media-filename">${image.original_filename}</div>
            <div class="media-stats">
                <span>${image.total_views} views</span>
                <span>${new Date(image.upload_date).toLocaleDateString()}</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                <button class="btn btn-sm" onclick="showImageDetails('${image.image_id}')">
                    <i class="ri-eye-line"></i> Details
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.image_id}')">
                    <i class="ri-delete-bin-line"></i> Delete
                </button>
            </div>
        </div>
    </div>
        `).join('')}
        </div>
            ${currentData.images.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-image-line"></i>
                </div>
                <div class="empty-state-title">No Images Uploaded</div>
                <div class="empty-state-description">Upload images to host them on our CDN with analytics</div>
                <button class="btn btn-primary" onclick="showImageUploadModal()">Upload First Image</button>
                </div>
                ` : ''}
                ${paginationState.images.total > paginationState.images.pageSize ? generatePagination('images', loadImages) : ''}
                `;
    } catch (error) {
        console.error('Images error:', error);
        showErrorState('Failed to load images');
    }
}
// Articles with Domains
// Articles with Domains
async function loadArticles(page = 1) {
    try {
        showSpinner();
        // Single API call gets both articles and domains
        const response = await api(`/dashboard/articles?page=${page}&page_size=10`);
        const { data, pagination } = response;
        // Extract articles and domains from the response
        currentData.articles = data.articles || [];
        currentData.domains = data.user?.domains || [];
        // Extract usage and plan data
        currentData.usage = data.user?.usage || null;
        currentData.plan = data.user?.plan || 'N/A';
        // Update pagination state
        paginationState.articles = {
            page: pagination.current || page,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Articles & Domains</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" id="addDomainBtn">
                    <i class="ri-global-line"></i> Add Domain
                </button>
                <button class="btn btn-primary" id="createArticleBtn">
                    <i class="ri-add-line"></i> Create Article
                </button>
            </div>
        </div>
                <div class="domains-usage-container" style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="card" style="flex: 1; min-width: 0;">
                <div class="card-header collapsible-header" onclick="toggleSection('domainsContent')" style="cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ri-arrow-down-s-line" id="domainsContentIcon" style="transition: transform 0.3s ease; display: none;"></i>
                        <h3 class="card-title">Domain Verification</h3>
                    </div>
                    <span class="badge badge-primary">${currentData.domains.length} domains</span>
                </div>
                <div class="card-body collapsible-content" id="domainsContent">
                    ${currentData.domains.length > 0 ? currentData.domains.map(domain => `
                        <div class="mobilearticle1 domain-item">
                            <div class="domain-url-row">
                                <span class="domain-url-text">${domain.domain}</span>
                            </div>
                            <div class="domain-actions-row">
                                <div class="domain-status-row">
                                    <span class="badge badge-${domain.verified ? 'success' : 'warning'} domain-status-badge">
                                        ${domain.verified ? '&#10003; Verified' : '&#9203; Pending'}
                                    </span>
                                    <div class="domain-verify-delete">
                                        <button class="btn btn-sm btn-danger btn-delete-domain" data-domain="${domain.domain}">
                                            <i class="ri-delete-bin-line"></i> <span class="btn-delete-text">Delete</span>
                                        </button>
                                    </div>
                                </div>
                                ${!domain.verified ? `
                                <div class="domain-buttons-row">
                                    <button class="btn btn-sm btn-secondary btn-verify-instructions" data-domain="${domain.domain}" data-txt="${domain.txt_record || ''}">
                                        <i class="ri-information-line"></i> DNS Setup
                                    </button>
                                    <button class="btn btn-sm btn-primary btn-verify-domain" data-domain="${domain.domain}">
                                        <i class="ri-checkbox-circle-line"></i> Verify Now
                                    </button>
                                </div>
                                ` : `
                                <div class="domain-buttons-row">
                                    <button class="btn btn-sm btn-secondary btn-install-instructions" data-domain="${domain.domain}">
                                        <i class="ri-code-s-slash-line"></i> Install Instructions
                                    </button>
                                </div>
                                `}
                                <div class="domain-verify-delete domain-verify-delete-desktop">
                                    <button class="btn btn-sm btn-danger btn-delete-domain" data-domain="${domain.domain}">
                                        <i class="ri-delete-bin-line"></i> <span class="btn-delete-text">Delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            No domains added yet. Add a domain to start publishing articles.
                        </div>
                    `}
                </div>
            </div>
                        <div class="card" style="flex: 0 0 380px; min-width: 0;">
                <div class="card-header collapsible-header" onclick="toggleSection('usageContent')" style="cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ri-arrow-down-s-line" id="usageContentIcon" style="transition: transform 0.3s ease; display: none;"></i>
                        <h3 class="card-title">Usage Plan</h3>
                    </div>
                    <span class="badge badge-info" style="text-transform: uppercase;">${currentData.plan || 'N/A'}</span>
                </div>
                <div class="card-body collapsible-content" id="usageContent">
                    <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                        ${currentData.usage && (currentData.usage.ai || currentData.usage.articles || currentData.usage.images) ? `
                                                ${currentData.usage.ai ? `
                            <div class="usage-category">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ri-robot-line" style="color: var(--primary); font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text);">AI Generations</span>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600;">${currentData.usage.ai.percentage}%</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div style="height: 100%; width: ${currentData.usage.ai.percentage}%; transition: width 0.3s ease, background-color 0.3s ease; background: ${currentData.usage.ai.percentage >= 100 ? '#8b5cf6' : currentData.usage.ai.percentage >= 10 ? '#10b981' : '#ef4444'};"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                                    <span><strong>${currentData.usage.ai.used}</strong> used</span>
                                    <span><strong>${currentData.usage.ai.remaining}</strong> remaining / <strong>${currentData.usage.ai.limit}</strong> total</span>
                                </div>
                            </div>
                            ` : ''}
                                                ${currentData.usage.articles ? `
                            <div class="usage-category">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ri-article-line" style="color: var(--success); font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text);">Articles</span>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600;">${currentData.usage.articles.percentage}%</span>
                                </div>
                                <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div class="progress-fill" style="height: 100%; width: ${currentData.usage.articles.percentage}%; transition: width 0.3s ease, background-color 0.3s ease; background: ${currentData.usage.articles.percentage >= 100 ? '#8b5cf6' : currentData.usage.articles.percentage >= 10 ? '#10b981' : '#ef4444'};"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                                    <span><strong>${currentData.usage.articles.used}</strong> used</span>
                                    <span><strong>${currentData.usage.articles.remaining}</strong> remaining / <strong>${currentData.usage.articles.limit}</strong> total</span>
                                </div>
                            </div>
                            ` : ''}
                                                ${currentData.usage.images ? `
                            <div class="usage-category">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ri-image-line" style="color: var(--warning); font-size: 1.1rem;"></i>
                                        <span style="font-weight: 600; color: var(--text);">Images</span>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600;">${currentData.usage.images.percentage}%</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div style="height: 100%; width: ${currentData.usage.images.percentage}%; transition: width 0.3s ease, background-color 0.3s ease; background: ${currentData.usage.images.percentage >= 100 ? '#8b5cf6' : currentData.usage.images.percentage >= 10 ? '#10b981' : '#ef4444'};"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                                    <span><strong>${currentData.usage.images.used}</strong> used</span>
                                    <span><strong>${currentData.usage.images.remaining}</strong> remaining / <strong>${currentData.usage.images.limit}</strong> total</span>
                                </div>
                            </div>
                            ` : ''}
                        ` : `
                            <div style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">
                                <i class="ri-information-line" style="font-size: 2rem; opacity: 0.5; margin-bottom: 0.5rem;"></i>
                                <p>No usage data available</p>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
                <div class="card">
            <div class="card-header">
                <h3 class="card-title">Published Articles</h3>
                <span class="badge badge-primary">${paginationState.articles.total} articles</span>
            </div>
            <div class="card-body">
                            <div class="table-container desktop-only">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Domain</th>
                                <th>Published</th>
                                <th>Views</th>
                                <th>Images</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentData.articles.map(article => `
                                <tr>
                                    <td>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${article.subject}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${article.article_id}</div>
                                    </td>
                                    <td>
                                        <a href="https://${article.url}" target="_blank" class="badge badge-primary" style="text-decoration: none;">
                                            ${article.url}
                                        </a>
                                    </td>
                                    <td style="font-size: 0.875rem; color: var(--text-secondary);">
                                        ${new Date(article.creation_date).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </td>
                                    <td>
                                        <span class="badge badge-success">${article.total_views || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-warning">${(article.images || []).length}</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="btn btn-sm btn-view-article" data-article-id="${article.article_id}" title="View Details">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-edit-article" data-article-id="${article.article_id}" title="Edit">
                                                <i class="ri-edit-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-view-live" data-url="${article.url}" title="View Live">
                                                <i class="ri-external-link-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger btn-delete-article" data-article-id="${article.article_id}" title="Delete">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                                <div class="mobile-only">
                    ${currentData.articles.length > 0 ? currentData.articles.map(article => {
                        const publishedDate = new Date(article.creation_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: new Date(article.creation_date).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                        });
                        return `
                        <div class="mobile-article-card" data-article-id="${article.article_id}" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: var(--transition);">
                                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; line-height: 1.3; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${article.subject}</h4>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <a href="https://${article.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 0.85rem; font-weight: 500;" onclick="event.stopPropagation()">
                                            <i class="ri-global-line" style="font-size: 0.8rem;"></i> ${article.url}
                                        </a>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                        Published ${publishedDate}
                                    </div>
                                </div>
                            </div>
                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Views:</span>
                                    <span class="badge badge-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${formatNumber(article.total_views || 0)}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Images:</span>
                                    <span class="badge badge-warning" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${(article.images || []).length}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">ID:</span>
                                    <code style="font-size: 0.65rem; background: var(--bg); padding: 0.2rem 0.4rem; border-radius: 3px;">${article.article_id.substring(0, 8)}...</code>
                                </div>
                            </div>
                                                        <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-view-article-mobile" data-article-id="${article.article_id}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-eye-line"></i> Details
                                </button>
                                <button class="btn btn-sm btn-edit-article-mobile" data-article-id="${article.article_id}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-edit-line"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-view-live-mobile" data-url="${article.url}" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="ri-external-link-line"></i> Live
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete-article-mobile" data-article-id="${article.article_id}" style="padding: 0.4rem 0.6rem; font-size: 0.75rem;">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('') : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="ri-article-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-weight: 500;">No articles published</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Create your first article to start publishing content</p>
                        </div>
                    `}
                </div>
                ${currentData.articles.length === 0 ? `
                <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="ri-article-line"></i>
                        </div>
                        <div class="empty-state-title">No Articles Published</div>
                        <div class="empty-state-description">Create your first article to start publishing content</div>
                        <button class="btn btn-primary" id="emptyStateCreateBtn">Create First Article</button>
                    </div>
                ` : generatePagination('articles', loadArticles)}
            </div>
        </div>
        `;
        // Add event listeners after DOM is updated
        document.getElementById('addDomainBtn')?.addEventListener('click', showDomainModal);
        document.getElementById('createArticleBtn')?.addEventListener('click', () => showArticleModal());
        document.getElementById('emptyStateCreateBtn')?.addEventListener('click', () => showArticleModal());
        // Domain action buttons
        document.querySelectorAll('.btn-verify-instructions').forEach(btn => {
            btn.addEventListener('click', () => {
                showVerificationInstructions(btn.dataset.domain, btn.dataset.txt);
            });
        });
        document.querySelectorAll('.btn-install-instructions').forEach(btn => {
            btn.addEventListener('click', () => {
                showInstallInstructions(btn.dataset.domain);
            });
        });
        document.querySelectorAll('.btn-verify-domain').forEach(btn => {
            btn.addEventListener('click', () => verifyDomain(btn.dataset.domain));
        });
        document.querySelectorAll('.btn-delete-domain').forEach(btn => {
            btn.addEventListener('click', () => confirmDeleteDomain(btn.dataset.domain));
        });
        // Article action buttons - Desktop
        document.querySelectorAll('.btn-view-article').forEach(btn => {
            btn.addEventListener('click', () => viewArticle(btn.dataset.articleId));
        });
        document.querySelectorAll('.btn-edit-article').forEach(btn => {
            btn.addEventListener('click', () => showArticleModal(btn.dataset.articleId));
        });
        document.querySelectorAll('.btn-view-live').forEach(btn => {
            btn.addEventListener('click', () => window.open(`https://${btn.dataset.url}`, '_blank'));
        });
        document.querySelectorAll('.btn-delete-article').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                    deleteArticle(btn.dataset.articleId);
                }
            });
        });
        // Article action buttons - Mobile
        document.querySelectorAll('.mobile-article-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('button') && !e.target.closest('a')) {
                    viewArticle(card.dataset.articleId);
                }
            });
        });
        document.querySelectorAll('.btn-view-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                viewArticle(btn.dataset.articleId);
            });
        });
        document.querySelectorAll('.btn-edit-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showArticleModal(btn.dataset.articleId);
            });
        });
        document.querySelectorAll('.btn-view-live-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                window.open(`https://${btn.dataset.url}`, '_blank');
            });
        });
        document.querySelectorAll('.btn-delete-article-mobile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                    deleteArticle(btn.dataset.articleId);
                }
            });
        });
    } catch (error) {
        console.error('Articles error:', error);
        showErrorState('Failed to load articles and domains');
    }
}
// Package Purchase Modal State
const packagePurchaseState = {
    selectedPackage: 'professional',
    paymentType: 'subscription',
    paymentProvider: 'stripe',
    duration: '3month'
};

// Hosting Packages Configuration
const hostingPackages = {
    basic: {
        name: 'Basic',
        icon: 'ri-seedling-line',
        color: '#10b981',
        gradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
        price: { '3month': 10, '6month': 18, '12month': 32 },
        limits: { articles: 200, images: 1000 },
        features: ['1,000 Image Uploads', '200 Article Uploads', 'Email Support', 'Basic Analytics']
    },
    professional: {
        name: 'Professional',
        icon: 'ri-rocket-line',
        color: '#6366f1',
        gradient: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
        popular: true,
        price: { '3month': 25, '6month': 45, '12month': 80 },
        limits: { articles: 600, images: 4000 },
        features: ['4,000 Image Uploads', '600 Article Uploads', 'Priority Support', 'Advanced Analytics', 'API Access']
    },
    enterprise: {
        name: 'Enterprise',
        icon: 'ri-building-line',
        color: '#f59e0b',
        gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
        price: { '3month': 50, '6month': 90, '12month': 160 },
        limits: { articles: 2000, images: 20000 },
        features: ['20,000 Image Uploads', '2,000 Article Uploads', 'Dedicated Support', 'White-label Options', 'Custom Integrations', 'SLA Guarantee']
    }
};

// Duration Labels
const durationLabels = {
    '3month': { label: '3 Months', months: 3, discount: 0 },
    '6month': { label: '6 Months', months: 6, discount: 10 },
    '12month': { label: '12 Months', months: 12, discount: 20 }
};

// Open Package Purchase Modal
function openPackagePurchaseModal() {
    const modal = document.getElementById('packagePurchaseModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        updatePackagePurchaseUI();
    }
}

// Close Package Purchase Modal
function closePackagePurchaseModal() {
    const modal = document.getElementById('packagePurchaseModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Select Package in Purchase Modal
function selectPackageOption(packageName) {
    packagePurchaseState.selectedPackage = packageName;
    document.querySelectorAll('.pkg-option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.package === packageName);
    });
    updatePackagePurchaseUI();
}

// Select Payment Type
function selectPackagePaymentType(type) {
    packagePurchaseState.paymentType = type;
    document.querySelectorAll('.pkg-payment-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
    
    // Show/hide provider options based on type
    const stripeOption = document.querySelector('.pkg-provider-option[data-provider="stripe"]');
    const oxapayOption = document.querySelector('.pkg-provider-option[data-provider="oxapay"]');
    
    if (type === 'subscription') {
        // Subscription only supports Stripe
        if (oxapayOption) oxapayOption.style.display = 'none';
        if (stripeOption) stripeOption.style.display = 'flex';
        packagePurchaseState.paymentProvider = 'stripe';
        document.querySelectorAll('.pkg-provider-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.provider === 'stripe');
        });
    } else {
        // One-time supports both
        if (oxapayOption) oxapayOption.style.display = 'flex';
        if (stripeOption) stripeOption.style.display = 'flex';
    }
    
    updatePackagePurchaseUI();
}

// Select Payment Provider
function selectPackageProvider(provider) {
    packagePurchaseState.paymentProvider = provider;
    document.querySelectorAll('.pkg-provider-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.provider === provider);
    });
    updatePackagePurchaseUI();
}

// Select Duration
function selectPackageDuration(duration) {
    packagePurchaseState.duration = duration;
    document.querySelectorAll('.pkg-duration-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.duration === duration);
    });
    updatePackagePurchaseUI();
}

// Update Package Purchase UI
function updatePackagePurchaseUI() {
    const pkg = hostingPackages[packagePurchaseState.selectedPackage];
    const duration = durationLabels[packagePurchaseState.duration];
    const basePrice = pkg.price[packagePurchaseState.duration];
    
    // Calculate per month price
    const perMonth = (basePrice / duration.months).toFixed(2);
    
    // Update summary
    const summaryEl = document.getElementById('pkgPurchaseSummary');
    if (summaryEl) {
        summaryEl.innerHTML = `
            <div class="pkg-summary-row">
                <span>Package</span>
                <span class="pkg-summary-value">${pkg.name}</span>
            </div>
            <div class="pkg-summary-row">
                <span>Duration</span>
                <span class="pkg-summary-value">${duration.label}</span>
            </div>
            <div class="pkg-summary-row">
                <span>Payment Type</span>
                <span class="pkg-summary-value">${packagePurchaseState.paymentType === 'subscription' ? 'Subscription' : 'One-time'}</span>
            </div>
            <div class="pkg-summary-row">
                <span>Provider</span>
                <span class="pkg-summary-value">${packagePurchaseState.paymentProvider === 'stripe' ? 'Card (Stripe)' : 'Crypto (OxaPay)'}</span>
            </div>
            ${duration.discount > 0 ? `
            <div class="pkg-summary-row pkg-discount">
                <span>Discount</span>
                <span class="pkg-summary-value">-${duration.discount}%</span>
            </div>
            ` : ''}
            <div class="pkg-summary-divider"></div>
            <div class="pkg-summary-row pkg-total">
                <span>Total</span>
                <span class="pkg-summary-value">$${basePrice.toFixed(2)}</span>
            </div>
            <div class="pkg-summary-row pkg-permonth">
                <span></span>
                <span>$${perMonth}/month</span>
            </div>
        `;
    }
    
    // Update purchase button
    const purchaseBtn = document.getElementById('pkgPurchaseBtn');
    if (purchaseBtn) {
        purchaseBtn.innerHTML = `<i class="ri-shopping-cart-2-line"></i> Purchase ${pkg.name} - $${basePrice.toFixed(2)}`;
    }
}

// Process Package Purchase
async function processPackagePurchase() {
    const pkg = hostingPackages[packagePurchaseState.selectedPackage];
    const currentPlan = window.currentPlanData;
    
    // Check if user has active plan
    if (currentPlan && currentPlan.current_plan && currentPlan.current_plan !== 'free') {
        const result = await Swal.fire({
            title: 'Active Plan Detected',
            html: `
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    You currently have an active <strong>${hostingPackages[currentPlan.current_plan]?.name || currentPlan.current_plan}</strong> plan.
                </p>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">
                    Would you like to cancel your current plan and purchase the new one?
                </p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: 'var(--primary)',
            cancelButtonColor: 'var(--bg-tertiary)',
            confirmButtonText: 'Yes, Replace Plan',
            cancelButtonText: 'Keep Current Plan',
            customClass: { popup: 'swal2-toast' }
        });
        
        if (!result.isConfirmed) return;
    }
    
    // Show loading
    Swal.fire({
        title: 'Processing...',
        html: 'Preparing your payment...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
        customClass: { popup: 'swal2-toast' }
    });
    
    try {
        const response = await api('/hosting/buy-package', {
            method: 'POST',
            body: JSON.stringify({
                package: packagePurchaseState.selectedPackage,
                provider: packagePurchaseState.paymentProvider,
                duration: packagePurchaseState.duration,
                subscription: packagePurchaseState.paymentType === 'subscription',
                cancel_previous: true,
                cancel_current_plan: true
            })
        });
        
        Swal.close();
        
        if (response.data?.payment_url) {
            closePackagePurchaseModal();
            window.open(response.data.payment_url, '_blank');
            
            Swal.fire({
                icon: 'info',
                title: 'Payment Page Opened',
                html: 'Complete your payment in the new tab. This page will refresh when you return.',
                confirmButtonText: 'I\'ve Completed Payment',
                customClass: { popup: 'swal2-toast' }
            }).then(() => {
                loadBilling();
            });
        } else if (response.data?.message) {
            // Handle pending payment message
            Swal.fire({
                icon: 'info',
                title: 'Pending Payment',
                html: response.data.message,
                showCancelButton: true,
                confirmButtonText: 'Go to Payment',
                cancelButtonText: 'Cancel',
                customClass: { popup: 'swal2-toast' }
            }).then((result) => {
                if (result.isConfirmed && response.data.payment_url) {
                    window.open(response.data.payment_url, '_blank');
                }
            });
        }
    } catch (error) {
        console.error('Purchase error:', error);
        
        // Handle specific error cases
        if (error.code === 409) {
            // Active subscription or plan conflict
            Swal.fire({
                icon: 'warning',
                title: 'Plan Conflict',
                html: error.message || 'You have an active plan. Please cancel it first or enable replacement.',
                customClass: { popup: 'swal2-toast' }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Purchase Failed',
                text: error.message || 'Failed to process purchase. Please try again.',
                customClass: { popup: 'swal2-toast' }
            });
        }
    }
}

// Upgraded Billing Function with Modern Design
async function loadBilling(page = 1, type = 'all') {
    try {
        showSpinner();
        // Single API call for all billing data
        const billingResponse = await api(`/dashboard/billings?page=${page}&limit=10&type=${type}`);
        const billingData = billingResponse.data;
        
        // Store billing data for global access
        window.currentBillingData = billingData;
        
        // --- 1. Extract subscription and usage data ---
        const subscriptions = billingData.subscription || [];
        const hostingSubscription = subscriptions.find(s => s.type === 'hosting');
        const taskSubscriptions = subscriptions.filter(s => s.type === 'task');
        const usage = billingData.usage || {};
        
        // Determine current plan from hosting subscription or payments
        const hostingPayments = billingData.hosting || [];
        const latestHostingPayment = hostingPayments.find(h => h.status?.toLowerCase() === 'paid');
        
        // Build plan data from billing response
        const planName = hostingSubscription?.description?.toLowerCase()?.replace(' package', '') || 
                        latestHostingPayment?.description?.toLowerCase()?.replace(' package', '') || 'free';
        const isSubscribed = !!hostingSubscription;
        const isFree = !hostingSubscription && !latestHostingPayment;
        
        // Calculate days left and expiry info from subscription
        let daysLeft = 0;
        let expiryDate = null;
        let subscriptionEnd = null;
        if (hostingSubscription?.next_billing_date) {
            subscriptionEnd = new Date(hostingSubscription.next_billing_date);
            expiryDate = subscriptionEnd;
            const now = new Date();
            daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            if (daysLeft < 0) daysLeft = 0;
        }
        
        // Usage data from API
        const imagesUsed = usage.images?.used || 0;
        const imagesLimit = usage.images?.limit || 0;
        const imagesRemaining = usage.images?.remaining || 0;
        const articlesUsed = usage.articles?.used || 0;
        const articlesLimit = usage.articles?.limit || 0;
        const articlesRemaining = usage.articles?.remaining || 0;
        const aiUsed = usage.ai?.used || 0;
        const aiLimit = usage.ai?.limit || 0;
        const aiRemaining = usage.ai?.remaining || 0;
        
        // Calculate percentages (used percentage, not remaining)
        const imagesUsedPercent = imagesLimit > 0 ? Math.min((imagesUsed / imagesLimit) * 100, 100) : 0;
        const articlesUsedPercent = articlesLimit > 0 ? Math.min((articlesUsed / articlesLimit) * 100, 100) : 0;
        const aiUsedPercent = aiLimit > 0 ? Math.min((aiUsed / aiLimit) * 100, 100) : 0;
        
        // Store plan data for showSubscriptionModal
        window.currentPlanData = {
            current_plan: planName,
            is_subscription: isSubscribed,
            expiry_date: expiryDate,
            subscription_period_end: subscriptionEnd,
            images_limit: imagesLimit,
            images_uploads: imagesUsed,
            articles_limit: articlesLimit,
            article_uploads: articlesUsed,
            ai_limit: aiLimit,
            ai_used: aiUsed,
            billing: {
                last_payment_amount: hostingSubscription?.amount || latestHostingPayment?.amount || 0,
                provider: 'stripe',
                currency: hostingSubscription?.currency || latestHostingPayment?.currency || 'usd'
            },
            hostingSubscription: hostingSubscription,
            taskSubscriptions: taskSubscriptions
        };
        
        // --- 2. Transaction History Data ---
        const taskPayments = billingData.tasks || [];
        const allPayments = [...hostingPayments, ...taskPayments].sort((a, b) => 
            new Date(b.date || 0) - new Date(a.date || 0)
        );
        
        paginationState.billing = {
            page: billingData.pagination?.page || 1,
            pageSize: billingData.pagination?.limit || 10,
            total: billingData.pagination?.total || 0,
            hasNext: (billingData.pagination?.page || 1) < (billingData.pagination?.pages || 1)
        };
        
        // Get last payment amount
        const lastPayment = hostingSubscription?.amount || latestHostingPayment?.amount || 0;
        
        // Get current package info
        const currentPkg = hostingPackages[planName] || null;
        
        // --- 3. Render everything together ---
        const content = document.getElementById('content');
        content.innerHTML = `
        <style>
            /* ========================================
               BILLING & PLANS PAGE STYLES
               ======================================== */
            
            /* Page Header */
            .billing-header {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
            }
            .billing-header-left h1 {
                font-size: 1.75rem; font-weight: 800; color: var(--text);
                display: flex; align-items: center; gap: 0.75rem; margin: 0 0 0.25rem 0;
            }
            .billing-header-left h1 i { color: var(--primary); }
            .billing-header-left p {
                color: var(--text-secondary); font-size: 0.9rem; margin: 0;
            }
            .billing-header-actions { display: flex; gap: 0.75rem; }
            
            /* SweetAlert2 Custom Theme */
            .swal2-popup.swal2-toast {
                background: var(--card) !important;
                border: 1px solid var(--border) !important;
                border-radius: var(--radius-lg) !important;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3) !important;
            }
            .swal2-popup .swal2-title {
                color: var(--text) !important;
                font-weight: 700 !important;
                font-size: 1.35rem !important;
            }
            .swal2-popup .swal2-html-container {
                color: var(--text-secondary) !important;
                font-size: 0.95rem !important;
                line-height: 1.6 !important;
            }
            .swal2-popup .swal2-confirm {
                background: var(--primary) !important;
                border-radius: var(--radius) !important;
                font-weight: 600 !important;
                padding: 0.75rem 1.5rem !important;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3) !important;
                transition: all 0.3s ease !important;
            }
            .swal2-popup .swal2-confirm:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4) !important;
            }
            .swal2-popup .swal2-cancel {
                background: var(--bg-tertiary) !important;
                color: var(--text) !important;
                border-radius: var(--radius) !important;
                font-weight: 600 !important;
                padding: 0.75rem 1.5rem !important;
                border: 1px solid var(--border) !important;
            }
            .swal2-popup .swal2-cancel:hover {
                background: var(--bg-secondary) !important;
            }
            .swal2-popup .swal2-icon {
                border-color: transparent !important;
                margin: 1.5rem auto !important;
            }
            .swal2-popup .swal2-icon.swal2-question {
                border-color: var(--primary) !important;
                color: var(--primary) !important;
            }
            .swal2-popup .swal2-icon.swal2-warning {
                border-color: #f59e0b !important;
                color: #f59e0b !important;
            }
            .swal2-popup .swal2-icon.swal2-success {
                border-color: var(--success) !important;
            }
            .swal2-popup .swal2-icon.swal2-success .swal2-success-ring {
                border-color: rgba(16, 185, 129, 0.3) !important;
            }
            .swal2-popup .swal2-icon.swal2-success [class^=swal2-success-line] {
                background-color: var(--success) !important;
            }
            .swal2-popup .swal2-icon.swal2-error {
                border-color: var(--error) !important;
            }
            .swal2-popup .swal2-icon.swal2-error .swal2-x-mark-line-left,
            .swal2-popup .swal2-icon.swal2-error .swal2-x-mark-line-right {
                background-color: var(--error) !important;
            }
            .swal2-popup .swal2-actions {
                margin-top: 1.5rem !important;
                gap: 0.75rem !important;
            }
            .swal2-popup .swal2-loader {
                border-color: var(--primary) transparent var(--primary) transparent !important;
            }
            
            /* Current Plan Card - Desktop: Gradient + Usage Side by Side */
            .current-plan-card {
                background: var(--card); border-radius: var(--radius-xl);
                border: 1px solid var(--border); overflow: hidden; margin-bottom: 1.5rem;
                display: grid; grid-template-columns: 1fr 1fr;
            }
            .current-plan-gradient {
                padding: 1.75rem; position: relative; overflow: hidden;
            }
            .current-plan-gradient::before {
                content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                opacity: 0.5;
            }
            .current-plan-header {
                position: relative; z-index: 1; display: flex; flex-direction: column;
                justify-content: center; height: 100%;
            }
            .current-plan-info { }
            .current-plan-badge {
                display: inline-flex; align-items: center; gap: 0.5rem;
                background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
                padding: 0.4rem 0.85rem; border-radius: 2rem; font-size: 0.65rem;
                font-weight: 600; color: white; margin-bottom: 0.75rem;
                text-transform: uppercase; letter-spacing: 0.5px; width: fit-content;
            }
            .current-plan-name {
                font-size: 1.75rem; font-weight: 800; color: white; margin: 0 0 0.5rem 0;
                display: flex; align-items: center; gap: 0.5rem;
            }
            .current-plan-name i { font-size: 1.5rem; }
            .current-plan-meta {
                display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem;
            }
            .current-plan-meta-item {
                display: flex; align-items: center; gap: 0.4rem;
                color: rgba(255,255,255,0.9); font-size: 0.8rem;
            }
            .current-plan-meta-item i { font-size: 1rem; opacity: 0.8; }
            
            /* Usage Progress Section - Like Article Usage Plan */
            .plan-usage-section {
                display: flex; flex-direction: column;
                padding: 1.5rem; background: var(--bg-secondary);
                border-left: 1px solid var(--border);
                justify-content: center; gap: 1rem;
            }
            .plan-usage-item {
                display: flex; flex-direction: column; gap: 0.5rem;
            }
            .plan-usage-header {
                display: flex; justify-content: space-between; align-items: center;
            }
            .plan-usage-info {
                display: flex; align-items: center; gap: 0.5rem;
            }
            .plan-usage-icon {
                width: 32px; height: 32px; border-radius: 8px; display: flex;
                align-items: center; justify-content: center; font-size: 1rem;
            }
            .plan-usage-icon.images { background: rgba(99, 102, 241, 0.12); color: var(--primary); }
            .plan-usage-icon.articles { background: rgba(16, 185, 129, 0.12); color: var(--success); }
            .plan-usage-icon.ai { background: rgba(168, 85, 247, 0.12); color: #a855f7; }
            .plan-usage-icon.time { background: rgba(245, 158, 11, 0.12); color: #f59e0b; }
            .plan-usage-label {
                font-size: 0.85rem; font-weight: 600; color: var(--text);
            }
            .plan-usage-percent {
                font-size: 0.85rem; font-weight: 700; color: var(--text);
            }
            .plan-usage-bar {
                height: 6px; background: var(--border); border-radius: 3px;
                overflow: hidden; width: 100%;
            }
            .plan-usage-fill {
                height: 100%; border-radius: 3px; transition: width 0.5s ease;
            }
            .plan-usage-fill.safe { background: var(--success); }
            .plan-usage-fill.warning { background: #fbbf24; }
            .plan-usage-fill.danger { background: #ef4444; }
            .plan-usage-stats {
                display: flex; justify-content: space-between;
                font-size: 0.75rem; color: var(--text-secondary);
            }
            .plan-usage-stats strong { color: var(--text); font-weight: 600; }
            
            
            /* Transaction History */
            .transactions-section {
                background: var(--card); border-radius: var(--radius-xl);
                border: 1px solid var(--border); overflow: hidden;
            }
            .transactions-header {
                display: flex; justify-content: space-between; align-items: center;
                padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border);
                flex-wrap: wrap; gap: 1rem;
            }
            .transactions-title {
                font-size: 1.1rem; font-weight: 700; color: var(--text);
                display: flex; align-items: center; gap: 0.5rem;
            }
            .transactions-filters {
                display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;
            }
            .filter-tabs {
                display: flex; background: var(--bg-tertiary); border-radius: var(--radius);
                padding: 0.25rem; gap: 0.25rem;
            }
            .filter-tab {
                padding: 0.5rem 1rem; border-radius: calc(var(--radius) - 2px);
                font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);
                cursor: pointer; transition: all 0.2s ease; border: none;
                background: transparent; white-space: nowrap;
            }
            .filter-tab:hover { color: var(--text); }
            .filter-tab.active {
                background: var(--card); color: var(--text);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .transactions-table {
                width: 100%; border-collapse: collapse;
            }
            .transactions-table th {
                text-align: left; padding: 0.875rem 1rem; font-size: 0.75rem;
                font-weight: 600; color: var(--text-secondary);
                text-transform: uppercase; letter-spacing: 0.5px;
                background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            }
            .transactions-table td {
                padding: 1rem; border-bottom: 1px solid var(--border);
                font-size: 0.875rem; color: var(--text);
            }
            .transactions-table tr:last-child td { border-bottom: none; }
            .transactions-table tr:hover { background: var(--bg-secondary); }
            .transaction-type-cell {
                display: flex; align-items: center; gap: 0.75rem;
            }
            .transaction-type-icon {
                width: 36px; height: 36px; border-radius: var(--radius);
                display: flex; align-items: center; justify-content: center; font-size: 1rem;
            }
            .transaction-type-info { display: flex; flex-direction: column; }
            .transaction-type-name { font-weight: 600; }
            .transaction-type-desc { font-size: 0.75rem; color: var(--text-secondary); }
            
            /* Mobile Transaction Cards */
            .mobile-transactions { display: none; }
            .mobile-transaction-card {
                background: var(--bg-secondary); border-radius: var(--radius);
                padding: 1rem; margin: 0.5rem 1rem;
            }
            .mobile-transaction-header {
                display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;
            }
            .mobile-transaction-type {
                display: flex; align-items: center; gap: 0.75rem;
            }
            .mobile-transaction-body {
                display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;
                font-size: 0.8rem;
            }
            .mobile-transaction-item label {
                display: block; color: var(--text-secondary); font-size: 0.7rem;
                text-transform: uppercase; margin-bottom: 0.15rem;
            }
            .mobile-transaction-actions {
                display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem;
                border-top: 1px solid var(--border);
            }
            
            /* Package Purchase Modal */
            .package-purchase-modal {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(10px);
                z-index: 9998; display: none; animation: fadeIn 0.3s ease;
            }
            .package-purchase-modal.active {
                display: flex; align-items: center; justify-content: center;
            }
            .pkg-modal-container {
                background: var(--bg-secondary); border-radius: 1.5rem;
                width: 95vw; max-width: 1100px; max-height: 90vh;
                overflow: hidden; display: flex; flex-direction: column;
                box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.3);
                animation: slideUpDesktop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            .pkg-modal-header {
                padding: 1.5rem 2rem; border-bottom: 1px solid var(--border);
                display: flex; justify-content: space-between; align-items: center;
            }
            .pkg-modal-title {
                font-size: 1.5rem; font-weight: 700; color: var(--text);
                display: flex; align-items: center; gap: 0.75rem;
            }
            .pkg-modal-title i { color: var(--primary); }
            .pkg-modal-close {
                width: 2.5rem; height: 2.5rem; border-radius: 50%;
                background: var(--bg-tertiary); border: 1px solid var(--border);
                color: var(--text-secondary); font-size: 1.25rem; cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                transition: all 0.3s ease;
            }
            .pkg-modal-close:hover {
                background: var(--error); color: white; transform: rotate(90deg);
            }
            .pkg-modal-body {
                flex: 1; padding: 2rem; overflow-y: auto;
                display: grid; grid-template-columns: 1fr 340px; gap: 2rem;
            }
            .pkg-options-section { }
            .pkg-summary-section {
                background: var(--bg-tertiary); border-radius: var(--radius-lg);
                padding: 1.5rem; height: fit-content; position: sticky; top: 0;
            }
            
            /* Package Options */
            .pkg-section-title {
                font-size: 1rem; font-weight: 600; color: var(--text);
                margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
            }
            .pkg-section-title i { color: var(--primary); }
            .pkg-options-grid {
                display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;
            }
            .pkg-option-card {
                background: var(--card); border: 2px solid var(--border);
                border-radius: var(--radius-lg); padding: 1.25rem; cursor: pointer;
                transition: all 0.3s ease; position: relative;
            }
            .pkg-option-card:hover { border-color: var(--primary); transform: translateY(-2px); }
            .pkg-option-card.selected {
                border-color: var(--primary); background: rgba(99, 102, 241, 0.05);
            }
            .pkg-option-card.selected::after {
                content: '✓'; position: absolute; top: 0.75rem; right: 0.75rem;
                width: 1.25rem; height: 1.25rem; background: var(--primary);
                color: white; border-radius: 50%; display: flex;
                align-items: center; justify-content: center; font-size: 0.7rem;
            }
            .pkg-option-card.popular::before {
                content: 'POPULAR'; position: absolute; top: -10px; left: 50%;
                transform: translateX(-50%); background: var(--primary);
                color: white; padding: 0.2rem 0.6rem; border-radius: 1rem;
                font-size: 0.6rem; font-weight: 700;
            }
            .pkg-option-icon {
                width: 40px; height: 40px; border-radius: var(--radius);
                display: flex; align-items: center; justify-content: center;
                font-size: 1.25rem; margin-bottom: 0.75rem;
            }
            .pkg-option-content { flex: 1; min-width: 0; }
            .pkg-option-name { font-weight: 700; color: var(--text); margin-bottom: 0.25rem; }
            .pkg-option-price { font-size: 0.85rem; color: var(--text-secondary); }
            .pkg-option-price strong { color: var(--text); font-size: 1.1rem; }
            .pkg-option-features {
                list-style: none; padding: 0; margin: 0.75rem 0 0 0;
                font-size: 0.75rem; color: var(--text-secondary);
            }
            .pkg-option-features li {
                display: flex; align-items: center; gap: 0.35rem; padding: 0.2rem 0;
            }
            .pkg-option-features li i { color: var(--success); font-size: 0.85rem; }
            
            /* Payment Type Toggle */
            .pkg-payment-type-toggle {
                display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
                background: var(--bg-tertiary); padding: 0.35rem; border-radius: var(--radius);
            }
            .pkg-payment-type-btn {
                flex: 1; padding: 0.75rem 1rem; border: none; border-radius: var(--radius);
                background: transparent; color: var(--text-secondary);
                font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            }
            .pkg-payment-type-btn.active {
                background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            
            /* Duration Options */
            .pkg-duration-grid {
                display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;
            }
            .pkg-duration-option {
                padding: 1rem; border: 2px solid var(--border); border-radius: var(--radius);
                cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative;
            }
            .pkg-duration-option:hover { border-color: var(--primary); }
            .pkg-duration-option.selected {
                border-color: var(--primary); background: rgba(99, 102, 241, 0.05);
            }
            .pkg-duration-option.best-value::before {
                content: 'BEST VALUE'; position: absolute; top: -10px; left: 50%;
                transform: translateX(-50%); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white; padding: 0.2rem 0.6rem; border-radius: 1rem;
                font-size: 0.55rem; font-weight: 700;
            }
            .pkg-duration-label { font-weight: 600; color: var(--text); }
            .pkg-duration-discount {
                font-size: 0.75rem; color: var(--success); margin-top: 0.25rem;
            }
            
            /* Payment Providers */
            .pkg-providers-grid {
                display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem;
            }
            .pkg-provider-option {
                display: flex; align-items: center; gap: 0.75rem; padding: 1rem;
                border: 2px solid var(--border); border-radius: var(--radius);
                cursor: pointer; transition: all 0.3s ease;
            }
            .pkg-provider-option:hover { border-color: var(--primary); }
            .pkg-provider-option.selected {
                border-color: var(--primary); background: rgba(99, 102, 241, 0.05);
            }
            .pkg-provider-icon { font-size: 1.5rem; }
            .pkg-provider-name { font-weight: 600; color: var(--text); }
            .pkg-provider-desc { font-size: 0.75rem; color: var(--text-secondary); }
            
            /* Summary Section */
            .pkg-summary-title {
                font-size: 1.1rem; font-weight: 700; color: var(--text);
                margin-bottom: 1rem; padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border);
            }
            .pkg-summary-row {
                display: flex; justify-content: space-between; padding: 0.5rem 0;
                font-size: 0.875rem; color: var(--text-secondary);
            }
            .pkg-summary-value { color: var(--text); font-weight: 500; }
            .pkg-summary-row.pkg-discount { color: var(--success); }
            .pkg-summary-row.pkg-discount .pkg-summary-value { color: var(--success); }
            .pkg-summary-divider {
                height: 1px; background: var(--border); margin: 0.75rem 0;
            }
            .pkg-summary-row.pkg-total {
                font-size: 1rem; color: var(--text); font-weight: 600;
            }
            .pkg-summary-row.pkg-total .pkg-summary-value {
                font-size: 1.25rem; font-weight: 800; color: var(--primary);
            }
            .pkg-summary-row.pkg-permonth {
                font-size: 0.8rem; color: var(--text-secondary); font-style: italic;
            }
            #pkgPurchaseBtn {
                width: 100%; padding: 1rem; margin-top: 1.5rem;
                background: var(--primary); color: white; border: none;
                border-radius: var(--radius); font-weight: 600; font-size: 1rem;
                cursor: pointer; transition: all 0.3s ease;
                display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            }
            #pkgPurchaseBtn:hover {
                background: var(--primary-dark); transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            }
            
            /* Free Plan Card */
            .free-plan-card {
                background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
                border: 2px dashed var(--border); border-radius: var(--radius-xl);
                padding: 3rem 2rem; text-align: center; margin-bottom: 1.5rem;
            }
            .free-plan-icon {
                width: 80px; height: 80px; margin: 0 auto 1.5rem;
                background: var(--bg-secondary); border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-size: 2.5rem; color: var(--text-secondary);
            }
            .free-plan-title { font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.5rem; }
            .free-plan-desc { color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 400px; margin-left: auto; margin-right: auto; }
            
            /* Responsive */
            @media (max-width: 1024px) {
                .pkg-modal-body { grid-template-columns: 1fr; }
                .pkg-summary-section { position: static; }
                .pkg-options-grid { grid-template-columns: 1fr 1fr; }
            }
            @media (max-width: 768px) {
                .billing-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
                .billing-header-actions { width: 100%; }
                .billing-header-actions .btn { flex: 1; justify-content: center; }
                
                /* Current Plan Card - Stack on Mobile */
                .current-plan-card { grid-template-columns: 1fr; }
                .current-plan-gradient { padding: 1.25rem; }
                .current-plan-name { font-size: 1.35rem; }
                .current-plan-name i { font-size: 1.15rem; }
                .current-plan-meta { gap: 0.5rem 1rem; }
                .current-plan-meta-item { font-size: 0.75rem; }
                
                /* Usage Section - Full width rows on mobile */
                .plan-usage-section { 
                    border-left: none; border-top: 1px solid var(--border);
                    padding: 1.25rem; gap: 1.25rem;
                }
                .plan-usage-item { gap: 0.4rem; }
                .plan-usage-icon { width: 28px; height: 28px; font-size: 0.9rem; }
                .plan-usage-label { font-size: 0.8rem; }
                .plan-usage-percent { font-size: 0.8rem; }
                .plan-usage-bar { height: 5px; }
                .plan-usage-stats { font-size: 0.7rem; }
                .transactions-table { display: none; }
                .mobile-transactions { display: block; }
                .transactions-header { padding: 1rem; gap: 0.75rem; }
                .transactions-title { font-size: 0.95rem; white-space: nowrap; }
                .transactions-title i { font-size: 1rem; }
                .filter-tabs { padding: 0.2rem; gap: 0.15rem; }
                .filter-tab { padding: 0.35rem 0.6rem; font-size: 0.7rem; }
                
                /* ========== MOBILE MODAL - COMPLETE REWRITE ========== */
                .package-purchase-modal {
                    padding: 0;
                }
                .pkg-modal-container {
                    width: 100%; max-width: 100%; height: 100%; max-height: 100%;
                    border-radius: 0; display: flex; flex-direction: column;
                    background: var(--bg);
                }
                
                /* Modal Header */
                .pkg-modal-header { 
                    padding: 1rem 1.25rem; flex-shrink: 0;
                    background: var(--card); 
                    border-bottom: 1px solid var(--border);
                    display: flex; justify-content: space-between; align-items: center;
                }
                .pkg-modal-title { 
                    font-size: 1.1rem; font-weight: 700;
                    display: flex; align-items: center; gap: 0.5rem;
                }
                .pkg-modal-title i { font-size: 1.2rem; color: var(--primary); }
                .pkg-modal-close { 
                    width: 38px; height: 38px; font-size: 1.3rem;
                    background: var(--bg-tertiary); border-radius: 50%;
                }
                
                /* Modal Body */
                .pkg-modal-body { 
                    flex: 1; overflow-y: auto; padding: 0;
                    display: flex; flex-direction: column;
                    -webkit-overflow-scrolling: touch;
                }
                
                /* Options Section - Scrollable Area */
                .pkg-options-section { 
                    flex: 1; padding: 1.25rem; 
                    display: flex; flex-direction: column; gap: 1.5rem;
                }
                
                /* Section Titles */
                .pkg-section-title { 
                    font-size: 0.85rem; font-weight: 700; margin-bottom: 0.75rem;
                    color: var(--text); display: flex; align-items: center; gap: 0.5rem;
                }
                .pkg-section-title i { color: var(--primary); font-size: 1rem; }
                
                /* Package Options - Cards with Features */
                .pkg-options-grid { 
                    display: flex; flex-direction: column; gap: 0.75rem;
                }
                .pkg-option-card { 
                    padding: 1rem 1.25rem; 
                    display: grid; grid-template-columns: auto 1fr auto;
                    grid-template-rows: auto auto;
                    gap: 0.5rem 0.75rem;
                    min-height: auto; border-width: 2px; border-radius: 14px;
                    background: var(--card); align-items: center;
                }
                .pkg-option-card .pkg-option-icon { 
                    width: 44px; height: 44px; font-size: 1.2rem;
                    border-radius: 10px; grid-row: 1; grid-column: 1;
                }
                .pkg-option-card .pkg-option-content { 
                    grid-row: 1; grid-column: 2;
                    display: flex; flex-direction: column;
                }
                .pkg-option-card .pkg-option-name { 
                    font-size: 1rem; font-weight: 700; margin-bottom: 0.1rem; 
                }
                .pkg-option-card .pkg-option-price { 
                    font-size: 0.8rem; color: var(--text-secondary);
                }
                .pkg-option-card .pkg-option-price strong {
                    color: var(--text); font-size: 0.9rem;
                }
                .pkg-option-card .pkg-option-features { 
                    display: flex; flex-wrap: wrap; gap: 0.25rem 0.75rem;
                    margin-top: 0; padding-top: 0.5rem;
                    border-top: 1px solid var(--border);
                    font-size: 0.7rem;
                    grid-row: 2; grid-column: 1 / -1;
                }
                .pkg-option-card .pkg-option-features li {
                    padding: 0.15rem 0;
                }
                .pkg-option-card .pkg-option-features li i { font-size: 0.75rem; }
                .pkg-option-card.selected { 
                    border-color: var(--primary); 
                    background: rgba(99, 102, 241, 0.08);
                    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
                }
                .pkg-option-card.selected::after { 
                    content: '✓'; grid-row: 1; grid-column: 3;
                    width: 26px; height: 26px; background: var(--primary); 
                    color: white; border-radius: 50%;
                    display: flex; align-items: center; justify-content: center; 
                    font-size: 0.75rem; font-weight: 700;
                    position: static; transform: none;
                }
                .pkg-option-card.popular::before { 
                    content: 'POPULAR'; position: absolute; top: -9px; left: 1rem;
                    transform: none; font-size: 0.6rem; padding: 0.2rem 0.6rem;
                    background: var(--primary); border-radius: 6px;
                }
                
                /* Payment Type Toggle */
                .pkg-payment-type-toggle { 
                    display: flex; gap: 0.5rem; padding: 0.3rem;
                    background: var(--bg-tertiary); border-radius: 12px;
                }
                .pkg-payment-type-btn { 
                    flex: 1; padding: 0.85rem 0.75rem; font-size: 0.85rem;
                    border-radius: 10px; font-weight: 600;
                    display: flex; align-items: center; justify-content: center; gap: 0.5rem;
                }
                .pkg-payment-type-btn i { font-size: 1.1rem; }
                .pkg-payment-type-btn.active {
                    background: var(--primary); color: white;
                    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                }
                
                /* Duration Grid - Horizontal Single Row */
                .pkg-duration-grid { 
                    display: flex; gap: 0.5rem;
                }
                .pkg-duration-option { 
                    flex: 1; padding: 0.85rem 0.5rem; min-width: 0; 
                    border-radius: 12px; text-align: center;
                    border-width: 2px; background: var(--card);
                }
                .pkg-duration-option.selected {
                    border-color: var(--primary);
                    background: rgba(99, 102, 241, 0.08);
                }
                .pkg-duration-option.best-value::before { 
                    content: 'BEST'; top: -8px; font-size: 0.5rem; 
                    padding: 0.15rem 0.4rem; border-radius: 4px;
                }
                .pkg-duration-label { font-size: 0.8rem; font-weight: 700; }
                .pkg-duration-discount { 
                    font-size: 0.65rem; margin-top: 0.25rem; 
                    color: var(--success); font-weight: 600;
                }
                
                /* Payment Providers */
                .pkg-providers-grid { 
                    display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;
                }
                .pkg-provider-option { 
                    padding: 0.85rem; gap: 0.5rem; border-radius: 12px;
                    flex-direction: column; text-align: center;
                    border-width: 2px; background: var(--card);
                }
                .pkg-provider-option.selected {
                    border-color: var(--primary);
                    background: rgba(99, 102, 241, 0.08);
                }
                .pkg-provider-icon { font-size: 1.5rem; line-height: 1; }
                .pkg-provider-name { font-size: 0.8rem; font-weight: 600; }
                .pkg-provider-desc { font-size: 0.65rem; color: var(--text-secondary); }
                
                /* Summary Section - Fixed at Bottom */
                .pkg-summary-section { 
                    flex-shrink: 0;
                    margin: 0; padding: 1.25rem;
                    background: var(--card); 
                    border-top: 1px solid var(--border);
                    border-radius: 20px 20px 0 0;
                    box-shadow: 0 -8px 30px rgba(0,0,0,0.12);
                }
                .pkg-summary-title { 
                    font-size: 1rem; margin-bottom: 0.85rem; 
                    padding-bottom: 0.65rem;
                }
                #pkgPurchaseSummary {
                    background: var(--bg-secondary); border-radius: 12px;
                    padding: 0.85rem; margin-bottom: 1rem;
                }
                .pkg-summary-row { 
                    font-size: 0.8rem; padding: 0.35rem 0;
                }
                .pkg-summary-row.pkg-total { 
                    font-size: 1rem; padding-top: 0.5rem;
                }
                .pkg-summary-row.pkg-total .pkg-summary-value {
                    font-size: 1.2rem;
                }
                .pkg-summary-row.pkg-permonth {
                    font-size: 0.75rem;
                }
                .pkg-summary-divider { margin: 0.5rem 0; }
                #pkgPurchaseBtn { 
                    padding: 1rem; font-size: 1rem; border-radius: 14px;
                    margin-top: 0;
                }
            }
            
            @media (max-width: 480px) {
                .billing-header-left h1 { font-size: 1.25rem; }
                .billing-header-left h1 i { font-size: 1.1rem; }
                .billing-header-left p { font-size: 0.75rem; }
                .billing-header-actions .btn { font-size: 0.75rem; padding: 0.55rem 0.75rem; }
                .current-plan-gradient { padding: 1rem; }
                .current-plan-badge { font-size: 0.55rem; padding: 0.3rem 0.6rem; }
                .current-plan-name { font-size: 1.15rem; gap: 0.4rem; }
                .current-plan-name i { font-size: 1rem; }
                .current-plan-meta { gap: 0.4rem 0.75rem; }
                .current-plan-meta-item { font-size: 0.7rem; }
                .current-plan-meta-item i { font-size: 0.8rem; }
                .plan-usage-section { padding: 1rem; gap: 1rem; }
                .plan-usage-icon { width: 26px; height: 26px; font-size: 0.85rem; }
                .plan-usage-label { font-size: 0.75rem; }
                .plan-usage-percent { font-size: 0.75rem; }
                .plan-usage-bar { height: 4px; }
                .plan-usage-stats { font-size: 0.65rem; }
                .transactions-header { padding: 0.75rem; }
                .transactions-title { font-size: 0.85rem; }
                .transactions-title i { font-size: 0.9rem; }
                .filter-tab { padding: 0.3rem 0.5rem; font-size: 0.65rem; }
                .mobile-transaction-card { padding: 0.65rem; margin: 0.3rem 0.5rem; }
                
                /* Modal 480px adjustments */
                .pkg-modal-header { padding: 0.85rem 1rem; }
                .pkg-modal-title { font-size: 1rem; }
                .pkg-modal-title i { font-size: 1.1rem; }
                .pkg-modal-close { width: 34px; height: 34px; font-size: 1.15rem; }
                .pkg-options-section { padding: 1rem; gap: 1.25rem; }
                .pkg-section-title { font-size: 0.8rem; margin-bottom: 0.6rem; }
                .pkg-section-title i { font-size: 0.9rem; }
                .pkg-option-card { padding: 0.85rem 1rem; border-radius: 12px; gap: 0.4rem 0.65rem; }
                .pkg-option-card .pkg-option-icon { width: 38px; height: 38px; font-size: 1.05rem; }
                .pkg-option-card .pkg-option-name { font-size: 0.9rem; }
                .pkg-option-card .pkg-option-price { font-size: 0.7rem; }
                .pkg-option-card .pkg-option-price strong { font-size: 0.8rem; }
                .pkg-option-card .pkg-option-features { font-size: 0.65rem; gap: 0.2rem 0.5rem; padding-top: 0.4rem; }
                .pkg-option-card.selected::after { width: 22px; height: 22px; font-size: 0.6rem; }
                .pkg-option-card.popular::before { font-size: 0.5rem; padding: 0.15rem 0.45rem; top: -8px; }
                .pkg-payment-type-btn { padding: 0.75rem 0.6rem; font-size: 0.8rem; }
                .pkg-payment-type-btn i { font-size: 1rem; }
                .pkg-duration-option { padding: 0.75rem 0.4rem; border-radius: 10px; }
                .pkg-duration-label { font-size: 0.75rem; }
                .pkg-duration-discount { font-size: 0.6rem; }
                .pkg-duration-option.best-value::before { font-size: 0.45rem; padding: 0.1rem 0.3rem; }
                .pkg-provider-option { padding: 0.75rem 0.5rem; border-radius: 10px; }
                .pkg-provider-icon { font-size: 1.35rem; }
                .pkg-provider-name { font-size: 0.75rem; }
                .pkg-provider-desc { font-size: 0.6rem; }
                .pkg-summary-section { padding: 1rem; border-radius: 16px 16px 0 0; }
                .pkg-summary-title { font-size: 0.9rem; margin-bottom: 0.75rem; }
                #pkgPurchaseSummary { padding: 0.75rem; margin-bottom: 0.85rem; border-radius: 10px; }
                .pkg-summary-row { font-size: 0.75rem; padding: 0.3rem 0; }
                .pkg-summary-row.pkg-total { font-size: 0.9rem; }
                .pkg-summary-row.pkg-total .pkg-summary-value { font-size: 1.1rem; }
                .pkg-summary-row.pkg-permonth { font-size: 0.7rem; }
                #pkgPurchaseBtn { padding: 0.9rem; font-size: 0.9rem; border-radius: 12px; }
            }
        </style>
        
        <!-- Package Purchase Modal -->
        <div class="package-purchase-modal" id="packagePurchaseModal">
            <div class="pkg-modal-container">
                <div class="pkg-modal-header">
                    <h2 class="pkg-modal-title"><i class="ri-shopping-bag-3-line"></i> Purchase Package</h2>
                    <button class="pkg-modal-close" onclick="closePackagePurchaseModal()">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
                <div class="pkg-modal-body">
                    <div class="pkg-options-section">
                        <!-- Select Package -->
                        <h3 class="pkg-section-title"><i class="ri-stack-line"></i> Select Package</h3>
                        <div class="pkg-options-grid">
                            ${Object.entries(hostingPackages).map(([key, pkg]) => `
                                <div class="pkg-option-card ${pkg.popular ? 'popular' : ''} ${key === 'professional' ? 'selected' : ''}" 
                                     data-package="${key}" onclick="selectPackageOption('${key}')">
                                    <div class="pkg-option-icon" style="background: ${pkg.gradient}; color: white;">
                                        <i class="${pkg.icon}"></i>
                                    </div>
                                    <div class="pkg-option-content">
                                        <div class="pkg-option-name">${pkg.name}</div>
                                        <div class="pkg-option-price">From <strong>$${pkg.price['3month']}</strong>/3mo</div>
                                    </div>
                                    <ul class="pkg-option-features">
                                        ${pkg.features.slice(0, 3).map(f => `<li><i class="ri-check-line"></i> ${f}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Payment Type -->
                        <h3 class="pkg-section-title"><i class="ri-repeat-line"></i> Payment Type</h3>
                        <div class="pkg-payment-type-toggle">
                            <button class="pkg-payment-type-btn active" data-type="subscription" onclick="selectPackagePaymentType('subscription')">
                                <i class="ri-refresh-line"></i> Subscription
                            </button>
                            <button class="pkg-payment-type-btn" data-type="one-time" onclick="selectPackagePaymentType('one-time')">
                                <i class="ri-bank-card-line"></i> One-time
                            </button>
                        </div>
                        
                        <!-- Duration -->
                        <h3 class="pkg-section-title"><i class="ri-calendar-line"></i> Duration</h3>
                        <div class="pkg-duration-grid">
                            <div class="pkg-duration-option selected" data-duration="3month" onclick="selectPackageDuration('3month')">
                                <div class="pkg-duration-label">3 Months</div>
                            </div>
                            <div class="pkg-duration-option" data-duration="6month" onclick="selectPackageDuration('6month')">
                                <div class="pkg-duration-label">6 Months</div>
                                <div class="pkg-duration-discount">Save 10%</div>
                            </div>
                            <div class="pkg-duration-option best-value" data-duration="12month" onclick="selectPackageDuration('12month')">
                                <div class="pkg-duration-label">12 Months</div>
                                <div class="pkg-duration-discount">Save 20%</div>
                            </div>
                        </div>
                        
                        <!-- Payment Provider -->
                        <h3 class="pkg-section-title"><i class="ri-secure-payment-line"></i> Payment Method</h3>
                        <div class="pkg-providers-grid">
                            <div class="pkg-provider-option selected" data-provider="stripe" onclick="selectPackageProvider('stripe')">
                                <div class="pkg-provider-icon">💳</div>
                                <div>
                                    <div class="pkg-provider-name">Card (Stripe)</div>
                                    <div class="pkg-provider-desc">Credit/Debit cards</div>
                                </div>
                            </div>
                            <div class="pkg-provider-option" data-provider="oxapay" onclick="selectPackageProvider('oxapay')" style="display: none;">
                                <div class="pkg-provider-icon">🪙</div>
                                <div>
                                    <div class="pkg-provider-name">Crypto (OxaPay)</div>
                                    <div class="pkg-provider-desc">Bitcoin, ETH, USDT...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pkg-summary-section">
                        <h3 class="pkg-summary-title">Order Summary</h3>
                        <div id="pkgPurchaseSummary">
                            <!-- Dynamically updated -->
                        </div>
                        <button id="pkgPurchaseBtn" onclick="processPackagePurchase()">
                            <i class="ri-shopping-cart-2-line"></i> Purchase - $25.00
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page Header -->
        <div class="billing-header">
            <div class="billing-header-left">
                <h1><i class="ri-bank-card-line"></i> Billing & Plans</h1>
                <p>Manage your subscription, view usage, and payment history</p>
            </div>
            <div class="billing-header-actions">
                <button class="btn btn-primary" onclick="openPackagePurchaseModal()">
                    <i class="ri-arrow-up-circle-line"></i> Upgrade Plan
                </button>
                ${subscriptions.length > 0 ? `
                    <button class="btn btn-secondary" onclick="showSubscriptionModal()">
                        <i class="ri-settings-3-line"></i> Manage
                    </button>
                ` : ''}
            </div>
        </div>
        
        ${isFree ? `
        <!-- Free Plan Card -->
        <div class="free-plan-card">
            <div class="free-plan-icon">
                <i class="ri-gift-line"></i>
            </div>
            <h2 class="free-plan-title">You're on the Free Plan</h2>
            <p class="free-plan-desc">Upgrade to unlock more features, higher limits, and priority support for your SEO needs.</p>
            <button class="btn btn-primary btn-lg" onclick="openPackagePurchaseModal()">
                <i class="ri-rocket-line"></i> Upgrade Now
            </button>
        </div>
        ` : `
        <!-- Current Plan Card with Usage Side by Side -->
        <div class="current-plan-card">
            <div class="current-plan-gradient" style="background: ${currentPkg?.gradient || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};">
                <div class="current-plan-header">
                    <div class="current-plan-info">
                        <div class="current-plan-badge">
                            <i class="${isSubscribed ? 'ri-refresh-line' : 'ri-time-line'}"></i>
                            ${isSubscribed ? 'Active Subscription' : 'One-time Purchase'}
                        </div>
                        <h2 class="current-plan-name">
                            <i class="${currentPkg?.icon || 'ri-vip-crown-line'}"></i>
                            ${currentPkg?.name || planName} Plan
                        </h2>
                        <div class="current-plan-meta">
                            <div class="current-plan-meta-item">
                                <i class="ri-time-line"></i>
                                ${daysLeft} days left
                            </div>
                            ${subscriptionEnd ? `
                                <div class="current-plan-meta-item">
                                    <i class="ri-repeat-line"></i>
                                    Renews ${subscriptionEnd.toLocaleDateString()}
                                </div>
                            ` : expiryDate ? `
                                <div class="current-plan-meta-item">
                                    <i class="ri-calendar-check-line"></i>
                                    Expires ${expiryDate.toLocaleDateString()}
                                </div>
                            ` : ''}
                            <div class="current-plan-meta-item">
                                <i class="ri-bank-card-line"></i>
                                ${planData.billing?.provider ? planData.billing.provider.charAt(0).toUpperCase() + planData.billing.provider.slice(1) : 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Usage Section - Like Article Usage Plan -->
            <div class="plan-usage-section">
                <div class="plan-usage-item">
                    <div class="plan-usage-header">
                        <div class="plan-usage-info">
                            <div class="plan-usage-icon images"><i class="ri-image-line"></i></div>
                            <span class="plan-usage-label">Images</span>
                        </div>
                        <span class="plan-usage-percent">${Math.round(imagesUsedPercent)}%</span>
                    </div>
                    <div class="plan-usage-bar">
                        <div class="plan-usage-fill ${imagesUsedPercent > 90 ? 'danger' : imagesUsedPercent > 70 ? 'warning' : 'safe'}" style="width: ${imagesUsedPercent}%;"></div>
                    </div>
                    <div class="plan-usage-stats">
                        <span><strong>${imagesUsed.toLocaleString()}</strong> used</span>
                        <span><strong>${imagesRemaining.toLocaleString()}</strong> remaining / <strong>${imagesLimit.toLocaleString()}</strong> total</span>
                    </div>
                </div>
                <div class="plan-usage-item">
                    <div class="plan-usage-header">
                        <div class="plan-usage-info">
                            <div class="plan-usage-icon articles"><i class="ri-article-line"></i></div>
                            <span class="plan-usage-label">Articles</span>
                        </div>
                        <span class="plan-usage-percent">${Math.round(articlesUsedPercent)}%</span>
                    </div>
                    <div class="plan-usage-bar">
                        <div class="plan-usage-fill ${articlesUsedPercent > 90 ? 'danger' : articlesUsedPercent > 70 ? 'warning' : 'safe'}" style="width: ${articlesUsedPercent}%;"></div>
                    </div>
                    <div class="plan-usage-stats">
                        <span><strong>${articlesUsed.toLocaleString()}</strong> used</span>
                        <span><strong>${articlesRemaining.toLocaleString()}</strong> remaining / <strong>${articlesLimit.toLocaleString()}</strong> total</span>
                    </div>
                </div>
                <div class="plan-usage-item">
                    <div class="plan-usage-header">
                        <div class="plan-usage-info">
                            <div class="plan-usage-icon ai"><i class="ri-robot-line"></i></div>
                            <span class="plan-usage-label">AI Credits</span>
                        </div>
                        <span class="plan-usage-percent">${Math.round(aiUsedPercent)}%</span>
                    </div>
                    <div class="plan-usage-bar">
                        <div class="plan-usage-fill ${aiUsedPercent > 90 ? 'danger' : aiUsedPercent > 70 ? 'warning' : 'safe'}" style="width: ${aiUsedPercent}%;"></div>
                    </div>
                    <div class="plan-usage-stats">
                        <span><strong>${aiUsed.toLocaleString()}</strong> used</span>
                        <span><strong>${aiRemaining.toLocaleString()}</strong> remaining / <strong>${aiLimit.toLocaleString()}</strong> total</span>
                    </div>
                </div>
                <div class="plan-usage-item">
                    <div class="plan-usage-header">
                        <div class="plan-usage-info">
                            <div class="plan-usage-icon time"><i class="ri-timer-line"></i></div>
                            <span class="plan-usage-label">Time Remaining</span>
                        </div>
                        <span class="plan-usage-percent">${daysLeft} days</span>
                    </div>
                    <div class="plan-usage-bar">
                        <div class="plan-usage-fill ${daysLeft < 7 ? 'danger' : daysLeft < 14 ? 'warning' : 'safe'}" style="width: ${Math.min(daysLeft * 3.33, 100)}%;"></div>
                    </div>
                    <div class="plan-usage-stats">
                        <span>${expiryDate ? expiryDate.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'}) : 'N/A'}</span>
                        <span>${subscriptionEnd ? 'Auto-renews' : 'Expires'}</span>
                    </div>
                </div>
            </div>
        </div>
        `}
        
        <!-- Transaction History -->
        <div class="transactions-section">
            <div class="transactions-header">
                <h3 class="transactions-title"><i class="ri-exchange-funds-line"></i> Transaction History</h3>
                <div class="transactions-filters">
                    <div class="filter-tabs">
                        <button class="filter-tab ${type === 'all' ? 'active' : ''}" onclick="loadBilling(1, 'all')">
                            All
                        </button>
                        <button class="filter-tab ${type === 'hosting' ? 'active' : ''}" onclick="loadBilling(1, 'hosting')">
                            Hosting
                        </button>
                        <button class="filter-tab ${type === 'tasks' ? 'active' : ''}" onclick="loadBilling(1, 'tasks')">
                            Tasks
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Desktop Table -->
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${allPayments.length > 0 ? allPayments.map(payment => {
                        let paymentType = '', description = '', badgeClass = '', icon = '', iconBg = '';
                        const isTask = payment.type === 'task';
                        const isHosting = payment.type === 'hosting';
                        
                        if (isTask) {
                            paymentType = 'SEO Task'; badgeClass = 'primary'; 
                            description = payment.description || 'Task Payment';
                            icon = 'ri-rocket-line'; iconBg = 'rgba(99, 102, 241, 0.1)';
                        } else if (isHosting) {
                            paymentType = 'Hosting'; badgeClass = 'warning'; 
                            description = payment.description || 'Hosting Package';
                            icon = 'ri-cloud-line'; iconBg = 'rgba(245, 158, 11, 0.1)';
                        } else {
                            paymentType = 'Payment'; badgeClass = 'primary'; 
                            description = payment.description || 'Payment';
                            icon = 'ri-bank-card-line'; iconBg = 'rgba(99, 102, 241, 0.1)';
                        }
                        
                        // Format currency symbol
                        const currencySymbol = payment.currency === 'eur' ? '€' : payment.currency === 'gbp' ? '£' : '$';
                        const amount = payment.amount || 0;
                        
                        let statusClass = 'warning'; let statusText = payment.status || 'Unknown';
                        switch (payment.status?.toLowerCase()) {
                            case 'paid': statusClass = 'success'; statusText = 'Paid'; break;
                            case 'pending': statusClass = 'warning'; statusText = 'Pending'; break;
                            case 'cancelled': statusClass = 'danger'; statusText = 'Cancelled'; break;
                            case 'expired': statusClass = 'danger'; statusText = 'Expired'; break;
                            case 'active': statusClass = 'success'; statusText = 'Active'; break;
                        }
                        const descTruncated = description.length > 30 ? description.substring(0, 30) + '...' : description;
                        return '<tr>' +
                            '<td>' +
                                '<div class="transaction-type-cell">' +
                                    '<div class="transaction-type-icon" style="background: ' + iconBg + '; color: var(--' + badgeClass + ');">' +
                                        '<i class="' + icon + '"></i>' +
                                    '</div>' +
                                    '<div class="transaction-type-info">' +
                                        '<span class="transaction-type-name">' + paymentType + '</span>' +
                                        '<span class="transaction-type-desc">' + descTruncated + '</span>' +
                                    '</div>' +
                                '</div>' +
                            '</td>' +
                            '<td>' + (payment.date ? new Date(payment.date).toLocaleDateString() : 'N/A') + '</td>' +
                            '<td style="font-weight: 600;">' + currencySymbol + amount.toFixed(2) + '</td>' +
                            '<td><span class="badge badge-' + statusClass + '">' + statusText + '</span></td>' +
                            '<td>' +
                                (payment.status?.toLowerCase() === 'paid' ? '<button class="btn btn-sm" onclick="viewPaymentDetails(\'' + payment.billing_id + '\')"><i class="ri-eye-line"></i></button>' : '') +
                                (payment.status?.toLowerCase() === 'pending' && payment.payment_url ? '<button class="btn btn-sm btn-primary" onclick="window.open(\'' + payment.payment_url + '\', \'_blank\')"><i class="ri-external-link-line"></i> Pay</button>' : '') +
                            '</td>' +
                        '</tr>';
                    }).join('') : `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 3rem;">
                                <div style="color: var(--text-secondary);">
                                    <i class="ri-file-list-3-line" style="font-size: 2.5rem; opacity: 0.4; margin-bottom: 0.5rem; display: block;"></i>
                                    <p style="font-weight: 600; margin: 0;">No transactions yet</p>
                                    <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;">Your payment history will appear here</p>
                                </div>
                            </td>
                        </tr>
                    `}
                </tbody>
            </table>
            
            <!-- Mobile Cards -->
            <div class="mobile-transactions">
                ${allPayments.length > 0 ? allPayments.map(payment => {
                    let paymentType = '', description = '', badgeClass = '', icon = '', iconBg = '';
                    const isTask = payment.type === 'task';
                    const isHosting = payment.type === 'hosting';
                    
                    if (isTask) {
                        paymentType = 'SEO Task'; badgeClass = 'primary'; 
                        description = payment.description || 'Task Payment';
                        icon = 'ri-rocket-line'; iconBg = 'rgba(99, 102, 241, 0.1)';
                    } else if (isHosting) {
                        paymentType = 'Hosting'; badgeClass = 'warning'; 
                        description = payment.description || 'Hosting Package';
                        icon = 'ri-cloud-line'; iconBg = 'rgba(245, 158, 11, 0.1)';
                    } else {
                        paymentType = 'Payment'; badgeClass = 'primary'; 
                        description = payment.description || 'Payment';
                        icon = 'ri-bank-card-line'; iconBg = 'rgba(99, 102, 241, 0.1)';
                    }
                    
                    // Format currency symbol
                    const currencySymbol = payment.currency === 'eur' ? '€' : payment.currency === 'gbp' ? '£' : '$';
                    const amount = payment.amount || 0;
                    
                    let statusClass = 'warning'; let statusText = payment.status || 'Unknown';
                    switch (payment.status?.toLowerCase()) {
                        case 'paid': statusClass = 'success'; statusText = 'Paid'; break;
                        case 'pending': statusClass = 'warning'; statusText = 'Pending'; break;
                        case 'cancelled': statusClass = 'danger'; statusText = 'Cancelled'; break;
                        case 'expired': statusClass = 'danger'; statusText = 'Expired'; break;
                        case 'active': statusClass = 'success'; statusText = 'Active'; break;
                    }
                    const descTruncated = description.length > 25 ? description.substring(0, 25) + '...' : description;
                    const showActions = payment.status?.toLowerCase() === 'paid' || (payment.status?.toLowerCase() === 'pending' && payment.payment_url);
                    let actionsHtml = '';
                    if (showActions) {
                        actionsHtml = '<div class="mobile-transaction-actions">';
                        if (payment.status?.toLowerCase() === 'paid') {
                            actionsHtml += '<button class="btn btn-sm" style="flex: 1;" onclick="viewPaymentDetails(\'' + payment.billing_id + '\')"><i class="ri-eye-line"></i> Details</button>';
                        }
                        if (payment.status?.toLowerCase() === 'pending' && payment.payment_url) {
                            actionsHtml += '<button class="btn btn-sm btn-primary" style="flex: 1;" onclick="window.open(\'' + payment.payment_url + '\', \'_blank\')"><i class="ri-external-link-line"></i> Pay Now</button>';
                        }
                        actionsHtml += '</div>';
                    }
                    return '<div class="mobile-transaction-card">' +
                        '<div class="mobile-transaction-header">' +
                            '<div class="mobile-transaction-type">' +
                                '<div class="transaction-type-icon" style="background: ' + iconBg + '; color: var(--' + badgeClass + ');">' +
                                    '<i class="' + icon + '"></i>' +
                                '</div>' +
                                '<div>' +
                                    '<div style="font-weight: 600;">' + paymentType + '</div>' +
                                    '<div style="font-size: 0.75rem; color: var(--text-secondary);">' + descTruncated + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<span class="badge badge-' + statusClass + '">' + statusText + '</span>' +
                        '</div>' +
                        '<div class="mobile-transaction-body">' +
                            '<div class="mobile-transaction-item">' +
                                '<label>Date</label>' +
                                '<div>' + (payment.date ? new Date(payment.date).toLocaleDateString() : 'N/A') + '</div>' +
                            '</div>' +
                            '<div class="mobile-transaction-item">' +
                                '<label>Amount</label>' +
                                '<div style="font-weight: 600;">' + currencySymbol + amount.toFixed(2) + '</div>' +
                            '</div>' +
                        '</div>' +
                        actionsHtml +
                    '</div>';
                }).join('') : `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="ri-file-list-3-line" style="font-size: 2.5rem; opacity: 0.4; margin-bottom: 0.5rem; display: block;"></i>
                        <p style="font-weight: 600; margin: 0;">No transactions yet</p>
                        <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;">Your payment history will appear here</p>
                    </div>
                `}
            </div>
        </div>
        
        ${paginationState.billing.total > paginationState.billing.pageSize ? generatePagination('billing', (page) => loadBilling(page, type)) : ''}
        `;
        
        // Initialize purchase modal UI
        updatePackagePurchaseUI();
        
    } catch (error) {
        console.error('Billing error:', error);
        showErrorState('Failed to load billing data. Please check your connection and try again.');
    }
}

// Show Subscription Management Modal
function showSubscriptionModal() {
    const planData = window.currentPlanData || {};
    const billingData = window.currentBillingData || {};
    
    const planName = planData.current_plan || 'Unknown';
    const hostingSubscription = planData.hostingSubscription;
    const taskSubscriptions = planData.taskSubscriptions || [];
    const isSubscribed = planData.is_subscription;
    const subscriptionEnd = planData.subscription_period_end ? new Date(planData.subscription_period_end) : null;
    const expiryDate = planData.expiry_date ? new Date(planData.expiry_date) : null;
    const lastPayment = planData.billing?.last_payment_amount || 0;
    const provider = planData.billing?.provider || 'stripe';
    const currency = planData.billing?.currency || 'usd';
    const pkg = hostingPackages[planName];
    
    // Format currency
    const getCurrencySymbol = (curr) => curr === 'eur' ? '€' : curr === 'gbp' ? '£' : '$';
    const currencySymbol = getCurrencySymbol(currency);
    
    // Calculate days left
    let daysLeft = 0;
    if (expiryDate) {
        daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
        if (daysLeft < 0) daysLeft = 0;
    }
    
    // Build task subscriptions HTML
    const escapeHtml = (str) => {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    };
    
    const taskSubscriptionsHtml = taskSubscriptions.length > 0 ? taskSubscriptions.map((task, idx) => {
        const taskCurrency = getCurrencySymbol(task.currency);
        const nextBilling = task.next_billing_date ? new Date(task.next_billing_date) : null;
        const safeDesc = escapeHtml(task.description || 'SEO Task');
        const safeBillingId = escapeHtml(task.billing_id || '');
        return `
            <div class="sub-task-item" data-task-idx="${idx}">
                <div class="sub-task-header">
                    <div class="sub-task-info">
                        <div class="sub-task-icon"><i class="ri-rocket-line"></i></div>
                        <div class="sub-task-details">
                            <div class="sub-task-name">${safeDesc}</div>
                            <div class="sub-task-meta">${taskCurrency}${task.amount?.toFixed(2) || '0.00'}/month</div>
                        </div>
                    </div>
                    <span class="badge badge-${task.status === 'active' ? 'success' : 'warning'}">${task.status || 'Unknown'}</span>
                </div>
                <div class="sub-task-body">
                    <div class="sub-task-row">
                        <span>Next Billing</span>
                        <span>${nextBilling ? nextBilling.toLocaleDateString() : 'N/A'}</span>
                    </div>
                    <div class="sub-task-row">
                        <span>Subscription ID</span>
                        <span class="sub-task-id">${task.subscription_id?.slice(-8) || 'N/A'}</span>
                    </div>
                </div>
                ${task.status === 'active' ? `
                <button class="btn btn-sm btn-danger sub-task-cancel" onclick="confirmCancelTaskSubscription('${safeBillingId}', '${safeDesc}')">
                    <i class="ri-close-circle-line"></i> Cancel
                </button>
                ` : ''}
            </div>
        `;
    }).join('') : '<p class="sub-no-tasks">No active task subscriptions</p>';
    
    const modalContent = `
        <style>
            /* Subscription Modal - Responsive Design */
            .sub-modal-content {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            /* Desktop Layout */
            .sub-modal-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
            
            .sub-modal-section {
                background: var(--bg-secondary);
                border-radius: var(--radius-lg);
                padding: 1.25rem;
            }
            
            .sub-section-title {
                font-size: 0.9rem;
                font-weight: 700;
                color: var(--text);
                margin: 0 0 1rem 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border);
            }
            
            .sub-section-title i {
                color: var(--primary);
            }
            
            /* Hosting Plan Card */
            .sub-plan-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            
            .sub-plan-icon {
                width: 48px;
                height: 48px;
                flex-shrink: 0;
                background: ${pkg?.gradient || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                color: white;
            }
            
            .sub-plan-info {
                flex: 1;
            }
            
            .sub-plan-name {
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--text);
                margin: 0 0 0.25rem 0;
            }
            
            .sub-plan-type {
                font-size: 0.8rem;
                color: var(--text-secondary);
            }
            
            /* Stats Grid */
            .sub-stats-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .sub-stat-box {
                background: var(--bg-tertiary);
                border-radius: var(--radius);
                padding: 0.75rem;
                text-align: center;
            }
            
            .sub-stat-value {
                font-size: 1.1rem;
                font-weight: 800;
                color: var(--text);
            }
            
            .sub-stat-label {
                font-size: 0.65rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }
            
            /* Detail Rows */
            .sub-detail-list {
                margin-bottom: 1rem;
            }
            
            .sub-detail-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--border);
                font-size: 0.85rem;
            }
            
            .sub-detail-row:last-child {
                border-bottom: none;
            }
            
            .sub-detail-label {
                color: var(--text-secondary);
            }
            
            .sub-detail-value {
                font-weight: 600;
                color: var(--text);
            }
            
            /* Task Subscriptions */
            .sub-tasks-list {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .sub-task-item {
                background: var(--bg-tertiary);
                border-radius: var(--radius);
                padding: 1rem;
                border: 1px solid var(--border);
            }
            
            .sub-task-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.75rem;
            }
            
            .sub-task-info {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            
            .sub-task-icon {
                width: 36px;
                height: 36px;
                background: rgba(99, 102, 241, 0.12);
                color: var(--primary);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
            }
            
            .sub-task-details {
                flex: 1;
                min-width: 0;
            }
            
            .sub-task-name {
                font-weight: 600;
                color: var(--text);
                font-size: 0.85rem;
                max-width: 180px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .sub-task-meta {
                font-size: 0.75rem;
                color: var(--text-secondary);
            }
            
            .sub-task-body {
                margin-bottom: 0.75rem;
            }
            
            .sub-task-row {
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
                padding: 0.35rem 0;
                color: var(--text-secondary);
            }
            
            .sub-task-row span:last-child {
                color: var(--text);
                font-weight: 500;
            }
            
            .sub-task-id {
                font-family: monospace;
                font-size: 0.75rem;
            }
            
            .sub-task-cancel {
                width: 100%;
            }
            
            .sub-no-tasks {
                text-align: center;
                color: var(--text-secondary);
                font-size: 0.85rem;
                padding: 2rem 1rem;
            }
            
            /* Warning Box */
            .sub-warning {
                display: flex;
                gap: 0.75rem;
                padding: 1rem;
                background: rgba(245, 158, 11, 0.1);
                border-radius: var(--radius);
                margin: 1rem 0;
            }
            
            .sub-warning i {
                color: #f59e0b;
                font-size: 1.25rem;
                flex-shrink: 0;
            }
            
            .sub-warning-text {
                font-size: 0.8rem;
                color: var(--text-secondary);
                line-height: 1.5;
            }
            
            /* Actions */
            .sub-modal-actions {
                display: flex;
                gap: 0.75rem;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid var(--border);
            }
            
            .sub-modal-actions button {
                flex: 1;
            }
            
            /* Mobile Responsive */
            @media (max-width: 768px) {
                .sub-modal-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }
                
                .sub-modal-section {
                    padding: 1rem;
                }
                
                .sub-plan-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.75rem;
                }
                
                .sub-plan-icon {
                    width: 42px;
                    height: 42px;
                    font-size: 1.1rem;
                }
                
                .sub-stats-grid {
                    grid-template-columns: repeat(3, 1fr);
                    gap: 0.5rem;
                }
                
                .sub-stat-box {
                    padding: 0.6rem 0.4rem;
                }
                
                .sub-stat-value {
                    font-size: 1rem;
                }
                
                .sub-stat-label {
                    font-size: 0.6rem;
                }
                
                .sub-task-name {
                    max-width: 140px;
                }
                
                .sub-task-info {
                    gap: 0.5rem;
                }
                
                .sub-task-icon {
                    width: 32px;
                    height: 32px;
                    font-size: 0.9rem;
                }
                
                .sub-modal-actions {
                    flex-direction: column;
                }
                
                .sub-modal-actions button {
                    width: 100%;
                }
            }
            
            @media (max-width: 480px) {
                .sub-stats-grid {
                    grid-template-columns: 1fr 1fr 1fr;
                }
                
                .sub-detail-row {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.25rem;
                }
                
                .sub-task-header {
                    flex-direction: column;
                    gap: 0.5rem;
                }
            }
        </style>
        
        <div class="sub-modal-content">
            <div class="sub-modal-grid">
                <!-- Hosting Plan Section -->
                <div class="sub-modal-section">
                    <h4 class="sub-section-title"><i class="ri-cloud-line"></i> Hosting Plan</h4>
                    
                    <div class="sub-plan-header">
                        <div class="sub-plan-icon">
                            <i class="${pkg?.icon || 'ri-vip-crown-line'}"></i>
                        </div>
                        <div class="sub-plan-info">
                            <h3 class="sub-plan-name">${pkg?.name || planName} Plan</h3>
                            <p class="sub-plan-type">${isSubscribed ? 'Active Subscription' : 'One-time Purchase'}</p>
                        </div>
                    </div>
                    
                    <div class="sub-stats-grid">
                        <div class="sub-stat-box">
                            <div class="sub-stat-value">${daysLeft}</div>
                            <div class="sub-stat-label">Days Left</div>
                        </div>
                        <div class="sub-stat-box">
                            <div class="sub-stat-value">${currencySymbol}${lastPayment.toFixed(0)}</div>
                            <div class="sub-stat-label">Amount</div>
                        </div>
                        <div class="sub-stat-box">
                            <div class="sub-stat-value"><span class="badge badge-${isSubscribed ? 'success' : 'warning'}" style="font-size: 0.7rem;">${isSubscribed ? 'Active' : 'Inactive'}</span></div>
                            <div class="sub-stat-label">Status</div>
                        </div>
                    </div>
                    
                    <div class="sub-detail-list">
                        ${isSubscribed && subscriptionEnd ? `
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">Next Billing</span>
                            <span class="sub-detail-value">${subscriptionEnd.toLocaleDateString()}</span>
                        </div>
                        ` : ''}
                        ${expiryDate ? `
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">Expires On</span>
                            <span class="sub-detail-value">${expiryDate.toLocaleDateString()}</span>
                        </div>
                        ` : ''}
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">Payment Method</span>
                            <span class="sub-detail-value">${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                        </div>
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">Images Limit</span>
                            <span class="sub-detail-value">${(planData.images_limit || 0).toLocaleString()}</span>
                        </div>
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">Articles Limit</span>
                            <span class="sub-detail-value">${(planData.articles_limit || 0).toLocaleString()}</span>
                        </div>
                        <div class="sub-detail-row">
                            <span class="sub-detail-label">AI Credits</span>
                            <span class="sub-detail-value">${(planData.ai_limit || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    ${isSubscribed ? `
                    <button class="btn btn-danger" style="width: 100%;" onclick="confirmCancelHostingSubscription()">
                        <i class="ri-close-circle-line"></i> Cancel Hosting Subscription
                    </button>
                    ` : `
                    <button class="btn btn-primary" style="width: 100%;" onclick="closeModal(); openPackagePurchaseModal();">
                        <i class="ri-refresh-line"></i> Upgrade Plan
                    </button>
                    `}
                </div>
                
                <!-- Task Subscriptions Section -->
                <div class="sub-modal-section">
                    <h4 class="sub-section-title"><i class="ri-rocket-line"></i> Task Subscriptions (${taskSubscriptions.length})</h4>
                    
                    <div class="sub-tasks-list">
                        ${taskSubscriptionsHtml}
                    </div>
                </div>
            </div>
            
            ${isSubscribed || taskSubscriptions.length > 0 ? `
            <div class="sub-warning">
                <i class="ri-information-line"></i>
                <div class="sub-warning-text">
                    Cancelling a subscription will keep it active until the end of the current billing period. 
                    You won't be charged again after cancellation.
                </div>
            </div>
            ` : ''}
            
            <div class="sub-modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="ri-close-line"></i> Close
                </button>
            </div>
        </div>
    `;
    
    showModal('Subscription Management', modalContent, '700px');
}

// Confirm Cancel Hosting Subscription
async function confirmCancelHostingSubscription() {
    closeModal();
    
    const result = await Swal.fire({
        title: 'Cancel Hosting Subscription?',
        html: `
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Are you sure you want to cancel your hosting subscription?
            </p>
            <p style="color: var(--text-secondary); font-size: 0.875rem;">
                Your plan will remain active until the end of the current billing period.
            </p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: 'var(--bg-tertiary)',
        confirmButtonText: 'Yes, Cancel Subscription',
        cancelButtonText: 'Keep Subscription',
        customClass: { popup: 'swal2-toast' }
    });
    
    if (result.isConfirmed) {
        Swal.fire({
            title: 'Cancelling...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            customClass: { popup: 'swal2-toast' }
        });
        
        try {
            await api('/hosting/cancel-subscription');
            Swal.fire({
                icon: 'success',
                title: 'Subscription Cancelled',
                text: 'Your hosting subscription has been cancelled. You\'ll retain access until the end of your billing period.',
                customClass: { popup: 'swal2-toast' }
            });
            loadBilling(); // Reload the billing page
        } catch (error) {
            console.error('Failed to cancel hosting subscription:', error);
            Swal.fire({
                icon: 'error',
                title: 'Cancellation Failed',
                text: error.message || 'Failed to cancel subscription. Please try again.',
                customClass: { popup: 'swal2-toast' }
            });
        }
    }
}

// Confirm Cancel Task Subscription
async function confirmCancelTaskSubscription(taskId, taskDescription) {
    closeModal();
    
    const result = await Swal.fire({
        title: 'Cancel Task Subscription?',
        html: `
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Are you sure you want to cancel the subscription for:
            </p>
            <p style="color: var(--text); font-weight: 600; margin-bottom: 1rem;">
                ${taskDescription}
            </p>
            <p style="color: var(--text-secondary); font-size: 0.875rem;">
                The task will remain active until the end of the current billing period.
            </p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: 'var(--bg-tertiary)',
        confirmButtonText: 'Yes, Cancel Subscription',
        cancelButtonText: 'Keep Subscription',
        customClass: { popup: 'swal2-toast' }
    });
    
    if (result.isConfirmed) {
        Swal.fire({
            title: 'Cancelling...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            customClass: { popup: 'swal2-toast' }
        });
        
        try {
            await api('/tasks/cancel-subscription', {
                method: 'POST',
                body: JSON.stringify({ task_id: taskId })
            });
            Swal.fire({
                icon: 'success',
                title: 'Task Subscription Cancelled',
                text: 'The task subscription has been cancelled. It will remain active until the end of the billing period.',
                customClass: { popup: 'swal2-toast' }
            });
            loadBilling(); // Reload the billing page
        } catch (error) {
            console.error('Failed to cancel task subscription:', error);
            Swal.fire({
                icon: 'error',
                title: 'Cancellation Failed',
                text: error.message || 'Failed to cancel task subscription. Please try again.',
                customClass: { popup: 'swal2-toast' }
            });
        }
    }
}

// Legacy function for backward compatibility
async function confirmCancelSubscription() {
    await confirmCancelHostingSubscription();
}
// Profile Page
function loadProfile() {
    const user = currentData.user;
    const content = document.getElementById('content');
    content.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Profile Settings</h2>
            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" value="${user.email}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Created</label>
                        <input type="text" class="form-input" value="${new Date(user.created_at).toLocaleDateString()}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hosting Plan</label>
                        <input type="text" class="form-input" value="${user.hosting.type.toUpperCase()}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Plan Expiry</label>
                        <input type="text" class="form-input" value="${new Date(user.hosting.expiry_date).toLocaleDateString()}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Images Uploaded</label>
                        <input type="text" class="form-input" value="${user.hosting.images_uploads}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Articles Published</label>
                        <input type="text" class="form-input" value="${user.hosting.article_uploads}" readonly>
                    </div>
                    <button class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    // Close dropdown
    document.getElementById('userDropdown').classList.remove('active');
}
// Modal Functions
// function showModal(title, content) {
//     document.getElementById('modalTitle').textContent = title;
//     document.getElementById('modalBody').innerHTML = content;
//     document.getElementById('modalOverlay').classList.add('active');
// }
function showModal(title, content, width = '900px') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    const modal = document.querySelector('.modal');
    modal.style.width = width;
    modal.style.maxWidth = '95vw';
    document.getElementById('modalOverlay').classList.add('active');
}
function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    // Reset task creation state
    currentData.selectedLocations = [];
    currentData.selectedKeywords = [];
    currentData.currentStep = 1;
}
function loadWebsitePreview(url) {
    const iframe = document.getElementById('taskPreviewFrame');
    const loader = document.getElementById('websiteLoader');
    const overlay = document.getElementById('xpathOverlay');
    // State
    let selectedElements = [];
    let maxSelections = getPriorityMaxLocations(currentData.taskPriority);
    let zoomLevel = 1;
    let isReady = false;
    let useOverlayMode = false;
    // Reset
    if (!url.startsWith('http')) url = 'https://' + url;
    loader.style.display = 'flex';
    iframe.style.display = 'none';
    overlay.innerHTML = '';
    overlay.style.display = 'none';
    currentData.selectedLocations = [];
    selectedElements = [];
    // Override display functions but let the app handle the header
    window.updateSelectedLocationsDisplay = () => {};
    window.showLocations = () => {};
    // Single display update function - NO HEADER, just content
    function updateDisplay() {
        const container = document.getElementById('selectedLocations');
        if (!container) return;
        const count = selectedElements.length;
        // Update currentData first so the app's header function can read it
        currentData.selectedLocations = [...selectedElements];
        // Find existing header and preserve it, only update the content below it
        const existingHeader = container.querySelector('h4');
        let headerHTML = '';
        if (existingHeader) {
            headerHTML = existingHeader.outerHTML;
        }
        // Only provide the content, no header
        const contentHTML = count === 0 ? `
            <div style="text-align:center;padding:2rem;color:var(--text-secondary)">
                <p>Click on any element in the website preview above.</p>
                <p>You can select up to ${maxSelections} locations for ${currentData.taskPriority} priority.</p>
                <p><small>${useOverlayMode ? 'Using overlay mode' : 'Direct element selection enabled'}</small></p>
            </div>
        ` : `
            ${selectedElements.map((loc, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.75rem;border-left:4px solid var(--success)">
                    <div style="flex:1">
                        <div style="font-weight:600;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem">
                            <span style="background:var(--primary);color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem">${i+1}</span>
                            ${loc.tag ? loc.tag.toUpperCase() + ' Element' : 'Element'}
                            <span style="background:var(--success);color:white;padding:0.2rem 0.4rem;border-radius:4px;font-size:0.7rem">? Selected</span>
                        </div>
                        ${loc.text ? `<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem;padding:0.5rem;background:var(--bg-tertiary);border-radius:4px">"${loc.text}"</div>` : ''}
                        <code style="background:var(--bg);padding:0.5rem;border-radius:4px;font-size:0.75rem;word-break:break-all;display:block;border:1px solid var(--border)">${loc.xpath}</code>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeXPathElement('${loc.id}')" style="margin-left:1rem">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `).join('')}
        `;
        // Clear container and add preserved header + new content
        container.innerHTML = headerHTML + contentHTML;
        updateZoomControls();
    }
    // Enhanced zoom controls
    function updateZoomControls() {
        const previewControls = document.getElementById('preview-controls');
        if (!previewControls) return;
        previewControls.innerHTML = `
            <div class="zoom-controls-container" style="display:flex;gap:6px;align-items:center;justify-content:center;padding:16px;background:linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);border-radius:16px;border:1px solid #e2e8f0;box-shadow:0 4px 12px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);">
                <button id="zoomOutBtn" style="
                    background:linear-gradient(145deg, #ef4444 0%, #dc2626 100%);
                    color:white;
                    border:none;
                    width:42px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-weight:bold;
                    font-size:18px;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(239,68,68,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Zoom Out (Ctrl/Cmd + -)">
                    <span style="z-index:1;">?</span>
                </button>
                <div style="
                    display:flex;
                    align-items:center;
                    padding:0 20px;
                    height:42px;
                    font-size:16px;
                    color:var(--text);
                    min-width:75px;
                    justify-content:center;
                    font-weight:700;
                    background:linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
                    border-radius:10px;
                    border:1px solid #cbd5e1;
                    box-shadow:inset 0 2px 4px rgba(0,0,0,0.06);
                    font-family:monospace;
                ">
                    ${Math.round(zoomLevel * 100)}%
                </div>
                <button id="zoomInBtn" style="
                    background:linear-gradient(145deg, #10b981 0%, #059669 100%);
                    color:white;
                    border:none;
                    width:42px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-weight:bold;
                    font-size:18px;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(16,185,129,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Zoom In (Ctrl/Cmd + +)">
                    <span style="z-index:1;">+</span>
                </button>
                <div style="width:1px;height:24px;background:linear-gradient(to bottom, transparent, #cbd5e1, transparent);margin:0 12px;"></div>
                <button id="zoomResetBtn" style="
                    background:linear-gradient(145deg, #6366f1 0%, #4f46e5 100%);
                    color:white;
                    border:none;
                    padding:0 16px;
                    height:42px;
                    border-radius:12px;
                    cursor:pointer;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:13px;
                    font-weight:600;
                    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow:0 3px 8px rgba(99,102,241,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
                    position:relative;
                    overflow:hidden;
                " title="Reset Zoom (Ctrl/Cmd + 0)">
                    <i class="ri-restart-line" style="margin-right:6px;font-size:14px;"></i>
                    <span>Reset</span>
                </button>
            </div>
        `;
        // Add working event listeners
        document.getElementById('zoomOutBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(zoomLevel - 0.25);
        });
        document.getElementById('zoomInBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(zoomLevel + 0.25);
        });
        document.getElementById('zoomResetBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            setZoom(1);
        });
    }
    function setZoom(scale) {
        zoomLevel = Math.max(0.25, Math.min(4, scale));
        iframe.style.transform = `scale(${zoomLevel})`;
        iframe.style.transformOrigin = '0 0';
        iframe.style.width = `${100/zoomLevel}%`;
        iframe.style.height = `${100/zoomLevel}%`;
        // Update zoom display
        const zoomDisplay = document.querySelector('.zoom-controls-container div[style*="font-family:monospace"]');
        if (zoomDisplay) {
            zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        }
    }
    // Element management
    function addElement(data) {
        if (selectedElements.length >= maxSelections) {
            if (window.showToast) {
                showToast(`Maximum ${maxSelections} selections reached`, 'warning');
            }
            return;
        }
        if (selectedElements.some(el => el.xpath === data.xpath)) {
            return;
        }
        const element = {
            id: data.id || 'xpath_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            xpath: data.xpath,
            text: (data.text || '').slice(0, 50),
            tag: data.tag || 'unknown',
            timestamp: Date.now()
        };
        selectedElements.push(element);
        updateDisplay(); // This will update currentData.selectedLocations
        if (window.showToast) {
            showToast(`Selected ${element.tag ? element.tag.toUpperCase() : 'element'}`, 'success');
        }
    }
    function removeElement(id) {
        const index = selectedElements.findIndex(el => el.id === id);
        if (index === -1) return;
        if (!useOverlayMode) {
            try {
                iframe.contentWindow?.postMessage({ type: 'remove_element', id }, '*');
            } catch (e) {}
        }
        selectedElements.splice(index, 1);
        updateDisplay(); // This will update currentData.selectedLocations
        if (window.showToast) showToast('Element removed', 'info');
    }
    // Message handling
    function handleMessage(event) {
        if (event.source !== iframe.contentWindow) return;
        const { type, data } = event.data;
        switch (type) {
            case 'xpath_selected':
                addElement(data);
                break;
            case 'iframe_ready':
                isReady = true;
                useOverlayMode = false;
                console.log('XPath selector ready - direct mode');
                updateDisplay();
                break;
            case 'fallback_to_overlay':
                useOverlayMode = true;
                setupOverlay();
                console.log('Falling back to overlay mode');
                break;
        }
    }
    // Setup overlay as fallback
    function setupOverlay() {
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            cursor: crosshair;
            display: block;
            background: rgba(59, 130, 246, 0.02);
        `;
        overlay.onclick = (e) => {
            if (selectedElements.length >= maxSelections) return;
            const rect = overlay.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            let xpath;
            if (y < 20) {
                const index = Math.min(8, Math.max(1, Math.floor(x / 12.5) + 1));
                xpath = `/html/body/header//nav//li[${index}]//a[1]`;
            } else if (y > 80) {
                const index = Math.min(6, Math.max(1, Math.floor(x / 16.67) + 1));
                xpath = `/html/body/footer//li[${index}]//a[1]`;
            } else {
                const row = Math.min(4, Math.max(1, Math.floor((y-20) / 15) + 1));
                const col = Math.min(3, Math.max(1, Math.floor((x-15) / 23.33) + 1));
                xpath = `/html/body//main//section[${row}]//div[${col}]//a[1]`;
            }
            addElement({
                xpath: xpath,
                tag: 'element',
                text: 'Overlay selection'
            });
        };
        updateDisplay();
    }
    // Global functions
    window.removeXPathElement = removeElement;
    // Setup iframe
    iframe.src = `https://cors.seotize.workers.dev/?url=${encodeURIComponent(url)}`;
    iframe.setAttribute('scrolling', 'yes');
    iframe.style.cssText = 'width:100%;height:100%;border:none;overflow:auto;';
    window.addEventListener('message', handleMessage);
    iframe.onload = () => {
        loader.style.display = 'none';
        iframe.style.display = 'block';
        setTimeout(() => {
            const script = `
                (function() {
                    console.log('Injecting XPath selector...');
                    try {
                        let selectedElements = new Map();
                        let selectedCount = 0;
                        const maxSelections = ${maxSelections};
                        let isActive = true;
                        document.documentElement.style.overflow = 'auto';
                        document.body.style.overflow = 'auto';
                        document.body.style.height = 'auto';
                        const style = document.createElement('style');
                        style.textContent = \`
                            .xpath-hover {
                                outline: 3px solid #3b82f6 !important;
                                background: rgba(59, 130, 246, 0.1) !important;
                                cursor: crosshair !important;
                            }
                            .xpath-selected {
                                outline: 3px solid #10b981 !important;
                                background: rgba(16, 185, 129, 0.15) !important;
                                position: relative !important;
                            }
                            .xpath-marker {
                                position: absolute !important;
                                top: -12px !important;
                                left: -12px !important;
                                background: #10b981 !important;
                                color: white !important;
                                width: 20px !important;
                                height: 20px !important;
                                border-radius: 50% !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font: bold 11px sans-serif !important;
                                z-index: 999999 !important;
                                border: 2px solid white !important;
                                pointer-events: none !important;
                            }
                            body {
                                overflow: auto !important;
                                height: auto !important;
                                user-select: none !important;
                            }
                        \`;
                        document.head.appendChild(style);
                        function generateXPath(element) {
                            if (element.id && document.querySelectorAll('#' + element.id).length === 1) {
                                return '//*[@id="' + element.id + '"]';
                            }
                            const path = [];
                            let current = element;
                            while (current && current.nodeType === 1 && current !== document.documentElement) {
                                let selector = current.tagName.toLowerCase();
                                if (current.className && typeof current.className === 'string') {
                                    const classes = current.className.trim();
                                    if (classes && !classes.includes('xpath-')) {
                                        selector += '[@class="' + classes + '"]';
                                    }
                                }
                                const siblings = Array.from(current.parentElement?.children || [])
                                    .filter(s => s.tagName === current.tagName);
                                if (siblings.length > 1) {
                                    const index = siblings.indexOf(current) + 1;
                                    if (index > 0) selector += '[' + index + ']';
                                }
                                path.unshift(selector);
                                current = current.parentElement;
                            }
                            return '//' + path.join('/');
                        }
                        function onMouseOver(e) {
                            if (!isActive || selectedElements.has(e.target)) return;
                            document.querySelectorAll('.xpath-hover').forEach(el =>
                                el.classList.remove('xpath-hover')
                            );
                            e.target.classList.add('xpath-hover');
                        }
                        function onMouseOut(e) {
                            if (!isActive) return;
                            e.target.classList.remove('xpath-hover');
                        }
                        function onClick(e) {
                            if (!isActive) return;
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            if (selectedElements.has(e.target)) return false;
                            if (selectedCount >= maxSelections) return false;
                            if (e.target.classList.contains('xpath-marker')) return false;
                            const xpath = generateXPath(e.target);
                            if (!xpath) return false;
                            e.target.classList.remove('xpath-hover');
                            e.target.classList.add('xpath-selected');
                            const marker = document.createElement('div');
                            marker.className = 'xpath-marker';
                            marker.textContent = selectedCount + 1;
                            marker.dataset.id = 'xpath_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            e.target.style.position = 'relative';
                            e.target.appendChild(marker);
                            selectedElements.set(e.target, {
                                id: marker.dataset.id,
                                marker: marker,
                                xpath: xpath
                            });
                            selectedCount++;
                            window.parent.postMessage({
                                type: 'xpath_selected',
                                data: {
                                    id: marker.dataset.id,
                                    xpath: xpath,
                                    text: (e.target.textContent || '').trim().slice(0, 50),
                                    tag: e.target.tagName.toLowerCase()
                                }
                            }, '*');
                            return false;
                        }
                        function onMessage(e) {
                            if (e.data.type === 'remove_element') {
                                for (const [element, data] of selectedElements.entries()) {
                                    if (data.id === e.data.id) {
                                        element.classList.remove('xpath-selected');
                                        if (data.marker) data.marker.remove();
                                        selectedElements.delete(element);
                                        selectedCount--;
                                        let index = 1;
                                        for (const [el, elData] of selectedElements.entries()) {
                                            if (elData.marker) elData.marker.textContent = index++;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        document.addEventListener('mouseover', onMouseOver, { capture: true, passive: true });
                        document.addEventListener('mouseout', onMouseOut, { capture: true, passive: true });
                        document.addEventListener('click', onClick, { capture: true, passive: false });
                        window.addEventListener('message', onMessage);
                        window.xpathCleanup = function() {
                            isActive = false;
                            document.removeEventListener('mouseover', onMouseOver, true);
                            document.removeEventListener('mouseout', onMouseOut, true);
                            document.removeEventListener('click', onClick, true);
                            window.removeEventListener('message', onMessage);
                            selectedElements.forEach(data => {
                                if (data.marker) data.marker.remove();
                            });
                            selectedElements.clear();
                        };
                        window.parent.postMessage({ type: 'iframe_ready' }, '*');
                    } catch (error) {
                        console.error('XPath selector failed:', error);
                        window.parent.postMessage({ type: 'fallback_to_overlay' }, '*');
                    }
                })();
            `;
            try {
                const doc = iframe.contentDocument;
                if (doc && doc.body) {
                    const scriptEl = doc.createElement('script');
                    scriptEl.textContent = script;
                    doc.body.appendChild(scriptEl);
                } else {
                    useOverlayMode = true;
                    setupOverlay();
                }
            } catch (e) {
                useOverlayMode = true;
                setupOverlay();
            }
        }, 1500);
    };
    iframe.onerror = () => {
        loader.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--danger)">Failed to load website</div>';
    };
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    setZoom(zoomLevel + 0.25);
                    break;
                case '-':
                    e.preventDefault();
                    setZoom(zoomLevel - 0.25);
                    break;
                case '0':
                    e.preventDefault();
                    setZoom(1);
                    break;
            }
        }
    });
    // Cleanup
    function cleanup() {
        window.removeEventListener('message', handleMessage);
        try {
            iframe.contentWindow?.postMessage({ type: 'cleanup' }, '*');
        } catch (e) {}
        if (iframe.contentWindow?.xpathCleanup) {
            iframe.contentWindow.xpathCleanup();
        }
        overlay.innerHTML = '';
        overlay.style.display = 'none';
        window.removeXPathElement = null;
    }
    iframe.xpathCleanup = cleanup;
    // Initialize
    updateDisplay();
    updateZoomControls();
    return {
        getSelectedElements: () => [...selectedElements],
        clearSelections: () => {
            selectedElements = [];
            currentData.selectedLocations = [];
            if (!useOverlayMode) {
                try {
                    iframe.contentWindow?.postMessage({ type: 'clear_all' }, '*');
                } catch (e) {}
            }
            overlay.innerHTML = '';
            updateDisplay();
        },
        setZoom,
        destroy: cleanup
    };
}
// Get priority max locations
function getPriorityMaxLocations(priority) {
    const limits = { basic: 1, standard: 3, premium: 5 };
    return limits[priority] || 3;
}
// Generate XPath based on click position
function generateXPath(x, y, index) {
    // Enhanced XPath generation based on click position
    const sections = [
        '/html/body/header//a',
        '/html/body/nav//a',
        '/html/body/main//a',
        '/html/body/section//a',
        '/html/body/aside//a',
        '/html/body/footer//a'
    ];
    let sectionIndex = Math.floor((y / 100) * sections.length);
    if (sectionIndex >= sections.length) sectionIndex = sections.length - 1;
    const elementIndex = Math.max(1, Math.floor((x / 100) * 10) + 1);
    return `${sections[sectionIndex]}[${elementIndex}]`;
}
// Set zoom for website preview
function setZoom(scale) {
    const iframe = document.getElementById('taskPreviewFrame');
    if (iframe) {
        iframe.style.transform = `scale(${scale})`;
        iframe.style.transformOrigin = '0 0';
        iframe.style.width = `${100/scale}%`;
        iframe.style.height = `${100/scale}%`;
    }
}
// Update order summary
function updateOrderSummary() {
    const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
    const priority = currentData.taskPriority;
    const keywordCount = currentData.selectedKeywords.length;
    const locationCount = currentData.selectedLocations.length;
    const paymentType = document.getElementById('paymentType')?.value || 'one-time';
    // Update all order summary elements if they exist
    const orderBudget = document.getElementById('orderBudget');
    const orderPriority = document.getElementById('orderPriority');
    const orderKeywords = document.getElementById('orderKeywords');
    const orderLocations = document.getElementById('orderLocations');
    const orderTotal = document.getElementById('orderTotal');
    if (orderBudget) orderBudget.textContent = `$${budget.toFixed(2)}`;
    if (orderPriority) orderPriority.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
    if (orderKeywords) orderKeywords.textContent = keywordCount;
    if (orderLocations) orderLocations.textContent = locationCount;
    if (orderTotal) orderTotal.textContent = `$${budget.toFixed(2)}${paymentType === 'subscription' ? '/mo' : ''}`;
    console.log('Order summary updated:', { budget, priority, keywordCount, locationCount }); // Debug log
}
// Toggle subscription options
function toggleSubscriptionOptions() {
    const paymentType = document.getElementById('paymentType')?.value;
    const subscriptionOptions = document.getElementById('subscriptionOptions');
    if (subscriptionOptions) {
        if (paymentType === 'subscription') {
            subscriptionOptions.style.display = 'block';
        } else {
            subscriptionOptions.style.display = 'none';
        }
    }
    updateOrderSummary();
}
// SEO Task Creator - New Implementation
let taskCreatorState = {
    currentStep: 1,
    selectedKeywords: [],
    taskPriority: 'standard',
    paymentMethod: 'stripe',
    paymentType: 'subscription',
    pendingTaskUrl: null,
    cancelPrevious: false
};
// Open the new task creator interface
function openSeoTaskCreator() {
    const creator = document.getElementById('seoTaskCreator');
    creator.classList.add('active');
    // Prevent body scrolling on mobile when modal is open
    if (window.innerWidth <= 768) {
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
    }
    resetTaskCreatorState();
    checkForPendingTasks();
}
// Close the task creator
function closeSeoTaskCreator() {
    const creator = document.getElementById('seoTaskCreator');
    creator.classList.remove('active');
    // Re-enable body scrolling
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
    // Reset and clean everything when closing
    resetTaskCreatorState();
    // Reset button state when closing
    const createBtn = document.getElementById('createTaskBtn');
    if (createBtn) {
        createBtn.innerHTML = '<i class="ri-check-line"></i> Create Task';
        createBtn.disabled = false;
    }
}
// Add click handler for backdrop to close modal
document.addEventListener('click', function(event) {
    const creator = document.getElementById('seoTaskCreator');
    if (!creator || !creator.classList.contains('active')) return;
    const container = creator.querySelector('.task-creator-container');
    // If click is on the creator element but not inside the container, it's on the backdrop
    if (event.target === creator) {
        closeSeoTaskCreator();
    }
});
// Handle escape key to close modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const creator = document.getElementById('seoTaskCreator');
        if (creator && creator.classList.contains('active')) {
            closeSeoTaskCreator();
        }
    }
});
// Reset state
function resetTaskCreatorState() {
    taskCreatorState = {
        currentStep: 1,
        selectedKeywords: [],
        taskPriority: 'standard',
        paymentMethod: 'stripe',
        paymentType: 'subscription',
        pendingTaskUrl: null,
        cancelPrevious: false
    };
    // Reset UI
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    document.querySelector('.progress-step[data-step="1"]').classList.add('active');
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('step1').classList.add('active');
    document.getElementById('prevStepBtn').style.display = 'none';
    document.getElementById('nextStepBtn').style.display = 'inline-flex';
    document.getElementById('createTaskBtn').style.display = 'none';
    // Clear form inputs
    document.getElementById('taskUrl').value = '';
    document.getElementById('keywordsInput').value = '';
    document.getElementById('taskBudget').value = '150';
    // Clear selected keywords state
    taskCreatorState.selectedKeywords = [];
    // Reset priority selection
    document.querySelectorAll('.priority-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.priority-option[data-priority="standard"]')?.classList.add('selected');
    // Reset payment type toggle
    document.querySelectorAll('.payment-type-option').forEach(opt => opt.classList.remove('active'));
    document.querySelector('.payment-type-option[data-type="subscription"]')?.classList.add('active');
    // Reset payment method cards
    document.querySelectorAll('.payment-card').forEach(card => card.classList.remove('selected'));
    document.querySelector('.payment-card[data-method="stripe"]')?.classList.add('selected');
    // Show subscription options by default
    const subscriptionOptions = document.getElementById('subscriptionOptions');
    if (subscriptionOptions) {
        subscriptionOptions.style.display = 'block';
    }
    // Reset billing cycle
    const billingCycle = document.getElementById('billingCycle');
    if (billingCycle) {
        billingCycle.value = 'quarterly'; // Set default to quarterly (popular option)
    }
    // Reset billing cycle visual options
    document.querySelectorAll('.billing-option').forEach(opt => opt.classList.remove('selected'));
    // Set quarterly as selected by default
    const quarterlyOption = document.querySelector('.billing-option.billing-popular');
    if (quarterlyOption) {
        quarterlyOption.classList.add('selected');
    }
    // Reset payment method visibility for subscription (only Stripe visible)
    const stripeCard = document.querySelector('.payment-card[data-method="stripe"]');
    const oxapayCard = document.querySelector('.payment-card[data-method="oxapay"]');
    if (stripeCard) stripeCard.style.display = 'block';
    if (oxapayCard) oxapayCard.style.display = 'none';
    // Clear selected keywords
    const selectedKeywordsSection = document.getElementById('selectedKeywordsSection');
    if (selectedKeywordsSection) {
        selectedKeywordsSection.style.display = 'none';
    }
    const selectedKeywordsDisplay = document.getElementById('selectedKeywordsDisplay');
    if (selectedKeywordsDisplay) {
        selectedKeywordsDisplay.innerHTML = '';
    }
    // Clear keyword suggestions (no cache)
    const keywordSuggestions = document.getElementById('keywordSuggestions');
    if (keywordSuggestions) {
        keywordSuggestions.innerHTML = '';
    }
    updateBudgetSummary();
}
// Check for pending tasks
async function checkForPendingTasks() {
    try {
        const response = await api('/get-user');
        if (response && response.billing) {
            const pendingTask = response.billing.tasks?.find(task =>
                task.status === 'pending' &&
                new Date(task.dates.created) > new Date(Date.now() - 24 * 60 * 60 * 1000)
            );
            if (pendingTask) {
                showPendingTaskAlert(pendingTask);
            }
        }
    } catch (error) {
        console.error('Error checking pending tasks:', error);
    }
}
// Show pending task alert
function showPendingTaskAlert(task) {
    const alert = document.getElementById('pendingTaskAlert');
    const details = document.getElementById('pendingTaskDetails');
    taskCreatorState.pendingTaskUrl = task.payment_url;
    details.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
                <strong>Invoice:</strong> ${task.billing_id}
            </div>
            <div>
                <strong>Amount:</strong> $${task.total_payment}
            </div>
            <div>
                <strong>Priority:</strong> ${task.details.priority.name}
            </div>
            <div>
                <strong>Created:</strong> ${new Date(task.dates.created).toLocaleString()}
            </div>
        </div>
    `;
    alert.classList.add('show');
}
// Cancel pending task
async function cancelPendingTask() {
    try {
        // Set cancel_previous to true and retry task creation
        taskCreatorState.cancelPrevious = true;
        document.getElementById('pendingTaskAlert').classList.remove('show');
        showToast('Previous task cancelled. You can now create a new task.', 'success');
    } catch (error) {
        showToast('Failed to cancel task', 'error');
    }
}
// Complete pending payment
function completePendingPayment() {
    if (taskCreatorState.pendingTaskUrl) {
        window.open(taskCreatorState.pendingTaskUrl, '_blank');
        closeSeoTaskCreator();
    }
}
// Navigate to next step
function nextStep() {
    const currentStep = taskCreatorState.currentStep;
    if (currentStep === 1) {
        const url = document.getElementById('taskUrl').value.trim();
        if (!url) {
            showToast('Please enter a valid URL', 'error');
            return;
        }
    } else if (currentStep === 2) {
        if (taskCreatorState.selectedKeywords.length === 0) {
            showToast('Please select at least one keyword', 'error');
            return;
        }
    }
    if (currentStep < 3) {
        goToStep(currentStep + 1);
    }
}
// Navigate to previous step
function previousStep() {
    const currentStep = taskCreatorState.currentStep;
    if (currentStep > 1) {
        goToStep(currentStep - 1);
    }
}
// Go to specific step
function goToStep(step) {
    // Update progress indicators
    document.querySelectorAll('.progress-step').forEach(stepEl => {
        const stepNum = parseInt(stepEl.dataset.step);
        stepEl.classList.remove('active');
        if (stepNum < step) {
            stepEl.classList.add('completed');
        } else if (stepNum === step) {
            stepEl.classList.add('active');
        } else {
            stepEl.classList.remove('completed');
        }
    });
    // Update content
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`step${step}`).classList.add('active');
    // Update navigation buttons
    document.getElementById('prevStepBtn').style.display = step === 1 ? 'none' : 'inline-flex';
    document.getElementById('nextStepBtn').style.display = step === 3 ? 'none' : 'inline-flex';
    document.getElementById('createTaskBtn').style.display = step === 3 ? 'inline-flex' : 'none';
    taskCreatorState.currentStep = step;
    if (step === 3) {
        updateBudgetSummary();
    }
}
// Select priority
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.priority-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.priority-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            taskCreatorState.taskPriority = this.dataset.priority;
            updateBudgetSummary();
        });
    });
});
// Add/Remove keywords
function toggleKeyword(keyword) {
    const index = taskCreatorState.selectedKeywords.indexOf(keyword);
    if (index === -1) {
        taskCreatorState.selectedKeywords.push(keyword);
    } else {
        taskCreatorState.selectedKeywords.splice(index, 1);
    }
    updateSelectedKeywords();
}
// Update selected keywords display
function updateSelectedKeywords() {
    const display = document.getElementById('selectedKeywordsDisplay');
    const section = document.getElementById('selectedKeywordsSection');
    if (taskCreatorState.selectedKeywords.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    display.innerHTML = taskCreatorState.selectedKeywords.map(keyword => `
        <div class="keyword-tag">
            <span class="keyword-tag-text">${keyword}</span>
            <span class="keyword-tag-remove" onclick="removeKeyword('${keyword}')">
                <i class="ri-delete-bin-line"></i>
            </span>
        </div>
    `).join('');
    // Update keyword suggestions to match selected state
    const suggestions = document.querySelectorAll('.keyword-suggestion');
    suggestions.forEach(sugg => {
        const suggText = sugg.textContent.trim();
        if (taskCreatorState.selectedKeywords.includes(suggText)) {
            sugg.classList.add('selected');
        } else {
            sugg.classList.remove('selected');
        }
    });
}
// Remove keyword
function removeKeyword(keyword) {
    const index = taskCreatorState.selectedKeywords.indexOf(keyword);
    if (index > -1) {
        taskCreatorState.selectedKeywords.splice(index, 1);
        updateSelectedKeywords();
        syncKeywordsInput();
        // Update suggestion state
        const suggestions = document.querySelectorAll('.keyword-suggestion');
        suggestions.forEach(sugg => {
            if (sugg.textContent.trim() === keyword) {
                sugg.classList.remove('selected');
            }
        });
    }
}
// Sync keywords input field with selected keywords
function syncKeywordsInput() {
    const keywordsInput = document.getElementById('keywordsInput');
    if (keywordsInput) {
        keywordsInput.value = taskCreatorState.selectedKeywords.join(', ');
    }
}
// Handle manual keyword input
function handleKeywordInput(value) {
    const keywords = value.split(',').map(k => k.trim()).filter(k => k);
    taskCreatorState.selectedKeywords = keywords;
    updateSelectedKeywords();
}
// Generate AI keywords
async function generateAIKeywords() {
    const url = document.getElementById('taskUrl').value;
    const btn = document.getElementById('aiKeywordsBtn');
    if (!url) {
        showToast('Please enter a URL first', 'error');
        return;
    }
    btn.innerHTML = '<i class="ri-loader-line"></i> Generating...';
    btn.disabled = true;
    try {
        // Clear previous suggestions (no cache)
        const container = document.getElementById('keywordSuggestions');
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">Loading suggestions...</div>';
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}&t=${Date.now()}`, {
            headers: { 'Session-Token': sessionToken },
            cache: 'no-cache'
        });
        if (!response.ok) throw new Error('Failed to generate keywords');
        const data = await response.json();
        // Clear and populate with fresh data
        container.innerHTML = (data.keywords || []).slice(0, 15).map(keyword => {
            const isSelected = taskCreatorState.selectedKeywords.includes(keyword);
            return `<div class="keyword-suggestion ${isSelected ? 'selected' : ''}" onclick="toggleSuggestion('${keyword}', this)">
                ${keyword}
            </div>`;
        }).join('');
    } catch (error) {
        const container = document.getElementById('keywordSuggestions');
        container.innerHTML = '';
        showToast('Failed to generate AI keywords', 'error');
    } finally {
        btn.innerHTML = '<i class="ri-magic-line"></i> AI Suggest';
        btn.disabled = false;
    }
}
// Toggle keyword suggestion
function toggleSuggestion(keyword, element) {
    const isSelected = element.classList.contains('selected');
    if (isSelected) {
        element.classList.remove('selected');
        removeKeyword(keyword);
    } else {
        element.classList.add('selected');
        const index = taskCreatorState.selectedKeywords.indexOf(keyword);
        if (index === -1) {
            taskCreatorState.selectedKeywords.push(keyword);
        }
    }
    updateSelectedKeywords();
    syncKeywordsInput();
}
// Handle keywords input
document.addEventListener('DOMContentLoaded', () => {
    const keywordsInput = document.getElementById('keywordsInput');
    if (keywordsInput) {
        // Handle both change and blur events for better sync
        keywordsInput.addEventListener('blur', (e) => {
            const keywords = e.target.value.split(',').map(k => k.trim()).filter(k => k);
            taskCreatorState.selectedKeywords = keywords;
            updateSelectedKeywords();
        });
    }
});
// Select payment type
function selectPaymentType(type) {
    document.querySelectorAll('.payment-type-option').forEach(opt => opt.classList.remove('active'));
    document.querySelector(`.payment-type-option[data-type="${type}"]`).classList.add('active');
    taskCreatorState.paymentType = type;
    const subscriptionOptions = document.getElementById('subscriptionOptions');
    subscriptionOptions.style.display = type === 'subscription' ? 'block' : 'none';
    // Show/hide payment methods based on payment type
    const stripeCard = document.querySelector('.payment-card[data-method="stripe"]');
    const oxapayCard = document.querySelector('.payment-card[data-method="oxapay"]');
    if (type === 'subscription') {
        // Subscription: show only Stripe
        stripeCard.style.display = 'block';
        oxapayCard.style.display = 'none';
        // Set Stripe as default for subscription
        selectPaymentMethod('stripe');
    } else {
        // One-time: show both Stripe and Oxapay
        stripeCard.style.display = 'block';
        oxapayCard.style.display = 'block';
        // Set Stripe as default for one-time (or keep current if already selected)
        if (taskCreatorState.paymentMethod !== 'stripe' && taskCreatorState.paymentMethod !== 'oxapay') {
            selectPaymentMethod('stripe');
        }
    }
    updateBudgetSummary();
}
// Select payment method
function selectPaymentMethod(method) {
    document.querySelectorAll('.payment-card').forEach(card => card.classList.remove('selected'));
    document.querySelector(`.payment-card[data-method="${method}"]`).classList.add('selected');
    taskCreatorState.paymentMethod = method;
    updateBudgetSummary();
}
// Select billing cycle
function selectBillingCycle(cycle, element) {
    // Remove selected class from all billing options
    document.querySelectorAll('.billing-option').forEach(opt => opt.classList.remove('selected'));
    // Add selected class to clicked option
    element.classList.add('selected');
    // Update the hidden select element
    document.getElementById('billingCycle').value = cycle;
    // Update budget summary to reflect new billing cycle
    updateBudgetSummary();
}
// Update budget summary
function updateBudgetSummary() {
    const budget = parseFloat(document.getElementById('taskBudget').value || 150);
    const priority = taskCreatorState.taskPriority;
    const rates = { basic: 0.10, standard: 0.12, premium: 0.15 };
    const rate = rates[priority] || 0.12;
    const estimatedClicks = Math.floor(budget / rate);
    // Get billing cycle for subscription
    const billingCycle = document.getElementById('billingCycle')?.value || 'monthly';
    const billingMultipliers = { monthly: 1, quarterly: 3, yearly: 12 };
    const multiplier = taskCreatorState.paymentType === 'subscription' ? billingMultipliers[billingCycle] : 1;
    // Calculate fees
    const providerFeeRate = taskCreatorState.paymentMethod === 'stripe' ? 0.029 : 0.015;
    const providerFixedFee = taskCreatorState.paymentMethod === 'stripe' ? 0.30 : 0;
    const platformFeeRate = 0.05;
    const monthlyProviderFee = (budget * providerFeeRate) + providerFixedFee;
    const monthlyPlatformFee = budget * platformFeeRate;
    const monthlyFinalAmount = budget - monthlyProviderFee - monthlyPlatformFee;
    // Calculate totals based on billing period
    const totalProviderFee = monthlyProviderFee * multiplier;
    const totalPlatformFee = monthlyPlatformFee * multiplier;
    const totalFinalAmount = monthlyFinalAmount * multiplier;
    document.getElementById('estimatedClicks').value = estimatedClicks.toLocaleString();
    // Update fee displays with period info
    const providerFeeElem = document.getElementById('providerFee');
    const platformFeeElem = document.getElementById('platformFee');
    const finalAmountElem = document.getElementById('finalAmount');
    if (taskCreatorState.paymentType === 'subscription' && multiplier > 1) {
        const periodText = multiplier === 3 ? '3 month' : (multiplier === 12 ? '12 month' : `${multiplier} month`);
        providerFeeElem.innerHTML = `$${totalProviderFee.toFixed(2)}<div class="budget-summary-period">${periodText}</div>`;
        platformFeeElem.innerHTML = `$${totalPlatformFee.toFixed(2)}<div class="budget-summary-period">${periodText}</div>`;
        finalAmountElem.innerHTML = `$${totalFinalAmount.toFixed(2)}<div class="budget-summary-period">${periodText}</div>`;
    } else {
        providerFeeElem.innerHTML = `$${monthlyProviderFee.toFixed(2)}`;
        platformFeeElem.innerHTML = `$${monthlyPlatformFee.toFixed(2)}`;
        finalAmountElem.innerHTML = `$${monthlyFinalAmount.toFixed(2)}`;
    }
}
// Create SEO Task
async function createSeoTask(isRetry = false) {
    const url = document.getElementById('taskUrl').value.trim();
    const budget = parseFloat(document.getElementById('taskBudget').value);
    const keywords = taskCreatorState.selectedKeywords;
    const paymentMethod = taskCreatorState.paymentMethod;
    const paymentType = taskCreatorState.paymentType;
    const billingCycle = document.getElementById('billingCycle')?.value;
    // Validation
    if (!url || !/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(url)) {
        return showToast('Please enter a valid URL', 'error');
    }
    if (!keywords.length) {
        return showToast('Please add at least one keyword', 'error');
    }
    if (!budget || budget < 10) {
        return showToast('Minimum budget is $10', 'error');
    }
    // Determine HTML locations based on priority
    const locationCounts = { basic: 1, standard: 3, premium: 5 };
    const htmlLocations = Array(locationCounts[taskCreatorState.taskPriority]).fill('-');
    const taskData = {
        task_details: {
            url: url.startsWith('http') ? url : `https://${url}`,
            keywords: keywords,
            html_locations: htmlLocations
        },
        task_priority: taskCreatorState.taskPriority,
        total_charge: budget,
        payment_method: paymentMethod,
        is_subscription: paymentType === 'subscription',
        cancel_previous: taskCreatorState.cancelPrevious || false
    };
    if (taskData.is_subscription && billingCycle) {
        taskData.billing_cycle = billingCycle;
    }
    // Show loading state only on first attempt
    const createBtn = document.getElementById('createTaskBtn');
    if (!isRetry) {
        createBtn.innerHTML = '<i class="ri-loader-line"></i> Creating...';
        createBtn.disabled = true;
    }
    try {
        const response = await api('/add-task', {
            method: 'POST',
            body: JSON.stringify(taskData)
        });
        // Reset cancel_previous flag after successful creation
        taskCreatorState.cancelPrevious = false;
        if (response.data?.payment_url) {
            window.open(response.data.payment_url, '_blank');
            closeSeoTaskCreator();
            showToast('Task created! Complete payment to activate.', 'success');
            loadTasks();
        } else {
            closeSeoTaskCreator();
            showToast('Task created successfully!', 'success');
            loadTasks();
        }
        // Reset button state after success
        createBtn.innerHTML = '<i class="ri-check-line"></i> Create Task';
        createBtn.disabled = false;
    } catch (error) {
        // Handle 409 error - Pending task exists
        if (error.code === 409 || (error.data && error.data.error && error.data.error.code === 409)) {
            const errorMessage = error.message || error.data?.error?.message || 'Pending task exists';
            // Always reset button state first
            createBtn.innerHTML = '<i class="ri-check-line"></i> Create Task';
            createBtn.disabled = false;
            // Show confirmation dialog for cancelling previous task
            const result = await Swal.fire({
                title: 'Pending Payment Active',
                text: 'You have a pending payment that needs to be completed. Would you like to cancel it and create a new task?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Cancel & Create New',
                cancelButtonText: 'No, Keep Existing'
            });
            if (result.isConfirmed) {
                // Set cancel_previous to true and retry
                taskCreatorState.cancelPrevious = true;
                // Show loading state again and retry
                createBtn.innerHTML = '<i class="ri-loader-line"></i> Creating...';
                createBtn.disabled = true;
                // Retry the task creation
                createSeoTask(true);
                return; // Don't close modal or reset state yet
            } else {
                // User chose not to cancel the pending task
                taskCreatorState.cancelPrevious = false;
                // Close the task creator
                closeSeoTaskCreator();
                showToast('Please complete your pending payment first.', 'info');
                // Optionally, you could redirect to pending payments or show them
                checkForPendingTasks();
            }
        } else {
            // Any other error
            showToast(error.message || 'Failed to create task', 'error');
            // Reset button state on error
            createBtn.innerHTML = '<i class="ri-check-line"></i> Create Task';
            createBtn.disabled = false;
        }
    }
}
// Keep the old function for compatibility but redirect to new interface
async function showTaskModal() {
    openSeoTaskCreator();
}
// [NEW] Rebuilt Task Details Modal using SweetAlert2
async function viewTaskDetails(taskId) {
    try {
        const response = await api('/get-task-details', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });
        const task = response.data;
        // --- 1. Process Data (All original logic preserved) ---
        const totalCharge = task.total_charge || 0;
        const availableCharge = task.available_charge || 0;
        const usedCharge = Math.max(0, totalCharge - availableCharge);
        const usedPercentageRaw = totalCharge > 0 ? (usedCharge / totalCharge) * 100 : 0;
        const usedPercentage = Math.max(0, Math.min(100, usedPercentageRaw));
        const remainingPercentageRaw = totalCharge > 0 ? (availableCharge / totalCharge) * 100 : 0;
        const remainingPercentageLabel = Math.max(0, remainingPercentageRaw);
        // Keep the bar visually consistent (always sums to 100%)
        const remainingPercentage = Math.max(0, Math.min(100, 100 - usedPercentage));
        const remainingFillColor =
            remainingPercentageLabel >= 50 ? 'var(--success)' :
            remainingPercentageLabel >= 20 ? 'var(--warning)' :
            'var(--error)';
        const priorityRate = parseFloat(task.task_priority) || 0.12;
        const priorityName = priorityRate <= 0.10 ? 'Basic' : priorityRate <= 0.12 ? 'Standard' : 'Premium';
        const priorityBadge = priorityName === 'Basic' ? 'warning' : priorityName === 'Standard' ? 'primary' : 'success';
        const viewsByDate = task.views_by_date || {};
        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
        const totalViews = Object.values(viewsByDate).reduce((sum, views) => sum + views, 0);
        const hasViewsAnalytics = sortedDates.length > 0;
        // Lightweight breakdown stats (no "daily" list)
        const daysTracked = sortedDates.length;
        const avgViewsPerDay = daysTracked > 0 ? (totalViews / daysTracked) : 0;
        const last7 = sortedDates.slice(-7);
        const last7Views = last7.reduce((sum, [, v]) => sum + (v || 0), 0);
        const bestEntry = sortedDates.reduce((best, cur) => (cur[1] > (best?.[1] ?? -Infinity) ? cur : best), null);
        const bestDayLabel = bestEntry?.[0]
            ? new Date(bestEntry[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            : '—';
        const bestDayViews = bestEntry?.[1] ?? 0;
        const countryVisits = task.country_visits || {};
        const hasAnyAnalytics = hasViewsAnalytics || Object.keys(countryVisits).length > 0;
        const totalCountryVisits = Object.values(countryVisits).reduce((sum, v) => sum + (Number(v) || 0), 0);
        const countryBuckets = Object.keys(countryVisits || {}).length;
        const topCountryChips = Object.entries(countryVisits)
            .sort((a, b) => (Number(b[1]) || 0) - (Number(a[1]) || 0))
            .slice(0, 6)
            .map(([cc, v]) => {
                const label = String(cc || 'Unknown');
                const nice = (label.toLowerCase() === 'unknown') ? 'Unknown' : label.toUpperCase();
                return `<div class="chip"><span>${nice}</span>${formatNumber(Number(v) || 0)}</div>`;
            })
            .join('');
        const mapSummaryChips = `
            <div class="chip"><span>Total</span>${formatNumber(totalCountryVisits)}</div>
            <div class="chip"><span>Countries</span>${formatNumber(countryBuckets)}</div>
        `;
        // --- 2. Construct Modal HTML (New Responsive Layout) ---
        const isVerified = task.verified !== false;
        const verificationStatus = isVerified ?
            '<span class="badge badge-success"><i class="ri-checkbox-circle-line"></i> Verified</span>' :
            '<span class="badge badge-danger"><i class="ri-error-warning-line"></i> Not Verified</span>';
        const lastVerifiedText = task.last_verified ?
            `<span><i class="ri-time-line"></i> Last Verified: ${new Date(task.last_verified).toLocaleString()}</span>` : '';
        // Done parts (More details)
        const donePartsRaw = task.done_parts ?? task.doneParts ?? task.done_parts_list ?? task.donePartsList ?? null;
        const doneParts = Array.isArray(donePartsRaw)
            ? donePartsRaw
            : (donePartsRaw && typeof donePartsRaw === 'object')
                ? Object.entries(donePartsRaw).map(([k, v]) => ({ key: k, value: v }))
                : [];
        const donePartsNormalized = (() => {
            const arr = Array.isArray(doneParts) ? doneParts : [];
            const out = [];
            for (let i = 0; i < arr.length; i++) {
                const p = arr[i];
                if (p == null) continue;
                if (typeof p === 'string' || typeof p === 'number' || typeof p === 'boolean') {
                    out.push({ country_code: '—', partner_email: '—', time: String(p) });
                    continue;
                }
                if (typeof p === 'object') {
                    // Preferred API shape: {country_code, partner_email, time}
                    const cc = p.country_code ?? p.countryCode ?? p.country ?? p.cc ?? p.location ?? '';
                    const email = p.partner_email ?? p.partnerEmail ?? p.email ?? p.user_email ?? '';
                    const time = p.time ?? p.date ?? p.at ?? p.created_at ?? p.createdAt ?? '';
                    if (cc || email || time) {
                        out.push({
                            country_code: String(cc || 'Unknown'),
                            partner_email: String(email || '—'),
                            time: String(time || '—')
                        });
                        continue;
                    }
                    // Fallback for key/value objects
                    if ('key' in p && 'value' in p) {
                        const v = (typeof p.value === 'object') ? JSON.stringify(p.value) : String(p.value);
                        out.push({ country_code: '—', partner_email: String(p.key || '—'), time: v || '—' });
                        continue;
                    }
                    // Last-resort stringify
                    out.push({ country_code: '—', partner_email: '—', time: JSON.stringify(p) });
                }
            }
            return out;
        })();
        const donePartsHtml = (() => {
            if (!donePartsNormalized || donePartsNormalized.length === 0) {
                return `
                    <div class="empty-state" style="padding: 1rem 0;">
                        <div class="empty-state-icon"><i class="ri-list-check-2"></i></div>
                        <div class="empty-state-title" style="font-size: 1.2rem;">No details yet</div>
                        <p class="empty-state-description">Completed steps will appear here once the task starts processing.</p>
                    </div>
                `;
            }
            return `
                <div class="task-done-table-wrap">
                    <div class="task-done-cards" id="taskDonePartsList" role="list" aria-label="Done parts activity log"></div>
                    <div class="task-done-pager" id="taskDonePartsPager"></div>
                </div>
            `;
        })();
        const modalHtml = `
        <div class="task-details-modal-container">
            <div class="task-modal-header">
                <div class="task-modal-header-row">
                    <div class="task-modal-title">
                        <h3>
                            <a class="task-modal-url-pill" href="${task.url}" target="_blank" rel="noopener noreferrer">
                                <span>${task.url}</span>
                                <i class="ri-external-link-line"></i>
                            </a>
                        </h3>
                    </div>
                    <div class="task-modal-actions-slot" aria-label="Task actions"></div>
                </div>
                <div class="header-meta">
                    <div class="header-meta-left">
                        <span><i class="ri-calendar-line"></i> Created: ${new Date(task.date_created).toLocaleString()}</span>
                        ${task.email ? `<span><i class="ri-mail-line"></i> Email: ${task.email}</span>` : ''}
                        <span><i class="ri-key-line"></i> ID: ${task._id}</span>
                        <span style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                            <span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="ri-shield-check-line"></i> Status: ${verificationStatus}</span>
                            ${!isVerified ? `<button class="btn task-verify-inline-btn" onclick="Swal.close(); verifyTask('${task._id}')"><i class="ri-shield-check-line"></i> Verify</button>` : ''}
                        </span>
                        ${lastVerifiedText}
                    </div>
                </div>
            </div>
            <div class="task-modal-stat-grid" aria-label="Quick stats">
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--success);">$${availableCharge.toFixed(2)}</div>
                    <div class="stat-label">Available Budget</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--primary);">${formatNumber(totalViews)}</div>
                    <div class="stat-label">Total Views</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--info);">${avgViewsPerDay.toFixed(1)}</div>
                    <div class="stat-label">Avg Views / Day</div>
                </div>
                <div class="task-modal-stat-card">
                    <div class="stat-value" style="color: var(--text);">${formatNumber(last7Views)}</div>
                    <div class="stat-label">Views (Last 7d)</div>
                </div>
            </div>
            <div class="task-budget-actions">
                <div class="task-budget-top">
                    <div class="task-budget-label">Budget Remaining</div>
                    <div class="task-budget-meta">
                        <span class="task-budget-amount">$${availableCharge.toFixed(2)}</span>
                        <span class="task-budget-percent">${remainingPercentageLabel.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="progress-bar" style="height: 10px;">
                    <div class="progress-fill" style="width: ${remainingPercentage}%; background: ${remainingFillColor};"></div>
                </div>
                <button class="task-modal-recharge-btn" type="button" onclick="Swal.close(); rechargeTask('${task._id}')">
                    <i class="ri-wallet-3-line"></i> Recharge
                </button>
            </div>
            <div class="task-modal-tabs" role="tablist" aria-label="Task details sections">
                <button class="task-modal-tab" type="button" data-tab="analytics" role="tab" aria-controls="task-panel-analytics">
                    <i class="ri-line-chart-line"></i>
                    <span class="label-desktop">Analytics</span>
                    <span class="label-mobile">View Analytics</span>
                </button>
                <button class="task-modal-tab" type="button" data-tab="details" role="tab" aria-controls="task-panel-details">
                    <i class="ri-list-check-2"></i>
                    <span class="label-desktop">More details</span>
                    <span class="label-mobile">More details</span>
                </button>
                <button class="task-modal-tab" type="button" data-tab="config" role="tab" aria-controls="task-panel-config">
                    <i class="ri-settings-3-line"></i>
                    <span class="label-desktop">Configuration</span>
                    <span class="label-mobile">Config</span>
                </button>
            </div>
            <div class="task-modal-panels">
                <div class="task-modal-panel" id="task-panel-analytics" data-panel="analytics" role="tabpanel">
                    <div class="analytics-mobile-switch" role="tablist" aria-label="Analytics view toggle">
                        <button class="analytics-switch-btn active" type="button" data-view="analytics" role="tab" aria-selected="true">
                            <i class="ri-line-chart-line"></i>
                            <span>View Analytics</span>
                        </button>
                        <button class="analytics-switch-btn" type="button" data-view="map" role="tab" aria-selected="false">
                            <i class="ri-map-2-line"></i>
                            <span>Traffic Map</span>
                        </button>
                    </div>
                    <div class="task-modal-grid">
                        <div class="task-modal-section analytics-section" data-analytics-view="analytics">
                            <h3 class="task-modal-section-title" style="color: var(--primary);"><i class="ri-line-chart-line"></i>View Analytics</h3>
                            ${hasViewsAnalytics ? `
                                <div class="task-modal-chart-stack">
                                    <div class="task-modal-chart-wrap"><canvas id="taskViewsTimelineChart"></canvas></div>
                                    <div class="task-modal-chart-wrap small"><canvas id="taskViewsTrendChart"></canvas></div>
                                </div>
                            ` : `
                                <div class="empty-state" style="padding: 1rem 0;">
                                    <div class="empty-state-icon"><i class="ri-bar-chart-line"></i></div>
                                    <div class="empty-state-title" style="font-size: 1.2rem;">No Analytics Yet</div>
                                    <p class="empty-state-description">View data will appear here once the campaign receives traffic.</p>
                                </div>
                            `}
                        </div>
                        <div class="task-modal-section map-section" data-analytics-view="map">
                            <h3 class="task-modal-section-title" style="color: var(--info);"><i class="ri-map-2-line"></i>Traffic Map</h3>
                            <div class="task-modal-map" id="taskCountryMap"></div>
                            <div class="task-modal-subtitle">Top Countries</div>
                            <div class="task-modal-map-note">
                                ${(Object.keys(countryVisits || {}).length > 0)
                                    ? (mapSummaryChips + topCountryChips)
                                    : '<div class="chip"><span>—</span>No country data</div>'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="task-modal-panel" id="task-panel-details" data-panel="details" role="tabpanel">
                    <div class="task-modal-section">
                        <h3 class="task-modal-section-title" style="color: var(--primary);">
                            <i class="ri-list-check-2"></i>More details
                        </h3>
                        <div class="task-modal-subtitle">Done parts (activity log)</div>
                        ${donePartsHtml}
                    </div>
                </div>
                <div class="task-modal-panel" id="task-panel-config" data-panel="config" role="tabpanel">
                  <div class="task-modal-section">
                  <h3 class="task-modal-section-title" style="color: var(--info);">
                    <i class="ri-settings-3-line"></i>Configuration
                  </h3>
                  <div style="font-size: 0.9rem; line-height: 2;">
                    <p>
                      <strong>Priority:</strong>
                      <span class="badge badge-${priorityBadge}">${priorityName}</span>
                      ($${priorityRate.toFixed(3)}/click)
                    </p>
                    <p><strong>Keywords:</strong></p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: -0.5rem;">
                      ${(task.keywords || []).map(k => `<span class="badge badge-primary">${k}</span>`).join('')}
                    </div>
                    ${task.sitekey ? `
                      <div class="task-install-instructions">
                        <p><strong>Installation Instruction:</strong></p>
                        <p>Add the following code into your website's &lt;head&gt; section, right before &lt;/head&gt;:</p>
                        <code id="install-code-${task._id}">&lt;script type="text/javascript" src="https://seotize.net/seotize-engine.js?id=${task.sitekey}"&gt;&lt;/script&gt;</code>
                        <button class="task-copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('install-code-${task._id}').innerText)">Copy Code</button>
                      </div>
                    ` : ''}
                  </div>
                </div>
                </div>
            </div>
        </div>
        `;
        // --- 3. Fire SweetAlert2 Modal ---
        const modalConfig = {
            html: modalHtml,
            showCloseButton: true,
            width: 'min(1100px, 96vw)',
            padding: '1.5rem',
            customClass: {
                popup: 'task-details-swal',
                closeButton: 'swal2-close'
            },
            showClass: { popup: 'swal2-show-super-fast' },
            hideClass: { popup: 'swal2-hide-super-fast' },
            didOpen: () => {
                // Move SweetAlert2 action buttons up next to the URL (header)
                try {
                    const popup = Swal.getPopup();
                    const actions = popup?.querySelector('.swal2-actions');
                    const slot = popup?.querySelector('.task-modal-actions-slot');
                    if (actions && slot) slot.appendChild(actions);
                } catch (e) {
                    // no-op
                }
                setupTaskDetailsTabs({ hasAnalytics: hasAnyAnalytics });
                attachTaskModalTabAutoIconOnly(Swal.getPopup());
                initializeTaskDoneParts(donePartsNormalized);
                // Charts + Map (Analytics + Country visits)
                if (hasViewsAnalytics) initializeTaskAnalyticsCharts(sortedDates);
                initializeTaskCountryMap(countryVisits);
            },
            willClose: () => {
                // Best-effort cleanup (charts + map root) to avoid leaks on repeated opens
                try {
                    if (window.charts?.taskModalTimeline) { window.charts.taskModalTimeline.destroy(); window.charts.taskModalTimeline = null; }
                    if (window.charts?.taskModalTrend) { window.charts.taskModalTrend.destroy(); window.charts.taskModalTrend = null; }
                } catch (_) {}
                try {
                    const popup = Swal.getPopup();
                    if (popup?.__tabLabelAbort) {
                        popup.__tabLabelAbort.abort();
                        popup.__tabLabelAbort = null;
                    }
                } catch (_) {}
                try {
                    const popup = Swal.getPopup();
                    const mapEl = popup?.querySelector('#taskCountryMap');
                    if (mapEl?.__am5root && !mapEl.__am5root.isDisposed()) {
                        mapEl.__am5root.dispose();
                        mapEl.__am5root = null;
                    }
                } catch (_) {}
            },
            showDenyButton: false,
            showCancelButton: false,
            showConfirmButton: false,
        };
        Swal.fire(modalConfig);
    } catch (error) {
        console.error('Task details error:', error);
        showToast('Failed to load task details', 'error');
    }
}
function setupTaskDetailsTabs({ hasAnalytics }) {
    const popup = Swal.getPopup();
    if (!popup) return;
    const tabs = Array.from(popup.querySelectorAll('.task-modal-tab'));
    const panels = Array.from(popup.querySelectorAll('.task-modal-panel'));
    if (tabs.length === 0 || panels.length === 0) return;
    const analyticsTab = tabs.find(t => t.dataset.tab === 'analytics');
    if (analyticsTab && !hasAnalytics) {
        analyticsTab.disabled = true;
        analyticsTab.title = 'Analytics will appear once the campaign receives traffic.';
    }
    const activate = (name) => {
        tabs.forEach(btn => {
            const isActive = btn.dataset.tab === name;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });
        panels.forEach(panel => {
            const isPanelActive = panel.dataset.panel === name;
            if (isPanelActive) {
                panel.removeAttribute('hidden');
                // Trigger a tiny fade/slide-in for polish
                panel.classList.remove('panel-in');
                panel.offsetWidth; // force reflow
                panel.classList.add('panel-in');
            } else {
                panel.setAttribute('hidden', '');
            }
        });
    };
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.disabled) return;
            activate(btn.dataset.tab);
        });
    });
    activate(hasAnalytics ? 'analytics' : 'details');
    // Setup mobile analytics/map switch
    setupAnalyticsMobileSwitch(popup);
}
function setupAnalyticsMobileSwitch(popup) {
    if (!popup) return;
    const switchContainer = popup.querySelector('.analytics-mobile-switch');
    if (!switchContainer) return;
    const switchBtns = Array.from(switchContainer.querySelectorAll('.analytics-switch-btn'));
    const analyticsSection = popup.querySelector('.analytics-section');
    const mapSection = popup.querySelector('.map-section');
    if (switchBtns.length === 0 || !analyticsSection || !mapSection) return;
    const activateView = (viewName) => {
        switchBtns.forEach(btn => {
            const isActive = btn.dataset.view === viewName;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        if (viewName === 'analytics') {
            analyticsSection.classList.add('active');
            mapSection.classList.remove('active');
        } else {
            analyticsSection.classList.remove('active');
            mapSection.classList.add('active');
        }
    };
    switchBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            activateView(btn.dataset.view);
        });
    });
    // Default to analytics view
    activateView('analytics');
}
function attachTaskModalTabAutoIconOnly(popup) {
    const root = popup || Swal.getPopup();
    if (!root) return;
    // Prevent stacking listeners on repeated opens
    try {
        if (root.__tabLabelAbort) root.__tabLabelAbort.abort();
    } catch (_) {}
    const ac = new AbortController();
    root.__tabLabelAbort = ac;
    const apply = () => {
        const tabs = Array.from(root.querySelectorAll('.task-modal-tab'));
        if (tabs.length === 0) return;
        tabs.forEach((tab) => {
            // Measure with labels visible to avoid toggling loops
            const hadIconOnly = tab.classList.contains('icon-only');
            if (hadIconOnly) tab.classList.remove('icon-only');
            // If the tab content overflows, we switch to icon-only.
            // This handles both "wrap to two lines" and "overflow" cases.
            const overflow = (tab.scrollWidth - tab.clientWidth) > 2;
            // Extra safety: detect multi-line label if any label is visible
            const label = tab.querySelector('.label-desktop') || tab.querySelector('.label-mobile');
            let wraps = false;
            try {
                if (label && label.getClientRects) wraps = label.getClientRects().length > 1;
            } catch (_) {}
            tab.classList.toggle('icon-only', overflow || wraps);
        });
    };
    // Run after layout settles
    setTimeout(apply, 0);
    setTimeout(apply, 50);
    window.addEventListener('resize', apply, { passive: true, signal: ac.signal });
    // Also observe the tabs row itself for size changes inside SweetAlert2
    try {
        const tabsWrap = root.querySelector('.task-modal-tabs');
        if (tabsWrap && window.ResizeObserver) {
            const ro = new ResizeObserver(() => apply());
            ro.observe(tabsWrap);
            ac.signal.addEventListener('abort', () => ro.disconnect(), { once: true });
        }
    } catch (_) {}
}
// Task details modal: Done parts table + pagination (task.done_parts)
function initializeTaskDoneParts(donePartsNormalized) {
    const popup = Swal.getPopup();
    if (!popup) return;
    const list = popup.querySelector('#taskDonePartsList');
    const pager = popup.querySelector('#taskDonePartsPager');
    if (!list || !pager) return;
    const escapeHtml = (s) => String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    const parseApiDate = (value) => {
        const s = String(value ?? '').trim();
        if (!s) return null;
        // API often returns "YYYY-MM-DD HH:mm:ss" -> make it ISO-ish for parsing
        const iso = s.includes('T') ? s : s.replace(' ', 'T');
        const d = new Date(iso);
        if (!isNaN(d.getTime())) return d;
        return null;
    };
    const baseRows = Array.isArray(donePartsNormalized) ? donePartsNormalized : [];
    const rows = baseRows
        .map((r, idx) => ({ ...r, __idx: idx }))
        .sort((a, b) => {
            const ad = parseApiDate(a.time);
            const bd = parseApiDate(b.time);
            const am = ad ? ad.getTime() : -Infinity;
            const bm = bd ? bd.getTime() : -Infinity;
            if (bm !== am) return bm - am; // newest first
            return a.__idx - b.__idx;
        });
    const perPage = 9;
    const total = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / perPage));
    let currentPage = 1;
    const render = (page) => {
        currentPage = Math.max(1, Math.min(totalPages, Number(page) || 1));
        const start = (currentPage - 1) * perPage;
        const slice = rows.slice(start, start + perPage);
        const flagEmojiFromCC = (cc) => {
            const raw = String(cc ?? '').trim().toUpperCase();
            const normalized = (raw === 'UK') ? 'GB' : raw;
            if (!/^[A-Z]{2}$/.test(normalized)) return '🌐';
            const A = 0x1F1E6;
            const base = 'A'.charCodeAt(0);
            const c1 = normalized.charCodeAt(0) - base;
            const c2 = normalized.charCodeAt(1) - base;
            return String.fromCodePoint(A + c1, A + c2);
        };
        list.innerHTML = slice.map((r, i) => {
            const idx = start + i + 1;
            const ccRaw = String(r.country_code ?? 'Unknown');
            const cc = (ccRaw || '').toLowerCase() === 'unknown' ? 'Unknown' : ccRaw.toUpperCase();
            const email = String(r.partner_email ?? '—');
            const timeRaw = String(r.time ?? '—');
            const dt = parseApiDate(timeRaw);
            const timePretty = dt ? dt.toLocaleString() : timeRaw;
            const mailto = (email && email !== '—') ? `mailto:${encodeURIComponent(email)}` : '';
            const flag = flagEmojiFromCC(cc);
            return `
                <div class="task-done-card" role="listitem">
                    <div class="task-done-card-top">
                        <div class="left">
                            <span class="task-done-idx">#${idx}</span>
                            <span class="task-done-time" title="${escapeHtml(dt ? timeRaw : timePretty)}">${escapeHtml(timePretty)}</span>
                        </div>
                        <span class="country-badge" title="${escapeHtml(cc)}">
                            <span class="country-flag" aria-hidden="true">${escapeHtml(flag)}</span>
                            <span class="country-text">${escapeHtml(cc)}</span>
                        </span>
                    </div>
                    <div class="task-done-kv">
                        <div class="label">Email</div>
                        <div class="value">
                            ${mailto
                                ? `<a class="task-email" href="${mailto}" target="_blank" rel="noopener noreferrer">${escapeHtml(email)}</a>`
                                : `<span class="muted">—</span>`}
                        </div>
                    </div>
                    <div class="task-done-rawtime">
                        <i class="ri-time-line" aria-hidden="true"></i>
                        <span title="${escapeHtml(dt ? timeRaw : timePretty)}">${escapeHtml(timePretty)}</span>
                    </div>
                </div>
            `;
        }).join('');
        if (slice.length === 0) {
            list.innerHTML = `<div class="muted" style="padding: 0.85rem;">No done parts yet.</div>`;
        }
        const makeBtn = (label, pageNum, opts = {}) => {
            const disabled = opts.disabled ? 'disabled' : '';
            const active = opts.active ? 'active' : '';
            const kind = opts.kind || 'page';
            const classes = ['task-done-page-btn', kind === 'nav' ? 'nav' : 'page'];
            if (active) classes.push('active');
            const aria = opts.ariaLabel ? `aria-label="${String(opts.ariaLabel).replace(/"/g, '&quot;')}"` : '';
            return `<button type="button" ${aria} ${disabled} class="${classes.join(' ')}" data-page="${pageNum}">${label}</button>`;
        };
        // Responsive page buttons - show more buttons based on screen width
        const pageBtns = [];
        const screenWidth = window.innerWidth;
        // Calculate max buttons based on available space
        let maxBtns;
        if (screenWidth >= 900) maxBtns = 11;
        else if (screenWidth >= 700) maxBtns = 9;
        else if (screenWidth >= 550) maxBtns = 7;
        else if (screenWidth >= 400) maxBtns = 5;
        else maxBtns = 3;
        if (totalPages <= maxBtns) {
            // Show all pages if they fit
            for (let p = 1; p <= totalPages; p++) pageBtns.push(makeBtn(String(p), p, { active: p === currentPage }));
        } else {
            const pushEllipsis = () => pageBtns.push(`<span class="ellipsis" aria-hidden="true">…</span>`);
            // Calculate how many buttons we can show around current page
            // Reserve 2 slots for first and last page, 2 for potential ellipses
            const sideSlots = Math.floor((maxBtns - 3) / 2); // buttons on each side of current
            // Always show first page
            pageBtns.push(makeBtn('1', 1, { active: currentPage === 1 }));
            // Calculate range around current page
            let rangeStart = Math.max(2, currentPage - sideSlots);
            let rangeEnd = Math.min(totalPages - 1, currentPage + sideSlots);
            // Adjust range to maximize button count
            const rangeSize = rangeEnd - rangeStart + 1;
            const targetSize = maxBtns - 2; // exclude first and last
            if (rangeSize < targetSize) {
                if (rangeStart === 2) {
                    rangeEnd = Math.min(totalPages - 1, rangeStart + targetSize - 1);
                } else if (rangeEnd === totalPages - 1) {
                    rangeStart = Math.max(2, rangeEnd - targetSize + 1);
                }
            }
            // Add ellipsis if gap after first page
            if (rangeStart > 2) pushEllipsis();
            // Add middle range buttons
            for (let p = rangeStart; p <= rangeEnd; p++) {
                pageBtns.push(makeBtn(String(p), p, { active: p === currentPage }));
            }
            // Add ellipsis if gap before last page
            if (rangeEnd < totalPages - 1) pushEllipsis();
            // Always show last page
            pageBtns.push(makeBtn(String(totalPages), totalPages, { active: currentPage === totalPages }));
        }
        pager.innerHTML = `
            <div class="btns">
                ${makeBtn('<i class="ri-arrow-left-s-line" aria-hidden="true"></i><span>Prev</span>', currentPage - 1, { disabled: currentPage <= 1, kind: 'nav', ariaLabel: 'Previous page' })}
                <div class="pages" aria-label="Pagination">
                    ${pageBtns.join('')}
                </div>
                ${makeBtn('<span>Next</span><i class="ri-arrow-right-s-line" aria-hidden="true"></i>', currentPage + 1, { disabled: currentPage >= totalPages, kind: 'nav', ariaLabel: 'Next page' })}
            </div>
            <div class="meta">Page ${currentPage} of ${totalPages} · ${total} total</div>
        `;
    };
    // Replace any previous handler (modal can be reopened)
    pager.onclick = (e) => {
        const btn = e.target && e.target.closest ? e.target.closest('button[data-page]') : null;
        if (!btn) return;
        const next = Number(btn.getAttribute('data-page'));
        if (!isFinite(next)) return;
        render(next);
    };
    // Responsive: re-render on window resize (debounced)
    let resizeTimeout;
    const handleResize = () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => render(currentPage), 150);
    };
    window.removeEventListener('resize', window._taskPagerResize);
    window._taskPagerResize = handleResize;
    window.addEventListener('resize', handleResize);
    render(1);
}
// [NEW] Helper function to initialize charts inside the task modal
function initializeTaskAnalyticsCharts(sortedDates) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#a0a0a0' : '#6c757d';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    const timelineCtx = document.getElementById('taskViewsTimelineChart');
    if (timelineCtx) {
        // Destroy previous charts if modal reopened
        if (window.charts?.taskModalTimeline) {
            try { window.charts.taskModalTimeline.destroy(); } catch (e) {}
        }
        if (window.charts?.taskModalTrend) {
            try { window.charts.taskModalTrend.destroy(); } catch (e) {}
        }
        const ctx2d = timelineCtx.getContext('2d');
        const gradient = ctx2d ? (() => {
            const g = ctx2d.createLinearGradient(0, 0, 0, 240);
            g.addColorStop(0, isDark ? 'rgba(16, 185, 129, 0.30)' : 'rgba(16, 185, 129, 0.22)');
            g.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
            return g;
        })() : 'rgba(16, 185, 129, 0.1)';
        const labels = sortedDates.map(([date]) =>
            new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        );
        const values = sortedDates.map(([, views]) => views);
        window.charts = window.charts || {};
        window.charts.taskModalTimeline = new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Views',
                    data: values,
                    borderColor: '#10b981',
                    backgroundColor: gradient,
                    tension: 0.35,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHitRadius: 16
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: (ctx) => ` ${ctx.dataset.label}: ${formatNumber(ctx.parsed.y || 0)}`
                        }
                    }
                },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: {
                        ticks: { color: textColor, font: { size: 10 }, maxRotation: 0, autoSkip: true },
                        grid: { color: gridColor, drawBorder: false }
                    },
                    y: {
                        ticks: {
                            color: textColor,
                            font: { size: 10 },
                            precision: 0,
                            callback: (v) => formatNumber(v)
                        },
                        grid: { color: gridColor, drawBorder: false },
                        beginAtZero: true
                    }
                }
            }
        });
        // ---- Second chart: "Home-style" trend (Views + 7d avg) ----
        const trendCanvas = document.getElementById('taskViewsTrendChart');
        if (trendCanvas) {
            const recent = sortedDates.slice(-10);
            const tLabels = recent.map(([date]) =>
                new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            );
            const tValues = recent.map(([, v]) => Number(v) || 0);
            const windowSize = Math.min(7, tValues.length || 1);
            const avg = tValues.map((_, i) => {
                const start = Math.max(0, i - windowSize + 1);
                const seg = tValues.slice(start, i + 1);
                const s = seg.reduce((a, b) => a + (Number(b) || 0), 0);
                return +(s / Math.max(1, seg.length)).toFixed(2);
            });
            const t2d = trendCanvas.getContext('2d');
            const indigoFill = t2d ? (() => {
                const g = t2d.createLinearGradient(0, 0, 0, 220);
                g.addColorStop(0, isDark ? 'rgba(99, 102, 241, 0.30)' : 'rgba(99, 102, 241, 0.22)');
                g.addColorStop(1, 'rgba(99, 102, 241, 0.02)');
                return g;
            })() : 'rgba(99, 102, 241, 0.12)';
            window.charts.taskModalTrend = new Chart(trendCanvas, {
                type: 'line',
                data: {
                    labels: tLabels,
                    datasets: [{
                        label: 'Views (recent)',
                        data: tValues,
                        borderColor: '#6366f1',
                        backgroundColor: indigoFill,
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: tValues.length > 1 ? 3 : 0,
                        pointHoverRadius: 6
                    }, {
                        label: 'Avg (rolling)',
                        data: avg,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.08)',
                        tension: 0.35,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                usePointStyle: true,
                                padding: 14
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: (ctx) => ` ${ctx.dataset.label}: ${formatNumber(ctx.parsed.y || 0)}`
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 11 }, maxRotation: 0, autoSkip: true }
                        },
                        y: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 11 }, callback: (v) => formatNumber(v) },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
}
// Task details modal map (amCharts v5) based on task.country_visits
function initializeTaskCountryMap(countryVisits) {
    const container = document.getElementById('taskCountryMap');
    if (!container) return;
    if (container.__am5root && !container.__am5root.isDisposed()) {
        try { container.__am5root.dispose(); } catch (_) {}
        container.__am5root = null;
    }
    const raw = countryVisits || {};
    const rows = Object.entries(raw).map(([id, value]) => ({ id: String(id || '').toUpperCase(), value: Number(value) || 0 }));
    const data = rows.filter(r => /^[A-Z]{2}$/.test(r.id) && r.value > 0);
    // Clean, modern 2-color ramp (simple + readable)
    const STOPS = ['#bbf7d0', '#10b981']; // light green -> green
    const HOVER_FILL = '#34d399';
    const BASE_EDGE = '#334155';
    container.innerHTML = `<div id="taskCountryMapCanvas" style="width:100%;height:100%;"></div>`;
    const ready = () =>
        typeof window.am5 !== 'undefined' &&
        typeof window.am5map !== 'undefined' &&
        typeof window.am5geodata_worldLow !== 'undefined';
    const add = (id, src) => new Promise((res, rej) => {
        if (document.getElementById(id)) return res();
        const s = document.createElement('script');
        s.id = id; s.src = src; s.async = true; s.setAttribute('data-cfasync','false');
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
    });
    function hexToNum(hex) {
        const s = String(hex || '').trim();
        let h = s.replace('#', '');
        if (h.length === 3) h = h.split('').map(x=>x+x).join('');
        if (!/^[0-9a-f]{6}$/i.test(h)) return 0x000000;
        return parseInt(h, 16);
    }
    function numToRgb(n){ return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
    function rgbToNum(r,g,b){ return ((r&255)<<16)|((g&255)<<8)|(b&255); }
    function lerp(a,b,t){ return Math.round(a + (b - a) * t); }
    function blend(aHex, bHex, t) {
        t = Math.max(0, Math.min(1, t || 0));
        const a = numToRgb(hexToNum(aHex));
        const b = numToRgb(hexToNum(bHex));
        return rgbToNum(lerp(a.r,b.r,t), lerp(a.g,b.g,t), lerp(a.b,b.b,t));
    }
    function multiGradient(stops, t) {
        const s = Array.isArray(stops) ? stops : [];
        if (s.length === 0) return hexToNum('#94a3b8');
        if (s.length === 1) return hexToNum(s[0]);
        t = Math.max(0, Math.min(1, t || 0));
        const seg = 1 / (s.length - 1);
        const idx = Math.min(s.length - 2, Math.floor(t / seg));
        const localT = (t - (idx * seg)) / seg;
        return blend(s[idx], s[idx + 1], localT);
    }
    function boot() {
        const root = am5.Root.new("taskCountryMapCanvas");
        container.__am5root = root;
        if (typeof am5themes_Animated !== 'undefined') {
            root.setThemes([ am5themes_Animated.new(root) ]);
        }
        const chart = root.container.children.push(am5map.MapChart.new(root, {}));
        const polygonSeries = chart.series.push(
            am5map.MapPolygonSeries.new(root, {
                geoJSON: am5geodata_worldLow,
                exclude: ["AQ"],
                valueField: "value",
                calculateAggregates: true
            })
        );
        const maxVal = Math.max(...data.map(d => d.value), 1);
        const minVal = Math.min(...data.map(d => d.value), 0);
        const range  = Math.max(1, maxVal - minVal);
        const polyTpl = polygonSeries.mapPolygons.template;
        polyTpl.setAll({
            tooltipText: "{name}: [bold]{value}[/]",
            strokeOpacity: 0.75,
            stroke: am5.color(hexToNum(BASE_EDGE)),
            fillOpacity: 1,
            interactive: true,
            cursorOverStyle: "pointer"
        });
        polyTpl.states.create("hover", {
            fill: am5.color(hexToNum(HOVER_FILL)),
            strokeWidth: 1.2
        });
        polyTpl.adapters.add("fill", (current, target) => {
            const v = target?.dataItem?.get("value");
            if (v == null || isNaN(v)) return am5.color(hexToNum('#cbd5e1'));
            const t = (v - minVal) / range;
            return am5.color(multiGradient(STOPS, t));
        });
        if (data.length > 0) polygonSeries.data.setAll(data);
        chart.set("wheelY", "zoom");
        chart.set("wheelX", "zoom");
        const ro = new ResizeObserver(() => root.resize());
        ro.observe(container);
        root.__ro = ro;
    }
    if (ready()) {
        boot();
    } else {
        Promise.resolve()
            .then(() => add('am5-core',     'https://cdn.amcharts.com/lib/5/index.js'))
            .then(() => add('am5-map',      'https://cdn.amcharts.com/lib/5/map.js'))
            .then(() => add('am5-worldlow', 'https://cdn.amcharts.com/lib/5/geodata/worldLow.js'))
            .then(() => add('am5-animated', 'https://cdn.amcharts.com/lib/5/themes/Animated.js'))
            .then(() => {
                let tries = 0;
                const t = setInterval(() => {
                    if (ready() || tries++ > 40) {
                        clearInterval(t);
                        if (ready()) boot();
                        else console.error('amCharts libs not ready (task map).');
                    }
                }, 100);
            })
            .catch(err => console.error('Task map libs failed to load:', err));
    }
}
// Recharge Task
// [NEW] Rebuilt Recharge Task Modal using SweetAlert2
// [NEW] Rebuilt Recharge Task Modal using SweetAlert2
// Verify Task
async function verifyTask(taskId) {
    try {
        const response = await api('/verify-task', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });
        // Handle the response structure: {status: "success", code: 200, data: {verified, message, ...}}
        if (response && response.status === 'success' && response.data) {
            const { verified, message, url } = response.data;
            if (verified) {
                // Show success message with Swal
                await Swal.fire({
                    icon: 'success',
                    title: 'Verification Successful!',
                    html: `
                        <p class="mb-2">${message || 'Script found on your website.'}</p>
                        <p class="text-muted small">URL: ${url || ''}</p>
                        <p class="text-success mt-3"><i class="ri-checkbox-circle-line"></i> Your task is now active!</p>
                    `,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#10b981'
                });
            } else {
                // Show simple error message
                await Swal.fire({
                    icon: 'error',
                    title: 'Verification Failed',
                    html: `
                        <p class="text-danger mt-3"><i class="ri-close-circle-line"></i> ${message || 'Script not found on your website. Please ensure the script is added to your website\'s &lt;head&gt; section and try again.'}</p>
                    `,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#ef4444'
                });
            }
            // Refresh the current view to show updated status (don't block on this)
            try {
                if (document.querySelector('.nav-item[data-page="tasks"]')?.classList.contains('active')) {
                    await loadTasks();
                } else {
                    await loadDashboard();
                }
            } catch (refreshError) {
                console.error('Failed to refresh view:', refreshError);
                // Don't show error to user, just log it
            }
        } else {
            throw new Error('Invalid response format from server');
        }
    } catch (error) {
        console.error('Verification error:', error);
        // Show error with Swal
        await Swal.fire({
            icon: 'error',
            title: 'Verification Error',
            text: error.message || 'Failed to verify task. Please try again.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#ef4444'
        });
    }
}
// Delete Task
async function deleteTask(taskId) {
    try {
        // Find the task to show its URL in the confirmation modal
        const task = currentData.tasks.find(t => t._id === taskId);
        const taskUrl = task ? task.url : 'this task';
        // Show confirmation dialog
        const result = await Swal.fire({
            icon: 'warning',
            title: 'Delete Task?',
            html: `
                <p class="mb-2">Are you sure you want to delete this task?</p>
                <p class="text-muted small">Task: <strong>${taskUrl}</strong></p>
                <p class="text-danger mt-3"><i class="ri-alert-line"></i> This action cannot be undone!</p>
            `,
            showCancelButton: true,
            confirmButtonText: 'Yes, Delete',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            reverseButtons: true
        });
        // If user cancelled, return early
        if (!result.isConfirmed) {
            return;
        }
        // Make the delete request
        const response = await api('/delete-task', {
            method: 'DELETE',
            body: JSON.stringify({ task_id: taskId })
        });
        // Handle the response structure: {status: "success", code: 200, data: {message, task_id}}
        if (response && response.status === 'success' && response.data) {
            // Show success message
            await Swal.fire({
                icon: 'success',
                title: 'Task Deleted!',
                html: `
                    <p class="mb-2">${response.data.message || 'Task has been deleted successfully.'}</p>
                    <p class="text-muted small">Task ID: ${response.data.task_id || taskId}</p>
                `,
                confirmButtonText: 'OK',
                confirmButtonColor: '#10b981',
                timer: 3000,
                timerProgressBar: true
            });
            // Refresh the current view to show updated list
            try {
                if (document.querySelector('.nav-item[data-page="tasks"]')?.classList.contains('active')) {
                    await loadTasks();
                } else {
                    await loadDashboard();
                }
            } catch (refreshError) {
                console.error('Failed to refresh view:', refreshError);
                // Don't show error to user, just log it
            }
        } else {
            throw new Error(response?.error?.message || 'Invalid response format from server');
        }
    } catch (error) {
        console.error('Delete task error:', error);
        // Show error with Swal
        await Swal.fire({
            icon: 'error',
            title: 'Delete Failed',
            text: error.message || 'Failed to delete task. Please try again.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#ef4444'
        });
    }
}
// Recharge Task
async function rechargeTask(taskId) {
    // Find the task to show its URL in the modal
    const task = currentData.tasks.find(t => t._id === taskId);
    const taskUrl = task ? task.url : `Task ID: ${taskId}`;
    const modalHtml = `
    <div class="recharge-modal-container">
        <div class="recharge-modal-section">
            <label class="recharge-modal-label">Choose an amount to add:</label>
            <div class="recharge-preset-amounts">
                <button class="recharge-preset-btn" data-amount="25">$25</button>
                <button class="recharge-preset-btn" data-amount="50">$50</button>
                <button class="recharge-preset-btn" data-amount="100">$100</button>
                <button class="recharge-preset-btn" data-amount="200">$200</button>
            </div>
            <label class="recharge-modal-label">Or enter a custom amount (min $10):</label>
            <input type="number" id="rechargeAmount" class="form-input" min="10" value="50" placeholder="">
        </div>
        <div class="recharge-modal-section">
            <label class="recharge-modal-label">Select payment method:</label>
            <div class="recharge-payment-options">
                <div class="recharge-payment-option selected" id="payment-stripe" data-provider="stripe">
                    <i class="ri-bank-card-line"></i>
                    <div class="provider-name">Card (Stripe)</div>
                </div>
                <div class="recharge-payment-option" id="payment-oxapay" data-provider="oxapay">
                    <i class="ri-bit-coin-line"></i>
                    <div class="provider-name">Crypto (OxaPay)</div>
                </div>
            </div>
        </div>
        <div class="recharge-summary">
            <div class="recharge-summary-item">
                <span>Recharging Task:</span>
                <strong style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${taskUrl}">${taskUrl}</strong>
            </div>
            <div class="recharge-summary-item" style="border-top: 1px solid var(--border); margin-top: 0.5rem; padding-top: 0.5rem;">
                <strong style="font-size: 1.1rem;">Total to Add:</strong>
                <strong id="rechargeTotal" style="font-size: 1.2rem; color: var(--primary);">$50.00</strong>
            </div>
        </div>
    </div>
    `;
    Swal.fire({
        title: 'Recharge Task Budget',
        html: modalHtml,
        showCancelButton: true,
        cancelButtonText: 'Cancel',
        confirmButtonText: '<i class="ri-wallet-3-line"></i> Proceed to Payment',
        confirmButtonColor: 'var(--primary)',
        // REMOVED width and maxWidth properties from here
        customClass: {
            popup: 'recharge-modal-custom' // ADDED our new class here
        },
        didOpen: () => {
            // --- Logic for the interactive modal ---
            const amountInput = document.getElementById('rechargeAmount');
            const totalDisplay = document.getElementById('rechargeTotal');
            const updateTotal = () => {
                const amount = parseFloat(amountInput.value) || 0;
                totalDisplay.textContent = `$${amount.toFixed(2)}`;
            };
            amountInput.addEventListener('input', updateTotal);
            document.querySelectorAll('.recharge-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    amountInput.value = btn.dataset.amount;
                    updateTotal();
                });
            });
            document.querySelectorAll('.recharge-payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.recharge-payment-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        },
        preConfirm: () => {
            // --- Gather data before confirming ---
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const provider = document.querySelector('.recharge-payment-option.selected').dataset.provider;
            if (!amount || amount < 10) {
                Swal.showValidationMessage('Minimum recharge amount is $10');
                return false;
            }
            return { amount, provider, taskId };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            const { amount, provider, taskId } = result.value;
            try {
                // This is the first attempt
                const response = await api('/recharge', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_ids: [taskId],
                        amount: amount,
                        payment_method: provider
                    })
                });
                if (response.data.payment_url) {
                    Swal.fire({
                        title: 'Redirecting...',
                        text: 'Redirecting you to the payment page to complete your recharge.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false,
                        customClass: { popup: 'swal2-toast' }
                    });
                    window.open(response.data.payment_url, '_blank');
                } else {
                    showToast('Task recharged successfully!', 'success');
                }
                // Refresh the list to show the new budget
                if (document.querySelector('.nav-item[data-page="tasks"]').classList.contains('active')) {
                    loadTasks();
                } else {
                    loadDashboard();
                }
            } catch (error) {
                // START OF MODIFIED SECTION
                // Check for the specific 409 error
                if (error.message === 'A pending recharge exists') {
                    Swal.fire({
                        title: 'Pending Recharge Exists',
                        html: "You already have a pending recharge. If you proceed, the previous pending recharge will be cancelled.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: 'var(--primary)',
                        confirmButtonText: 'Proceed & Cancel Previous',
                        cancelButtonText: 'Cancel',
                        customClass: { popup: 'swal2-toast' }
                    }).then(async (proceedResult) => {
                        if (proceedResult.isConfirmed) {
                            // User wants to proceed, send the request again with cancel_previous: true
                            try {
                                Swal.fire({
                                    title: 'Cancelling and Recharging...',
                                    didOpen: () => Swal.showLoading(),
                                    allowOutsideClick: false,
                                    customClass: { popup: 'swal2-toast' }
                                });
                                const response = await api('/recharge', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        task_ids: [taskId],
                                        amount: amount,
                                        payment_method: provider,
                                        cancel_previous: true // The new key to override
                                    })
                                });
                                if (response.data.payment_url) {
                                    Swal.fire({
                                        title: 'Redirecting...',
                                        text: 'Redirecting you to the new payment page.',
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false,
                                        customClass: { popup: 'swal2-toast' }
                                    });
                                    window.open(response.data.payment_url, '_blank');
                                } else {
                                    showToast('Task recharged successfully!', 'success');
                                }
                                // Refresh the list
                                if (document.querySelector('.nav-item[data-page="tasks"]').classList.contains('active')) {
                                    loadTasks();
                                } else {
                                    loadDashboard();
                                }
                            } catch (retryError) {
                                // Handle error on the *second* attempt
                                Swal.fire('Error!', 'Failed to initiate recharge: ' + retryError.message, 'error');
                            }
                        }
                    });
                } else {
                    // It was a different error, show the generic message
                    Swal.fire('Error!', 'Failed to initiate recharge: ' + error.message, 'error');
                }
                // END OF MODIFIED SECTION
            }
        }
    });
}
// ADD THIS NEW, UNIFIED FUNCTION
async function showDomainModal() {
    const modalHtml = `
    <div style="text-align: left;">
        <div class="form-group">
            <label class="form-label">Domain URL</label>
            <input type="text" id="swal-domain-url" class="form-input" name="url" required placeholder="example.com/blog">
            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                Enter your domain or subdomain where articles will be published.
            </small>
        </div>
        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin-top: 1.5rem;">
            <p style="font-size: 0.875rem; margin: 0;">
                <strong>Note:</strong> You will need to verify ownership by adding a TXT record to your DNS settings after adding the domain.
            </p>
        </div>
    </div>
    `;
    Swal.fire({
        title: 'Add New Domain',
        html: modalHtml,
        showCloseButton: true, // Adds the 'X' button
        confirmButtonText: 'Add Domain',
        confirmButtonColor: 'var(--primary)',
        showCancelButton: true,
        customClass: {
            popup: 'swal2-toast', // Use our theme
        },
        didOpen: () => {
            // Focus the input field when the modal opens
            document.getElementById('swal-domain-url').focus();
        },
        preConfirm: () => {
            // Validate the input before closing the modal
            const url = document.getElementById('swal-domain-url').value;
            if (!url) {
                Swal.showValidationMessage('Please enter a domain URL.');
                return false;
            }
            return url;
        }
    }).then(async (result) => {
        // This block runs only if preConfirm validation passes
        if (result.isConfirmed) {
            const url = result.value;
            Swal.fire({
                title: 'Adding Domain...',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                customClass: { popup: 'swal2-toast' }
            });
            try {
                const response = await api('/add-domain', {
                    method: 'POST',
                    body: JSON.stringify({ url: url })
                });
                // If a TXT record is returned, open the verification instructions modal
                if (response.data.txt_record) {
                    showVerificationInstructions(url, response.data.txt_record);
                } else {
                    // Otherwise, the domain might be auto-verified
                    Swal.close();
                    showToast('Domain added and verified successfully!', 'success');
                    loadArticles();
                }
            } catch (error) {
                console.error('Add domain error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to Add',
                    text: error.message,
                    customClass: { popup: 'swal2-toast' }
                });
            }
        }
    });
}
async function verifyDomain(url) {
    try {
        await api('/verify-domain', {
            method: 'POST',
            body: JSON.stringify({ url })
        });
        showToast('Domain verified successfully', 'success');
        closeModal();
        loadArticles();
    } catch (error) {
        console.error('Verify domain error:', error);
        showToast('Verification failed. Please check your DNS settings and try again.', 'error');
    }
}
function confirmDeleteDomain(domain) {
    Swal.fire({
        title: 'Delete Domain?',
        html: `<p style="margin: 0;">Are you sure you want to remove <strong>${domain}</strong> from your account?</p>
               <span style="display: block; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">If the domain was verified, related articles will also be removed.</span>`,
        icon: 'warning',
        showCancelButton: true,
        focusCancel: true,
        confirmButtonText: 'Delete',
        confirmButtonColor: '#d33',
        cancelButtonText: 'Cancel',
        customClass: { popup: 'swal2-toast' }
    }).then((result) => {
        if (result.isConfirmed) {
            deleteDomain(domain);
        }
    });
}
async function deleteDomain(domain) {
    Swal.fire({
        title: 'Deleting domain...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
        customClass: { popup: 'swal2-toast' }
    });
    try {
        await api('/delete-domain', {
            method: 'POST',
            body: JSON.stringify({ url: domain })
        });
        Swal.close();
        showToast('Domain deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        Swal.close();
        console.error('Delete domain error:', error);
        const message = error?.data?.message || error?.message || 'Failed to delete domain. Please try again.';
        showToast(message, 'error');
    }
}
// ADD THIS NEW, IMPROVED FUNCTION
function showVerificationInstructions(domain, txtRecord = '') {
    const modalHtml = `
    <div style="text-align: left;">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            To use <strong>${domain}</strong> for publishing articles, you must first prove you own it by adding a simple record to its DNS settings.
        </p>
        ${txtRecord ? `
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <h5 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text);">Your TXT Record:</h5>
                <div style="background: var(--bg); padding: 0.75rem; border-radius: var(--radius-sm); font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
                    ${txtRecord}
                </div>
            </div>
        ` : ''}
        <ol style="margin: 1.5rem 0; padding-left: 1.5rem;" class="mobileol">
            <li style="margin-bottom: 1rem;">
                <strong>Access your DNS provider:</strong> Log in to your domain registrar (like Cloudflare, GoDaddy, etc.).
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Find DNS management:</strong> Look for "DNS Settings" or "Zone Editor".
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Add a new TXT record</strong> with these settings:
                <ul style="margin-left: 1rem; margin-top: 0.5rem; list-style-type: disc;">
                    <li><strong>Type:</strong> TXT</li>
                    <li><strong>Name/Host:</strong> @ (or your root domain)</li>
                    <li><strong>Value/Content:</strong> Paste the TXT record from above.</li>
                </ul>
            </li>
            <li>
                <strong>Wait & Verify:</strong> DNS changes can take a few minutes or hours. Once done, click the "Verify Now" button.
            </li>
        </ol>
    </div>
    `;
    Swal.fire({
        title: 'Domain Verification',
        html: modalHtml,
        width: '95vw',
        maxWidth: '700px',
        showCloseButton: true, // Adds the 'X' button
        showConfirmButton: true,
        confirmButtonText: '<i class="ri-check-line"></i> Verify Now',
        confirmButtonColor: 'var(--primary)',
        showDenyButton: true,
        denyButtonText: '<i class="ri-file-copy-line"></i> Copy Record',
    }).then((result) => {
        if (result.isConfirmed) {
            // User clicked "Verify Now"
            verifyDomain(domain);
        } else if (result.isDenied) {
            // User clicked "Copy Record"
            copyToClipboard(txtRecord);
            // We return false to prevent the modal from closing, so they can see the 'copied' toast.
            return false;
        }
    });
}
// ADD THIS NEW, IMPROVED FUNCTION
async function viewArticle(articleId) {
    try {
        const response = await api(`/dashboard/articles?article_id=${articleId}`);
        const article = response.data.article;
        // --- Data processing (This part is unchanged) ---
        const stats = article.stats || {};
        const countries = {}, browsers = {}, devices = {}, viewsByDate = {};
        Object.entries(stats).forEach(([month, monthStats]) => {
            if (monthStats.country) Object.entries(monthStats.country).forEach(([k, v]) => { countries[k.toUpperCase()] = (countries[k.toUpperCase()] || 0) + v; });
            if (monthStats.browser) Object.entries(monthStats.browser).forEach(([k, v]) => { browsers[k] = (browsers[k] || 0) + v; });
            if (monthStats.devices) Object.entries(monthStats.devices).forEach(([k, v]) => { devices[k] = (devices[k] || 0) + v; });
            if (monthStats.daily) Object.entries(monthStats.daily).forEach(([day, views]) => {
                const [year, monthNum] = month.split('-');
                const fullDate = `${year}-${monthNum}-${String(day).padStart(2, '0')}`;
                viewsByDate[fullDate] = (viewsByDate[fullDate] || 0) + views;
            });
        });
        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
        const haveStats = Object.keys(stats).length > 0;
        const hasImages = article.images && article.images.length > 0;
        // Format dates nicely
        const creationDate = new Date(article.creation_date);
        const formattedDate = creationDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        // Calculate content stats
        const wordCount = article.body ? article.body.replace(/<[^>]*>/g, '').split(/\s+/).filter(w => w.length > 0).length : 0;
        const readingTime = Math.max(1, Math.ceil(wordCount / 200));
        const charCount = article.body ? article.body.replace(/<[^>]*>/g, '').length : 0;
        // Calculate analytics stats
        const totalViews = article.total_views || 0;
        const countryCount = Object.keys(countries).length;
        const last7Views = sortedDates.slice(-7).reduce((sum, [, v]) => sum + v, 0);
        const avgViews = sortedDates.length > 0 ? Math.round(sortedDates.reduce((sum, [, v]) => sum + v, 0) / sortedDates.length) : 0;
        // --- Build new responsive HTML for Swal with Tabs ---
        const modalHtml = `
        <div class="article-details-modal-container">
            <!-- Header Section -->
            <div class="article-modal-header">
                <div class="article-modal-header-row">
                    <div class="article-modal-title">
                        <h3>
                            <a class="article-modal-url-pill" href="https://${article.url}" target="_blank" rel="noopener noreferrer">
                                <span>${article.url}</span>
                                <i class="ri-external-link-line"></i>
                            </a>
                        </h3>
                    </div>
                </div>
                <div class="article-header-meta-row">
                    <div class="article-header-meta">
                        <span><i class="ri-calendar-line"></i> ${formattedDate}</span>
                        <span><i class="ri-text"></i> ${formatNumber(wordCount)} words</span>
                        <span><i class="ri-time-line"></i> ${readingTime} min</span>
                    </div>
                    <div class="article-modal-actions-mobile">
                        <button class="btn btn-sm" onclick="Swal.close(); showArticleModal('${articleId}')" title="Edit">
                            <i class="ri-edit-line"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); confirmDeleteArticle('${articleId}')" title="Delete">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                    <div class="article-modal-actions-desktop">
                        <button class="btn btn-edit" onclick="Swal.close(); showArticleModal('${articleId}')" title="Edit Article">
                            <i class="ri-edit-line"></i> Edit Article
                        </button>
                        <button class="btn btn-delete" onclick="event.stopPropagation(); confirmDeleteArticle('${articleId}')" title="Delete Article">
                            <i class="ri-delete-bin-line"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
            <!-- Stats Grid -->
            <div class="article-modal-stat-grid">
                <div class="article-modal-stat-card">
                    <div class="stat-value" style="color: var(--success);">${formatNumber(totalViews)}</div>
                    <div class="stat-label">Total Views</div>
                </div>
                <div class="article-modal-stat-card">
                    <div class="stat-value" style="color: var(--primary);">${formatNumber(last7Views)}</div>
                    <div class="stat-label">Last 7 Days</div>
                </div>
                <div class="article-modal-stat-card">
                    <div class="stat-value" style="color: var(--info);">${countryCount}</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="article-modal-stat-card">
                    <div class="stat-value" style="color: var(--warning);">${hasImages ? article.images.length : 0}</div>
                    <div class="stat-label">Images</div>
                </div>
            </div>
            <!-- Tabs Navigation -->
            <div class="article-modal-tabs" role="tablist" aria-label="Article details sections">
                <button class="article-modal-tab active" type="button" data-tab="analytics" role="tab" aria-controls="article-panel-analytics">
                    <i class="ri-line-chart-line"></i>
                    <span class="label-desktop">Analytics</span>
                </button>
                <button class="article-modal-tab" type="button" data-tab="images" role="tab" aria-controls="article-panel-images">
                    <i class="ri-image-line"></i>
                    <span class="label-desktop">Images</span>
                </button>
                <button class="article-modal-tab" type="button" data-tab="content" role="tab" aria-controls="article-panel-content">
                    <i class="ri-file-text-line"></i>
                    <span class="label-desktop">Content</span>
                </button>
            </div>
            <!-- Panels -->
            <div class="article-modal-panels">
                <!-- Analytics Panel -->
                <div class="article-modal-panel" id="article-panel-analytics" data-panel="analytics" role="tabpanel">
                    ${haveStats ? `
                        <div class="article-analytics-section">
                            <div class="article-chart-wrap">
                                <canvas id="articleViewsChart"></canvas>
                            </div>
                            <div class="article-mini-charts-grid">
                                <div class="article-mini-chart-card">
                                    <div class="chart-title"><i class="ri-earth-line"></i> Countries</div>
                                    <div class="chart-body"><canvas id="articleCountriesChart"></canvas></div>
                                </div>
                                <div class="article-mini-chart-card">
                                    <div class="chart-title"><i class="ri-window-line"></i> Browsers</div>
                                    <div class="chart-body"><canvas id="articleBrowsersChart"></canvas></div>
                                </div>
                                <div class="article-mini-chart-card">
                                    <div class="chart-title"><i class="ri-device-line"></i> Devices</div>
                                    <div class="chart-body"><canvas id="articleDevicesChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="empty-state" style="padding: 3rem 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius); border: 1px solid var(--border);">
                            <div class="empty-state-icon"><i class="ri-bar-chart-line"></i></div>
                            <div class="empty-state-title" style="font-size: 1.2rem;">No Analytics Yet</div>
                            <p class="empty-state-description" style="font-size: 0.9rem; margin: 0;">Analytics will appear once your article receives traffic.</p>
                        </div>
                    `}
                </div>
                <!-- Images Panel -->
                <div class="article-modal-panel" id="article-panel-images" data-panel="images" role="tabpanel" hidden>
                    ${hasImages ? `
                        <div class="article-images-slider-container">
                            <div class="article-image-slider">
                                <button class="article-slider-nav prev" onclick="articleSliderPrev()" aria-label="Previous image">
                                    <i class="ri-arrow-left-s-line"></i>
                                </button>
                                <img id="articleSliderImage" class="article-slider-image" src="${article.images[0]}" alt="Article image" onclick="window.open(this.src, '_blank')">
                                <button class="article-slider-nav next" onclick="articleSliderNext()" aria-label="Next image">
                                    <i class="ri-arrow-right-s-line"></i>
                                </button>
                            </div>
                            <div class="article-slider-counter">
                                <span id="articleSliderCurrent">1</span> / <span>${article.images.length}</span>
                            </div>
                            <div class="article-slider-thumbnails" id="articleSliderThumbnails">
                                ${article.images.map((img, idx) => `
                                    <div class="article-slider-thumb ${idx === 0 ? 'active' : ''}" onclick="articleSliderGoTo(${idx})" data-index="${idx}">
                                        <img src="${img}" alt="Thumbnail ${idx + 1}" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="article-no-images">
                            <i class="ri-image-line"></i>
                            <h4>No Images</h4>
                            <p>This article doesn't have any images attached.</p>
                        </div>
                    `}
                </div>
                <!-- Content Panel -->
                <div class="article-modal-panel" id="article-panel-content" data-panel="content" role="tabpanel" hidden>
                    <div class="article-content-panel">
                        <div class="article-content-preview">
                            <div class="article-content-preview-header">
                                <h4><i class="ri-file-text-line"></i> ${article.subject}</h4>
                            </div>
                            <div class="article-content-body">
                                ${article.body}
                            </div>
                        </div>
                        <div class="article-content-info">
                            <div class="article-content-info-card">
                                <div class="info-value">${formatNumber(wordCount)}</div>
                                <div class="info-label">Words</div>
                            </div>
                            <div class="article-content-info-card">
                                <div class="info-value">${formatNumber(charCount)}</div>
                                <div class="info-label">Characters</div>
                            </div>
                            <div class="article-content-info-card">
                                <div class="info-value">${readingTime} min</div>
                                <div class="info-label">Read Time</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
        // Store images for slider functionality
        window.articleSliderImages = article.images || [];
        window.articleSliderIndex = 0;
        Swal.fire({
            html: modalHtml,
            width: 'min(1100px, 96vw)',
            showCloseButton: true,
            showConfirmButton: false,
            showDenyButton: false,
            showCancelButton: false,
            customClass: {
                popup: 'swal2-toast article-details-swal',
                closeButton: 'swal2-close'
            },
            showClass: { popup: 'swal2-show-super-fast' },
            hideClass: { popup: 'swal2-hide-super-fast' },
            didOpen: () => {
                setupArticleDetailsTabs({ hasAnalytics: haveStats });
                // Initialize charts after the modal is in the DOM
                if (haveStats) {
                    setTimeout(() => {
                        initializeArticleCharts(countries, browsers, devices, sortedDates);
                    }, 100);
                }
            },
            willClose: () => {
                // Cleanup
                window.articleSliderImages = null;
                window.articleSliderIndex = 0;
            }
        });
    } catch (error) {
        console.error('View article error:', error);
        showToast('Failed to load article details', 'error');
    }
}
// Setup article details tabs
function setupArticleDetailsTabs({ hasAnalytics }) {
    const popup = Swal.getPopup();
    if (!popup) return;
    const tabs = Array.from(popup.querySelectorAll('.article-modal-tab'));
    const panels = Array.from(popup.querySelectorAll('.article-modal-panel'));
    if (tabs.length === 0 || panels.length === 0) return;
    const analyticsTab = tabs.find(t => t.dataset.tab === 'analytics');
    if (analyticsTab && !hasAnalytics) {
        analyticsTab.disabled = true;
        analyticsTab.title = 'Analytics will appear once the article receives traffic.';
    }
    const activate = (name) => {
        tabs.forEach(btn => {
            const isActive = btn.dataset.tab === name;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });
        panels.forEach(panel => {
            const isPanelActive = panel.dataset.panel === name;
            if (isPanelActive) {
                panel.removeAttribute('hidden');
                panel.classList.remove('panel-in');
                panel.offsetWidth; // force reflow
                panel.classList.add('panel-in');
            } else {
                panel.setAttribute('hidden', '');
            }
        });
    };
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.disabled) return;
            activate(btn.dataset.tab);
        });
    });
    // Default to analytics if has data, otherwise content
    activate(hasAnalytics ? 'analytics' : 'content');
}
// Article slider navigation functions
function articleSliderGoTo(index) {
    if (!window.articleSliderImages || window.articleSliderImages.length === 0) return;
    const images = window.articleSliderImages;
    if (index < 0) index = images.length - 1;
    if (index >= images.length) index = 0;
    window.articleSliderIndex = index;
    const mainImage = document.getElementById('articleSliderImage');
    const counter = document.getElementById('articleSliderCurrent');
    const thumbnails = document.querySelectorAll('.article-slider-thumb');
    if (mainImage) mainImage.src = images[index];
    if (counter) counter.textContent = index + 1;
    thumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
    });
}
function articleSliderNext() {
    articleSliderGoTo(window.articleSliderIndex + 1);
}
function articleSliderPrev() {
    articleSliderGoTo(window.articleSliderIndex - 1);
}
// Charts
function initializeArticleCharts(countries, browsers, devices, sortedDates) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 0 },
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: textColor,
                    usePointStyle: true,
                    padding: 6,
                    font: { size: 10 }
                }
            },
            tooltip: {
                backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)',
                titleColor: textColor,
                bodyColor: textColor,
                borderWidth: 1,
                cornerRadius: 6,
                padding: 8,
                titleFont: { size: 11 },
                bodyFont: { size: 10 }
            }
        }
    };
    // Timeline
    if (sortedDates && sortedDates.length > 0) {
        const viewsChart = document.getElementById('articleViewsChart');
        if (viewsChart) {
            new Chart(viewsChart, {
                type: 'line',
                data: {
                    labels: sortedDates.map(([date]) =>
                        new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    ),
                    datasets: [{
                        label: 'Views',
                        data: sortedDates.map(([, views]) => views),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.12)',
                        tension: 0.35,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2.5,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, maxRotation: 0, autoSkipPadding: 8 }
                        },
                        y: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, beginAtZero: true }
                        }
                    },
                    plugins: { ...commonOptions.plugins, legend: { display: false } }
                }
            });
        }
    }
    // Doughnuts with distinct readable colors
    const distinctColors = [
        '#10b981', // green
        '#6366f1', // indigo
        '#f59e0b', // amber
        '#ef4444', // red
        '#8b5cf6', // violet
        '#06b6d4', // cyan
        '#ec4899', // pink
        '#84cc16', // lime
        '#f97316', // orange
        '#14b8a6'  // teal
    ];
    const chartConfigs = [
        { id: 'articleCountriesChart', data: countries },
        { id: 'articleBrowsersChart', data: browsers },
        { id: 'articleDevicesChart', data: devices }
    ];
    chartConfigs.forEach(({ id, data }) => {
        if (data && Object.keys(data).length > 0) {
            const el = document.getElementById(id);
            if (!el) return;
            const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a).slice(0, 10);
            new Chart(el, {
                type: 'doughnut',
                data: {
                    labels: sortedData.map(([key]) => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        data: sortedData.map(([, v]) => v),
                        backgroundColor: distinctColors.slice(0, sortedData.length),
                        borderWidth: 2,
                        borderColor: isDark ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.8)'
                    }]
                },
                options: {
                    ...commonOptions,
                    cutout: '55%',
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            display: true,
                            position: 'right',
                            labels: {
                                ...commonOptions.plugins.legend.labels,
                                boxWidth: 12,
                                padding: 8
                            }
                        }
                    }
                }
            });
        }
    });
}
// ADD THIS NEW, ALL-IN-ONE FUNCTION
// ADD THIS NEW, ALL-IN-ONE FUNCTION
async function showArticleModal(articleId = null) {
    const isEdit = !!articleId;
    let articleData = null;
    if (isEdit) {
        Swal.fire({
            title: 'Loading Article...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            customClass: { popup: 'swal2-toast' }
        });
        try {
            const response = await api(`/dashboard/articles?article_id=${articleId}`);
            articleData = response.data.article;
            Swal.close();
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Failed to load article',
                text: error.message,
                customClass: { popup: 'swal2-toast' }
            });
            return;
        }
    }
    const modalHtml = `
    <style>
        .article-modal-wrapper {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.25rem;
            text-align: left;
            max-height: calc(90vh - 80px);
            overflow: auto;
        }
        .article-main-content {
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        .article-main-content form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .article-main-content::-webkit-scrollbar {
            width: 6px;
        }
        .article-main-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        .article-main-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .article-main-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        .article-sidebar {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            border-left: 2px solid var(--border);
            padding-left: 1.25rem;
        }
        .article-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .article-sidebar::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        .article-sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .article-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0.85rem;
            transition: var(--transition);
            width: 100%;
            box-sizing: border-box;
        }
        .article-section:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }
        .form-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }
        .form-label i {
            font-size: 1rem;
            color: var(--primary);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        .section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title i {
            font-size: 1.1rem;
            color: var(--primary);
        }
        .ai-btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .ai-btn {
            padding: 0.35rem 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.35rem;
            white-space: nowrap;
        }
        .ai-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .ai-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .ai-btn.generating {
            background: linear-gradient(270deg, #667eea, #764ba2, #667eea);
            background-size: 200% 200%;
            animation: gradientShift 2s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .ai-btn i {
            font-size: 0.85rem;
        }
        .ai-btn.generating i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .progress-dots {
            display: inline-flex;
            gap: 2px;
            margin-left: 4px;
        }
        .progress-dots span {
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }
        .progress-dots span:nth-child(1) { animation-delay: -0.32s; }
        .progress-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .body-editor-container {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .editor-toolbar {
            display: flex;
            gap: 0.35rem;
            padding: 0.5rem;
            background: var(--card);
            border-radius: var(--radius);
            flex-wrap: wrap;
        }
        .editor-btn {
            padding: 0.35rem 0.65rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .editor-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .editor-btn i {
            font-size: 0.85rem;
        }
        .form-textarea-enhanced {
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            resize: vertical;
        }
        .form-textarea-enhanced:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .usage-stats {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-lg);
            padding: 0.85rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.15rem;
        }
        .usage-item {
            text-align: center;
        }
        .usage-value {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }
        .usage-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.65rem;
        }
        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid var(--border);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }
        .image-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }
        .image-item.marked-delete {
            opacity: 0.4;
            border-color: var(--error);
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            gap: 0.5rem;
        }
        .image-item:hover .image-overlay {
            opacity: 1;
        }
        .img-btn {
            padding: 0.35rem 0.55rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .img-btn.view { background: var(--primary); }
        .img-btn.delete { background: var(--error); }
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--card-hover);
        }
        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .upload-icon {
            font-size: 2rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.65rem;
        }
        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 2px solid var(--success);
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            z-index: 2;
        }
        .preview-refresh {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            z-index: 2;
            transition: var(--transition);
        }
        .preview-refresh:hover {
            transform: rotate(180deg);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .preview-refresh.loading {
            animation: spin 1s linear infinite;
        }
        .char-count {
            text-align: right;
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.35rem;
        }
        .generation-status {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius);
            padding: 0.85rem;
            margin-top: 0.75rem;
            display: none;
            align-items: center;
            gap: 0.65rem;
        }
        .generation-status.active {
            display: flex;
        }
        .status-spinner {
            width: 18px;
            height: 18px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .status-text {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 500;
        }
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .article-modal-wrapper {
                grid-template-columns: 1fr;
                gap: 1rem;
                max-height: calc(85vh - 80px);
            }
            .article-sidebar {
                border-left: none;
                border-top: 2px solid var(--border);
                padding-left: 0;
                padding-top: 1rem;
            }
            .image-gallery {
                grid-template-columns: repeat(3, 1fr);
            }
            .usage-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-textarea-enhanced {
                min-height: 280px;
                max-height: 400px;
            }
        }
        @media (max-width: 768px) {
            .article-modal-wrapper {
                max-height: calc(85vh - 60px);
            }
            .article-section {
                padding: 0.75rem;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.65rem;
            }
            .ai-btn-group {
                width: 100%;
            }
            .ai-btn {
                justify-content: center;
                font-size: 0.7rem;
                padding: 0.3rem 0.55rem;
            }
            .image-gallery,
            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .usage-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .editor-toolbar {
                padding: 0.4rem;
            }
            .editor-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            .form-textarea-enhanced {
                min-height: 220px;
                max-height: 300px;
                font-size: 0.8rem;
            }
        }
        /* Fix swal2-title gap and mobile responsiveness */
        .article-modal-swal .swal2-title {
            padding: 0.5rem 0 !important;
            margin: 0 !important;
            font-size: 1.15rem !important;
        }
        @media (max-width: 768px) {
            .article-modal-swal .swal2-title {
                padding: 0.25rem 0 !important;
                font-size: 1rem !important;
            }
            .article-modal-swal {
                padding: 0.75rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.75rem !important;
                max-height: 90vh !important;
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
            .article-modal-swal .swal2-html-container {
                max-height: 75vh !important;
                padding: 0.25rem !important;
                padding-bottom: 1rem !important;
            }
            #ai-generate-all-btn {
                font-size: 0.65rem !important;
                padding: 0.25rem 0.4rem !important;
                white-space: nowrap !important;
            }
            #ai-generate-all-btn span {
                display: inline !important;
            }
            #ai-generate-all-btn i {
                font-size: 0.7rem !important;
                margin-right: 0.15rem !important;
            }
        }
        @media (max-width: 480px) {
            #ai-generate-all-btn span {
                display: none !important;
            }
            #ai-generate-all-btn {
                padding: 0.3rem 0.45rem !important;
                font-size: 0.65rem !important;
            }
            #ai-generate-all-btn i {
                font-size: 0.75rem !important;
                margin-right: 0 !important;
            }
        }
        /* Hide default action buttons */
        .article-modal-swal .swal2-actions {
            display: none !important;
        }
        /* Custom action buttons in sidebar */
        .article-section.action-buttons-wrapper {
            margin-top: auto;
        }
        .article-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .article-actions button {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .article-actions .btn-save {
            background: var(--primary);
            color: white;
        }
        .article-actions .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .article-actions .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .article-actions .btn-cancel:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
    </style>
    <div class="article-modal-wrapper">
        <div class="article-main-content">
            <form id="articleForm">
                <div class="article-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label class="form-label" style="margin-bottom: 0;"><i class="ri-text"></i> Title</label>
                        <button type="button" class="ai-btn" id="ai-generate-all-btn">
                            <i class="ri-magic-line"></i> <span>Generate by AI</span>
                        </button>
                    </div>
                    <input type="text" id="article-subject" class="form-input" name="subject" required
                        placeholder="Enter article title..." value="${articleData ? articleData.subject : ''}" maxlength="200">
                    <div class="char-count"><span id="title-count">0</span>/200</div>
                </div>
                <div class="article-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label class="form-label" style="margin-bottom: 0;"><i class="ri-file-text-line"></i> Content</label>
                    </div>
                    <div class="body-editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" data-tag="h1">
                                <i class="ri-h-1"></i> H1
                            </button>
                            <button type="button" class="editor-btn" data-tag="h2">
                                <i class="ri-h-2"></i> H2
                            </button>
                            <button type="button" class="editor-btn" data-tag="p">
                                <i class="ri-paragraph"></i> P
                            </button>
                            <button type="button" class="editor-btn" data-tag="strong">
                                <i class="ri-bold"></i> Bold
                            </button>
                            <button type="button" class="editor-btn" data-tag="em">
                                <i class="ri-italic"></i> Italic
                            </button>
                            <button type="button" class="editor-btn" data-tag="a">
                                <i class="ri-link"></i> Link
                            </button>
                        </div>
                        <textarea class="form-textarea-enhanced" id="article-body" name="body" required
                            placeholder="<h1>Main Heading</h1>&#10;<p>Your content here...</p>&#10;&#10;<h2>Subheading</h2>&#10;<p>More content...</p>">${articleData ? articleData.body : ''}</textarea>
                    </div>
                    <div class="char-count"><span id="body-count">0</span> characters</div>
                    <div class="generation-status" id="gen-status">
                        <div class="status-spinner"></div>
                        <div class="status-text" id="gen-status-text">Generating content...</div>
                    </div>
                </div>
                <input type="hidden" id="delete-images" name="delete_image_ids" value="">
                <input type="hidden" id="image-urls" name="image_urls" value="">
            </form>
        </div>
        <div class="article-sidebar">
            <div class="article-section">
                <label class="form-label"><i class="ri-global-line"></i> Domain</label>
                <select class="form-select" id="article-url" name="url" required>
                    <option value="">Select domain...</option>
                    ${currentData.domains.filter(d => d.verified).map(d => `
                        <option value="${d.domain}" ${articleData && articleData.url === d.domain ? 'selected' : ''}>${d.domain}</option>
                    `).join('')}
                </select>
            </div>
            ${isEdit && articleData && articleData.images && articleData.images.length > 0 ? `
            <div class="article-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-image-line"></i> Current (${articleData.images.length})</h3>
                </div>
                <div class="image-gallery" id="current-images">
                    ${articleData.images.map((img, i) => {
                        // --- [START OF FIX] ---
                        // This block robustly finds the URL and the REAL ID
                        let url = '';
                        let id = '';
                        if (typeof img === 'string') {
                            // This handles the old, buggy backend response (a list of strings)
                            url = img;
                            // Extract the UUID from the URL
                            const match = url.match(/image-cdn\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);
                            if (match) {
                                id = match[1]; // The REAL ID
                            } else {
                                id = 'img_fallback_' + i; // A fallback that will fail, but it's better than 'img_0'
                            }
                        } else if (typeof img === 'object' && img !== null) {
                            // This handles the new, correct backend response (a list of objects)
                            url = img.url;
                            id = img.id; // The key is 'id'
                        }
                        // --- [END OF FIX] ---
                        return `
                        <div class="image-item" data-id="${id}">
                            <img src="${url}" alt="Image ${i + 1}" loading="lazy">
                            <div class="image-overlay">
                                <button type="button" class="img-btn view" onclick="window.open('${url}', '_blank')">
                                    <i class="ri-eye-line"></i> View
                                </button>
                                <button type="button" class="img-btn delete" onclick="window.toggleDeleteImage('${id}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}
            <div class="article-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-upload-line"></i> ${isEdit ? 'Add New' : 'Upload'}</h3>
                    <button type="button" class="ai-btn" id="ai-image-btn">
                        <i class="ri-magic-line"></i> <span>AI</span>
                    </button>
                </div>
                <div class="upload-area" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" name="image_data" multiple accept="image/*" style="display:none;">
                    <div class="upload-icon"><i class="ri-upload-cloud-line"></i></div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Click or drop images</div>
                    <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-top: 0.25rem;">Max 10 files, 5MB each</div>
                </div>
                <div id="preview-container" class="preview-grid"></div>
            </div>
            <div class="article-section" id="usage-section" style="display: block;">
                <div class="section-header">
                    <h3 class="section-title"><i class="ri-pie-chart-line"></i> AI Usage</h3>
                </div>
                <div class="usage-category" id="usage-stats-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-robot-line" style="color: var(--primary); font-size: 1.1rem;"></i>
                            <span style="font-weight: 600; color: var(--text);">AI Generations</span>
                        </div>
                        <span style="font-size: 0.875rem; font-weight: 600;" id="usage-percentage">0%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div id="usage-progress-bar" style="height: 100%; width: 0%; transition: width 0.3s ease, background-color 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                        <span><strong id="usage-used">0</strong> used</span>
                        <span><strong id="usage-remaining">0</strong> remaining / <strong id="usage-limit">0</strong> total</span>
                    </div>
                </div>
            </div>
            <div class="article-section action-buttons-wrapper">
                <div class="article-actions">
                    <button type="button" class="btn-save" id="article-save-btn">
                        <i class="ri-save-line"></i> ${isEdit ? 'Update Article' : 'Create Article'}
                    </button>
                    <button type="button" class="btn-cancel" id="article-cancel-btn">
                        <i class="ri-close-line"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    `;
    Swal.fire({
        title: `<div style="font-size: 1.15rem; font-weight: 700;">${isEdit ? '<i class="ri-edit-line"></i> Edit Article' : '<i class="ri-add-line"></i> Create Article'}</div>`,
        html: modalHtml,
        width: '95vw',
        showCloseButton: true,
        showCancelButton: true,
        confirmButtonText: `<i class="ri-save-line"></i> ${isEdit ? 'Update' : 'Create'}`,
        cancelButtonText: 'Cancel',
        confirmButtonColor: 'var(--primary)',
        customClass: { popup: 'article-modal-swal' },
        didOpen: () => {
            // State
            window.articleFiles = [];
            window.deleteImageIds = [];
            window.imageUrls = [];
            // Counters
            const titleInput = document.getElementById('article-subject');
            const bodyInput = document.getElementById('article-body');
            const updateCounters = () => {
                document.getElementById('title-count').textContent = titleInput.value.length;
                document.getElementById('body-count').textContent = bodyInput.value.length;
            };
            titleInput.addEventListener('input', updateCounters);
            bodyInput.addEventListener('input', updateCounters);
            updateCounters();
            // File input
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    if (!file.type.startsWith('image/')) return;
                    if (file.size > 5 * 1024 * 1024) {
                        showToast(file.name + ' exceeds 5MB', 'error');
                        return;
                    }
                    const totalImages = window.articleFiles.length + window.imageUrls.length;
                    if (totalImages >= 10) {
                        showToast('Max 10 images', 'warning');
                        return;
                    }
                    window.articleFiles.push(file);
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `
                            <img src="${ev.target.result}" alt="${file.name}">
                            <button type="button" class="preview-remove" onclick="window.removePreview('${file.name}', this)">
                                <i class="ri-close-line"></i>
                            </button>
                        `;
                        document.getElementById('preview-container').appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                fileInput.value = '';
            });
            // Drag & drop
            const zone = document.getElementById('upload-zone');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
            zone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change'));
            });
            // Helper: Update usage display
// Helper: Update usage display
            window.updateUsageDisplay = (usage) => {
                if (!usage) return;
                // Handle API response format
                const used = usage.ai_generations_used !== undefined ? usage.ai_generations_used : (usage.used || 0);
                const limit = usage.ai_generations_limit !== undefined ? usage.ai_generations_limit : (usage.limit || 0);
                const remaining = usage.ai_generations_remaining !== undefined ? usage.ai_generations_remaining : (usage.remaining || 0);
                // --- [FIX #1] ---
                // We calculate the percentage REMAINING, not the percentage used.
                const percentageRemaining = limit > 0 ? Math.round((remaining / limit) * 100) : 0;
                // Update text values
                document.getElementById('usage-used').textContent = used;
                document.getElementById('usage-limit').textContent = limit;
                document.getElementById('usage-remaining').textContent = remaining;
                // --- [FIX #2] ---
                // We display the new 'percentageRemaining' variable.
                document.getElementById('usage-percentage').textContent = percentageRemaining + '%';
                // Update progress bar with dynamic color
                const progressBar = document.getElementById('usage-progress-bar');
                if (progressBar) {
                    // --- [FIX #3] ---
                    // The bar width is also based on 'percentageRemaining'.
                    progressBar.style.width = percentageRemaining + '%';
                    // --- [FIX #4] ---
                 // The color logic is now correctly based on how much is REMAINING.
                    let progressColor;
                    if (percentageRemaining >= 100) {
                        progressColor = '#8b5cf6'; // Purple (100% or more)
                    } else if (percentageRemaining >= 10) {
                       progressColor = '#10b981'; // Green (10% - 99%)
                    } else {
                        progressColor = '#ef4444'; // Red (below 10%)
                    }
                    progressBar.style.background = progressColor;
                    // Update percentage text color to match
                    const percentageEl = document.getElementById('usage-percentage');
                    if (percentageEl) {
                        // --- [FIX #5] ---
                     // Show "danger" color if remaining is 20% or less.
                        if (percentageRemaining <= 20) {
                            percentageEl.style.color = 'var(--danger)';
                        } else {
                            percentageEl.style.color = 'var(--primary)';
                     }
                    }
                }
            };
            // Fetch and display current usage stats from API
            (async () => {
                try {
                    const response = await api('/dashboard/articles');
                    if (response && response.data) {
                        let usageData = null;
                        // Check if usage is in the format from generate-article (direct usage object)
                        if (response.data.usage && response.data.usage.ai_generations_limit !== undefined) {
                            usageData = response.data.usage;
                        }
                        // Check if usage is in the format from loadArticles (user.usage.ai)
                        else if (response.data.user && response.data.user.usage && response.data.user.usage.ai) {
                            const usage = response.data.user.usage.ai;
                            // Convert usage format from loadArticles format to updateUsageDisplay format
                            usageData = {
                                ai_generations_limit: usage.limit || usage.ai_generations_limit,
                                ai_generations_remaining: usage.remaining || usage.ai_generations_remaining,
                                ai_generations_used: usage.used || usage.ai_generations_used,
                                percentage_remaining: usage.percentage || usage.percentage_remaining
                            };
                        }
                        if (usageData) {
                            window.updateUsageDisplay(usageData);
                        }
                    }
                } catch (error) {
                    console.error('Failed to fetch usage stats:', error);
                }
            })();
            // Helper: Show status
            window.showGenStatus = (text) => {
                const status = document.getElementById('gen-status');
                const statusText = document.getElementById('gen-status-text');
                statusText.textContent = text;
                status.classList.add('active');
            };
            // Helper: Hide status
            window.hideGenStatus = () => {
                document.getElementById('gen-status').classList.remove('active');
            };
            // Global functions
            window.removePreview = (name, btn) => {
                window.articleFiles = window.articleFiles.filter(f => f.name !== name);
                btn.closest('.preview-item').remove();
            };
            window.toggleDeleteImage = (id) => {
                const item = document.querySelector(`[data-id="${id}"]`);
                const idx = window.deleteImageIds.indexOf(id);
                if (idx > -1) {
                    window.deleteImageIds.splice(idx, 1);
                    item.classList.remove('marked-delete');
                } else {
                    window.deleteImageIds.push(id);
                    item.classList.add('marked-delete');
                }
                document.getElementById('delete-images').value = window.deleteImageIds.join(',');
            };
            // Editor functions - FIXED SYNTAX ERROR
            document.querySelectorAll('.editor-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tagName = btn.getAttribute('data-tag');
                    const textarea = document.getElementById('article-body');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    const selectedText = text.substring(start, end);
                    let openTag, closeTag;
                    if (tagName === 'a') {
                        openTag = '<a href="">';
                        closeTag = '</a>';
                    } else {
                        openTag = `<${tagName}>`;
                        closeTag = `</${tagName}>`;
                    }
                    const newText = text.substring(0, start) + openTag + selectedText + closeTag + text.substring(end);
                    textarea.value = newText;
                    textarea.focus();
                    const cursorPos = start + openTag.length + selectedText.length;
                    textarea.setSelectionRange(cursorPos, cursorPos);
                    document.getElementById('body-count').textContent = newText.length;
                });
            });
            // AI Generate All (Title + Body + Image)
            document.getElementById('ai-generate-all-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                const btn = e.currentTarget;
                const url = document.getElementById('article-url').value.trim();
                const subject = document.getElementById('article-subject').value.trim();
                // Validate that domain is selected
                if (!url) {
                    showToast('Please select a domain first', 'warning');
                    return;
                }
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = '<i class="ri-loader-4-line"></i> <span>Generating</span><div class="progress-dots"><span></span><span></span><span></span></div>';
                window.showGenStatus('Generating complete article with AI...');
                try {
                    // Build payload: with subject if provided, without subject if empty
                    const payload = subject ? {
                        subject: subject,
                        url: url
                    } : {
                        url: url
                    };
                    const response = await fetch(`${API_BASE}/generate-article`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Session-Token': sessionToken
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        // Set title
                        if (data.data.title || data.data.subject) {
                            const title = data.data.title || data.data.subject;
                            document.getElementById('article-subject').value = title;
                            document.getElementById('title-count').textContent = title.length;
                        }
                        // Set body
                        if (data.data.body) {
                            document.getElementById('article-body').value = data.data.body;
                            document.getElementById('body-count').textContent = data.data.body.length;
                        }
                        // Handle AI-generated image URL
                        if (data.data.image_url) {
                            window.imageUrls.push(data.data.image_url);
                            document.getElementById('image-urls').value = window.imageUrls.join(',');
                            // Add preview
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.dataset.isAiGenerated = 'true';
                            div.innerHTML = `
                                <img src="${data.data.image_url}" alt="AI Generated">
                                <button type="button" class="preview-refresh" onclick="window.refreshAiImage('${data.data.image_url}', this)" title="Reload image">
                                    <i class="ri-refresh-line"></i>
                                </button>
                                <button type="button" class="preview-remove" onclick="window.removeUrlPreview('${data.data.image_url}', this)">
                                    <i class="ri-close-line"></i>
                                </button>
                            `;
                            document.getElementById('preview-container').appendChild(div);
                        }
                        // Update usage
                        if (data.data && data.data.usage) {
                            window.updateUsageDisplay(data.data.usage);
                        }
                        showToast('Article generated successfully!', 'success');
                    } else {
                        throw new Error(data.error?.message || 'Failed to generate');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('generating');
                    btn.innerHTML = '<i class="ri-magic-line"></i> <span>Generate by AI</span>';
                    window.hideGenStatus();
                }
            });
            // AI Generate Image Only
            document.getElementById('ai-image-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                const btn = e.currentTarget;
                const url = document.getElementById('article-url').value.trim();
                const subject = document.getElementById('article-subject').value.trim();
                // Validate that domain is selected
                if (!url) {
                    showToast('Please select a domain first', 'warning');
                    return;
                }
                if (!subject) {
                    showToast('Enter a title first', 'warning');
                    return;
                }
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = '<i class="ri-loader-4-line"></i> <span>AI</span><div class="progress-dots"><span></span><span></span><span></span></div>';
                window.showGenStatus('Generating AI image...');
                try {
                    const response = await fetch(`${API_BASE}/generate-article`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Session-Token': sessionToken
                        },
                        body: JSON.stringify({ url: url, subject })
                    });
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        // Handle AI-generated image URL
                        if (data.data.image_url) {
                            const totalImages = window.articleFiles.length + window.imageUrls.length;
                            if (totalImages >= 10) {
                                showToast('Max 10 images reached', 'warning');
                                return;
                            }
                            window.imageUrls.push(data.data.image_url);
                            document.getElementById('image-urls').value = window.imageUrls.join(',');
                            // Add preview
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.dataset.isAiGenerated = 'true';
                            div.innerHTML = `
                                <img src="${data.data.image_url}" alt="AI Generated">
                                <button type="button" class="preview-refresh" onclick="window.refreshAiImage('${data.data.image_url}', this)" title="Reload image">
                                    <i class="ri-refresh-line"></i>
                                </button>
                                <button type="button" class="preview-remove" onclick="window.removeUrlPreview('${data.data.image_url}', this)">
                                    <i class="ri-close-line"></i>
                                </button>
                            `;
                            document.getElementById('preview-container').appendChild(div);
                            showToast('AI image generated!', 'success');
                        }
                        // Update usage
                        if (data.data && data.data.usage) {
                            window.updateUsageDisplay(data.data.usage);
                        }
                    } else {
                        throw new Error(data.error?.message || 'Failed to generate');
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('generating');
                    btn.innerHTML = '<i class="ri-magic-line"></i> <span>AI</span>';
                    window.hideGenStatus();
                }
            });
            // Remove URL preview
            window.removeUrlPreview = (url, btn) => {
                window.imageUrls = window.imageUrls.filter(u => u !== url);
                document.getElementById('image-urls').value = window.imageUrls.join(',');
                btn.closest('.preview-item').remove();
            };
            // Refresh AI-generated image (reload the same image)
            window.refreshAiImage = (imageUrl, btn) => {
                const previewItem = btn.closest('.preview-item');
                const img = previewItem.querySelector('img');
                const refreshIcon = btn.querySelector('i');
                btn.disabled = true;
                refreshIcon.classList.add('loading');
                // Add cache-busting parameter to force reload
                const url = new URL(imageUrl);
                url.searchParams.set('t', Date.now());
                // Create a temporary image to test if it loads
                const tempImg = new Image();
                tempImg.onload = () => {
                    // Image loaded successfully, update the main image
                    img.src = url.toString();
                    showToast('Image reloaded successfully!', 'success');
                    btn.disabled = false;
                    refreshIcon.classList.remove('loading');
                };
                tempImg.onerror = () => {
                    showToast('Failed to reload image', 'error');
                    btn.disabled = false;
                    refreshIcon.classList.remove('loading');
                };
                // Start loading the image
                tempImg.src = url.toString();
            };
            // Custom save button handler
            document.getElementById('article-save-btn').addEventListener('click', () => {
                Swal.clickConfirm();
            });
            // Custom cancel button handler
            document.getElementById('article-cancel-btn').addEventListener('click', () => {
                Swal.clickCancel();
            });
        },
        preConfirm: () => {
            const url = document.getElementById('article-url').value;
            const subject = document.getElementById('article-subject').value.trim();
            const body = document.getElementById('article-body').value.trim();
            if (!url) { Swal.showValidationMessage('Select a domain'); return false; }
            if (!subject) { Swal.showValidationMessage('Enter a title'); return false; }
            if (!body) { Swal.showValidationMessage('Enter content'); return false; }
            // Validate that we have at least one image (file or URL)
            if (window.articleFiles.length === 0 && window.imageUrls.length === 0 && !isEdit) {
                Swal.showValidationMessage('At least one image is required');
                return false;
            }
            const formData = new FormData();
            formData.append('url', url);
            formData.append('subject', subject);
            formData.append('body', body);
            if (window.deleteImageIds.length) formData.append('delete_image_ids', window.deleteImageIds.join(','));
            if (window.imageUrls.length) formData.append('image_urls', window.imageUrls.join(','));
            window.articleFiles.forEach(f => formData.append('image_data', f));
            return formData;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({ title: isEdit ? 'Updating...' : 'Creating...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            try {
                const endpoint = isEdit ? `/edit-article/${articleId}` : '/add-article';
                const method = isEdit ? 'PUT' : 'POST';
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method,
                    headers: { 'Session-Token': sessionToken },
                    body: result.value
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || data.message || 'Failed');
                Swal.close();
                showToast(`Article ${isEdit ? 'updated' : 'created'}!`, 'success');
                loadArticles();
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Failed', text: error.message, customClass: { popup: 'swal2-toast' } });
            }
        }
    });
}
// ADD THIS SMALL HELPER FUNCTION BACK
function editArticle(articleId) {
    // This now simply closes the details modal and opens the new edit modal
    Swal.close();
    showArticleModal(articleId);
}
function showInstallInstructions(domain) {
    const divCode = `<div id="seotize-blog-root"></div>`;
    const scriptCode = `<script src="https://seotize.net/blog.js?site=${domain}" defer><\/script>`;
    const modalHtml = `
    <style>
        .install-code-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }
        .install-code-block pre {
            background: var(--input-bg);
            color: var(--text);
            padding: 1rem;
            border-radius: var(--radius);
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .install-code-block code {
            white-space: pre-wrap;
        }
        .install-code-block p {
            margin: 0 0 0.75rem 0;
            color: var(--text);
            font-size: 0.9rem;
        }
        .install-copy-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
        }
        /* Mobile adjustments */
        @media (max-width: 600px) {
            .install-code-block {
                padding: 0.75rem;
            }
            .install-code-block pre {
                padding: 0.75rem;
                font-size: 0.75rem;
            }
            .install-copy-btn {
                position: static;
                display: block;
                width: 100%;
                margin-top: 0.75rem;
            }
        }
    </style>
    <div style="text-align: left;">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            This is what you would send to your client:
            <br><strong>How to Install Your Seotize Blog:</strong>
        </p>
        <div class="install-code-block">
            <button class="btn btn-sm btn-primary install-copy-btn" onclick="copyToClipboard(document.getElementById('install-code-div').innerText)">
                <i class="ri-file-copy-line"></i> Copy
            </button>
            <p><strong>Step 1:</strong> Paste this &lt;div&gt; tag exactly where you want the blog to appear on your page:</p>
            <pre><code id="install-code-div">${divCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
        </div>
        <div class="install-code-block">
            <button class="btn btn-sm btn-primary install-copy-btn" onclick="copyToClipboard(document.getElementById('install-code-script').innerText)">
                <i class="ri-file-copy-line"></i> Copy
            </button>
            <p><strong>Step 2:</strong> Paste this &lt;script&gt; tag just before your closing &lt;/body&gt; tag:</p>
            <pre><code id="install-code-script">${scriptCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
        </div>
    </div>
    `;
    Swal.fire({
        title: 'Client-Side Installation',
        html: modalHtml,
        width: '95vw',
        maxWidth: '800px',
        showCloseButton: true,
        showConfirmButton: false,
    });
}
// Custom delete confirmation modal
function confirmDeleteArticle(articleId) {
    Swal.fire({
        title: '<i class="ri-error-warning-line" style="color: var(--danger); font-size: 2.5rem;"></i>',
        html: `
            <div style="text-align: center;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text);">Delete Article?</h3>
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">This action cannot be undone. The article and all its data will be permanently removed.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="ri-delete-bin-line"></i> Delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--bg-tertiary)',
        reverseButtons: true,
        customClass: {
            popup: 'swal2-toast',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn'
        },
        buttonsStyling: false,
        focusCancel: true
    }).then((result) => {
        if (result.isConfirmed) {
            deleteArticle(articleId);
        }
    });
}
async function deleteArticle(articleId) {
    try {
        Swal.fire({
            title: 'Deleting...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            customClass: { popup: 'swal2-toast' }
        });
        await api(`/delete-article/${articleId}`, { method: 'DELETE' });
        Swal.close();
        showToast('Article deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        console.error('Delete article error:', error);
        Swal.close();
        showToast('Failed to delete article: ' + error.message, 'error');
    }
}
// ADD THIS NEW, COMBINED FUNCTION
async function showImageUploadModal() {
    const swalHtml = `
        <form id="imageUploadForm" enctype="multipart/form-data" style="text-align: left;">
            <div class="form-group">
                <label class="form-label">Select Images</label>
                <input type="file" id="swal-file-input" class="form-input" name="file" multiple accept="image/*" required>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    Maximum 10 files, 5MB per file. Supported formats: JPG, PNG, GIF, WebP
                </small>
            </div>
            <div id="uploadPreview" style="margin-top: 1rem; display: none;">
                <h4 style="font-size: 0.9rem; font-weight: 500; margin-bottom: 0.75rem;">Preview:</h4>
                <div id="previewContainer" style="display: flex; flex-wrap: wrap; gap: 0.75rem; background: var(--bg-tertiary); padding: 0.75rem; border-radius: var(--radius);"></div>
            </div>
        </form>
    `;
    Swal.fire({
        title: 'Upload Images',
        html: swalHtml,
        showCloseButton: true, // This adds the 'X' button to the top-right
        showCancelButton: true,
        confirmButtonText: '<i class="ri-upload-2-line"></i> Upload',
        confirmButtonColor: 'var(--primary)',
        customClass: { popup: 'swal2-toast' }, // Re-use toast class for theming
        didOpen: () => {
            // Attach the preview logic after the modal opens
            const fileInput = document.getElementById('swal-file-input');
            const previewContainer = document.getElementById('previewContainer');
            const uploadPreview = document.getElementById('uploadPreview');
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    uploadPreview.style.display = 'block';
                    previewContainer.innerHTML = ''; // Clear previous previews
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius-sm); border: 2px solid var(--border);';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    uploadPreview.style.display = 'none';
                }
            });
        },
        preConfirm: () => {
            // This function runs when the confirm button is clicked, before the modal closes.
            // It's used for validation.
            const fileInput = document.getElementById('swal-file-input');
            const files = fileInput.files;
            if (files.length === 0) {
                Swal.showValidationMessage('Please select at least one image to upload.');
                return false; // Prevent closing
            }
            if (files.length > 10) {
                Swal.showValidationMessage('You can upload a maximum of 10 images at a time.');
                return false; // Prevent closing
            }
            // If validation passes, return the form data for the next step
            const formData = new FormData(document.getElementById('imageUploadForm'));
            return formData;
        }
    }).then(async (result) => {
        // This block runs after preConfirm is successful and the user has confirmed
        if (result.isConfirmed) {
            const formData = result.value;
            // Show a loading indicator
            Swal.fire({
                title: 'Uploading...',
                text: 'Please wait while your images are being uploaded.',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                customClass: { popup: 'swal2-toast' }
            });
            try {
                const response = await fetch(`${API_BASE}/images/upload`, {
                    method: 'POST',
                    headers: { 'Session-Token': sessionToken },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error?.message || data.message || 'Upload failed');
                }
                Swal.close(); // <-- ADD THIS LINE
                showToast(`Successfully uploaded ${data.data.uploaded_images.length} images!`, 'success');
                loadImages(); // Refresh the images list
            } catch (error) {
                console.error('Upload error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: error.message,
                    customClass: { popup: 'swal2-toast' }
                });
            }
        }
    });
}
// [NEW] Enhanced Image Details using SweetAlert2
async function showImageDetails(imageId) {
    const image = currentData.images.find(img => img.image_id === imageId);
    if (!image) {
        showToast('Image not found', 'error');
        return;
    }
    // --- 1. Process Analytics Data ---
    const monthlyStats = image.monthly_stats || {};
    const countries = {}, browsers = {}, devices = {}, viewsByDate = {};
    Object.entries(monthlyStats).forEach(([month, stats]) => {
        if (stats.country) Object.entries(stats.country).forEach(([k, v]) => { countries[k.toUpperCase()] = (countries[k.toUpperCase()] || 0) + v; });
        if (stats.browser) Object.entries(stats.browser).forEach(([k, v]) => { browsers[k] = (browsers[k] || 0) + v; });
        if (stats.devices) Object.entries(stats.devices).forEach(([k, v]) => { devices[k] = (devices[k] || 0) + v; });
        if (stats.daily) Object.entries(stats.daily).forEach(([day, views]) => {
            const [year, monthNum] = month.split('-');
            viewsByDate[`${year}-${monthNum}-${day.padStart(2, '0')}`] = views;
        });
    });
    const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
    const topCountries = Object.entries(countries).sort(([,a], [,b]) => b - a).slice(0, 5);
    const topBrowsers = Object.entries(browsers).sort(([,a], [,b]) => b - a).slice(0, 5);
    const topDevices = Object.entries(devices).sort(([,a], [,b]) => b - a).slice(0, 5);
    const hasAnalytics = sortedDates.length > 0;
    // Format dates and stats
    const uploadDate = new Date(image.upload_date);
    const formattedDate = uploadDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    const totalViews = image.total_views || 0;
    const countryCount = Object.keys(countries).length;
    const browserCount = Object.keys(browsers).length;
    const last7Views = sortedDates.slice(-7).reduce((sum, [, v]) => sum + v, 0);
    // Truncate filename for display
    const displayFilename = image.original_filename.length > 35
        ? image.original_filename.substring(0, 32) + '...'
        : image.original_filename;
    // --- 2. Construct Modal HTML ---
    const modalHtml = `
    <div class="image-details-modal-container">
        <!-- Hero Section: Image at Top -->
        <div class="image-hero-section">
            <div class="image-hero-preview">
                <img src="${image.cdn_url}" alt="${image.original_filename}" class="image-hero-img" onclick="window.open('${image.cdn_url}', '_blank')" title="Click to view full size">
            </div>
            <div class="image-info-bar">
                <div class="image-info-left">
                    <h3 class="image-filename">
                        <i class="ri-image-line"></i>
                        <span title="${image.original_filename}">${displayFilename}</span>
                    </h3>
                    <div class="image-meta-row">
                        <span><i class="ri-calendar-line"></i> ${formattedDate}</span>
                        <span><i class="ri-key-2-line"></i> ${image.image_id.substring(0, 8)}...</span>
                <div class="image-actions-bar">
                    <button class="image-action-btn btn-copy" onclick="copyToClipboard('${image.cdn_url}')" title="Copy CDN URL">
                        <i class="ri-file-copy-line"></i>
                        <span>Copy URL</span>
                    </button>
                    <button class="image-action-btn btn-open" onclick="window.open('${image.cdn_url}', '_blank')" title="Open Full Size">
                        <i class="ri-external-link-line"></i>
                        <span>Open</span>
                    </button>
                    <button class="image-action-btn btn-delete" onclick="Swal.close(); deleteImage('${image.image_id}')" title="Delete Image">
                        <i class="ri-delete-bin-line"></i>
                        <span>Delete</span>
                    </button>
                </div>
                                    </div>
                </div>
            </div>
        </div>
        <!-- Stats Grid -->
        <div class="image-stats-grid">
            <div class="image-stat-card">
                <div class="stat-value" style="color: var(--success);">${formatNumber(totalViews)}</div>
                <div class="stat-label">Total Views</div>
            </div>
            <div class="image-stat-card">
                <div class="stat-value" style="color: var(--primary);">${formatNumber(last7Views)}</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
            <div class="image-stat-card">
                <div class="stat-value" style="color: var(--info);">${countryCount}</div>
                <div class="stat-label">Countries</div>
            </div>
            <div class="image-stat-card">
                <div class="stat-value" style="color: var(--warning);">${browserCount}</div>
                <div class="stat-label">Browsers</div>
            </div>
        </div>
        <!-- Tabs -->
        <div class="image-modal-tabs" role="tablist">
            <button class="image-modal-tab active" type="button" data-tab="analytics" role="tab">
                <i class="ri-line-chart-line"></i> Analytics
            </button>
            <button class="image-modal-tab" type="button" data-tab="traffic" role="tab">
                <i class="ri-pie-chart-line"></i> Traffic
            </button>
        </div>
        <!-- Panels -->
        <div class="image-modal-panels">
            <!-- Analytics Panel -->
            <div class="image-modal-panel" id="image-panel-analytics" data-panel="analytics" role="tabpanel">
                ${hasAnalytics ? `
                    <div class="image-analytics-content">
                        <div class="image-chart-card">
                            <div class="chart-header"><i class="ri-line-chart-line"></i> Views Over Time</div>
                            <div class="chart-body"><canvas id="imageViewsTimelineChart"></canvas></div>
                        </div>
                        <div class="image-chart-card">
                            <div class="chart-header"><i class="ri-earth-line"></i> Top Countries</div>
                            <div class="chart-body"><canvas id="imageCountriesChart"></canvas></div>
                        </div>
                    </div>
                ` : `
                    <div class="image-empty-state">
                        <i class="ri-bar-chart-line"></i>
                        <h4>No Analytics Yet</h4>
                        <p>Analytics will appear once the image receives views.</p>
                    </div>
                `}
            </div>
            <!-- Traffic Panel -->
            <div class="image-modal-panel" id="image-panel-traffic" data-panel="traffic" role="tabpanel" hidden>
                ${hasAnalytics ? `
                    <div class="image-traffic-content">
                        <div class="image-traffic-card">
                            <div class="card-header"><i class="ri-window-line"></i> Browsers</div>
                            <div class="card-body">
                                <div class="image-traffic-list">
                                    ${topBrowsers.length > 0 ? topBrowsers.map(b => `
                                        <div class="image-traffic-item">
                                            <span class="item-name">${b[0]}</span>
                                            <span class="badge badge-primary">${formatNumber(b[1])}</span>
                                        </div>
                                    `).join('') : '<div class="image-traffic-item"><span class="item-name">No data</span><span>—</span></div>'}
                                </div>
                            </div>
                        </div>
                        <div class="image-traffic-card">
                            <div class="card-header"><i class="ri-device-line"></i> Devices</div>
                            <div class="card-body">
                                <div class="image-traffic-list">
                                    ${topDevices.length > 0 ? topDevices.map(d => `
                                        <div class="image-traffic-item">
                                            <span class="item-name">${d[0]}</span>
                                            <span class="badge badge-warning">${formatNumber(d[1])}</span>
                                        </div>
                                    `).join('') : '<div class="image-traffic-item"><span class="item-name">No data</span><span>—</span></div>'}
                                </div>
                            </div>
                        </div>
                        <div class="image-traffic-card">
                            <div class="card-header"><i class="ri-earth-line"></i> Countries</div>
                            <div class="card-body">
                                <div class="image-traffic-list">
                                    ${topCountries.length > 0 ? topCountries.map(c => `
                                        <div class="image-traffic-item">
                                            <span class="item-name">${c[0]}</span>
                                            <span class="badge badge-success">${formatNumber(c[1])}</span>
                                        </div>
                                    `).join('') : '<div class="image-traffic-item"><span class="item-name">No data</span><span>—</span></div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="image-empty-state">
                        <i class="ri-pie-chart-line"></i>
                        <h4>No Traffic Data</h4>
                        <p>Traffic breakdown will appear once the image receives views.</p>
                    </div>
                `}
            </div>
        </div>
    </div>`;
    // --- 3. Fire Modal ---
    Swal.fire({
        html: modalHtml,
        showCloseButton: true,
        showConfirmButton: false,
        width: 'min(900px, 96vw)',
        customClass: {
            popup: 'swal2-toast image-details-swal',
            closeButton: 'swal2-close'
        },
        showClass: { popup: 'swal2-show-super-fast' },
        hideClass: { popup: 'swal2-hide-super-fast' },
        didOpen: () => {
            setupImageDetailsTabs();
            if (hasAnalytics) {
                initializeImageAnalyticsCharts(sortedDates, topCountries);
            }
        }
    });
}
// Setup image details tabs
function setupImageDetailsTabs() {
    const popup = Swal.getPopup();
    if (!popup) return;
    const tabs = Array.from(popup.querySelectorAll('.image-modal-tab'));
    const panels = Array.from(popup.querySelectorAll('.image-modal-panel'));
    if (tabs.length === 0 || panels.length === 0) return;
    const activate = (name) => {
        tabs.forEach(btn => {
            const isActive = btn.dataset.tab === name;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        panels.forEach(panel => {
            const isPanelActive = panel.dataset.panel === name;
            if (isPanelActive) {
                panel.removeAttribute('hidden');
                panel.classList.remove('panel-in');
                panel.offsetWidth;
                panel.classList.add('panel-in');
            } else {
                panel.setAttribute('hidden', '');
            }
        });
    };
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            activate(btn.dataset.tab);
        });
    });
    activate('analytics');
}
// [NEW] Helper function to initialize charts inside the modal
function initializeImageAnalyticsCharts(sortedDates, topCountries) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#a0a0a0' : '#6c757d';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    // Views Timeline Chart (Line Chart)
    const timelineCtx = document.getElementById('imageViewsTimelineChart');
    if (timelineCtx) {
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: sortedDates.map(([date]) => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                datasets: [{
                    label: 'Views',
                    data: sortedDates.map(([, views]) => views),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Views Over Time', color: textColor } },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true }
                }
            }
        });
    }
    // Top Countries Chart (Bar Chart - better for ranking)
    const countriesCtx = document.getElementById('imageCountriesChart');
    if (countriesCtx) {
        new Chart(countriesCtx, {
            type: 'bar',
            data: {
                labels: topCountries.map(([country]) => country),
                    datasets: [{
                        label: 'Views',
                        data: topCountries.map(([, views]) => views),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y', // Horizontal bars
                plugins: { legend: { display: false }, title: { display: true, text: 'Top 5 Countries', color: textColor } },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { display: false } }
                }
            }
        });
    }
}
// [NEW] Improved delete function with confirmation via SweetAlert2
async function deleteImage(imageId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--error)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'Yes, delete it!',
        customClass: { popup: 'swal2-toast' } // Use our theme
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                await api('/images', {
                    method: 'DELETE',
                    body: JSON.stringify({ image_ids: [imageId] })
                });
                showToast('Image deleted successfully', 'success');
                // Close any open modal and reload the list
                Swal.close();
                loadImages(paginationState.images.page); // Reload current page
            } catch (error) {
                showToast('Failed to delete image: ' + error.message, 'error');
            }
        }
    });
}
function deleteImageFromModal(imageId) {
    closeModal();
    setTimeout(() => deleteImage(imageId), 100);
}
// [NEW] Payment Details Modal
async function viewPaymentDetails(billingId) {
    Swal.fire({ title: 'Loading...', showConfirmButton: false, customClass: { popup: 'swal2-toast' } });
    try {
        const { data: p } = await api(`/get-payment-status?payment_id=${billingId}`);
        if (!p) throw new Error('Payment not found');
        
        const st = { paid:['Paid','#10b981','ri-check-line'], succeeded:['Paid','#10b981','ri-check-line'], pending:['Pending','#f59e0b','ri-time-line'], failed:['Failed','#ef4444','ri-close-line'], cancelled:['Cancelled','#ef4444','ri-close-line'], refunded:['Refunded','#8b5cf6','ri-refund-line'] };
        const [sT,sC,sI] = st[(p.status||p.payment_status||'').toLowerCase()] || ['Unknown','#64748b','ri-question-line'];
        const fmt = d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
        const fmtShort = d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
        const cp = id => `<i class="ri-file-copy-line pcp" onclick="copyToClipboard('${id}')" title="Copy"></i>`;
        const isStripe = p.payment_method?.toLowerCase()==='stripe';

        Swal.update({ title:'', html:`<style>
.pay-modal{width:85vw!important;max-width:950px!important;padding:0!important;border-radius:var(--radius-lg,16px)!important;background:var(--bg,#fff)!important;box-shadow:0 25px 60px rgba(0,0,0,.3)!important;overflow:hidden}
.pay-modal .swal2-html-container{margin:0!important;padding:0!important}
.pay-modal .swal2-title{display:none!important}
.pay-modal .swal2-close{position:absolute;top:1.25rem;right:1.25rem;width:2.5rem;height:2.5rem;background:var(--bg-tertiary,rgba(0,0,0,.06));color:var(--text-secondary,#64748b);border-radius:var(--radius,8px);font-size:1.5rem;transition:.2s;z-index:10;display:flex;align-items:center;justify-content:center}
.pay-modal .swal2-close:hover{background:var(--error,#ef4444);color:#fff}
.pay-wrap{display:grid;grid-template-columns:340px 1fr;min-height:400px}
.pay-left{background:linear-gradient(180deg,var(--primary,#6366f1) 0%,#4f46e5 100%);color:#fff;padding:2.5rem;display:flex;flex-direction:column}
.pay-amount{margin-bottom:2rem}
.pay-amount h2{font-size:3.5rem;font-weight:800;margin:0;letter-spacing:-2px;line-height:1}
.pay-amount span{font-size:1rem;opacity:.7;font-weight:500;margin-left:.25rem}
.pay-status{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1.25rem;border-radius:50px;font-weight:600;font-size:.9rem;background:${sC};color:#fff;box-shadow:0 4px 15px ${sC}60;margin-top:.5rem}
.pay-status i{font-size:1.1rem}
.pay-actions{margin-top:auto;display:flex;flex-direction:column;gap:.75rem}
.pay-btn{display:flex;align-items:center;gap:.75rem;padding:.9rem 1.25rem;border-radius:var(--radius,10px);font-weight:600;font-size:.95rem;text-decoration:none;background:rgba(255,255,255,.15);color:#fff;transition:.2s;border:1px solid rgba(255,255,255,.2)}
.pay-btn:hover{background:rgba(255,255,255,.25);transform:translateX(5px)}
.pay-btn i{font-size:1.25rem}
.pay-right{padding:2rem 2.5rem;overflow-y:auto;max-height:80vh}
.pay-section{margin-bottom:2rem}
.pay-section:last-child{margin-bottom:0}
.pay-section h3{font-size:.8rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary,#64748b);font-weight:700;margin:0 0 1rem;display:flex;align-items:center;gap:.5rem}
.pay-section h3 i{font-size:1.1rem;opacity:.6}
.pay-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.pay-card{background:var(--bg-secondary,#f8fafc);border:1px solid var(--border,#e2e8f0);border-radius:var(--radius,12px);padding:1rem 1.25rem;display:flex;align-items:center;gap:1rem;transition:.2s}
.pay-card:hover{border-color:var(--primary,#6366f1);box-shadow:0 4px 20px rgba(99,102,241,.1)}
.pay-card-icon{width:2.75rem;height:2.75rem;background:linear-gradient(135deg,var(--primary,#6366f1),#8b5cf6);border-radius:var(--radius,8px);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pay-card-icon i{font-size:1.25rem;color:#fff}
.pay-card-info{flex:1;min-width:0}
.pay-card label{font-size:.65rem;text-transform:uppercase;letter-spacing:.4px;color:var(--text-secondary,#64748b);font-weight:600;display:block;margin-bottom:.15rem}
.pay-card strong{font-size:.95rem;color:var(--text,#1e293b);display:block}
.pay-stripe{background:#635bff;color:#fff;padding:.25rem .6rem;border-radius:6px;font-size:.85rem;font-weight:600;display:inline-block}
.pay-stat{display:inline-flex;align-items:center;gap:.25rem;padding:.3rem .7rem;border-radius:6px;font-size:.85rem;font-weight:600;background:${sC}15;color:${sC}}
.pay-timeline{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.pay-time{background:var(--bg-secondary,#f8fafc);border:1px solid var(--border,#e2e8f0);border-radius:var(--radius,12px);padding:1rem 1.25rem;display:flex;align-items:center;gap:1rem}
.pay-time i{font-size:1.5rem;color:var(--primary,#6366f1)}
.pay-time div label{font-size:.65rem;text-transform:uppercase;letter-spacing:.3px;color:var(--text-secondary,#64748b);font-weight:600;display:block;margin-bottom:.15rem}
.pay-time div strong{font-size:.95rem;color:var(--text,#1e293b)}
.pay-refs{display:flex;flex-direction:column;gap:.75rem}
.pay-ref{background:var(--bg-secondary,#f8fafc);border:1px solid var(--border,#e2e8f0);border-radius:var(--radius,10px);padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;transition:.2s}
.pay-ref:hover{border-color:var(--primary,#6366f1)}
.pay-ref label{font-size:.75rem;text-transform:uppercase;letter-spacing:.3px;color:var(--text-secondary,#64748b);font-weight:600;white-space:nowrap}
.pay-ref div{display:flex;align-items:center;gap:.5rem;flex:1;min-width:0;justify-content:flex-end}
.pay-ref code{background:var(--bg-tertiary,#f1f5f9);padding:.4rem .6rem;border-radius:6px;font-size:.8rem;font-family:'SF Mono',Monaco,monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text,#1e293b)}
.pcp{cursor:pointer;width:2rem;height:2rem;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:.15s;color:var(--text-secondary,#94a3b8);font-size:1.1rem}
.pcp:hover{color:var(--primary,#6366f1);background:rgba(99,102,241,.1)}
@media(max-width:800px){.pay-modal{width:100vw!important;max-width:100%!important;border-radius:1.5rem 1.5rem 0 0!important;max-height:95vh!important;margin:0!important}.pay-wrap{grid-template-columns:1fr;min-height:auto}.pay-left{padding:1.75rem 1.5rem;flex-direction:column;align-items:center;text-align:center;gap:.75rem}.pay-amount{margin-bottom:0}.pay-amount h2{font-size:3rem;letter-spacing:-1.5px}.pay-amount span{font-size:1rem;opacity:.8}.pay-status{padding:.6rem 1.5rem;font-size:.9rem;margin-top:.25rem;border-radius:2rem}.pay-status i{font-size:1.1rem}.pay-actions{margin-top:1rem;flex-direction:row;width:100%;gap:.5rem}.pay-btn{flex:1;flex-direction:column;align-items:center;gap:.3rem;padding:.75rem .5rem;font-size:.75rem;text-align:center;border-radius:.75rem}.pay-btn i{font-size:1.35rem}.pay-right{padding:1.25rem;max-height:50vh;overflow-y:auto}.pay-section{margin-bottom:1.25rem}.pay-section h3{font-size:.7rem;margin-bottom:.75rem}.pay-cards{grid-template-columns:1fr 1fr;gap:.6rem}.pay-card{padding:.75rem .85rem;gap:.7rem}.pay-card-icon{width:2.25rem;height:2.25rem}.pay-card-icon i{font-size:1rem}.pay-card label{font-size:.55rem}.pay-card strong{font-size:.8rem}.pay-timeline{gap:.6rem}.pay-time{padding:.7rem .85rem;gap:.6rem}.pay-time i{font-size:1.1rem}.pay-time div label{font-size:.55rem}.pay-time div strong{font-size:.8rem}.pay-refs{gap:.5rem}.pay-ref{padding:.7rem .85rem}.pay-ref label{font-size:.65rem}.pay-ref code{font-size:.7rem;padding:.3rem .5rem}}
</style>
<div class="pay-wrap">
<div class="pay-left">
<div class="pay-amount"><h2>$${(p.amount||0).toFixed(2)}<span>${(p.currency||'USD').toUpperCase()}</span></h2></div>
<div class="pay-status"><i class="${sI}"></i>${sT}</div>
${(p.receipt_url||p.invoice_url||p.invoice_pdf)?`<div class="pay-actions">${p.receipt_url?`<a href="${p.receipt_url}" target="_blank" class="pay-btn"><i class="ri-receipt-line"></i>View Receipt</a>`:''}${p.invoice_url?`<a href="${p.invoice_url}" target="_blank" class="pay-btn"><i class="ri-file-text-line"></i>View Invoice</a>`:''}${p.invoice_pdf?`<a href="${p.invoice_pdf}" target="_blank" class="pay-btn"><i class="ri-download-line"></i>Download PDF</a>`:''}</div>`:''}
</div>
<div class="pay-right">
<div class="pay-section"><h3><i class="ri-information-line"></i>Payment Details</h3>
<div class="pay-cards">
${p.type?`<div class="pay-card"><div class="pay-card-icon"><i class="ri-price-tag-3-line"></i></div><div class="pay-card-info"><label>Type</label><strong style="text-transform:capitalize">${p.type.replace(/_/g,' ')}</strong></div></div>`:''}
${p.payment_method?`<div class="pay-card"><div class="pay-card-icon"><i class="ri-bank-card-line"></i></div><div class="pay-card-info"><label>Method</label><strong>${isStripe?'<span class="pay-stripe">Stripe</span>':p.payment_method}</strong></div></div>`:''}
<div class="pay-card"><div class="pay-card-icon"><i class="ri-checkbox-circle-line"></i></div><div class="pay-card-info"><label>Status</label><strong><span class="pay-stat"><i class="${sI}"></i>${sT}</span></strong></div></div>
${p.date_created?`<div class="pay-card"><div class="pay-card-icon"><i class="ri-calendar-line"></i></div><div class="pay-card-info"><label>Date</label><strong>${fmtShort(p.date_created)}</strong></div></div>`:''}
</div></div>
${(p.date_created||p.date_updated)?`<div class="pay-section"><h3><i class="ri-time-line"></i>Timeline</h3><div class="pay-timeline">${p.date_created?`<div class="pay-time"><i class="ri-calendar-check-line"></i><div><label>Created</label><strong>${fmt(p.date_created)}</strong></div></div>`:''}${p.date_updated?`<div class="pay-time"><i class="ri-history-line"></i><div><label>Last Updated</label><strong>${fmt(p.date_updated)}</strong></div></div>`:''}</div></div>`:''}
${(p.invoice_number||p.invoice_number_stripe||p.transaction_id||p.task_id)?`<div class="pay-section"><h3><i class="ri-key-2-line"></i>Reference IDs</h3><div class="pay-refs">${p.invoice_number?`<div class="pay-ref"><label>Invoice Number</label><div><code title="${p.invoice_number}">${p.invoice_number}</code>${cp(p.invoice_number)}</div></div>`:''}${p.invoice_number_stripe?`<div class="pay-ref"><label>Stripe Invoice</label><div><code>${p.invoice_number_stripe}</code>${cp(p.invoice_number_stripe)}</div></div>`:''}${p.transaction_id?`<div class="pay-ref"><label>Transaction ID</label><div><code title="${p.transaction_id}">${p.transaction_id}</code>${cp(p.transaction_id)}</div></div>`:''}${p.task_id?`<div class="pay-ref"><label>Task ID</label><div><code>${p.task_id}</code>${cp(p.task_id)}</div></div>`:''}</div></div>`:''}</div>
</div>`, showConfirmButton:false, showCloseButton:true, customClass:{popup:'pay-modal'} });
    } catch(e) { console.error('Payment error:',e); Swal.fire({icon:'error',title:'Error',text:'Failed to load payment details.',customClass:{popup:'swal2-toast'}}); }
}
// Charts
function initializeCharts(user) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    // Task Performance Chart
    const taskCtx = document.getElementById('taskChart');
    if (taskCtx) {
        if (charts.task) {
            charts.task.destroy();
        }
        const taskData = generateTaskChartData(user);
        const hasRealData = taskData.labels[0] !== 'No Data';
        charts.task = new Chart(taskCtx, {
            type: 'line',
            data: {
                labels: taskData.labels,
                datasets: [{
                    label: 'Views',
                    data: taskData.views,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }, {
                    label: 'Active Tasks',
                    data: taskData.tasks,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: textColor,
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        enabled: hasRealData,
                        backgroundColor: isDark ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: textColor,
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 },
                            maxRotation: 45
                        }
                    },
                    y: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 }
                        },
                        beginAtZero: true
                    }
                },
                elements: {
                    point: {
                        hoverRadius: hasRealData ? 6 : 0
                    }
                }
            }
        });
        // Add "No data available" message if needed
        if (!hasRealData) {
            const chartContainer = taskCtx.parentElement;
            const noDataMsg = document.createElement('div');
            noDataMsg.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-align: center;
                pointer-events: none;
                z-index: 10;
            `;
            noDataMsg.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                <div>No analytics data available yet</div>
                <div style="font-size: 0.75rem; margin-top: 0.25rem;">Data will appear when tasks receive views</div>
            `;
            chartContainer.style.position = 'relative';
            chartContainer.appendChild(noDataMsg);
        }
    }
}
function generateTaskChartData(user) {
    const analytics = user.analytics || {};
    const monthlyStats = analytics.monthly_stats || {};
    // Collect all date-view pairs from the analytics
    const dateViews = [];
    // Parse analytics data: "2025-02": {"daily": {"04": 1, "09": 3}}
    Object.entries(monthlyStats).forEach(([monthKey, stats]) => {
        if (stats.daily) {
            Object.entries(stats.daily).forEach(([day, views]) => {
                // Convert "2025-02" and "04" to "2025-02-04"
                const fullDate = `${monthKey}-${day.padStart(2, '0')}`;
                const dateObj = new Date(fullDate);
                if (!isNaN(dateObj.getTime())) {
                    dateViews.push({
                        date: dateObj,
                        dateString: fullDate,
                        views: views || 0
                    });
                }
            });
        }
    });
    // Sort by date
    dateViews.sort((a, b) => a.date - b.date);
    // If we have analytics data, use the actual dates and views
    if (dateViews.length > 0) {
        // Take last 10 data points or all if less than 10
        const recentData = dateViews.slice(-10);
        const labels = recentData.map(item =>
            item.date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            })
        );
        const views = recentData.map(item => item.views);
        const tasks = new Array(recentData.length).fill(user.usage_summary?.active_tasks || 0);
        return { labels, views, tasks };
    }
    // Fallback: if no analytics data, show empty chart with message
    return {
        labels: ['No Data'],
        views: [0],
        tasks: [user.usage_summary?.active_tasks || 0]
    };
}
// amCharts v5 World Map ? Indigo ramp, hover = green
function initializeCountryMap(user) {
  const container = document.getElementById('countryMap');
  if (!container) return;
  if (!container.style.height) container.style.height = '420px';
  // Dispose previous instance
  if (container.__am5root && !container.__am5root.isDisposed()) {
    try { container.__am5root.dispose(); } catch (_) {}
    container.__am5root = null;
  }
  // ---- Colors ----
  const RAMP_MIN   = '#a5b4fc'; // light indigo
  const RAMP_MAX   = '#4338ca'; // deep indigo
  const HOVER_FILL = '#10b981'; // green on hover
  const HOVER_EDGE = '#065f46'; // darker green stroke
  const BASE_EDGE  = '#374151'; // indigo border
  // ---- Build data ----
  const src = user?.data?.data?.user ?? user?.data?.user ?? user?.user ?? user;
  const counts = {};
  const monthly = src?.analytics?.monthly_stats || {};
  Object.values(monthly).forEach(m => {
    const cc = m?.country || {};
    for (const [iso2, v] of Object.entries(cc)) {
      const k = String(iso2).toUpperCase();
      counts[k] = (counts[k] || 0) + (Number(v) || 0);
    }
  });
  if (Object.keys(counts).length === 0 && Array.isArray(src?.sessions)) {
    src.sessions.forEach(s => {
      const k = (s.country_code || s.country || '').toUpperCase();
      if (k) counts[k] = (counts[k] || 0) + 1;
    });
  }
  const data = Object.entries(counts).map(([id, value]) => ({
    id,
    value: Number(value) || 0
  }));
  container.innerHTML = `<div id="countryMapCanvas" style="width:100%;height:100%;"></div>`;
  // ---- Helpers ----
  const ready = () =>
    typeof window.am5 !== 'undefined' &&
    typeof window.am5map !== 'undefined' &&
    typeof window.am5geodata_worldLow !== 'undefined';
  const add = (id, src) => new Promise((res, rej) => {
    if (document.getElementById(id)) return res();
    const s = document.createElement('script');
    s.id = id; s.src = src; s.async = true; s.setAttribute('data-cfasync','false');
    s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
  function hexToNum(hex) {
    const s = String(hex || '').trim();
    const m = s.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (m) { const r=+m[1], g=+m[2], b=+m[3]; return (r<<16) + (g<<8) + b; }
    let h = s.replace('#', '');
    if (h.length === 3) h = h.split('').map(x=>x+x).join('');
    if (!/^[0-9a-f]{6}$/i.test(h)) return 0x000000;
    return parseInt(h, 16);
  }
  function numToRgb(n){ return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
  function rgbToNum(r,g,b){ return ((r&255)<<16)|((g&255)<<8)|(b&255); }
  function lerp(a,b,t){ return Math.round(a + (b - a) * t); }
  function gradient(minHex, maxHex, t) {
    t = Math.max(0, Math.min(1, t || 0));
    const a = numToRgb(hexToNum(minHex));
    const b = numToRgb(hexToNum(maxHex));
    return rgbToNum(lerp(a.r,b.r,t), lerp(a.g,b.g,t), lerp(a.b,b.b,t));
  }
  function boot() {
    const root = am5.Root.new("countryMapCanvas");
    container.__am5root = root;
    if (typeof am5themes_Animated !== 'undefined') {
      root.setThemes([ am5themes_Animated.new(root) ]);
    }
    const chart = root.container.children.push(am5map.MapChart.new(root, {}));
    const polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow,
        exclude: ["AQ"],
        valueField: "value",
        calculateAggregates: true
      })
    );
    const maxVal = Math.max(...data.map(d => d.value), 1);
    const minVal = Math.min(...data.map(d => d.value), 0);
    const range  = Math.max(1, maxVal - minVal);
    const polyTpl = polygonSeries.mapPolygons.template;
    polyTpl.setAll({
      tooltipText: "{name}: [bold]{value}[/]",
      strokeOpacity: 0.7,
      stroke: am5.color(hexToNum(BASE_EDGE)),
      fillOpacity: 1,
      interactive: true,
      cursorOverStyle: "pointer"
    });
    // Hover turns country fill GREEN
    polyTpl.states.create("hover", {
      fill: am5.color(hexToNum(HOVER_FILL)),
      stroke: am5.color(hexToNum(HOVER_EDGE)),
      strokeWidth: 1.2
    });
    // Adapter: indigo ramp for normal state
    polyTpl.adapters.add("fill", (current, target) => {
      const v = target?.dataItem?.get("value");
      if (v == null || isNaN(v)) return am5.color(hexToNum(RAMP_MIN));
      const t = (v - minVal) / range;
      return am5.color(gradient(RAMP_MIN, RAMP_MAX, t));
    });
    if (data.length > 0) polygonSeries.data.setAll(data);
    polyTpl.events.on("pointerover", ev => ev.target.toFront());
    chart.set("wheelY", "zoom");
    chart.set("wheelX", "zoom");
    const ro = new ResizeObserver(() => root.resize());
    ro.observe(container);
    root.__ro = ro;
  }
  if (ready()) {
    boot();
  } else {
    Promise.resolve()
      .then(() => add('am5-core',     'https://cdn.amcharts.com/lib/5/index.js'))
      .then(() => add('am5-map',      'https://cdn.amcharts.com/lib/5/map.js'))
      .then(() => add('am5-worldlow', 'https://cdn.amcharts.com/lib/5/geodata/worldLow.js'))
      .then(() => add('am5-animated', 'https://cdn.amcharts.com/lib/5/themes/Animated.js'))
      .then(() => {
        let tries = 0;
        const t = setInterval(() => {
          if (ready() || tries++ > 40) {
            clearInterval(t);
            if (ready()) boot();
            else console.error('amCharts libs not ready.');
          }
        }, 100);
      })
      .catch(err => console.error('Map libs failed to load:', err));
  }
}
function updateCharts() {
    if (currentData.user) {
        setTimeout(() => {
            initializeCharts(currentData.user);
            if (globalMap) {
                globalMap.remove();
                initializeCountryMap(currentData.user);
            }
        }, 100);
    }
}
// Pagination
// USE THIS REPLACEMENT FUNCTION
function generatePagination(type, loadFunction) {
    const pagination = paginationState[type];
    if (!pagination) return '';
    // Create a unique ID for this specific pagination instance and store the handler function
    const handlerId = `${type}_${Date.now()}`;
    paginationHandlers[handlerId] = loadFunction;
    const totalPages = Math.max(1, Math.ceil(pagination.total / pagination.pageSize));
    const currentPage = pagination.page || 1;
    const hasMultiplePages = totalPages > 1;
    let paginationHTML = '<div class="pagination">';
    // Previous button
    paginationHTML += `<button class="pagination-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
    </button>`;
    // Page numbers
    if (hasMultiplePages) {
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        if (startPage > 1) {
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', 1)">1</button>`;
            if (startPage > 2) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
        }
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="callPaginationHandler('${handlerId}', ${i})">${i}</button>`;
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
            paginationHTML += `<button class="pagination-btn" onclick="callPaginationHandler('${handlerId}', ${totalPages})">${totalPages}</button>`;
        }
    } else {
        paginationHTML += `<button class="pagination-btn active">1</button>`;
    }
    // Next button
    paginationHTML += `<button class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''} onclick="callPaginationHandler('${handlerId}', ${currentPage + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
    </button>`;
    // Info text
    const startItem = Math.max(1, ((currentPage - 1) * pagination.pageSize) + 1);
    const endItem = Math.min(currentPage * pagination.pageSize, pagination.total);
    paginationHTML += `<div class="pagination-info">
        ${pagination.total > 0 ? `Showing ${startItem} to ${endItem} of ${pagination.total} results` : 'No results'}
    </div>`;
    paginationHTML += '</div>';
    return paginationHTML;
}
// Toast Notifications
function showToast(message, type = 'info') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
    <i class="ri-${type === 'success' ? 'check' : type === 'error' ? 'close' : type === 'warning' ? 'alert' : 'information'}-circle-line"></i>
    <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 4000);
}
// Subscription Management Helper
async function cancelSubscription() {
    showSubscriptionModal();
}
// Utility Functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
function showSpinner() {
    document.getElementById('content').innerHTML = `
    <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
    <div class="spinner"></div>
    </div>
    `;
}
function showErrorState(message) {
    document.getElementById('content').innerHTML = `
    <div class="empty-state">
    <div class="empty-state-icon">
    <i class="ri-error-warning-line"></i>
    </div>
    <div class="empty-state-title">Error Loading Data</div>
    <div class="empty-state-description">${message}</div>
    <button class="btn btn-primary" onclick="location.reload()">
    <i class="ri-refresh-line"></i> Retry
    </button>
    </div>
    `;
}
async function logout() {
    try {
        await api('/logout');
    } catch (error) {
        console.error('Logout error:', error);
    } finally {
        // Clear cookie with correct Domain attribute
        document.cookie = 'session_token=; path=/; Domain=.seotize.net; Secure; SameSite=Lax; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
    }
}
// Mobile responsiveness
window.addEventListener('resize', () => {
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (window.innerWidth <= 768) {
        sidebarToggle.style.display = 'block';
    } else {
        sidebarToggle.style.display = 'none';
        document.getElementById('sidebar').classList.remove('active');
    }
    // Handle task creator layout on resize
    const taskCreator = document.getElementById('seoTaskCreator');
    if (taskCreator && taskCreator.classList.contains('active')) {
        // Force re-layout for task creator on resize
        const container = taskCreator.querySelector('.task-creator-container');
        if (container) {
            container.style.display = 'none';
            setTimeout(() => {
                container.style.display = '';
            }, 10);
        }
    }
});
// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('mobileProfileDropdown');
    const button = document.querySelector('.mobile-profile-menu');
    if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
        closeMobileProfileDropdown();
    }
});
// Initialize theme on page load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
});
</script>
<style>
@media (max-width: 480px) {
   .priority-option {
       padding-top: 34px!important;
   }
   .progress-steps {
       margin-bottom: 1rem!important;
       min-height: 80px!important;
   }
}
@media (min-width: 770px){
   span.billing-save {
       margin-top: 18px!important;
       font-size: 11px!important;
       text-align: center!important;
   }
}
@media (max-width: 769px) {
   .billing-option{
      max-width:100%!important;
   }
   input#estimatedClicks {
       height: 49px!important;
       padding-left: 38px!important;
       font-size: 1rem!important;
   }
   .budget-field .currency-symbol {
       top: 43px !important;
        left: 14px !important;
   }
   .budget-summary-value {
        font-size: 0.975rem;
        padding-top: 10px;
    }
   div#finalAmount {
       padding-top: 3px!important;
   }
   .progress-step {
       margin-bottom: 0px !important;
   }
       .billing-cycle-options {
           flex-direction: row!important;
        }
       .billing-option {
           max-width: none !important;
           width: 32%!important;
           min-width: auto !important;
       }
        .billing-cycle-options .billing-option-top {
           flex-direction: column!important;
       }
   .progress-step.completed .step-indicator::before{display:none!important;}
   .step-indicator {
    padding: 0 !important;
    margin: 0 !important;
   }
   .progress-steps {
    margin-bottom: 0px !important;
   }
   .task-creator-sidebar {
    padding: 0 6px !important;
   }
}
</style>
</body>
</html>
